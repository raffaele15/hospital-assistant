<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lettera.AI ‚Äî Dimissione</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0f0f0f; --surface:#171717; --surface2:#1e1e1e; --surface3:#242424;
  --border:#2a2a2a; --border-hi:#3d3d3d;
  --text:#e8e4dc; --dim:#7a7570; --mid:#b0aa9f;
  --accent:#c9a96e; --accent-d:#7a6340; --accent-g:rgba(201,169,110,0.12);
  --red:#c96e6e; --green:#6ec98a; --blue:#6ea8c9; --purple:#a96ec9; --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:17px;line-height:1.6;height:100vh}
.app{display:grid;grid-template-columns:210px 1fr;grid-template-rows:52px 1fr;height:100vh;overflow:hidden}
header{grid-column:1/-1;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px}
.logo{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.14em;color:var(--accent);text-transform:uppercase}
.logo span{color:var(--dim)}
.badge{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);background:var(--surface2);border:1px solid var(--border);padding:3px 10px;border-radius:20px}
aside{background:var(--surface);border-right:1px solid var(--border);padding:14px 0;display:flex;flex-direction:column;gap:1px;overflow-y:auto}
.ns{padding:12px 14px 5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase}
.ni{display:flex;align-items:center;gap:9px;padding:8px 13px;margin:0 5px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);cursor:pointer;border:1px solid transparent;background:transparent;width:calc(100% - 10px);text-align:left;transition:all .12s}
.ni:hover{background:var(--surface2);color:var(--text)}
.ni.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}
.ni.done .sn{background:rgba(110,201,138,.15);border-color:var(--green);color:var(--green)}
.sn{width:17px;height:17px;border-radius:50%;background:var(--surface3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;transition:all .12s}
.ni.active .sn{background:var(--accent-d);border-color:var(--accent);color:var(--accent)}
main{overflow:hidden;background:var(--bg);display:flex;flex-direction:column}
.panel{display:none;padding:28px 32px;width:100%;flex:1}
.panel.active{display:block;overflow-y:auto}
#panel1.active{display:block;overflow-y:auto;padding:20px 28px 120px 28px}
.ptitle{font-size:24px;font-weight:300;margin-bottom:3px;letter-spacing:-.01em}
.psub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:22px;letter-spacing:.06em}
label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;margin-top:16px}
label:first-child{margin-top:0}
textarea,input[type=text],input[type=password]{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;padding:11px 13px;outline:none;transition:border-color .12s}
textarea{resize:vertical}
textarea:focus,input:focus{border-color:var(--accent-d)}
textarea::placeholder,input::placeholder{color:var(--dim)}
select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:10px 12px;outline:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.05em;cursor:pointer;border:1px solid;transition:all .12s;text-transform:uppercase}
.btn-p{background:var(--accent);color:#0f0f0f;border-color:var(--accent)}
.btn-p:hover{background:#dfbb80}
.btn-p:disabled{opacity:.4;cursor:not-allowed}
.btn-g{background:transparent;color:var(--mid);border-color:var(--border)}
.btn-g:hover{background:var(--surface2);color:var(--text);border-color:var(--border-hi)}
.btn-row{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;align-items:center}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.ctitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:11px}
.ib{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);line-height:1.65;margin-bottom:13px}
.ib.red{border-left-color:var(--red)} .ib.green{border-left-color:var(--green)}
.ib.acc{border-left-color:var(--accent)} .ib.blue{border-left-color:var(--blue)}
.ib.purple{border-left-color:var(--purple)}
.chip{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.06em;padding:3px 8px;border-radius:20px;text-transform:uppercase}
.c-ok{background:rgba(110,201,138,.12);color:var(--green);border:1px solid rgba(110,201,138,.25)}
.c-w{background:rgba(201,169,110,.12);color:var(--accent);border:1px solid rgba(201,169,110,.25)}
.c-err{background:rgba(201,110,110,.12);color:var(--red);border:1px solid rgba(201,110,110,.25)}
.c-blue{background:rgba(110,168,201,.12);color:var(--blue);border:1px solid rgba(110,168,201,.25)}
.c-purple{background:rgba(169,110,201,.12);color:var(--purple);border:1px solid rgba(169,110,201,.25)}
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.diff-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
.diff-grid>div{display:flex;flex-direction:column}
.diff-col{display:flex;flex-direction:column}
.diff-scroll{overflow-y:auto}
.dlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;padding:2px 6px;background:var(--surface2);border-radius:3px;display:inline-block;flex-shrink:0}
.dtext{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.8;white-space:pre-wrap;min-height:200px;width:100%;box-sizing:border-box}
.collapsible-section{margin-bottom:11px}
.collapsible-toggle{display:flex;align-items:center;gap:8px;width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:8px 12px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mid);text-align:left;transition:border-color .14s}
.collapsible-toggle:hover{border-color:var(--border-hi);color:var(--text)}
.collapsible-toggle .ct-icon{flex-shrink:0;transition:transform .2s;font-style:normal}
.collapsible-toggle .ct-label{flex:1}
.collapsible-toggle .ct-count{color:var(--accent);font-weight:600}
.collapsible-body{display:none;padding-top:8px}
.redacted{background:rgba(201,110,110,.18);color:var(--red);border-radius:2px;padding:0 2px}
.bpblock{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 12px;margin-bottom:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);white-space:pre-wrap;line-height:1.6}
.bpblock .bptag{color:var(--accent);font-size:9px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;display:block}
.rl{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:11px;margin-bottom:11px}
.rtitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.rrow{display:flex;align-items:center;gap:7px;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 0;border-bottom:1px solid var(--border)}
.rrow:last-child{border-bottom:none}
.rorig{color:var(--red);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rarr{color:var(--dim);flex-shrink:0}
.rnew{color:var(--green);flex:1}
.rtype{color:var(--dim);font-size:9px;background:var(--surface3);padding:2px 5px;border-radius:3px;white-space:nowrap}
.paper{background:#faf8f3;color:#1a1a1a;border-radius:var(--r);padding:42px 50px;font-family:'Crimson Pro',Georgia,serif;font-size:15.5px;line-height:1.82;white-space:pre-wrap;border:1px solid #d4d0c8;box-shadow:0 4px 40px rgba(0,0,0,.5);max-height:680px;overflow-y:auto}
.tabs{display:flex;gap:4px;margin-bottom:8px}
.tab{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 12px;border-radius:var(--r);border:1px solid var(--border);background:transparent;color:var(--mid);cursor:pointer;transition:all .12s;text-transform:uppercase;letter-spacing:.05em}
.tab.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}
.cc{display:none;position:absolute;top:10px;right:10px;background:var(--green);color:#0f0f0f;font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 10px;border-radius:4px;font-weight:600}
.an{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);display:flex;gap:7px;margin-top:8px;line-height:1.5}
.tok-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.tok-row{display:flex;align-items:center;gap:0;font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 0;border-bottom:1px solid var(--border)}
.tok-row:last-child{border-bottom:none;font-weight:600;color:var(--text)}
.tok-label{flex:1;color:var(--mid)}
.tok-bar-wrap{width:180px;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin:0 12px}
.tok-bar{height:100%;border-radius:3px;transition:width .3s}
.tok-val{width:70px;text-align:right;color:var(--dim)}
.tok-cost{width:90px;text-align:right}
.tok-cached{color:var(--blue);font-size:9px;margin-left:5px}
.tok-total-row{margin-top:12px;padding-top:10px;border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tok-total-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 14px;text-align:center}
.tok-total-box .tlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px}
.tok-total-box .tval{font-family:'JetBrains Mono',monospace;font-size:18px;color:var(--accent);font-weight:500}
.tok-total-box .tsub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:2px}
.tok-cache-note{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);margin-top:10px;line-height:1.6}
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-bottom:14px}
.tpl-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px;cursor:pointer;transition:all .12s;position:relative}
.tpl-card:hover{border-color:var(--border-hi);background:var(--surface3)}
.tpl-card.active-tpl{border-color:var(--accent-d);background:var(--accent-g)}
.tpl-name{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);margin-bottom:4px;font-weight:500}
.tpl-meta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim)}
.tpl-del{position:absolute;top:8px;right:8px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);background:none;border:none;cursor:pointer;padding:2px 5px;border-radius:3px}
.tpl-del:hover{color:var(--red);background:rgba(201,110,110,.1)}
.tpl-cached-badge{display:inline-block;margin-left:4px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--blue);background:rgba(110,168,201,.1);border:1px solid rgba(110,168,201,.2);padding:2px 6px;border-radius:3px}
hr.div{border:none;border-top:1px solid var(--border);margin:18px 0}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:3px}
@media(max-width:640px){.app{grid-template-columns:1fr}aside{display:none}.diff-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">Lettera<span>.</span>AI</div>
  <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);">Generatore Lettera di Dimissione</div>
  <div class="badge" id="statusBadge">‚óè Pronto</div>
</header>

<aside>
  <div class="ns">Flusso</div>
  <button class="ni active" onclick="goTo(0)" id="nav0"><span class="sn">1</span>Testo Clinico</button>
  <button class="ni" onclick="goTo(1)" id="nav1"><span class="sn">2</span>Anonimizzazione</button>
  <button class="ni" onclick="goTo(2)" id="nav2"><span class="sn">3</span>Generazione</button>
  <button class="ni" onclick="goTo(3)" id="nav3"><span class="sn">4</span>Lettera</button>
  <div class="ns" style="margin-top:14px;">Config</div>
  <button class="ni" onclick="goTo(4)" id="nav4"><span class="sn">‚öô</span>Impostazioni</button>
  <button class="ni" onclick="goTo(5)" id="nav5"><span class="sn">üìö</span>Libreria Casi</button>
</aside>

<main>

<!-- ‚ïê‚ïê‚ïê STEP 1 ‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel0">
  <div class="ptitle">Testo Clinico</div>
  <div class="psub">// step 01 ‚Äî carica PDF o incolla il testo</div>
  <div class="ib acc">
    Incolla il testo della cartella o carica il PDF. Le intestazioni (Regione, Azienda, Direttore, metadati paziente, numeri pagina) vengono rimosse automaticamente prima dell'invio al modello.
  </div>
  <div class="card">
    <div class="ctitle">Carica PDF ‚Äî Estrazione Testo Offline</div>
    <div id="pdfDropzone" onclick="document.getElementById('pdfFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:24px 20px;text-align:center;cursor:pointer;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handlePdfDrop(event)">
      <input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="handlePdfFile(event)">
      <div style="font-size:24px;margin-bottom:6px;color:var(--dim);">‚¨Ü</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina il PDF</strong> ‚Äî testo estratto offline, nessun dato trasmesso
      </div>
    </div>
    <div id="pdfStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="pdfSpin" style="display:none;"></span><span id="pdfStatusTxt"></span>
      </div>
      <div style="background:var(--surface3);border-radius:2px;height:3px;margin-top:6px;overflow:hidden;">
        <div id="pdfBar" style="height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .2s;"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ctitle">Carica Referto Laboratorio XLS / XLSX ‚Äî Opzionale</div>
    <div id="xlsDropzone" onclick="document.getElementById('xlsFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handleXlsDrop(event)">
      <input type="file" id="xlsFileInput" accept=".xls,.xlsx,.csv" style="display:none;" onchange="handleXlsFile(event)">
      <div style="font-size:22px;margin-bottom:5px;color:var(--dim);">üìä</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina XLS / XLSX</strong> ‚Äî referto laboratorio
      </div>
    </div>
    <div id="xlsStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="xlsSpin" style="display:none;"></span><span id="xlsStatusTxt"></span>
      </div>
    </div>
    <div id="xlsPreview" style="display:none;margin-top:10px;">
      <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px;">Anteprima valori estratti</div>
      <div id="xlsPreviewContent" style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mid);max-height:200px;overflow-y:auto;white-space:pre-wrap;"></div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="clearXls()">‚úï Rimuovi</button>
      </div>
    </div>
  </div>
  <label>Testo Completo del Paziente</label>
  <textarea id="inp_raw" style="flex:1;min-height:200px;" placeholder="Incolla qui il testo copiato dal PDF...&#10;&#10;Pu√≤ contenere tutto, incluse intestazioni ospedaliere ‚Äî verranno rimosse automaticamente."></textarea>
  <label>Diagnosi Principale</label>
  <input type="text" id="inp_diagnosi" placeholder='Es: "Sospetto minor stroke silviano destro a genesi indeterminata"'>
  <div class="btn-row">
    <button class="btn btn-p" onclick="goToAnon()">Avanti ‚Üí Anonimizza</button>
    <button class="btn btn-g" onclick="clearAll()">‚úï Reset</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 2 ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel1">
  <div class="ptitle">Anonimizzazione</div>
  <div class="psub">// step 02 ‚Äî scegli modalit√† ‚Üí boilerplate strip ‚Üí anonimizza ‚Üí revisiona</div>
  <div class="card">
    <div class="ctitle">Modalit√† Anonimizzazione</div>
  </div>
  <div id="anonStatus" class="card" style="display:flex;align-items:center;gap:10px;padding:12px 14px;">
    <span class="spin" id="anonSpin" style="display:none;"></span>
    <span id="anonStatusTxt" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">Pronto.</span>
  </div>
  <div id="dictStatus" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);padding:4px 2px;">‚è≥ Caricamento dizionario nomi in corso...</div>
  <div class="collapsible-section" id="bpSection" style="display:none;">
    <button class="collapsible-toggle" onclick="toggleSection('bpSection')">
      <i class="ct-icon">‚ñ∂</i>
      <span class="ct-label">‚úÇ Blocchi rimossi ‚Äî <strong style="color:var(--text);">NON inviati al modello</strong></span>
      <span class="ct-count" id="bpCount"></span>
    </button>
    <div class="collapsible-body" id="bpBody">
      <div class="ib acc" style="margin-bottom:8px;">Verifica cosa √® stato eliminato prima di procedere.</div>
      <div id="bpList"></div>
    </div>
  </div>
  <div class="collapsible-section" id="repSection" style="display:none;">
    <button class="collapsible-toggle" onclick="toggleSection('repSection')">
      <i class="ct-icon">‚ñ∂</i>
      <span class="ct-label">üõ° Anonimizzazioni applicate</span>
      <span class="ct-count" id="repCount"></span>
    </button>
    <div class="collapsible-body" id="repBody">
      <div id="repList"></div>
    </div>
  </div>
  <div class="diff-grid">
    <div class="diff-col">
      <div class="dlabel">Testo originale ‚Äî locale, non inviato</div>
      <div class="diff-scroll">
        <div class="dtext" id="origText">‚Äî</div>
      </div>
    </div>
    <div class="diff-col">
      <div class="dlabel">Testo anonimizzato ‚úè modificabile</div>
      <div class="diff-scroll" id="anonScroll">
        <textarea id="anonText" class="dtext" style="font-size:11px;resize:none;height:100%;"></textarea>
      </div>
    </div>
  </div>
  <div class="ib red">‚ö† Verifica il testo a destra. Correggi manualmente qualsiasi dato rimasto prima di procedere.</div>
  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(0)">‚Üê Indietro</button>
    <button class="btn btn-p" onclick="proceedToGenerate()">Avanti ‚Üí Genera</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 3 ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel2">
  <div class="ptitle">Generazione</div>
  <div class="psub">// step 03 ‚Äî stima costo ‚Üí genera</div>
  <div class="card">
    <div class="ctitle">API Key Anthropic</div>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-... (solo in memoria di sessione, mai su disco)">
    <div class="an"><span>‚Ñπ</span><span>Usata solo per questa sessione. Mai salvata. Ottenibile su console.anthropic.com.</span></div>
  </div>
  <div class="card">
    <div class="ctitle">Modello & Temperatura</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label>Modello</label>
        <select id="modelSelect" onchange="updateTokenPanel()">
          <option value="claude-haiku-4-5-20251001">claude-haiku-4-5 ‚Äî economico, veloce</option>
          <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6 ‚Äî migliore qualit√†</option>
        </select>
      </div>
      <div>
        <label>Temperatura ‚Äî <span id="tempLabel">0.1</span></label>
        <input type="range" id="tempSlider" min="0" max="5" value="1" step="1" style="width:100%;accent-color:var(--accent);margin-top:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);display:flex;justify-content:space-between;margin-top:2px;"><span>preciso</span><span>creativo</span></div>
      </div>
    </div>
  </div>
  <div id="ragPreviewGen" style="display:none;" class="card">
    <div class="ctitle">Casi Simili Trovati <span class="chip c-purple" style="margin-left:6px;">RAG auto</span></div>
    <div id="ragMatchesGen"></div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:8px;">Le lettere di questi casi vengono incluse nel prompt come esempi few-shot. Le cartelle restano locali.</div>
  </div>
  <div class="tok-panel" id="tokPanel">
    <div class="ctitle" style="margin-bottom:14px;">
      Stima Token & Costo
      <span id="cacheActiveBadge" class="chip c-blue" style="margin-left:8px;display:none;">‚ö° Cache Attiva</span>
    </div>
    <div id="tokRows"><div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);">Completa gli Step 1‚Äì2 per vedere la stima.</div></div>
  </div>
  <div class="card">
    <div class="ctitle">Prompt di Sistema ‚Äî modificabile</div>
    <textarea id="systemPrompt" rows="8" style="font-size:11px;"></textarea>
  </div>
  <div class="card" id="optimizerCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Ottimizzatore Prompt <span class="chip c-purple" style="margin-left:6px;">AI</span></div>
      <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="toggleOptimizer()">‚ñæ Espandi</button>
    </div>
    <div id="optimizerBody" style="display:none;">
      <div class="ib purple" style="margin-bottom:12px;">
        Analizza la cartella corrente + il prompt attuale e suggerisce: (1) un prompt di sistema migliorato, (2) sezioni mancanti, (3) un addendum specifico per questo caso.
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <label style="display:flex;align-items:center;gap:5px;margin:0;text-transform:none;font-size:11px;cursor:pointer;">
          <input type="checkbox" id="optUseSimilar" checked style="width:auto;accent-color:var(--purple);">
          <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mid);">Confronta con caso simile (RAG)</span>
        </label>
        <label style="display:flex;align-items:center;gap:5px;margin:0;text-transform:none;font-size:11px;cursor:pointer;">
          <input type="checkbox" id="optApplyAddendum" checked style="width:auto;accent-color:var(--purple);">
          <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mid);">Genera addendum user-prompt</span>
        </label>
      </div>
      <button class="btn btn-g" style="border-color:var(--purple);color:var(--purple);" id="optBtn" onclick="runPromptOptimizer()">
        <span id="optSpin" class="spin" style="display:none;border-top-color:var(--purple);"></span>
        ‚ú¶ Analizza &amp; Ottimizza
      </button>
      <div id="optErr" class="ib red" style="display:none;margin-top:10px;"></div>
      <div id="optResults" style="display:none;margin-top:14px;">
        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
          <button class="btn btn-g" style="font-size:10px;padding:4px 10px;" onclick="showOptTab('missing')" id="optTab_missing">‚ö† Sezioni Mancanti</button>
          <button class="btn btn-g" style="font-size:10px;padding:4px 10px;" onclick="showOptTab('improved')" id="optTab_improved">‚ú¶ Prompt Migliorato</button>
          <button class="btn btn-g" style="font-size:10px;padding:4px 10px;" onclick="showOptTab('addendum')" id="optTab_addendum">Ôºã Addendum</button>
        </div>
        <div id="optPane_missing" style="display:none;">
          <div class="ctitle" style="margin-bottom:8px;">Sezioni / Istruzioni Mancanti</div>
          <div id="optMissingText" class="dtext" style="min-height:80px;white-space:pre-wrap;font-size:11px;"></div>
        </div>
        <div id="optPane_improved" style="display:none;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div class="ctitle" style="margin:0;">Prompt di Sistema Suggerito</div>
            <button class="btn btn-p" style="font-size:10px;padding:4px 11px;" onclick="applyImprovedPrompt()">‚úì Applica</button>
          </div>
          <textarea id="optImprovedText" rows="10" style="font-size:11px;" readonly></textarea>
        </div>
        <div id="optPane_addendum" style="display:none;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div class="ctitle" style="margin:0;">Addendum User-Prompt (caso specifico)</div>
            <button class="btn btn-p" style="font-size:10px;padding:4px 11px;" onclick="applyAddendum()">‚úì Aggiungi al Prompt</button>
          </div>
          <textarea id="optAddendumText" rows="6" style="font-size:11px;" readonly></textarea>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:6px;">Verr√† accodato al prompt utente al momento della generazione.</div>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Prompt Completo</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="refreshPrompt()">‚Ü∫ Aggiorna</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyFull()">‚éò Tutto</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyUser()">‚éò Solo User</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabFull"   onclick="showTab('full')">Completo</button>
      <button class="tab"        id="tabSystem" onclick="showTab('system')">System</button>
      <button class="tab"        id="tabUser"   onclick="showTab('user')">User</button>
    </div>
    <div style="position:relative;">
      <textarea id="promptView" readonly rows="12" style="font-size:11px;background:var(--surface2);color:var(--dim);cursor:default;"></textarea>
      <div class="cc" id="copyConfirm">‚úì Copiato!</div>
    </div>
  </div>
  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(1)">‚Üê Indietro</button>
    <button class="btn btn-p" id="genBtn" onclick="generateLetter()">
      <span class="spin" id="genSpin" style="display:none;"></span>
      ‚ú¶ Genera Lettera
    </button>
  </div>
  <div id="genErr" style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);display:none;"></div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 4 ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel3">
  <div class="ptitle">Lettera Generata</div>
  <div class="psub">// step 04 ‚Äî revisiona, stampa, copia</div>
  <div class="ib green">‚úì Sostituisci i placeholder <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[PAZIENTE_NOME]</code>, <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[DATA_NASCITA]</code> ecc. con i dati reali prima di stampare.</div>
  <div id="usageInfo" style="display:none;" class="ib blue"></div>
  <div id="letterOut" class="paper">‚Äî</div>
  <div class="btn-row" style="margin-top:18px;">
    <button class="btn btn-p" onclick="copyLetter()">‚éò Copia testo</button>
    <button class="btn btn-g" onclick="printLetter()">‚éô Stampa / PDF</button>
    <button class="btn btn-g" onclick="newLetter()">‚Ü∫ Nuova lettera</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 5 ‚Äî IMPOSTAZIONI ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel4">
  <div class="ptitle">Impostazioni</div>
  <div class="psub">// config ‚Äî intestazione, firma, regex custom</div>
  <div class="card">
    <div class="ctitle">Intestazione & Firme</div>
    <label>Citt√†</label><input type="text" id="cfg_citta" placeholder="Es: Padova">
    <label>U.O. / Reparto</label><input type="text" id="cfg_reparto" placeholder="Es: U.O. di Neurologia">
    <label>Firma ‚Äî Medico in Formazione Specialistica</label><input type="text" id="cfg_dott" placeholder="Es: Dott. [COGNOME]">
    <label>Firma ‚Äî Dirigente Medico</label><input type="text" id="cfg_prof" placeholder="Es: Prof. [COGNOME]">
  </div>
  <div class="card">
    <div class="ctitle">Pattern Regex Custom</div>
    <div class="ib" style="margin-bottom:10px;">Pattern aggiuntivi in JSON. I pattern base sono gi√† inclusi.</div>
    <textarea id="cfg_regex" rows="5" placeholder='[
  {"pattern": "NHI:\\s*[A-Z]{3}\\d{4}", "replace": "[ID_PAZIENTE]"},
  {"pattern": "cartella\\s*n\\.?\\s*\\d+", "replace": "[CARTELLA]"}
]'></textarea>
  </div>
  <div class="card">
    <div class="ctitle">Sorgenti Dizionario Nomi</div>
    <div class="ib" style="margin-bottom:10px;">URL raw GitHub o altro CDN per i file cognomi/nomi.</div>
    <label>URL Cognomi (testo, uno per riga)</label>
    <input type="text" id="cfg_surnames_url" placeholder="https://raw.githubusercontent.com/...">
    <label>URL Nomi propri (CSV, prima colonna = nome)</label>
    <input type="text" id="cfg_firstnames_url" placeholder="https://raw.githubusercontent.com/...">
    <button class="btn btn-g" style="margin-top:12px;" onclick="reloadNameDictionary()">‚Ü∫ Ricarica dizionario</button>
    <div id="dictStatusSettings" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:8px;"></div>
  </div>
  <div class="card">
    <div class="ctitle">Archiviazione Casi ‚Äî GitHub</div>
    <div class="ib" style="margin-bottom:10px;">Salva la libreria casi come file JSON in un repository GitHub privato. Richiede un Personal Access Token con scope <code>repo</code>. <a href="https://github.com/settings/tokens/new" target="_blank" style="color:var(--accent);">Crea token ‚Üí</a></div>
    <label>Personal Access Token (PAT)</label>
    <input type="password" id="cfg_gh_token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
    <label>Repository (owner/repo)</label>
    <input type="text" id="cfg_gh_repo" placeholder="Es: mariorossi/lettera-ai-cases">
    <label>Percorso file JSON nel repo</label>
    <input type="text" id="cfg_gh_path" placeholder="cases.json" value="cases.json">
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
      <button class="btn btn-g" style="font-size:10px;padding:6px 13px;" onclick="testGitHubConnection()">‚ö° Testa Connessione</button>
      <button class="btn btn-g" style="font-size:10px;padding:6px 13px;" onclick="syncLibraryToGitHub()">‚Üë Push Libreria</button>
      <button class="btn btn-g" style="font-size:10px;padding:6px 13px;" onclick="pullLibraryFromGitHub()">‚Üì Pull Libreria</button>
    </div>
    <div id="ghStatus" style="font-family:'JetBrains Mono',monospace;font-size:10px;margin-top:8px;color:var(--dim);"></div>
  </div>
  <div class="btn-row">
    <button class="btn btn-p" onclick="saveBaseSettings()">‚úì Salva</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 6 ‚Äî LIBRERIA ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel5">
  <div class="ptitle">Libreria Casi</div>
  <div class="psub">// casi clinici precedenti ‚Äî RAG + fingerprint + caching</div>
  <div class="ib blue">
    <strong style="color:var(--text);">Come funziona:</strong> ogni caso memorizza la cartella anonimizzata (usata localmente per TF-IDF), la lettera generata (iniettata come few-shot), e un fingerprint stilistico compresso (cacheable). I 1‚Äì2 casi pi√π simili vengono recuperati automaticamente. Solo le <em>lettere</em>, non le cartelle, vengono inviate al modello.
  </div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Casi Salvati</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);" id="libStats"></div>
        <label style="display:flex;align-items:center;gap:6px;margin:0;text-transform:none;font-size:11px;cursor:pointer;">
          <input type="checkbox" id="ragToggle" checked style="width:auto;accent-color:var(--blue);">
          <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);">RAG auto</span>
        </label>
      </div>
    </div>
    <div id="tplGrid" class="tpl-grid"></div>
    <div id="noTplMsg" class="ib" style="margin:0;">Nessun caso ancora. Aggiungine uno qui sotto.</div>
  </div>
  <div id="ragPreview" style="display:none;" class="card">
    <div class="ctitle">Casi Recuperati <span class="chip c-blue" style="margin-left:6px;">RAG</span></div>
    <div id="ragMatches"></div>
  </div>
  <div class="card">
    <div class="ctitle">Aggiungi Caso</div>
    <label>Nome / Etichetta Caso</label>
    <input type="text" id="newTplName" placeholder='Es: "Neurologia ‚Äî Stroke ischemico"'>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;margin-top:16px;">
      <label style="margin:0;">Cartella Clinica Anonimizzata <span style="color:var(--dim);font-size:9px;text-transform:none;letter-spacing:0;">(solo locale per RAG)</span></label>
      <button class="btn btn-g" style="font-size:9px;padding:3px 9px;" onclick="autoFillCaseFolder()">‚ü≥ Da sessione</button>
    </div>
    <textarea id="newCaseFolder" rows="8" placeholder="Incolla la cartella anonimizzata..."></textarea>
    <label>Lettera di Dimissione Corrispondente <span style="color:var(--dim);font-size:9px;text-transform:none;letter-spacing:0;">(inviata come few-shot)</span></label>
    <textarea id="newCaseLetter" rows="8" placeholder="Incolla la lettera gi√† generata e revisionata..."></textarea>
    <div class="btn-row" style="margin-top:12px;">
      <button class="btn btn-g" onclick="autoExtractTemplate()">
        <span class="spin" id="tplExtSpin" style="display:none;"></span>
        ‚ú¶ Auto-estrai fingerprint
      </button>
      <button class="btn btn-p" onclick="saveNewTemplate()">‚úì Salva Caso</button>
    </div>
    <div id="tplExtStatus" style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);display:none;"></div>
    <div id="newTplSections" style="margin-top:10px;"></div>
  </div>
</div>

</main>
</div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRICING = {
  'claude-sonnet-4-6':        { in:3.00,  in_cache_write:3.75, in_cache_read:0.30, out:15.00 },
  'claude-haiku-4-5-20251001':{ in:0.80,  in_cache_write:1.00, in_cache_read:0.08, out:4.00  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S    = { rawText:'', cleanText:'', anonText:'', letter:'', strippedBlocks:[], activeTemplateId:null };
const S_XLS = { text:'', filename:'' };
let newTplSections = [];

const DEFAULT_SYS = `Sei un assistente esperto in documentazione medica ospedaliera italiana.
Genera una lettera di dimissione strutturata in italiano formale clinico.

REGOLE ASSOLUTE:
- NON inventare, inferire o aggiungere dati clinici non presenti nell'input.
- NON aggiungere diagnosi, valori di laboratorio, farmaci, dosi o date non esplicitamente forniti.
- Se una sezione manca, scrivi: "Non documentato."
- NON usare nomi di pazienti, medici, ospedali o qualsiasi identificativo personale.
- USA ESCLUSIVAMENTE passato remoto o imperfetto per eventi durante il ricovero. MAI il passato prossimo (ha eseguito ‚Üí esegu√¨ / venne eseguito; √® stata avviata ‚Üí venne avviata / fu avviata; √® stato ricoverato ‚Üí venne ricoverato; ha presentato ‚Üí present√≤; √® stato sottoposto ‚Üí venne sottoposto). Regola: se puoi scrivere "venne" o "fu" al posto di "√® stato/√® stata", fallo sempre.
- Mantieni il registro formale della medicina clinica italiana.
- Segui esattamente la struttura del template fornito.
- Restituisci SOLO la lettera, senza preamboli o commenti.

ACCERTAMENTI STRUMENTALI:
- Per ogni accertamento riporta la data tra parentesi nel formato (DD/MM/YYYY). Esempio: "ECG (22/02/2026): Fibrillazione atriale..."
- Per esami ancora in corso di refertazione al momento della dimissione scrivi esattamente: "(referto in corso di completamento)"
- Non omettere mai la data di un accertamento se presente nell'input.

ESAME OBIETTIVO NEUROLOGICO (EON):
- Trascrivi la formula neurologica verbatim dall'input senza riformulare. Non sintetizzare, non accorciare.
- Includi sempre NIHSS e mRS se presenti.
- Formula standard: "paziente vigile, orientato, collaborante. Esegue ordini semplici. Eloquio... nervi cranici... Mingazzini I e II... NIHSS:X. mRS X."

TERAPIA DOMICILIARE:
- Formato: lista inline separata da virgole con nome commerciale + dosaggio. Esempio: "Bisoprololo 2,5 mg, Ramipril 5 mg, ..."
- Includi allergie immediatamente dopo la terapia domiciliare se presenti.

TERAPIA ALLA DIMISSIONE ‚Äî TABELLA MARKDOWN:
Usa obbligatoriamente una tabella a 4 colonne:
| Farmaco | Posologia | Orari | Note |
|---------|-----------|-------|------|
- Colonna "Farmaco": nome commerciale + formulazione (es. "Apixaban 2,5 mg cpr")
- Colonna "Posologia": numero di unit√† e via (es. "1 cp os")
- Colonna "Orari": orari di somministrazione (es. "8.00 - 20.00")
- Colonna "Note": una tra ‚Äî "terapia domiciliare" / "nuova terapia" / "dose modificata" / "fino al GG/MM poi stop" / "sospeso"
- Ordina per orario di somministrazione mattutino.

SWITCH TERAPEUTICI:
- Se un farmaco √® stato sostituito durante il ricovero, mantieni nel decorso la motivazione clinica esplicita (es. "in considerazione dell'eziologia cardioembolica...").
- Nella tabella riporta solo la terapia attiva alla dimissione.`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(i) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  document.getElementById('panel'+i).classList.add('active');
  document.getElementById('nav'+i).classList.add('active');
  if (i === 1) requestAnimationFrame(updateDiffHeight);
  if (i===2) updateTokenPanel();
  if (i===5) renderLibrary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANON_CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ANON_CONFIG = {
  regexRules: [
    { pattern: /\b[A-Z]{6}\d{2}[A-EHLMPRST]\d{2}[A-Z]\d{3}[A-Z]\b/g,
      label: '[CODICE_FISCALE]', type: 'id' },
    { pattern: /\bRIC_AO_\d{6,12}\b/g, label: '[ID_EPISODIO]', type: 'id' },
    { pattern: /\b(?:Nosografico|Ref\.?\s*SSI|Ric\/Ref|Ref\.|ASSIPCA|Num\.\s*(?:interno|esterno)|N\.\s*Richiesta)\s*:?\s*[\d\/\-A-Z_]+/gi,
      label: '[ID_INTERNO]', type: 'id' },
    { pattern: /\b\d\/\d{4}\/\d{4,6}\b/g, label: '[ID_RICOVERO]', type: 'id' },
    { pattern: /(?:nato\/a?\s+il|d\.n\.|Data\s+(?:di\s+)?[Nn]ascita\s*:?)\s*\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}/gi,
      label: '[DATA_NASCITA]', type: 'date' },
    { pattern: /\[PAZIENTE\][^\n]{0,50}?:\s*(\d{2}[\/\.]\d{2}[\/\.]\d{4})/g,
      label: '[PAZIENTE]: [DATA_NASCITA]', type: 'date' },
    { pattern: /\bDN\s+\d{2}[\/\.]\d{2}[\/\.]\d{4}\b/gi,
      label: '[DATA_NASCITA]', type: 'date' },
    { pattern: /\(d\.n\.\d{2}\/\d{2}\/\d{4}\)/gi,
      label: '[DATA_NASCITA]', type: 'date' },
    { pattern: /\bNato\/a?\s+il:?\s*\d{2}\/\d{2}\/\d{4}\b/gi,
      label: '[DATA_NASCITA]', type: 'date' },
    { pattern: /di\s+anni\s+\d{1,3}\s+\(D\.?N\.?\s+\d{2}[\/\.]\d{2}[\/\.]\d{4}\)/gi,
      label: '[ETA_DN]', type: 'date' },
    { pattern: /di\s+anni\s+\d{1,3}\s+\(d\.n\.\d{2}\/\d{2}\/\d{4}\)/gi,
      label: '[ETA_DN]', type: 'date' },
    { pattern: /\(n[\s.]+\s*\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}\)/gi,
      label: '([DATA_NASCITA])', type: 'date' },
    { pattern: /Episodio\s+RIC_AO_\S+\s+[A-Z]+\s+[A-Z]+\s+nato\/a\s+il\s+[\d\/]+/gi,
      label: '[INTESTAZIONE_EPISODIO]', type: 'boiler' },
    { pattern: /(?:^|\r?\n)\s*(?:Paziente|Intestatario|Nominativo)\s*:\s*(?!(?:Nato|Data|Sesso|Cod|RIC|vigile|orientato|deceduto)\b)[A-Z][a-z\u00C0-\u00FF]+(?:\s+(?!(?:Nato|Data|Sesso|Cod|RIC)\b)[A-Z][a-z\u00C0-\u00FF]+)?/gm,
      label: '[PAZIENTE]', type: 'name' },
    { pattern: /(?<=dimettiamo\s+in\s+data\s+odierna\s+(?:il\s+Sig\.?ra?\.?\s+|la\s+Sig\.?ra\.?\s+))[A-Z][a-zA-Z\u00C0-\u00FF]+(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)?(?=\s*,)/gi,
      label: '[PAZIENTE]', type: 'name' },
    { pattern: /\bil\s+(?:[Ss]ig\.(?:ra)?|[Pp]aziente)\s+([A-Z][a-zA-Z\u00C0-\u00FF]+(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)?)/g,
      label: 'il sig. [PAZIENTE]', type: 'name' },
    { pattern: /\bla\s+[Ss]ig\.?ra\.?\s+([A-Z][a-zA-Z\u00C0-\u00FF]+)/g,
      label: 'la sig.ra [PAZIENTE]', type: 'name' },
    { pattern: /\b[A-Za-z0-9._%+\-]+@[A-Za-z0-9.\-]+\.[A-Za-z]{2,}\b/g,
      label: '[EMAIL]', type: 'id' },
    { pattern: /(?:Tel(?:efono)?\s*\d*|Fax)\.?\s*:?\s*\+?\d[\d\s\.\-]{6,}/gi,
      label: '[TELEFONO]', type: 'id' },
    { pattern: /\b3\d{2}[\s\-]?\d{3,4}[\s\-]?\d{3,4}\b/g,
      label: '[TELEFONO]', type: 'id' },
    { pattern: /(?:Telefono\s*\d*\s*:)\s*\d{5,9}\b/gi,
      label: '[TELEFONO]', type: 'id' },
    { pattern: /\bSSN\s*:?\s*\d{6,12}\b/gi,
      label: '[SSN]', type: 'id' },
    { pattern: /Indirizzo\s+(?:domicilio|residenza)\s*:?\s*[^\n\r]+/gi,
      label: '[INDIRIZZO_PAZIENTE]', type: 'boiler' },
    { pattern: /\b(?:VIA|VIALE|CORSO|PIAZZA|LARGO|VICOLO|STRADA)\s+[A-Z][A-Z\s]+\d+(?:\s+[A-Z][A-Z\s]+)?/g,
      label: '[INDIRIZZO_PAZIENTE]', type: 'boiler' },
    // ALL CAPS patient name before Paziente: keyword
    { pattern: /(?:Paziente|Intestatario|Nominativo)\s*:\s*[A-Z]{2,}(?:\s+[A-Z]{2,})?/g,
      label: '[PAZIENTE]', type: 'name' },
    { pattern: /\(?(?:Nato\s+il|nato\s+in\s+data|nato\/a?\s+il|n\.\s*|n\s+\.\s*|Data\s+di\s+nascita|D\.?N\.?)\s*:?\s*\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}\)?/gi,
      label: '[DATA_NASCITA]', type: 'date' },
    { pattern: /Nosologico\s*:?\s*[\w\-\/]*/gi,
      label: '[NOSOLOGICO]', type: 'boiler' },
    { pattern: /\bRIC_AO_\d+\b/g,
      label: '[ID_RICOVERO]', type: 'id' },
    { pattern: /(?:MMG|PLS)(?:\s*\/\s*(?:MMG|PLS))?\s*:?\s*[A-Z][A-Za-z\u00C0-\u00FF]+(?:\s+[A-Z][A-Za-z\u00C0-\u00FF]+)?(?=\s{2,}|\s*[\r\n]|\s+(?:Data|Telefono|Indirizzo|Nosologico|Anamnesi|Reparto|Ricovero|[A-Z][a-z]))/g,
      label: 'MMG/PLS: [OPERATORE]', type: 'name' },
    { pattern: /\b[A-Z][a-z\u00C0-\u00FF]+\s+[A-Z][a-z\u00C0-\u00FF]+(?=\s+\(\d{2}\/\d{2}\/\d{4})/g,
      label: '[OPERATORE]', type: 'name' },
    { pattern: /\b[A-Z][a-z\u00C0-\u00FF]+(?:\s+[A-Z][a-z\u00C0-\u00FF]+){1,2}(?=\s*[MIFRmifr][A-Za-z]|\s+[MIFRmifr]\s+[A-Za-z])/g,
      label: '[OPERATORE]', type: 'name' },
    { pattern: /\b[A-Za-z\u00C0-\u00FF][a-zA-Z\u00C0-\u00FF]{1,}(?:\s+[A-Za-z\u00C0-\u00FF][a-zA-Z\u00C0-\u00FF]{1,}){0,2}(?=\s+(?:Coniuge|Figlio|Figlia|Fratello|Sorella|Genitore|Amico|Convivente|Nipote))/g,
      label: '[CONTATTO]', type: 'name' },
    { pattern: /(?:Coniuge|Figlio|Figlia|Fratello|Sorella|Genitore|Convivente|Nipote)\s+Sconosciuto[^\n]*/gi,
      label: '[RELAZIONE_FAMILIARE]', type: 'boiler' },
    { pattern: /(?:Certificato\s+n\.|SGQ\s+UNI.*?Certiquality)[^\n]*/gi,
      label: '[CERTIFICAZIONE]', type: 'boiler' },
    { pattern: /(?:ID\s+paziente|ID\s+Persona)\s*:?\s*\d+/gi,
      label: '[ID_PAZIENTE]', type: 'id' },
    { pattern: /(?:Documento|Referto|Lettera di dimissione)\s+[Ff]irmato\s+digitalmente\s+(?:da|il)[^\n]*/g,
      label: '[FIRMA_DIGITALE]', type: 'boiler' },
    { pattern: /[Ff]irmatario\s*:\s*\S+\s+\S+\s+Codice\s+Fiscale\s*:[^\n]*/g,
      label: '[FIRMA_DIGITALE]', type: 'boiler' },
    { pattern: /Firmato\s+il[:\s]+[\d\/]+\s+Ora[:\s]+[\d:\.]+[^\n]*/g,
      label: '[FIRMA_DIGITALE]', type: 'boiler' },
    { pattern: /Il\s+referto\s+√®\s+conservato\s+secondo\s+la\s+normativa[^\n]*/gi,
      label: '[CONSERVAZIONE]', type: 'boiler' },
    { pattern: /Copia\s+di\s+(?:documento|referto)\s+firmato\s+e\s+conservato[^\n]*/gi,
      label: '[CONSERVAZIONE]', type: 'boiler' },
    { pattern: /Rappresentazione\s+di\s+un\s+referto\s+firmato\s+elettronicamente[^\n]*/gi,
      label: '[CONSERVAZIONE]', type: 'boiler' },
    { pattern: /Pag(?:ina)?\.?\s*\d+\s*(?:di|\/)\s*\d+/gi,
      label: '[PAGINA]', type: 'boiler' },
    { pattern: /Data\s+stampa\s*:\s*[\d\/]+\s+[\d:]+/gi,
      label: '[DATA_STAMPA]', type: 'boiler' },
    { pattern: /Versione\s+Referto\s*:\s*\d+/gi, label: '[VERSIONE]', type: 'boiler' },
    { pattern: /Versione\s+\d+\s+CC\s*:\s*[NY]/gi, label: '[VERSIONE]', type: 'boiler' },
    { pattern: /(?:Num\.\s*(?:interno|esterno)|Documento\s+Numero)\s*:?\s*[\d\-\/]+/gi,
      label: '[NUM_DOCUMENTO]', type: 'boiler' },
    { pattern: /INFORMAZIONE\s+AI\s+SENSI\s+DELLA\s+DELIBERAZIONE[^\n]*/gi,
      label: '[INFO_DELIBERAZIONE]', type: 'boiler' },
    { pattern: /Gentile\s+signore\/signora\s+desideriamo[^\n]*/gi,
      label: '[INFO_COSTO]', type: 'boiler' },
    { pattern: /un\s+impiego\s+di\s+risorse\s+economiche[^\n]*/gi,
      label: '[INFO_COSTO]', type: 'boiler' },
    { pattern: /pari\s+ad\s+euro\s+[\d\.,]+/gi, label: '[COSTO_SSR]', type: 'boiler' },
    { pattern: /(?:Prelievo\s+del|Ricevuto\s+il|Riferimento)\s*:\s*[\d\/\s:]+/gi,
      label: '[DATI_PRELIEVO]', type: 'boiler' },
    { pattern: /Ric\/Ref\s*:\s*[\d\/\-\w]+/gi, label: '[RIC_REF]', type: 'boiler' },
    { pattern: /SARANNO\s+DISPONIBILI\s+ULTERIORI\s+REFERTI[^\n]*/gi,
      label: '[NOTA_REFERTO]', type: 'boiler' },
    { pattern: /Note\s+dal\s+richiedente\s*:\s*RICHIESTA\s+URGENTE/gi,
      label: '[RICHIESTA_URGENTE]', type: 'boiler' },
    { pattern: /Al\s+Medico\s+Curante\s*:\s*\S+\s+\S+/gi,
      label: 'Al Medico Curante: [PAZIENTE]', type: 'name' },
    { pattern: /Provenienza\s*:\s*[^\n]+/gi, label: '[PROVENIENZA]', type: 'boiler' },
    { pattern: /Medico\s+[Rr]ichiedente\s*:\s*[A-Z][a-z\u00C0-\u00FF][a-zA-Z\u00C0-\u00FF]*(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)*/g,
      label: 'Medico richiedente: [OPERATORE]', type: 'name' },
    { pattern: /Medico\s+[Rr]efertante\s*:\s*[A-Z][a-z\u00C0-\u00FF][a-zA-Z\u00C0-\u00FF]*(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)*/g,
      label: 'Medico refertante: [OPERATORE]', type: 'name' },
    { pattern: /Refertato\s+da\s*:\s*(?:Dott\.(?:ssa\.?)?\s+|Dr\.(?:ssa\.?)?\s+)?[A-Z][a-z\u00C0-\u00FF][a-zA-Z\u00C0-\u00FF]*(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)*/g,
      label: 'Refertato da: [OPERATORE]', type: 'name' },
    { pattern: /Responsabile(?:\s+[A-Za-z]+)?\s*:\s*(?:Dr\.?(?:ssa\.?)?|Prof\.?(?:ssa\.?)?)\s*[A-Z][a-zA-Z\u00C0-\u00FF]+(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)*/gi,
      label: 'Responsabile: [OPERATORE]', type: 'name' },
    { pattern: /Operatore\s*:\s*[A-Z][a-z\u00C0-\u00FF][a-zA-Z\u00C0-\u00FF]*(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)*/g,
      label: 'Operatore: [OPERATORE]', type: 'name' },
    { pattern: /Richiesta\s+in\s+data\s*:\s*[\d\/\s:]+(?:per\s+il[\d\/\s:]+)?/gi,
      label: 'Richiesta in data: [DATA]', type: 'boiler' },
    { pattern: /Azienda\s+Ospedale\s*-\s*Universit\u00e0\s+Padova\s*:\s*Via[^\n]+/gi,
      label: '[INDIRIZZO_AZ]', type: 'boiler' },
    { pattern: /Via\s+[A-Z][a-z]+\s+[A-Z][a-z]+(?:ini)?\s+\d+[^\n]*/gi,
      label: '[INDIRIZZO]', type: 'boiler' },
    { pattern: /C\.F\.\s+P\.IVA\s+\d{11}/gi, label: '[CF_PIVA_AZ]', type: 'boiler' },
    // ‚îÄ‚îÄ LAB HEADER ‚Äî protect "Costituente Risultato Unita'" line ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { pattern: /^Costituente\s+Risultato\s+Unit[^\n]*/gm,
      label: '[INTESTAZIONE_LAB]', type: 'boiler' },
    // ‚îÄ‚îÄ LAB NOTES ‚Äî protect clinical comments in lab blocks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { pattern: /^(?:alterata\s+a\s+digiuno|gravidanza)\s*:[^\n]*/gim,
      label: '[NOTA_LAB]', type: 'boiler' },
    { pattern: /Obiettivo\s+terapeutico\s*:\s*[\d,\.]+/gi,
      label: '[OBIETTIVO_TERAPEUTICO]', type: 'boiler' },
    { pattern: /^Commento\s*:\s*[^\n]+/gim,
      label: '[COMMENTO_LAB]', type: 'boiler' },
    // ECG metadata
    { pattern: /\b[A-Z]{2,}(?:\s+[A-Z]{2,})+(?=\s+(?:Et√†|Sesso|Nome|Cognome)\s*:)/g,
      label: '[PAZIENTE]', type: 'name' },
    { pattern: /\d{4}\s+[A-Z]{2,}(?:\s+[A-Z]{2,})+(?=\s+(?:Et√†|Sesso|Nome|Cognome))/g,
      label: '[DATA_NASCITA] [PAZIENTE]', type: 'name' },
    { pattern: /(?:Nome|Cognome)\s*:\s*[A-Z][A-Za-z\u00C0-\u00FF]+/g,
      label: '[PAZIENTE]', type: 'name' },
    { pattern: /\b[A-Z]{2,}(?:\s+[A-Z]{2,})+(?=\s+Et[√†a]\s*:)/g,
      label: '[PAZIENTE]', type: 'name' },
    { pattern: /\b\d{2}[\/\.]\d{2}[\/\.]\d{4}(?=\s+(?:Maschio|Femmina|M\b|F\b))/g,
      label: '[DATA_NASCITA]', type: 'date' },
    // ALL CAPS full name on own line ‚Äî excludes clinical locations and exam section labels
    { pattern: /^(?!(?:STROKE\s+UNIT|PRONTO\s+SOCCORSO|CLINICA\s+NEUROLOGICA|CLINICA\s+NEUROLOG|UNITA\s+STROKE|STROKE\s+UNIT\s+[-‚Äì]|ESAME\s+NEUROLOGICO|ESAME\s+OBIETTIVO|ESAME\s+OBBIETTIVO|ANAMNESI\s+PATOLOGICA|ANAMNESI\s+FISIOLOGICA|DECORSO\s+CLINICO|TERAPIA\s+DOMICILIARE|TERAPIA\s+ALLA|MOTIVO\s+DEL\s+RICOVERO|ACCERTAMENTI\s+STRUMENTALI|VALUTAZIONI\s+SPECIALISTICHE|ESAMI\s+DI\s+LABORATORIO|FOLLOW[\s\-]UP))[A-Z]{2,}(?:\s+[A-Z]{2,})+$/gm,
      label: '[OPERATORE]', type: 'name' },
    // ‚îÄ‚îÄ PATCHED: ALL CAPS single word ‚Äî expanded exclusion list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    { pattern: /^(?!(?:STROKE|URGENTE|ORDINARIO|AMBULATORIALE|DIAGNOSI|REPARTO|COGNOME|NOME|SESSO|DATA|INTERVENTO|PRIMO|SECONDO|ANESTESISTA|INFERMIERE|TECNICO|CHIRURGO|OPERATORE|GLUCOSIO|UREA|CREATININA|SODIO|POTASSIO|CLORO|CALCIO|FOSFATO|ALBUMINA|BILIRUBINA|TOTALE|CONIUGATA|INORGANICO|INORGANICA|URICO|ACIDO|PROTROMBINA|TROMBINA|FIBRINOGENO|FERRITINA|TRANSFERRINA|COLESTEROLO|TRIGLICERIDI|EMOGLOBINA|EMATOCRITO|PIASTRINE|LEUCOCITI|ERITROCITI|BASOFILI|EOSINOFILI|NEUTROFILI|LINFOCITI|MONOCITI|TROPONINA|PROCALCITONINA|SIDEREMIA|PROTEINURIA|MICROALBUMINURIA|CISTATINA|COSTITUENTE|RISULTATO|RIFERIMENTO|PRECEDENTE|INTERVALLO|METODO|CAMPIONE|COMMENTO|OBIETTIVO|NORMALIZZATO|BIOCHIMICI|BIOCHIMICHE|EMATOLOGICI|EMATOLOGICHE|COAGULAZIONE|SIEROLOGIA|IMMUNOLOGIA|ELETTROLITI|COSTITUENTI|URINE|LIQUOR|REATTIVA|CREATINCHINASI|DEIDROGENASI|LATTATO|LIPASI|AMILASI|FOSFATASI|TRANSAMINASI|GLICEMIA|INSULINA|CORTISOLO|PARATORMONE|COMPLEMENTO|ANTICORPI|ANTIGENE|SIEREMIA|VITAMINA|FOLATI|OMOCISTEINA|OSMOLALITA|CLEARANCE|BICARBONATO|MAGNESIO|ZINCO)$)[A-Z]{5,}$/gm,
      label: '[PAZIENTE]', type: 'name' },
    // ALL CAPS name + date
    { pattern: /\b[A-Z]{2,}(?:\s+[A-Z]{2,})+(?=\s+(?:\d{2}[\/\.]\d{2}[\/\.]\d{4}|\())/g,
      label: '[PAZIENTE]', type: 'name' },
    // Signature blocks
    { pattern: /(?:Dott\.(?:ssa\.?)?|Dr\.(?:ssa\.?)?|Prof\.?(?:ssa\.?)?|prof\.?(?:ssa\.?)?|dott\.(?:ssa\.?)?|dr\.(?:ssa\.?)?)\s+(?:[A-Z]\.\s*){0,4}[A-Z][a-zA-Z\u00C0-\u00FF]+(?:\s+(?!(?:Dott|Dr|Prof|prof|dott|dr)\.)[A-Z][a-zA-Z\u00C0-\u00FF]+)*/g,
      label: '[OPERATORE]', type: 'name' },
    { pattern: /\bD\.\s+[A-Z][a-zA-Z\u00C0-\u00FF]{2,}(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)+/g,
      label: '[OPERATORE]', type: 'name' },
    { pattern: /firm(?:ata?|ato)(?:\s+digitalmente)?\s+da:?\s+[A-Z][a-zA-Z\u00C0-\u00FF]+(?:\s+[A-Z][a-zA-Z\u00C0-\u00FF]+)+/gi,
      label: 'firmata da [OPERATORE]', type: 'name' },
    { pattern: /Lettera\s+di\s+dimissione\s+firm(?:ata?|ato)[^\n]*/gi,
      label: '[FIRMA_DIMISSIONE]', type: 'boiler' },
    { pattern: /\d{5}\s+Padova\s*-\s*Ospedale[^\n]*/gi,
      label: '[INTESTAZIONE_AZ]', type: 'boiler' },
    { pattern: /^Episodio\s+[A-Z0-9_\-]+\s+[A-Z]+\s+[A-Z]+\s+[\d\/]+$/gim,
      label: '[INTESTAZIONE_EPISODIO]', type: 'boiler' },
    { pattern: /Data\s+nota\s+Nota\s+P\s+OperatoreData\s+ins\.?/gi,
      label: '[INTESTAZIONE_COLONNE]', type: 'boiler' },
    { pattern: /049\.821\.\d{4}(?:[^\n]*Prenotazioni[^\n]*)?/g,
      label: '[TELEFONO_AZ]', type: 'boiler' },
    { pattern: /^Pag\.\s+\d{3}$/gim,
      label: '[PAGINA_LAB]', type: 'boiler' },
    { pattern: /\d+Page\s+\d+\s+of\s+\d+/gi,
      label: '[PAGINA]', type: 'boiler' },
    { pattern: /FINE\s+DOCUMENTO\s*[-‚Äì]\s*PAGINA\s+FINALE/gi,
      label: '[FINE_DOCUMENTO]', type: 'boiler' },
    // Cap pair before date ‚Äî exclude clinical locations and exam labels
    { pattern: /\b(?!(?:Stroke\s+Unit|Pronto\s+Soccorso|Clinica\s+Neurologica|Esame\s+Neurologico|Esame\s+Obiettivo|Esame\s+Obbiettivo|Anamnesi\s+Patologica|Anamnesi\s+Fisiologica|Decorso\s+Clinico|Reparto\s+Neurologia|Unita\s+Stroke|Pronto\s+Soc)\b)[A-Z][a-z\u00C0-\u00FF]+\s+[A-Z][a-z\u00C0-\u00FF]+(?=\s+\(\d{2}\/\d{2}\/\d{4})/g,
      label: '[OPERATORE]', type: 'name' },
    { pattern: /\[NOME\]\s*\(\d{2}\/\d{2}\/\d{4}\s+[\d:]+\)/g,
      label: '[OPERATORE_FARMACO]', type: 'boiler' },
    { pattern: /^\(S\)\s+[A-Z][A-Z\s\d\.\*]+$/gim,
      label: '[CONFERMA_FARMACO]', type: 'boiler' },
    { pattern: /(?:anni\s+\d{1,3}|Sesso:\s*[MF]|C\.F\.:|nato\s+il)[^\n]{0,15}(\d{2}[\/\.]\d{2}[\/\.]\d{4})/gi,
      label: '[DATI_PAZIENTE]', type: 'date' },
    { pattern: /Frequenza\s+campionamento[^\n]*/gi,
      label: '[METADATI_ECG]', type: 'boiler' },
    { pattern: /Device:\s*[A-Za-z]+[^\n]*/gi,
      label: '[METADATI_ECG]', type: 'boiler' },
    { pattern: /\b[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]\b/g,
      label: '[CODICE_FISCALE]', type: 'id' },
    { pattern: /C\.?F\.?\s*:\s*[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]/g,
      label: '[CODICE_FISCALE]', type: 'id' },
    { pattern: /\([A-Z][a-z\u00C0-\u00FF]+(?:\s+[A-Z][a-z\u00C0-\u00FF]+){1,2}\)/g,
      label: '([OPERATORE])', type: 'name' },
  ],

  nameDict_fallback: [
    'Marcolin','Marianno','MARCOLIN','MARIANNO',
    'Baracchini','Cavatorti','Favaretto','Ragone','Minicuci','Petrosino',
    'Fredianelli','Mozzetta','Pieroni','Fabris','Viaro','Rubino',
    'Biscari','Filosa','Calore','Tommasin','Cuzzilla','Lorioni',
    'Formentin','Nuzzo','Venuto','Pernice','Montagnana','Fogar',
    'Faggian','Cattai','Carraro','Manara','Librizzi','Mazzi','Rigato',
    'Muffatto','Camporese','Corrado','Baritussio','Bauce','Brunello',
    'Caforio','Cecchetto','Famoso','Fraccaro','Giordani','Schiavon',
    'Piccione','Bettio','Santoro','Caldon','Cernaz','Palermo',
    'Acerbi','Campagnolo','Raccanello','Antonini','Rozzi','Boschini',
    'Bolgan','Bolgon',
    'Amedeo','Marta','Sofia','Angelo','Martina','Laura',
    'Giovanni','Maria','Giuseppe','Anna','Antonio','Rosa','Mario','Lucia',
    'Francesco','Teresa','Luigi','Carmela','Salvatore','Angela','Sergio',
    'Giovanna','Roberto','Giuseppina','Pietro','Caterina','Carlo','Concetta',
    'Stefano','Paola','Claudio','Sandra','Maurizio','Giulia','Luca','Elena',
    'Marco','Andrea','Alessandro','Valentina','Simone','Chiara','Davide',
    'Alessandra','Matteo','Sara','Daniele','Federica','Emilio','Carla',
    'Enzo','Ornella','Piero','Roberta','Renato','Patrizia','Giorgio',
    'Cristina','Massimo','Alfredo','Monica','Bruno','Rossana','Diego',
    'Claudia','Renzo','Arianna','Lorenzo','Ilaria','Edoardo','Silvia',
    'Federica','Tiziana','Domenico','Romano','Donato','Francesco',
  ],

  boilerplateLinePatterns: [
    /^Regione\s+(?:del\s+)?[Vv]eneto\s*$/,
    /^REGIONE\s+(?:DEL\s+)?VENETO\s*$/,
    /^AZIENDA\s+OSPEDALE[^\n]*PADOVA\s*$/i,
    /^Didas?\s+Medicina\s+dei\s+Sistemi\s*$/i,
    /^U\.O\.[SC]\.?[DS]?\.\s+\w[\w\s]*/i,
    /^U\.O\.C\b/i,
    /^U\.O\.S\b/i,
    /^Direttore\s*:?\s*/i,
    /^Dr\.?\s*(?:ssa\s*)?[A-Z][\w\s]+$/,
    /^Prof\.?\s*(?:ssa\s*)?[A-Z][\w\s]+$/,
    /^Dirigenti\s+Medici\s*:/i,
    /^Responsabile\s+(?:Laboratorio\s*)?:?\s*Dr/i,
    /^Coordinatore\s*$/i,
    /^Segreteria\s+(?:interni\s*)?:/i,
    /^Lab\.\s+Neurosonologia\s*:/i,
    /^Radiologia\s+Pediatrica\s*:/i,
    /^Piastra\s+Ambulatoriale\s*$/i,
    /^Dipartimento\s+di\s+Scienze\s+Card/i,
    /^Dip\.\s+Didattico[^\n]*/i,
    /^Servizi\s+di\s+Diagnostica\s+Integrata/i,
    /^PARAMETRI\s+VITALI\s*$/i,
    /^PRESCRIZIONE\s+SOMMINISTRAZIONE\s*$/i,
    /^TERAPIA\s+FARMACOLOGICA\s*$/i,
    /^ALLERGIE\s*$/i,
    /^CONSULENZA\s+SPECIALISTICA\s*$/,
    /^FINE\s+DOCUMENTO\s*$/i,
    /^PAGINA\s+FINALE\s*$/i,
    /^Diario\s+clinico\s*$/i,
    /^L'ORARIO\s+DELLE\s+SOMMINISTRAZIONI[^\n]*/i,
    /^QUELLO\s+PRESCRITTO\s+DAL\s+MEDICO\s*$/i,
    /^Legenda\s+vie\s*:/i,
    /^\(P\)\s+Profilo[^\n]*/i,
    /^per\s+il\s+ricovero\s+\d/i,
    /^Padova,?\s+\d{2}\/\d{2}\/\d{4}\s*$/i,
    /^Alla\s+(?:cortese\s+attenzione|[Cc]ortese\s+[Aa]ttenzione)\s+del\s+Medico\s+Curante\s*$/i,
    /^Egregio\s+[Cc]ollega\s*,?\s*$/i,
    /^I\s+risultati\s+di\s+questo\s+referto[^\n]*/i,
    /^parte\s+del\s+(?:Medico\s+)?[Rr]eportage[^\n]*/i,
    /^\*\*\*\s+Referto\s+Finale\s+\*\*\*/i,
    /^Il\s+[Dd]irettore\s*$/i,
    /^Validato\s+da\s*:/i,
    /^Medico\s*:\s*(?:Prof\.|Dr(?:\.ssa)?)?\s*[A-Z]/i,
    /^T\.S\.R\.M\.\s+/i,
    /^Equipe\s*:\s*$/i,
    /^Il\s+Medico\s+Radiologo\s*$/i,
    /^Ringraziando\s+per\s+la\s+cortese\s+collaborazione[^\n]*/i,
    /^rimaniamo\s+ad?\s+disposizione[^\n]*/i,
    /^Dott\.?\s*(?:ssa\.?)?\s+[A-Z]\.\s+[A-Z][a-z]+\s*$/,
    /^\(Medici\s+in\s+formazione\s+specialistica\)\s*$/i,
    /^\(Dirigenti\s+medici\)\s*$/i,
    /^Cordiali\s+saluti\s*,?\s*$/i,
    /^Il\s+medico\s+strutturato\s+Dott\./i,
    /^MFS\s+Dott\.sse?\s+/i,
  ],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAB LINE FREEZE ‚Äî protects analyte lines from name regex
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freezeLabLines(text) {
  const placeholders = [];
  let idx = 0;
  let frozen = text;

  // Freeze P-/B-/U-/C-/S-/E- prefixed lab result lines (e.g. P-GLUCOSIO 4,4 mmol/L)
  frozen = frozen.replace(/^[PBUCSE]-[A-Z].*/gm, (match) => {
    const key = '\x00LAB' + (idx++) + '\x00';
    placeholders.push({ key, value: match });
    return key;
  });

  // Freeze spaced-letter section headers (C O S T I T U E N T I B I O C H I M I C I)
  frozen = frozen.replace(/^(?:[A-Z] ){4,}[A-Z]\s*$/gm, (match) => {
    const key = '\x00LAB' + (idx++) + '\x00';
    placeholders.push({ key, value: match });
    return key;
  });

  // Freeze "Costituente Risultato Unita'" header line
  frozen = frozen.replace(/^Costituente\s+Risultato\s+Unit[^\n]*/gm, (match) => {
    const key = '\x00LAB' + (idx++) + '\x00';
    placeholders.push({ key, value: match });
    return key;
  });

  // Freeze bare lab result lines: ALL_CAPS_WORD * numeric unit range
  frozen = frozen.replace(/^[A-Z][A-Z\s\-\/\(\)]{3,}\*?\s+[\d,]+\s+\S+.*$/gm, (match) => {
    // Only freeze if it looks like a lab value (has a number after the name)
    if (/\d/.test(match)) {
      const key = '\x00LAB' + (idx++) + '\x00';
      placeholders.push({ key, value: match });
      return key;
    }
    return match;
  });

  const restore = (s) => {
    let out = s;
    for (const { key, value } of placeholders) {
      out = out.split(key).join(value);
    }
    return out;
  };

  return { frozen, restore };
}

function stripBoilerplate(text) {
  const stripped = [];
  const lines = text.split('\n');
  const cleaned = lines.filter(line => {
    for (const pat of ANON_CONFIG.boilerplateLinePatterns) {
      if (pat.test(line.trim())) {
        const t = line.trim();
        if (t.length > 2 && !stripped.find(b => b.text === t))
          stripped.push({ text: t, tag: 'Boilerplate' });
        return false;
      }
    }
    return true;
  });
  return {
    clean: cleaned.join('\n').replace(/\n{3,}/g, '\n\n').trim(),
    strippedBlocks: stripped,
  };
}

function applyRegex(text) {
  const reps = [];
  let result = text;
  const rules = [...ANON_CONFIG.regexRules];
  try {
    const raw = document.getElementById('cfg_regex').value.trim();
    if (raw) JSON.parse(raw).forEach(cp => {
      rules.push({ pattern: new RegExp(cp.pattern, 'gi'), label: cp.replace, type: 'id' });
    });
  } catch(e) {}
  for (const rule of rules) {
    const re = new RegExp(rule.pattern.source, rule.pattern.flags);
    if (re.global) re.lastIndex = 0;
    result = result.replace(re, (match) => {
      const m = match.trim();
      if (m.length > 1 && !reps.find(r => r.orig === m))
        reps.push({ orig: m, repl: rule.label,
          type: rule.type === 'id'   ? 'ID/Codice'
              : rule.type === 'date' ? 'Data sensibile'
              : rule.type === 'name' ? 'Nome'
              : 'Boilerplate' });
      return rule.label;
    });
  }
  return { text: result, reps };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXTERNAL NAME DICTIONARY + FUZZY ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NAME_SOURCES = {
  firstNames: 'https://raw.githubusercontent.com/mrblasco/genderNamesITA/master/gender_firstnames_ITA.csv',
  surnames:   'https://raw.githubusercontent.com/PaoloSarti/lista_cognomi_italiani/main/cognomi.txt',
};
const NAMES_DB = { firstNames:[], surnames:[], loaded:false, loading:false, error:null };

async function reloadNameDictionary() {
  NAMES_DB.loaded=false; NAMES_DB.loading=false;
  NAMES_DB.firstNames=[]; NAMES_DB.surnames=[];
  bkSurnames=new BKTree(); bkFirstNames=new BKTree();
  const el=document.getElementById('dictStatusSettings');
  if(el) el.textContent='‚è≥ Ricaricamento...';
  await loadNameDictionary();
  const statusEl=document.getElementById('dictStatus');
  if(el&&statusEl) el.textContent=statusEl.textContent;
}

function levenshtein(a,b) {
  const m=a.length,n=b.length;
  if(Math.abs(m-n)>2)return 99;
  if(m===0)return n; if(n===0)return m;
  let prev=Array.from({length:n+1},(_,i)=>i);
  for(let i=1;i<=m;i++){
    const curr=[i];
    for(let j=1;j<=n;j++){
      const cost=a[i-1]===b[j-1]?0:1;
      curr[j]=Math.min(curr[j-1]+1,prev[j]+1,prev[j-1]+cost);
    }
    prev=curr;
  }
  return prev[n];
}

class BKTree {
  constructor(){this.root=null;}
  add(word){
    if(!this.root){this.root={word,children:{}};return;}
    let node=this.root;
    while(true){
      const d=levenshtein(word,node.word);
      if(d===0)return;
      if(node.children[d]){node=node.children[d];}
      else{node.children[d]={word,children:{}};return;}
    }
  }
  search(query,maxDist){
    if(!this.root)return[];
    const results=[],stack=[this.root];
    while(stack.length){
      const node=stack.pop();
      const d=levenshtein(query,node.word);
      if(d<=maxDist)results.push({word:node.word,dist:d});
      for(let k=d-maxDist;k<=d+maxDist;k++)
        if(k>0&&node.children[k])stack.push(node.children[k]);
    }
    return results;
  }
}

let bkSurnames=new BKTree(), bkFirstNames=new BKTree();

async function loadNameDictionary() {
  if(NAMES_DB.loaded||NAMES_DB.loading)return;
  NAMES_DB.loading=true;
  const statusEl=document.getElementById('dictStatus');
  if(statusEl)statusEl.textContent='‚è≥ Caricamento dizionario nomi...';
  const customSurnamesUrl=document.getElementById('cfg_surnames_url')?.value.trim();
  const customFirstNamesUrl=document.getElementById('cfg_firstnames_url')?.value.trim();
  const surnamesUrl=customSurnamesUrl||NAME_SOURCES.surnames;
  const firstNamesUrl=customFirstNamesUrl||NAME_SOURCES.firstNames;
  try{
    const [surnameResp,firstNameResp]=await Promise.all([fetch(surnamesUrl),fetch(firstNamesUrl)]);
    if(surnameResp.ok){
      const text=await surnameResp.text();
      const names=text.split('\n').map(l=>l.trim().toLowerCase()).filter(l=>l.length>=3&&l.length<=30&&/^[a-z√†√®√©√¨√≤√π√§√∂√º'\- ]+$/.test(l));
      NAMES_DB.surnames=names; names.forEach(n=>bkSurnames.add(n));
    }
    if(firstNameResp.ok){
      const text=await firstNameResp.text();
      const lines=text.split('\n').slice(1);
      const names=lines.map(l=>l.split(',')[0].replace(/['"]/g,'').trim().toLowerCase()).filter(n=>n.length>=3&&n.length<=20&&/^[a-z√†√®√©√¨√≤√π√§√∂√º'\- ]+$/.test(n));
      NAMES_DB.firstNames=names; names.forEach(n=>bkFirstNames.add(n));
    }
    NAMES_DB.loaded=true; NAMES_DB.error=null;
    const msg=`‚úì Dizionario: ${NAMES_DB.surnames.length.toLocaleString()} cognomi ¬∑ ${NAMES_DB.firstNames.length.toLocaleString()} nomi`;
    if(statusEl)statusEl.textContent=msg;
    const settingsEl=document.getElementById('dictStatusSettings');
    if(settingsEl)settingsEl.textContent=msg;
  }catch(e){
    NAMES_DB.error=e.message;
    const fb=ANON_CONFIG.nameDict_fallback;
    fb.forEach(n=>{bkSurnames.add(n.toLowerCase());bkFirstNames.add(n.toLowerCase());});
    NAMES_DB.surnames=fb.map(n=>n.toLowerCase());
    NAMES_DB.loaded=true;
    const errMsg=`‚ö† Rete non disponibile ‚Äî dizionario locale (${fb.length} nomi)`;
    if(statusEl)statusEl.textContent=errMsg;
    const settingsEl=document.getElementById('dictStatusSettings');
    if(settingsEl)settingsEl.textContent=errMsg;
  }
  NAMES_DB.loading=false;
}

function isFuzzyName(token,bkTree,maxDist){
  if(token.length<3)return false;
  return bkTree.search(token.toLowerCase(),maxDist).length>0;
}
function fuzzyThreshold(word){return word.length<=5?1:2;}

function applyNameDict(text) {
  if(!NAMES_DB.loaded)return{text,reps:[]};
  const reps=[];
  let result=text;
  const addRep=(orig,type)=>{if(!reps.find(r=>r.orig===orig))reps.push({orig,repl:'[NOME]',type});};

  const exactSurnameSet=new Set(NAMES_DB.surnames);
  const exactFirstSet=new Set(NAMES_DB.firstNames);
  ANON_CONFIG.nameDict_fallback.forEach(n=>{exactSurnameSet.add(n.toLowerCase());exactFirstSet.add(n.toLowerCase());});

  function tokenise(str){
    const tokens=[];
    const re=/\S+/g; let m;
    while((m=re.exec(str))!==null){
      const t=m[0];
      const isCapWord=/^[A-Z√Ä√à√â√å√í√ô][a-z√†√®√©√¨√≤√πA-Z√Ä√à√â√å√í√ô'-]+$/.test(t)||/^[A-Z√Ä√à√â√å√í√ô]{2,}$/.test(t);
      tokens.push({text:t,start:m.index,end:m.index+t.length,isCapWord});
    }
    return tokens;
  }

  function applySpans(str,spans,type){
    spans.sort((a,b)=>a.start-b.start);
    let out='',prev=0;
    for(const s of spans){out+=str.slice(prev,s.start)+'[NOME]';addRep(s.orig,type);prev=s.end;}
    return out+str.slice(prev);
  }

  // Pass 1: exact pairs
  const pass1Spans=[];
  const tokens=tokenise(result);
  for(let i=0;i<tokens.length-1;i++){
    const t1=tokens[i],t2=tokens[i+1];
    if(!t1.isCapWord||!t2.isCapWord)continue;
    const w1=t1.text.replace(/[.,;:!?]$/,'').toLowerCase();
    const w2=t2.text.replace(/[.,;:!?]$/,'').toLowerCase();
    const isPair=(exactSurnameSet.has(w1)&&exactFirstSet.has(w2))||
                 (exactFirstSet.has(w1)&&exactSurnameSet.has(w2))||
                 (exactSurnameSet.has(w1)&&exactSurnameSet.has(w2));
    if(isPair){pass1Spans.push({start:t1.start,end:t2.end,orig:t1.text+' '+t2.text});i++;continue;}
    if(/^[A-Z]\.$/.test(t1.text)&&exactSurnameSet.has(w2)){
      pass1Spans.push({start:t1.start,end:t2.end,orig:t1.text+' '+t2.text});i++;
    }
  }
  result=applySpans(result,pass1Spans,'Nome+Cognome (coppia esatta)');

  // Pass 2: fuzzy pairs
  const tokens2=tokenise(result);
  const pass2Spans=[];
  // ‚îÄ‚îÄ PATCHED: expanded SKIP set with biochemistry terms and clinical labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const SKIP2=new Set([
    'nascita','cognome','nome','sesso','reparto','diagnosi','anamnesi',
    'terapia','esame','referto','paziente','medico','infermiere',
    'ambulatorio','ricovero','dimissione','urgente','ordinario',
    'stroke','unita','scala','valore','misura','dato','nota',
    'stato','grado','tipo','data','ora','firma','timbro',
    'mese','anno','giorno','settimana',
    'setto','atrio','mitrale','aortica','ventricolo','valvola',
    // Lab analytes & biochemistry
    'glucosio','urea','creatinina','sodio','potassio','cloro',
    'calcio','fosfato','albumina','bilirubina','totale','coniugata',
    'inorganico','inorganica','urico','acido','ratio','tempo',
    'protrombina','trombina','fibrinogeno','ferritina','transferrina',
    'colesterolo','trigliceridi','emoglobina','ematocrito','piastrine',
    'leucociti','eritrociti','basofili','eosinofili','neutrofili',
    'linfociti','monociti','reticolociti','glicemia','insulina',
    'cortisolo','troponina','mioglobina','procalcitonina','sideremia',
    'proteinuria','microalbuminuria','cistatina','osmolalita','clearance',
    'bicarbonato','magnesio','zinco','fosforo','transaminasi','lipasi',
    'amilasi','fosfatasi','creatinchinasi','lattato','deidrogenasi',
    // Lab header/comment words
    'costituente','risultato','riferimento','precedente',
    'intervallo','metodo','campione','commento','obiettivo',
    'terapeutico','normalizzato','alterata','digiuno',
    'gravidanza','emolizzato','sovrastima','reattiva',
    // Units
    'mmol','umol','nmol','litro','litri',
    // Clinical locations and exam section labels ‚Äî NEW
    'neurologica','neurologico','neurologici','neurologia',
    'obiettivo','obbiettivo','generale','ingresso',
    'soccorso','pronto','clinica','unita','unit',
    'fisiatrica','fisiatrico','fisiatria',
    'cardiologica','cardiologia','radiologia',
    'nefrologia','pneumologia','ortopedia',
    'geriatria','medicina','chirurgia','riabilitazione',
    'decorso','clinico','farmacologica','motivo',
    'patologica','remota','fisiologica','familiare',
    'accertamenti','strumentali','laboratorio','specialistiche',
    'valutazioni','neurologica','obiettivi',
    // Letter structure words ‚Äî must never be redacted
    'curante','attenzione','cortese','collega','egregio',
    'dimettiamo','odierna','assistita','assistito',
    'ricoverata','ricoverato','degenza',
  ]);
  for(let i=0;i<tokens2.length-1;i++){
    const t1=tokens2[i],t2=tokens2[i+1];
    if(!t1.isCapWord||!t2.isCapWord)continue;
    if(t1.text==='[NOME]'||t2.text==='[NOME]')continue;
    const w1=t1.text.replace(/[.,;:!?]$/,'').toLowerCase();
    const w2=t2.text.replace(/[.,;:!?]$/,'').toLowerCase();
    if(w1.length<4||w2.length<4)continue;
    if(SKIP2.has(w1)||SKIP2.has(w2))continue;
    const th1=fuzzyThreshold(w1),th2=fuzzyThreshold(w2);
    const isFuzzyPair=(isFuzzyName(w1,bkSurnames,th1)&&isFuzzyName(w2,bkFirstNames,th2))||
                      (isFuzzyName(w1,bkFirstNames,th1)&&isFuzzyName(w2,bkSurnames,th2));
    if(isFuzzyPair){pass2Spans.push({start:t1.start,end:t2.end,orig:t1.text+' '+t2.text});i++;}
  }
  pass2Spans.sort((a,b)=>a.start-b.start);
  let out2='',prev2=0;
  for(const s of pass2Spans){out2+=result.slice(prev2,s.start)+'[NOME]';addRep(s.orig,'Nome+Cognome (coppia fuzzy ~2 lettere)');prev2=s.end;}
  result=out2+result.slice(prev2);

  // Pass 3: exact individual surnames
  const allSurnames=[...exactSurnameSet];
  allSurnames.sort((a,b)=>b.length-a.length);
  // ‚îÄ‚îÄ PATCHED: expanded CLINICAL_KEYWORDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const CLINICAL_KEYWORDS=new Set([
    'nascita','cognome','nome','sesso','reparto','diagnosi','anamnesi',
    'terapia','esame','referto','paziente','medico','infermiere',
    'ambulatorio','ricovero','dimissione','urgente','ordinario',
    'stroke','unita','scala','valore','misura','dato','nota',
    'stato','grado','tipo','data','ora','firma','timbro',
    'mese','anno','giorno','settimana',
    'setto','atrio','mitrale','aortica','ventricolo','valvola',
    'romano','ferrari','russo','esposito','bianchi',
    'greco','lombardi','ricci','marino','gallo','conti','de',
    // Lab analytes
    'glucosio','urea','creatinina','sodio','potassio','cloro',
    'calcio','fosfato','albumina','bilirubina','totale','coniugata',
    'inorganico','inorganica','urico','acido','ratio','tempo',
    'protrombina','trombina','fibrinogeno','ferritina','transferrina',
    'colesterolo','trigliceridi','emoglobina','ematocrito','piastrine',
    'leucociti','eritrociti','basofili','eosinofili','neutrofili',
    'linfociti','monociti','reticolociti','glicemia','insulina',
    'cortisolo','troponina','mioglobina','procalcitonina','sideremia',
    'proteinuria','microalbuminuria','cistatina','osmolalita','clearance',
    'bicarbonato','magnesio','zinco','fosforo','transaminasi','lipasi',
    'amilasi','fosfatasi','creatinchinasi','lattato','deidrogenasi',
    'costituente','risultato','riferimento','precedente',
    'intervallo','metodo','campione','commento','obiettivo',
    'terapeutico','normalizzato','alterata','digiuno',
    'gravidanza','emolizzato','sovrastima','reattiva',
    'mmol','umol','nmol','litro','litri',
    // Clinical locations, exam labels, section headers ‚Äî NEW
    'neurologica','neurologico','neurologici','neurologia',
    'obiettivo','obbiettivo','generale','ingresso',
    'soccorso','pronto','clinica','fisiatrica','fisiatrico','fisiatria',
    'cardiologica','cardiologia','radiologia','nefrologia',
    'pneumologia','ortopedia','geriatria','medicina','chirurgia',
    'riabilitazione','decorso','clinico','farmacologica','motivo',
    'patologica','remota','fisiologica','familiare',
    'accertamenti','strumentali','laboratorio','specialistiche',
    'valutazioni','obiettivi','unita',
    // Letter structure words ‚Äî must never be redacted
    'curante','attenzione','cortese','collega','egregio',
    'dimettiamo','odierna','assistita','assistito',
    'ricoverata','ricoverato','degenza',
  ]);
  for(const name of allSurnames){
    if(name.length<4)continue;
    if(CLINICAL_KEYWORDS.has(name.toLowerCase()))continue;
    const escaped=name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const re=new RegExp(`(?<![\\w\\u00C0-\\u024F])${escaped}(?![\\w\\u00C0-\\u024F])`,'gi');
    if(re.test(result))result=result.replace(re,(m)=>{addRep(m,'Cognome (esatto)');return'[NOME]';});
  }
  return{text:result,reps};
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIPELINE ‚Äî with freeze/restore
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToAnon() {
  const raw=document.getElementById('inp_raw').value.trim();
  if(!raw&&!S_XLS.text){alert('Incolla il testo clinico o carica un referto XLS nello Step 1.');return;}
  S.rawText=raw+(S_XLS.text?'\n\n'+S_XLS.text:'');
  goTo(1); runPipeline();
}

function runPipeline() {
  const spin=document.getElementById('anonSpin');
  const stxt=document.getElementById('anonStatusTxt');
  const scard=document.getElementById('anonStatus');
  spin.style.display='inline-block';
  stxt.textContent='Strip boilerplate...';
  scard.style.borderColor='var(--border)';

  setTimeout(async()=>{
    try{
      // Stage 1 ‚Äî boilerplate
      const{clean,strippedBlocks}=stripBoilerplate(S.rawText);
      S.cleanText=clean; S.strippedBlocks=strippedBlocks;
      renderBoilerplateReview(strippedBlocks);

      // ‚îÄ‚îÄ PATCHED: freeze lab lines before any regex/dict processing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const{frozen,restore}=freezeLabLines(clean);
      let finalText=clean, reps=[];

      stxt.textContent='Stage 1 ‚Äî Regex strutturale...';
      const res=applyRegex(frozen);

      stxt.textContent='Stage 2 ‚Äî Caricamento dizionario...';
      if(!NAMES_DB.loaded)await loadNameDictionary();
      if(!NAMES_DB.loaded){
        stxt.textContent='‚ö† Dizionario non disponibile ‚Äî solo regex';
        finalText=restore(res.text); reps=res.reps;
      }else{
        stxt.textContent='Stage 2 ‚Äî Ricerca nomi (esatta + fuzzy)...';
        const res2=applyNameDict(res.text);
        // ‚îÄ‚îÄ PATCHED: restore lab lines after all processing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        finalText=restore(res2.text);
        reps=[...res.reps,...res2.reps];
      }

      renderAnonResult(finalText,reps);
      const saved=S.rawText.length-clean.length;
      stxt.textContent=`‚úì ${strippedBlocks.length} blocchi rimossi (‚àí${saved} char) ¬∑ üõ° Regex+Dizionario ¬∑ verifica manualmente`;
      scard.style.borderColor='var(--green)';
    }catch(err){
      stxt.textContent='‚úó '+err.message;
      scard.style.borderColor='var(--red)';
      console.error(err);
    }finally{spin.style.display='none';}
  },60);
}

function toggleSection(id){
  const sec=document.getElementById(id);
  const body=sec.querySelector('.collapsible-body');
  const icon=sec.querySelector('.ct-icon');
  const open=body.style.display==='block';
  body.style.display=open?'none':'block';
  icon.textContent=open?'‚ñ∂':'‚ñº';
}

function renderBoilerplateReview(blocks){
  const sec=document.getElementById('bpSection');
  const list=document.getElementById('bpList');
  const count=document.getElementById('bpCount');
  if(!blocks.length){sec.style.display='none';return;}
  sec.style.display='block';
  count.textContent=blocks.length+' blocchi';
  list.innerHTML=blocks.map(b=>`<div class="bpblock"><span class="bptag">‚úÇ ${esc(b.tag)}</span>${esc(b.text)}</div>`).join('');
}

function renderAnonResult(anonText,reps){
  document.getElementById('anonText').value=anonText;
  const sec=document.getElementById('repSection');
  const listEl=document.getElementById('repList');
  const count=document.getElementById('repCount');
  if(!reps.length){sec.style.display='none';}
  else{
    sec.style.display='block';
    count.textContent=reps.length+' sostituzioni';
    const modeChip=`<span class="chip c-w" style="margin-left:6px;">{ } Regex</span><span class="chip c-ok" style="margin-left:4px;">üìñ Dizionario</span>`;
    let h=`<div class="rl"><div class="rtitle">${reps.length} sostituzion${reps.length===1?'e':'i'} ${modeChip}</div>`;
    for(const r of reps)h+=`<div class="rrow"><span class="rorig">${esc(r.orig)}</span><span class="rarr">‚Üí</span><span class="rnew">${esc(r.repl)}</span><span class="rtype">${r.type}</span></div>`;
    h+='</div>';
    listEl.innerHTML=h;
  }
  let hi=esc(S.cleanText);
  for(const r of reps)hi=hi.replace(new RegExp(escR(esc(r.orig)),'g'),`<span class="redacted">${esc(r.orig)}</span>`);
  document.getElementById('origText').innerHTML=hi;
  const origScrollEl=document.getElementById('origText').parentElement;
  const anonScrollEl=document.getElementById('anonScroll');
  if(!origScrollEl._syncBound){
    origScrollEl._syncBound=true;
    let syncing=false;
    origScrollEl.addEventListener('scroll',()=>{if(syncing)return;syncing=true;anonScrollEl.scrollTop=origScrollEl.scrollTop;syncing=false;});
    anonScrollEl.addEventListener('scroll',()=>{if(syncing)return;syncing=true;origScrollEl.scrollTop=anonScrollEl.scrollTop;syncing=false;});
  }
  updateDiffHeight();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XLS / XLSX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleXlsDrop(e){e.preventDefault();document.getElementById('xlsDropzone').style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f)processXls(f);}
function handleXlsFile(e){const f=e.target.files[0];if(f)processXls(f);}
async function ensureSheetJs(){
  if(window.XLSX)return window.XLSX;
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload=()=>res(window.XLSX);s.onerror=()=>rej(new Error('Impossibile caricare SheetJS'));
    document.head.appendChild(s);
  });
}
async function processXls(file){
  const spin=document.getElementById('xlsSpin'),stxt=document.getElementById('xlsStatusTxt');
  const status=document.getElementById('xlsStatus'),preview=document.getElementById('xlsPreview');
  status.style.display='block';spin.style.display='inline-block';
  stxt.style.color='var(--mid)';stxt.textContent='Caricamento SheetJS...';
  try{
    const XLS=await ensureSheetJs();stxt.textContent='Parsing '+file.name+'...';
    const buf=await file.arrayBuffer();
    const wb=XLS.read(buf,{type:'array',cellText:true,cellDates:true});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLS.utils.sheet_to_json(ws,{header:1,defval:'',raw:false});
    const fmt=formatLabRows(rows);
    S_XLS.text=fmt.text;S_XLS.filename=file.name;
    spin.style.display='none';stxt.style.color='var(--green)';
    stxt.textContent=`‚úì ${fmt.examCount} esami estratti da "${file.name}"`;
    document.getElementById('xlsPreviewContent').textContent=fmt.preview;
    preview.style.display='block';
    document.getElementById('xlsFileInput').value='';
  }catch(err){spin.style.display='none';stxt.style.color='var(--red)';stxt.textContent='‚úó '+err.message;}
}
function formatLabRows(rows){
  let dataStart=0;
  for(let i=0;i<Math.min(rows.length,15);i++){
    const r=rows[i].map(c=>String(c).trim().toLowerCase());
    if(r.some(c=>c.includes('metodo')||c.includes('unit')||c.includes('intervallo')||c.includes('riferimento'))){dataStart=i+1;break;}
  }
  const lines=[];let examCount=0;
  for(let i=dataStart;i<rows.length;i++){
    const row=rows[i].map(c=>String(c).trim());
    const[name,value,,unit,refRange]=row;
    if(!name)continue;
    const isComment=name&&!value&&name.length>40;
    const isSection=name&&!value&&!unit&&!isComment;
    const isExam=name&&value&&value!=='';
    if(isComment){lines.push(`  ‚Äª ${name}`);continue;}
    if(isSection){lines.push(`\n[${name.toUpperCase()}]`);continue;}
    if(isExam){
      examCount++;
      let line=`  ${name}: ${value}`;
      if(unit)line+=` ${unit}`;
      if(refRange)line+=` (rif: ${refRange})`;
      if(isAbnormal(value,refRange))line+=' ‚ö†';
      lines.push(line);
    }
  }
  const text=`## ESAMI DI LABORATORIO (da file: ${S_XLS.filename||'referto.xls'})\n`+lines.join('\n');
  const preview=lines.slice(0,40).join('\n')+(lines.length>40?`\n  ... e altri ${lines.length-40} righe`:'');
  return{text,preview,examCount};
}
function isAbnormal(value,refRange){
  if(!refRange||!value)return false;
  if(/\d{1,2}\/\d{1,2}/.test(refRange))return false;
  const numVal=parseFloat(value.replace(',','.'));
  if(isNaN(numVal))return false;
  const m=refRange.match(/([\d.,]+)\s*[-‚Äì]\s*([\d.,]+)/);
  if(!m)return false;
  const lo=parseFloat(m[1].replace(',','.')),hi=parseFloat(m[2].replace(',','.'));
  if(isNaN(lo)||isNaN(hi))return false;
  return numVal<lo||numVal>hi;
}
function clearXls(){
  S_XLS.text='';S_XLS.filename='';
  document.getElementById('xlsPreview').style.display='none';
  document.getElementById('xlsStatus').style.display='none';
  document.getElementById('xlsFileInput').value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF.js
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pdfjsLib=null;
async function ensurePdfJs(){
  if(pdfjsLib)return pdfjsLib;
  return new Promise((res,rej)=>{
    if(window.pdfjsLib){pdfjsLib=window.pdfjsLib;res(pdfjsLib);return;}
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
    s.onload=()=>{pdfjsLib=window.pdfjsLib;pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';res(pdfjsLib);};
    s.onerror=()=>rej(new Error('Impossibile caricare PDF.js.'));
    document.head.appendChild(s);
  });
}
function handlePdfDrop(e){e.preventDefault();document.getElementById('pdfDropzone').style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')processPdf(f);else alert('Carica un PDF.');}
function handlePdfFile(e){const f=e.target.files[0];if(f)processPdf(f);}
async function processPdf(file){
  const spin=document.getElementById('pdfSpin'),stxt=document.getElementById('pdfStatusTxt'),
    bar=document.getElementById('pdfBar'),status=document.getElementById('pdfStatus');
  status.style.display='block';spin.style.display='inline-block';
  bar.style.width='0%';stxt.style.color='var(--mid)';stxt.textContent='Caricamento PDF.js...';
  try{
    const lib=await ensurePdfJs();stxt.textContent=`Lettura: ${file.name}`;
    const ab=await file.arrayBuffer();const pdf=await lib.getDocument({data:ab}).promise;
    const tot=pdf.numPages;let full='';
    for(let i=1;i<=tot;i++){
      const pg=await pdf.getPage(i);const ct=await pg.getTextContent();
      let pt='',ly=null;
      for(const it of ct.items){
        if('str'in it){if(ly!==null&&Math.abs(it.transform[5]-ly)>5)pt+='\n';pt+=it.str;if(it.hasEOL)pt+='\n';ly=it.transform[5];}
      }
      full+=pt.trim()+'\n\n';bar.style.width=Math.round(i/tot*100)+'%';stxt.textContent=`Pag ${i}/${tot}...`;
    }
    full=full.replace(/\n{3,}/g,'\n\n').trim();
    const ex=document.getElementById('inp_raw').value.trim();
    document.getElementById('inp_raw').value=ex?ex+'\n\n--- '+file.name+' ---\n\n'+full:full;
    bar.style.width='100%';spin.style.display='none';stxt.style.color='var(--green)';
    stxt.textContent=`‚úì ${tot} pagina${tot===1?'':'e'} ¬∑ ${full.length.toLocaleString()} caratteri`;
    document.getElementById('pdfFileInput').value='';
  }catch(err){spin.style.display='none';stxt.style.color='var(--red)';stxt.textContent='‚úó '+err.message;}
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEMPLATE LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadLibrary(){try{return JSON.parse(localStorage.getItem('letteraai_lib')||'[]');}catch(e){return[];}}
function saveLibrary(lib){localStorage.setItem('letteraai_lib',JSON.stringify(lib));}

function renderLibrary(){
  const lib=loadLibrary();
  const grid=document.getElementById('tplGrid'),noMsg=document.getElementById('noTplMsg'),stats=document.getElementById('libStats');
  stats.textContent=`${lib.length} casi ¬∑ lettere ~${lib.reduce((a,t)=>a+tok(t.letter||''),0)} tok`;
  if(!lib.length){grid.innerHTML='';noMsg.style.display='block';updateRagPreview();return;}
  noMsg.style.display='none';
  grid.innerHTML=lib.map(t=>{
    const isActive=S.activeTemplateId===t.id;
    return `<div class="tpl-card${isActive?' active-tpl':''}" onclick="selectTemplate('${t.id}')">
      <button class="tpl-del" onclick="event.stopPropagation();deleteTemplate('${t.id}')">‚úï</button>
      <div class="tpl-name">${esc(t.name)}</div>
      <div class="tpl-meta" style="margin-bottom:6px;">${new Date(t.createdAt).toLocaleDateString('it-IT')}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        ${t.folder?`<span class="chip c-w">üìÅ ~${tok(t.folder)}t</span>`:''}
        ${t.letter?`<span class="chip c-ok">üìÑ ~${tok(t.letter)}t</span>`:''}
        ${t.fingerprint?`<span class="tpl-cached-badge">‚ö° fp ~${tok(t.fingerprint)}t</span>`:''}
      </div>
    </div>`;
  }).join('');
  updateRagPreview();
}

function selectTemplate(id){
  S.activeTemplateId=(S.activeTemplateId===id)?null:id;
  renderLibrary();updateTokenPanel();
  const t=loadLibrary().find(x=>x.id===id);
  document.getElementById('statusBadge').textContent=(t&&S.activeTemplateId===id)?`üìö ${t.name}`:'‚óè Pronto';
}
function deleteTemplate(id){
  if(!confirm('Eliminare questo caso?'))return;
  if(S.activeTemplateId===id)S.activeTemplateId=null;
  saveLibrary(loadLibrary().filter(t=>t.id!==id));renderLibrary();updateTokenPanel();
}
function getActiveFingerprint(){
  if(!S.activeTemplateId)return'';
  const t=loadLibrary().find(x=>x.id===S.activeTemplateId);
  return t?(t.fingerprint||''):'';
}

// TF-IDF RAG
const STOPWORDS_IT=new Set(['il','la','lo','i','gli','le','un','una','uno','dei','delle','degli','di','da','in','con','su','per','tra','fra','a','al','alla','allo','ai','alle','agli','del','della','dello','e','ed','o','ma','se','non','si','che','√®','era','sono','stato','stata','stati','state','ha','hanno','ho','nei','nelle','negli','nel','nella','nello','questo','questa','questi','queste','come','pi√π','anche','dopo','prima','durante','presso','viene','veniva','venivano','dal','dai','dalle','dagli']);
function tokenizeForTfidf(text){
  return text.toLowerCase().replace(/\[[\w_]+\]/g,'').replace(/[^a-z√†√®√©√¨√≠√≤√≥√π√∫\s]/g,' ').split(/\s+/).filter(w=>w.length>3&&!STOPWORDS_IT.has(w));
}
function buildTfIdf(docs){
  const N=docs.length,df={};
  for(const d of docs)for(const w of new Set(d))df[w]=(df[w]||0)+1;
  return docs.map(tokens=>{
    const tf={},vec={};
    for(const w of tokens)tf[w]=(tf[w]||0)+1;
    for(const[w,c]of Object.entries(tf))vec[w]=(c/tokens.length)*Math.log((N+1)/((df[w]||0)+1));
    return vec;
  });
}
function cosineSim(a,b){
  let dot=0,na=0,nb=0;
  for(const[w,v]of Object.entries(a)){dot+=v*(b[w]||0);na+=v*v;}
  for(const v of Object.values(b))nb+=v*v;
  return(na&&nb)?dot/(Math.sqrt(na)*Math.sqrt(nb)):0;
}
function findSimilarCases(queryText,topK=2){
  const lib=loadLibrary().filter(t=>t.folder&&t.letter);
  if(!lib.length)return[];
  const qt=tokenizeForTfidf(queryText);
  const allDocs=[qt,...lib.map(t=>tokenizeForTfidf(t.folder))];
  const vecs=buildTfIdf(allDocs);
  const scored=lib.map((t,i)=>({t,score:cosineSim(vecs[0],vecs[i+1])}));
  scored.sort((a,b)=>b.score-a.score);
  return scored.slice(0,topK).filter(x=>x.score>0.05);
}

function updateRagPreview(){
  const ragOn=document.getElementById('ragToggle')?.checked;
  const matches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const show=(wrapId,listId,showFolder)=>{
    const wrap=document.getElementById(wrapId),list=document.getElementById(listId);
    if(!wrap)return;
    if(!matches.length||!S.anonText){wrap.style.display='none';return;}
    wrap.style.display='block';
    list.innerHTML=matches.map(({t,score})=>`
      <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="flex:1;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);">${esc(t.name)}</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:2px;">lettera ~${tok(t.letter||'')} tok${showFolder?` ¬∑ cartella locale ~${tok(t.folder||'')} tok (non inviata)`:''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--blue);">${(score*100).toFixed(0)}%</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);">similarit√†</div>
        </div>
      </div>`).join('');
  };
  show('ragPreview','ragMatches',false);
  show('ragPreviewGen','ragMatchesGen',true);
}

function deleteNewTplSection(id){newTplSections=newTplSections.filter(s=>s.id!==id);renderNewTplSections();}
function renderNewTplSections(){
  const el=document.getElementById('newTplSections');
  if(!newTplSections.length){el.innerHTML='';return;}
  el.innerHTML=`<div style="margin-top:10px;"><div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Fingerprint Estratto</div>`
    +newTplSections.map(s=>`
    <div style="margin-bottom:8px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;">
        <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.08em;">${esc(s.label)}</span>
        <button style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--red);cursor:pointer;background:none;border:none;" onclick="deleteNewTplSection('${s.id}')">‚úï</button>
      </div>
      <textarea rows="2" style="font-size:11px;margin-top:0;" oninput="updateNewTplSection('${s.id}',this.value)">${esc(s.text||'')}</textarea>
    </div>`).join('')
    +`</div>`;
}
function updateNewTplSection(id,val){const s=newTplSections.find(x=>x.id===id);if(s)s.text=val;}
function buildFingerprintFromSections(sections){
  const active=sections.filter(s=>s.text&&s.text.trim());
  if(!active.length)return'';
  return active.map(s=>`[${s.label}]\n${s.text.trim()}`).join('\n\n');
}
async function autoExtractTemplate(){
  const key=document.getElementById('apiKeyInput').value.trim();
  const letter=document.getElementById('newCaseLetter').value.trim();
  if(!letter){alert('Incolla prima la lettera.');return;}
  if(!key){alert('Inserisci la API key nella sezione Generazione.');return;}
  const spin=document.getElementById('tplExtSpin'),status=document.getElementById('tplExtStatus');
  spin.style.display='inline-block';status.style.display='block';
  status.style.color='var(--mid)';status.textContent='Estrazione fingerprint con Haiku...';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:500,
        system:`Estrai lo stile da una lettera di dimissione medica italiana. Restituisci SOLO JSON:
{"apertura":"...","decorso":"...","terapia":"...","chiusura":"..."} Solo stile/registro, NO dati clinici. Solo JSON nudo.`,
        messages:[{role:'user',content:`Lettera:\n\n${letter}`}]}),
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const raw=(await resp.json()).content[0].text;
    const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const map={apertura:'Apertura',decorso:'Decorso tipo',terapia:'Terapia tipo',chiusura:'Chiusura'};
    newTplSections=[];
    for(const[k,label]of Object.entries(map))
      if(parsed[k])newTplSections.push({id:'ntpl_'+Date.now()+'_'+k,label,text:parsed[k]});
    renderNewTplSections();
    const origTok=tok(letter),newTok=tok(buildFingerprintFromSections(newTplSections));
    status.style.color='var(--green)';
    status.textContent=`‚úì Fingerprint estratto ¬∑ da ~${origTok} a ~${newTok} token (‚àí${Math.round((1-newTok/origTok)*100)}%)`;
  }catch(err){status.style.color='var(--red)';status.textContent='‚úó '+err.message;}
  finally{spin.style.display='none';}
}
function saveNewTemplate(){
  const name=document.getElementById('newTplName').value.trim();
  const folder=document.getElementById('newCaseFolder').value.trim();
  const letter=document.getElementById('newCaseLetter').value.trim();
  if(!name){alert('Inserisci un nome.');return;}
  if(!letter){alert('La lettera √® obbligatoria.');return;}
  const fp=buildFingerprintFromSections(newTplSections);
  const lib=loadLibrary();
  lib.push({id:'tpl_'+Date.now(),name,folder,letter,fingerprint:fp,createdAt:new Date().toISOString()});
  saveLibrary(lib);newTplSections=[];renderNewTplSections();
  ['newTplName','newCaseFolder','newCaseLetter'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('tplExtStatus').style.display='none';
  renderLibrary();alert(`Caso "${name}" salvato.`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOKEN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tok(str){return Math.round((str||'').length/4);}

function updateTokenPanel(){
  if(!S.anonText)return;
  const model=document.getElementById('modelSelect').value;
  const price=PRICING[model]||PRICING['claude-sonnet-4-6'];
  const sysTxt=document.getElementById('systemPrompt').value||DEFAULT_SYS;
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const templateTxt=buildLetterTemplate();
  const tSys=tok(sysTxt),tFp=tok(fp);
  const tRag=ragMatches.reduce((a,{t})=>a+tok(t.letter||''),0);
  const tTemplate=tok(templateTxt),tClinical=tok(S.anonText),tOut=1800;
  const tCacheable=tFp+tRag,tTotal=tSys+tFp+tRag+tTemplate+tClinical;
  const cacheActive=tCacheable>0;
  const costNoCache=(tTotal/1e6)*price.in;
  const costCacheW=cacheActive?(tCacheable/1e6)*price.in_cache_write:0;
  const costCacheR=cacheActive?(tCacheable/1e6)*price.in_cache_read:0;
  const costNonCached=((tSys+tTemplate+tClinical)/1e6)*price.in;
  const costFirst=costCacheW+costNonCached,costSubseq=costCacheR+costNonCached;
  const costOut=(tOut/1e6)*price.out;
  const sections=[
    {label:'System Prompt',tokens:tSys,color:'#7a6340',cached:false},
    {label:'Fingerprint Stile',tokens:tFp,color:'#6ea8c9',cached:cacheActive&&tFp>0},
    {label:`RAG (${ragMatches.length} casi)`,tokens:tRag,color:'#a96ec9',cached:cacheActive&&tRag>0},
    {label:'Template lettera',tokens:tTemplate,color:'#7a7570',cached:false},
    {label:'Testo clinico',tokens:tClinical,color:'#c9a96e',cached:false},
    {label:'Output stimato',tokens:tOut,color:'#6ec98a',cached:false},
  ].filter(s=>s.tokens>0);
  const maxTok=Math.max(...sections.map(s=>s.tokens),1);
  let html='<div style="margin-bottom:12px;">';
  for(const s of sections){
    const pct=Math.round((s.tokens/maxTok)*100);
    const up=s.label==='Output stimato'?price.out:price.in;
    html+=`<div class="tok-row"><span class="tok-label">${s.label}${s.cached?'<span class="tok-cached">‚ö° cached</span>':''}</span><div class="tok-bar-wrap"><div class="tok-bar" style="width:${pct}%;background:${s.color};"></div></div><span class="tok-val">${s.tokens.toLocaleString()} tok</span><span class="tok-cost" style="color:${s.cached?'var(--blue)':'var(--dim)'};">$${((s.tokens/1e6)*up).toFixed(4)}</span></div>`;
  }
  html+='</div>';
  html+=`<div class="tok-total-row"><div class="tok-total-box"><div class="tlabel">Senza caching</div><div class="tval">$${(costNoCache+costOut).toFixed(4)}</div><div class="tsub">${(tTotal+tOut).toLocaleString()} token</div></div><div class="tok-total-box" style="${cacheActive?'border-color:var(--blue);':''}"><div class="tlabel">${cacheActive?'Con caching (1¬™)':'Nessun caso/template'}</div><div class="tval" style="color:${cacheActive?'var(--blue)':'var(--accent)'};">$${(costFirst+costOut).toFixed(4)}</div><div class="tsub">${cacheActive?`Successive: $${(costSubseq+costOut).toFixed(4)}`:'Seleziona un caso'}</div></div></div>`;
  if(cacheActive){
    const saving=costNoCache>0?((costNoCache-costSubseq)/costNoCache*100).toFixed(0):0;
    html+=`<div class="tok-cache-note">‚ö° ${tCacheable} token cacheable. Risparmio dalla 2¬™ chiamata: <strong>${saving}%</strong> sull'input.</div>`;
  }
  document.getElementById('tokRows').innerHTML=html;
  document.getElementById('cacheActiveBadge').style.display=cacheActive?'inline-flex':'none';
  updateRagPreview();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPT BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildLetterTemplate(){
  const citta=(document.getElementById('cfg_citta').value||'Padova').trim();
  const dott=(document.getElementById('cfg_dott').value||'Dott. [NOME]').trim();
  const prof=(document.getElementById('cfg_prof').value||'Prof. [NOME]').trim();
  const diagnosi=document.getElementById('inp_diagnosi').value.trim()||'[DIAGNOSI_PRINCIPALE]';
  const today=new Date().toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
  return `## TEMPLATE LETTERA DI DIMISSIONE

Genera la lettera seguendo ESATTAMENTE questa struttura. Per dati assenti: "Non documentato." ‚Äî MAI inventare.

---
${citta}, ${today}

All'attenzione del Medico Curante

Egregio Collega,
        dimettiamo in data odierna la Sua Assistita, [PAZIENTE_NOME], nata in data [DATA_NASCITA], ricoverata presso la nostra Clinica dal [DATA_RICOVERO] u.s., con diagnosi di:

"${diagnosi}"

**Motivo del ricovero**
[Prosa continua, passato remoto o imperfetto ‚Äî MAI passato prossimo ‚Äî dati di presentazione dall'input]

**Non farmacoallergie note.** [oppure allergie se documentate]

**Terapia domiciliare**: [farmaci pre-ricovero dall'input]

**Anamnesi Patologica Remota**
[Trattini per voce ‚Äî dati APR dall'input]

**Anamnesi Fisiologica/Sociale/Familiare**
[Prosa concisa ‚Äî dati dall'input]

**Esame neurologico all'ingresso**: [se presente ‚Äî ometti altrimenti]

**Esame obiettivo generale all'ingresso**: [se presente ‚Äî ometti altrimenti]

Durante la degenza sono stati eseguiti i seguenti **esami di laboratorio:**
[Lista ‚Äî mantieni valori numerici esatti dall'input]

ed i seguenti **accertamenti strumentali** e **valutazioni specialistiche**:
[Per ogni accertamento: "Nome esame (DD/MM/YYYY): referto sintetico." ‚Äî se in refertazione: "(referto in corso di completamento)"]

**Decorso clinico**
[Prosa clinica 150-300 parole, passato remoto o imperfetto ‚Äî MAI passato prossimo ‚Äî sintesi cronologica dell'input]

Alla dimissione [condizioni cliniche alla dimissione].

**Terapia alla dimissione:**

| Farmaco | Posologia | Orari | Note |
|---------|-----------|-------|------|
[Una riga per farmaco ‚Äî nome+formulazione | n cp/os | 8.00-20.00 | terapia domiciliare / nuova terapia / dose modificata / fino al GG/MM poi stop]

[Follow-up e accertamenti pendenti dall'input]

Si prega di presentarsi muniti degli appositi foglietti azzurri allegati.

Sar√† nostra cura fornire gli esiti mediante Lettera di Completamento.

[Raccomandazioni specifiche se presenti nell'input]

Ringraziando per la collaborazione, rimaniamo a disposizione. Cordiali saluti.

${dott.padEnd(46)}${prof}
(Medico in formazione specialistica)${' '.repeat(14)}(Dirigente Medico)
---`;
}

function buildMessages(){
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const blocks=[];
  if(fp)blocks.push({type:'text',text:`## RIFERIMENTO STILISTICO\n\n${fp}\n\n---\n\n`,cache_control:{type:'ephemeral'}});
  if(ragMatches.length){
    let rb=`## ESEMPI DI RIFERIMENTO ‚Äî casi simili\n\nUsa per stile e struttura. NON copiare dati clinici.\n\n`;
    ragMatches.forEach(({t,score},i)=>{rb+=`### Esempio ${i+1} ‚Äî ${t.name} (${(score*100).toFixed(0)}%)\n\n${t.letter}\n\n---\n\n`;});
    blocks.push({type:'text',text:rb,cache_control:{type:'ephemeral'}});
  }
  const addendum=S_optAddendum?`\n\n[ISTRUZIONI AGGIUNTIVE PER QUESTO CASO]\n${S_optAddendum}`:'';
  blocks.push({type:'text',text:`## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n`+buildLetterTemplate()+addendum});
  const useCache=fp||ragMatches.length;
  return[{role:'user',content:useCache?blocks:blocks.map(b=>b.text).join('')}];
}

function buildUserPromptStr(){
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  let p='';
  if(fp)p+=`## RIFERIMENTO STILISTICO\n\n${fp}\n\n---\n\n`;
  if(ragMatches.length){
    p+=`## ESEMPI DI RIFERIMENTO\n\n`;
    ragMatches.forEach(({t,score},i)=>{p+=`### Esempio ${i+1} ‚Äî ${t.name} (${(score*100).toFixed(0)}%)\n\n${t.letter}\n\n---\n\n`;});
  }
  p+=`## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n`;
  p+=buildLetterTemplate();
  if(S_optAddendum)p+=`\n\n[ISTRUZIONI AGGIUNTIVE PER QUESTO CASO]\n${S_optAddendum}`;
  return p;
}

function proceedToGenerate(){
  S.anonText=document.getElementById('anonText').value;
  if(!S.anonText.trim()){alert('Nessun testo. Torna allo Step 1.');return;}
  if(!document.getElementById('systemPrompt').value.trim())
    document.getElementById('systemPrompt').value=DEFAULT_SYS;
  goTo(2);updateRagPreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateLetter(){
  const key=document.getElementById('apiKeyInput').value.trim();
  if(!key){showErr('Inserisci la API key Anthropic.');return;}
  if(!S.anonText){showErr('Nessun testo anonimizzato.');return;}
  const btn=document.getElementById('genBtn'),spin=document.getElementById('genSpin');
  btn.disabled=true;spin.style.display='inline-block';
  document.getElementById('genErr').style.display='none';
  document.getElementById('statusBadge').textContent='‚ü≥ Generando...';
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const useCache=fp||ragMatches.length>0;
  const headers={'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'};
  if(useCache)headers['anthropic-beta']='prompt-caching-2024-07-31';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers,
      body:JSON.stringify({
        model:document.getElementById('modelSelect').value,
        max_tokens:6000,
        temperature:parseInt(document.getElementById('tempSlider').value)/10,
        system:[{type:'text',text:document.getElementById('systemPrompt').value||DEFAULT_SYS,...(useCache?{cache_control:{type:'ephemeral'}}:{})}],
        messages:buildMessages(),
      }),
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const data=await resp.json();
    S.letter=data.content[0].text;
    const u=data.usage||{};
    const price=PRICING[document.getElementById('modelSelect').value]||PRICING['claude-sonnet-4-6'];
    const inCost=((u.input_tokens||0)/1e6)*price.in;
    const cacheCr=((u.cache_creation_input_tokens||0)/1e6)*price.in_cache_write;
    const cacheRd=((u.cache_read_input_tokens||0)/1e6)*price.in_cache_read;
    const outCost=((u.output_tokens||0)/1e6)*price.out;
    const total=inCost+cacheCr+cacheRd+outCost;
    const usageEl=document.getElementById('usageInfo');
    usageEl.style.display='block';
    usageEl.innerHTML=`‚úì Costo reale ‚Äî input: ${u.input_tokens||0} tok ($${inCost.toFixed(4)})`
      +(u.cache_creation_input_tokens?` ¬∑ cache write: ${u.cache_creation_input_tokens} tok ($${cacheCr.toFixed(4)})`:'')+
      (u.cache_read_input_tokens?` ¬∑ cache read: ${u.cache_read_input_tokens} tok ($${cacheRd.toFixed(4)})`:'')+
      ` ¬∑ output: ${u.output_tokens||0} tok ($${outCost.toFixed(4)}) ‚Äî <strong style="color:var(--text);">totale: $${total.toFixed(4)}</strong>`;
    document.getElementById('letterOut').textContent=S.letter;
    document.getElementById('statusBadge').textContent='‚úì Lettera generata';
    document.getElementById('nav3').classList.add('done');
    goTo(3);
  }catch(err){
    showErr('‚úó '+err.message);
    document.getElementById('statusBadge').textContent='‚úó Errore';
  }finally{btn.disabled=false;spin.style.display='none';}
}
function showErr(msg){const el=document.getElementById('genErr');el.textContent=msg;el.style.display='block';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPT VIEWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pTab='full',pSys='',pUsr='';
function showTab(t){
  pTab=t;
  ['full','system','user'].forEach(id=>document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)).classList.toggle('active',id===t));
  renderPromptView();
}
function renderPromptView(){
  const el=document.getElementById('promptView');
  if(!pSys&&!pUsr)return;
  if(pTab==='full')el.value='‚ïê‚ïê SYSTEM ‚ïê‚ïê\n\n'+pSys+'\n\n‚ïê‚ïê USER ‚ïê‚ïê\n\n'+pUsr;
  else if(pTab==='system')el.value=pSys;
  else el.value=pUsr;
}
function refreshPrompt(){
  if(!S.anonText){document.getElementById('promptView').value='Completa gli Step 1‚Äì2.';return;}
  pSys=document.getElementById('systemPrompt').value||DEFAULT_SYS;
  pUsr=buildUserPromptStr();
  renderPromptView();updateTokenPanel();
}
async function copyFull(){refreshPrompt();await navigator.clipboard.writeText(document.getElementById('promptView').value);flash();}
async function copyUser(){refreshPrompt();await navigator.clipboard.writeText(pUsr);flash();}
function flash(){const el=document.getElementById('copyConfirm');el.style.display='block';setTimeout(()=>el.style.display='none',1600);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OUTPUT ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyLetter(){navigator.clipboard.writeText(S.letter).then(()=>alert('Copiato.'));}
function printLetter(){
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Lettera di Dimissione</title><style>body{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.8;margin:2.5cm;color:#000}pre{white-space:pre-wrap;font-family:inherit}</style></head><body><pre>${esc(S.letter)}</pre></body></html>`);
  w.document.close();w.print();
}
function newLetter(){
  if(!confirm('Nuova lettera? I dati correnti andranno persi.'))return;
  S.rawText=S.cleanText=S.anonText=S.letter='';S.strippedBlocks=[];
  document.getElementById('inp_raw').value='';document.getElementById('inp_diagnosi').value='';
  document.getElementById('letterOut').textContent='‚Äî';document.getElementById('usageInfo').style.display='none';
  document.getElementById('statusBadge').textContent=S.activeTemplateId?'üìö Template attivo':'‚óè Pronto';
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('done'));
  goTo(0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveBaseSettings(){
  localStorage.setItem('letteraai_cfg',JSON.stringify({
    citta:document.getElementById('cfg_citta').value,
    reparto:document.getElementById('cfg_reparto').value,
    dott:document.getElementById('cfg_dott').value,
    prof:document.getElementById('cfg_prof').value,
    regex:document.getElementById('cfg_regex').value,
    surnamesUrl:document.getElementById('cfg_surnames_url').value,
    firstNamesUrl:document.getElementById('cfg_firstnames_url').value,
    ghToken:document.getElementById('cfg_gh_token').value,
    ghRepo:document.getElementById('cfg_gh_repo').value,
    ghPath:document.getElementById('cfg_gh_path').value,
  }));alert('Impostazioni salvate.');
}
function loadBaseSettings(){
  try{
    const c=JSON.parse(localStorage.getItem('letteraai_cfg')||'{}');
    if(c.citta)document.getElementById('cfg_citta').value=c.citta;
    if(c.reparto)document.getElementById('cfg_reparto').value=c.reparto;
    if(c.dott)document.getElementById('cfg_dott').value=c.dott;
    if(c.prof)document.getElementById('cfg_prof').value=c.prof;
    if(c.regex)document.getElementById('cfg_regex').value=c.regex;
    if(c.surnamesUrl)document.getElementById('cfg_surnames_url').value=c.surnamesUrl;
    if(c.firstNamesUrl)document.getElementById('cfg_firstnames_url').value=c.firstNamesUrl;
    if(c.ghToken)document.getElementById('cfg_gh_token').value=c.ghToken;
    if(c.ghRepo)document.getElementById('cfg_gh_repo').value=c.ghRepo;
    if(c.ghPath)document.getElementById('cfg_gh_path').value=c.ghPath||'cases.json';
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escR(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function clearAll(){
  if(!confirm('Cancellare tutto?'))return;
  document.getElementById('inp_raw').value='';document.getElementById('inp_diagnosi').value='';
  S.rawText=S.cleanText=S.anonText=S.letter='';S.strippedBlocks=[];
}

function updateDiffHeight(){
  const panel=document.getElementById('panel1');
  if(!panel.classList.contains('active'))return;
  const grid=panel.querySelector('.diff-grid');
  if(!grid)return;
  const HEADER_H=52,VIEWPORT_H=window.innerHeight,MAX_H=VIEWPORT_H-HEADER_H;
  const scrolled=panel.scrollTop,aboveH=grid.offsetTop;
  const scrolledIntoAbove=Math.min(scrolled,aboveH);
  const targetH=Math.min(MAX_H,(VIEWPORT_H-HEADER_H-aboveH)+scrolledIntoAbove);
  const clampedH=Math.max(300,targetH);
  grid.style.height=clampedH+'px';
  const cols=grid.querySelectorAll('.diff-scroll');
  cols.forEach(c=>{c.style.height=(clampedH-28)+'px';});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GITHUB LIBRARY SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGitHubCfg(){
  const c=JSON.parse(localStorage.getItem('letteraai_cfg')||'{}');
  return{token:c.ghToken||'',repo:c.ghRepo||'',path:c.ghPath||'cases.json'};
}
function ghStatus(msg,color='var(--dim)'){
  const el=document.getElementById('ghStatus');
  if(el){el.style.color=color;el.textContent=msg;}
}
async function ghApiGet(cfg){
  const url=`https://api.github.com/repos/${cfg.repo}/contents/${cfg.path}`;
  const r=await fetch(url,{headers:{Authorization:`token ${cfg.token}`,'Accept':'application/vnd.github.v3+json'}});
  if(r.status===404)return null;
  if(!r.ok)throw new Error(`GitHub GET ${r.status}: ${await r.text()}`);
  return r.json();
}
async function ghApiPut(cfg,content,sha){
  const url=`https://api.github.com/repos/${cfg.repo}/contents/${cfg.path}`;
  const body={message:`Lettera.AI ‚Äî aggiorna libreria casi ${new Date().toISOString()}`,content:btoa(unescape(encodeURIComponent(content)))};
  if(sha)body.sha=sha;
  const r=await fetch(url,{method:'PUT',headers:{Authorization:`token ${cfg.token}`,'Content-Type':'application/json','Accept':'application/vnd.github.v3+json'},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(`GitHub PUT ${r.status}: ${await r.text()}`);
  return r.json();
}
async function testGitHubConnection(){
  const cfg=getGitHubCfg();
  if(!cfg.token||!cfg.repo){ghStatus('‚úó Configura token e repo prima.','var(--red)');return;}
  ghStatus('‚ü≥ Test in corso...','var(--dim)');
  try{
    const r=await fetch(`https://api.github.com/repos/${cfg.repo}`,{headers:{Authorization:`token ${cfg.token}`}});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    ghStatus(`‚úì Connesso a ${d.full_name} (${d.private?'privato':'pubblico'})${d.private?'':' ‚Äî ‚ö† repo pubblico!'}`,d.private?'var(--green)':'var(--accent)');
  }catch(e){ghStatus('‚úó '+e.message,'var(--red)');}
}
async function syncLibraryToGitHub(){
  const cfg=getGitHubCfg();
  if(!cfg.token||!cfg.repo){ghStatus('‚úó Configura token e repo prima.','var(--red)');return;}
  ghStatus('‚ü≥ Upload in corso...','var(--dim)');
  try{
    const existing=await ghApiGet(cfg);
    const sha=existing?.sha;
    const lib=loadLibrary();
    await ghApiPut(cfg,JSON.stringify(lib,null,2),sha);
    ghStatus(`‚úì ${lib.length} casi caricati su ${cfg.repo}/${cfg.path}`,'var(--green)');
  }catch(e){ghStatus('‚úó '+e.message,'var(--red)');}
}
async function pullLibraryFromGitHub(){
  const cfg=getGitHubCfg();
  if(!cfg.token||!cfg.repo){ghStatus('‚úó Configura token e repo prima.','var(--red)');return;}
  ghStatus('‚ü≥ Download in corso...','var(--dim)');
  try{
    const file=await ghApiGet(cfg);
    if(!file){ghStatus('‚úó File non trovato. Fai prima un push.','var(--red)');return;}
    const decoded=decodeURIComponent(escape(atob(file.content.replace(/\n/g,''))));
    const lib=JSON.parse(decoded);
    if(!Array.isArray(lib))throw new Error('Formato non valido');
    saveLibrary(lib);renderLibrary();
    ghStatus(`‚úì ${lib.length} casi scaricati da ${cfg.repo}/${cfg.path}`,'var(--green)');
  }catch(e){ghStatus('‚úó '+e.message,'var(--red)');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-FILL CASE FOLDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoFillCaseFolder(){
  if(!S.anonText){alert('Nessun testo anonimizzato in sessione. Completa prima lo Step 2.');return;}
  document.getElementById('newCaseFolder').value=S.anonText;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPT OPTIMIZER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S_optAddendum='';

function toggleOptimizer(){
  const body=document.getElementById('optimizerBody');
  const btn=document.querySelector('#optimizerCard .btn-g');
  const visible=body.style.display!=='none';
  body.style.display=visible?'none':'block';
  btn.textContent=visible?'‚ñæ Espandi':'‚ñ¥ Chiudi';
}
function showOptTab(tab){
  ['missing','improved','addendum'].forEach(t=>{
    document.getElementById('optPane_'+t).style.display=t===tab?'block':'none';
    const btn=document.getElementById('optTab_'+t);
    if(btn){btn.style.borderColor=t===tab?'var(--purple)':'';btn.style.color=t===tab?'var(--purple)':'';}
  });
}
function applyImprovedPrompt(){
  const val=document.getElementById('optImprovedText').value;
  if(!val)return;
  if(!confirm('Sostituire il prompt di sistema corrente con quello suggerito?'))return;
  document.getElementById('systemPrompt').value=val;
  updateTokenPanel();
}
function applyAddendum(){
  const val=document.getElementById('optAddendumText').value;
  if(!val)return;
  S_optAddendum=val;
  alert('Addendum salvato. Verr√† incluso nella prossima generazione.');
}
async function runPromptOptimizer(){
  const key=document.getElementById('apiKeyInput').value.trim();
  if(!key){document.getElementById('optErr').style.display='block';document.getElementById('optErr').textContent='‚úó Inserisci la API key nella sezione sopra.';return;}
  if(!S.anonText){document.getElementById('optErr').style.display='block';document.getElementById('optErr').textContent='‚úó Nessun testo anonimizzato. Completa prima lo Step 1-2.';return;}
  const btn=document.getElementById('optBtn'),spin=document.getElementById('optSpin');
  btn.disabled=true;spin.style.display='inline-block';
  document.getElementById('optErr').style.display='none';
  document.getElementById('optResults').style.display='none';
  const currentPrompt=document.getElementById('systemPrompt').value||DEFAULT_SYS;
  const useSimilar=document.getElementById('optUseSimilar')?.checked;
  const wantAddendum=document.getElementById('optApplyAddendum')?.checked;
  let similarContext='';
  if(useSimilar&&S.anonText){
    const matches=findSimilarCases(S.anonText).slice(0,1);
    if(matches.length>0){
      const t=matches[0];
      similarContext=`\n\n---\nCASO SIMILE IN LIBRERIA (${t.name}):\n${t.letter?t.letter.slice(0,1200):'(lettera non disponibile)'}\n---`;
    }
  }
  const metaPrompt=`Sei un esperto di prompt engineering per documentazione medica italiana.
Ti viene fornito:
1. Il PROMPT DI SISTEMA attuale usato per generare lettere di dimissione
2. Una CARTELLA CLINICA ANONIMIZZATA di esempio
${similarContext?'3. Una LETTERA DI ESEMPIO da un caso simile in libreria':''}

Il tuo compito √® analizzare e ottimizzare il prompt.

Rispondi SOLO con un oggetto JSON valido con questa struttura esatta:
{
  "missing_sections": "Elenco puntato delle sezioni o istruzioni mancanti nel prompt attuale, basandoti sulla cartella clinica fornita. Sii specifico su cosa manca.",
  "improved_system_prompt": "Il prompt di sistema completo e migliorato, in italiano, incorporando le istruzioni mancanti. Mantieni le regole esistenti e aggiungi quelle necessarie.",
  "user_addendum": "${wantAddendum?'Breve addendum specifico per questo caso (2-5 righe) da aggiungere al prompt utente, con istruzioni su come gestire elementi clinici peculiari di questa cartella.':'(non richiesto)'}"
}

Non aggiungere testo fuori dal JSON.`;
  const userMsg=`PROMPT DI SISTEMA ATTUALE:\n\`\`\`\n${currentPrompt}\n\`\`\`\n\nCARTELLA CLINICA ANONIMIZZATA:\n\`\`\`\n${S.anonText.slice(0,4000)}\n\`\`\`${similarContext}`;
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:2000,temperature:0,system:metaPrompt,messages:[{role:'user',content:userMsg}]}),
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const data=await resp.json();
    const raw=data.content[0].text.trim();
    const cleaned=raw.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    const parsed=JSON.parse(cleaned);
    document.getElementById('optMissingText').textContent=parsed.missing_sections||'(nessuna sezione mancante identificata)';
    document.getElementById('optImprovedText').value=parsed.improved_system_prompt||currentPrompt;
    document.getElementById('optAddendumText').value=parsed.user_addendum&&parsed.user_addendum!=='(non richiesto)'?parsed.user_addendum:'';
    document.getElementById('optResults').style.display='block';
    showOptTab('missing');
  }catch(e){
    document.getElementById('optErr').style.display='block';
    document.getElementById('optErr').textContent='‚úó '+e.message;
  }finally{btn.disabled=false;spin.style.display='none';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('tempSlider').addEventListener('input',function(){
  document.getElementById('tempLabel').textContent=(this.value/10).toFixed(1);
});
document.getElementById('systemPrompt').addEventListener('input',()=>{updateTokenPanel();refreshPrompt();});
loadBaseSettings();
document.getElementById('systemPrompt').value=DEFAULT_SYS;
renderLibrary();
loadNameDictionary();
document.getElementById('panel1').addEventListener('scroll',updateDiffHeight);
window.addEventListener('resize',updateDiffHeight);

</script>
</body>
</html>
