<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lettera.AI â€” Dimissione</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f0f; --surface:#171717; --surface2:#1e1e1e; --surface3:#242424;
  --border:#2a2a2a; --border-hi:#3d3d3d;
  --text:#e8e4dc; --dim:#7a7570; --mid:#b0aa9f;
  --accent:#c9a96e; --accent-d:#7a6340; --accent-g:rgba(201,169,110,0.12);
  --red:#c96e6e; --green:#6ec98a; --blue:#6ea8c9; --purple:#a96ec9; --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:17px;line-height:1.6;min-height:100vh}

.app{display:grid;grid-template-columns:210px 1fr;grid-template-rows:52px 1fr;min-height:100vh}
header{grid-column:1/-1;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px}
.logo{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.14em;color:var(--accent);text-transform:uppercase}
.logo span{color:var(--dim)}
.badge{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);background:var(--surface2);border:1px solid var(--border);padding:3px 10px;border-radius:20px}

aside{background:var(--surface);border-right:1px solid var(--border);padding:14px 0;display:flex;flex-direction:column;gap:1px;overflow-y:auto}
.ns{padding:12px 14px 5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase}
.ni{display:flex;align-items:center;gap:9px;padding:8px 13px;margin:0 5px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);cursor:pointer;border:1px solid transparent;background:transparent;width:calc(100% - 10px);text-align:left;transition:all .12s}
.ni:hover{background:var(--surface2);color:var(--text)}
.ni.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}
.ni.done .sn{background:rgba(110,201,138,.15);border-color:var(--green);color:var(--green)}
.sn{width:17px;height:17px;border-radius:50%;background:var(--surface3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;transition:all .12s}
.ni.active .sn{background:var(--accent-d);border-color:var(--accent);color:var(--accent)}

main{overflow-y:auto;background:var(--bg);display:flex;flex-direction:column}
.panel{display:none;padding:28px 32px;width:100%;flex:1}
.panel.active{display:block}
#panel0.active{display:flex;flex-direction:column;height:calc(100vh - 52px)}

.ptitle{font-size:24px;font-weight:300;margin-bottom:3px;letter-spacing:-.01em}
.psub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:22px;letter-spacing:.06em}

label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;margin-top:16px}
label:first-child{margin-top:0}
textarea,input[type=text],input[type=password]{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;padding:11px 13px;outline:none;transition:border-color .12s}
textarea{resize:vertical}
textarea:focus,input:focus{border-color:var(--accent-d)}
textarea::placeholder,input::placeholder{color:var(--dim)}
select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:10px 12px;outline:none;cursor:pointer}

.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.05em;cursor:pointer;border:1px solid;transition:all .12s;text-transform:uppercase}
.btn-p{background:var(--accent);color:#0f0f0f;border-color:var(--accent)}
.btn-p:hover{background:#dfbb80}
.btn-p:disabled{opacity:.4;cursor:not-allowed}
.btn-g{background:transparent;color:var(--mid);border-color:var(--border)}
.btn-g:hover{background:var(--surface2);color:var(--text);border-color:var(--border-hi)}
.btn-row{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;align-items:center}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.ctitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:11px}

.ib{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);line-height:1.65;margin-bottom:13px}
.ib.red{border-left-color:var(--red)}
.ib.green{border-left-color:var(--green)}
.ib.acc{border-left-color:var(--accent)}
.ib.blue{border-left-color:var(--blue)}
.ib.purple{border-left-color:var(--purple)}

.chip{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.06em;padding:3px 8px;border-radius:20px;text-transform:uppercase}
.c-ok{background:rgba(110,201,138,.12);color:var(--green);border:1px solid rgba(110,201,138,.25)}
.c-w{background:rgba(201,169,110,.12);color:var(--accent);border:1px solid rgba(201,169,110,.25)}
.c-err{background:rgba(201,110,110,.12);color:var(--red);border:1px solid rgba(201,110,110,.25)}
.c-blue{background:rgba(110,168,201,.12);color:var(--blue);border:1px solid rgba(110,168,201,.25)}
.c-purple{background:rgba(169,110,201,.12);color:var(--purple);border:1px solid rgba(169,110,201,.25)}

.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* diff */
.diff-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:13px;align-items:stretch}
.diff-grid > div{display:flex;flex-direction:column;flex:1}
.dlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;padding:2px 6px;background:var(--surface2);border-radius:3px;display:inline-block}
.dtext{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.8;white-space:pre-wrap;overflow-y:auto;min-height:600px}
.redacted{background:rgba(201,110,110,.18);color:var(--red);border-radius:2px;padding:0 2px}

/* boilerplate review */
.bpblock{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 12px;margin-bottom:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);white-space:pre-wrap;line-height:1.6}
.bpblock .bptag{color:var(--accent);font-size:9px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;display:block}

/* replacements */
.rl{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:11px;margin-bottom:11px}
.rtitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.rrow{display:flex;align-items:center;gap:7px;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 0;border-bottom:1px solid var(--border)}
.rrow:last-child{border-bottom:none}
.rorig{color:var(--red);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rarr{color:var(--dim);flex-shrink:0}
.rnew{color:var(--green);flex:1}
.rtype{color:var(--dim);font-size:9px;background:var(--surface3);padding:2px 5px;border-radius:3px;white-space:nowrap}

/* letter */
.paper{background:#faf8f3;color:#1a1a1a;border-radius:var(--r);padding:42px 50px;font-family:'Crimson Pro',Georgia,serif;font-size:15.5px;line-height:1.82;white-space:pre-wrap;border:1px solid #d4d0c8;box-shadow:0 4px 40px rgba(0,0,0,.5);max-height:680px;overflow-y:auto}

/* prompt tabs */
.tabs{display:flex;gap:4px;margin-bottom:8px}
.tab{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 12px;border-radius:var(--r);border:1px solid var(--border);background:transparent;color:var(--mid);cursor:pointer;transition:all .12s;text-transform:uppercase;letter-spacing:.05em}
.tab.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}

.cc{display:none;position:absolute;top:10px;right:10px;background:var(--green);color:#0f0f0f;font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 10px;border-radius:4px;font-weight:600}
.an{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);display:flex;gap:7px;margin-top:8px;line-height:1.5}

/* â”€â”€ TOKEN COST BREAKDOWN â”€â”€ */
.tok-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.tok-row{display:flex;align-items:center;gap:0;font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 0;border-bottom:1px solid var(--border)}
.tok-row:last-child{border-bottom:none;font-weight:600;color:var(--text)}
.tok-label{flex:1;color:var(--mid)}
.tok-bar-wrap{width:180px;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin:0 12px}
.tok-bar{height:100%;border-radius:3px;transition:width .3s}
.tok-val{width:70px;text-align:right;color:var(--dim)}
.tok-cost{width:90px;text-align:right}
.tok-cached{color:var(--blue);font-size:9px;margin-left:5px}
.tok-total-row{margin-top:12px;padding-top:10px;border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tok-total-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 14px;text-align:center}
.tok-total-box .tlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px}
.tok-total-box .tval{font-family:'JetBrains Mono',monospace;font-size:18px;color:var(--accent);font-weight:500}
.tok-total-box .tsub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:2px}
.tok-cache-note{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);margin-top:10px;line-height:1.6}

/* â”€â”€ TEMPLATE LIBRARY â”€â”€ */
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-bottom:14px}
.tpl-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px;cursor:pointer;transition:all .12s;position:relative}
.tpl-card:hover{border-color:var(--border-hi);background:var(--surface3)}
.tpl-card.active-tpl{border-color:var(--accent-d);background:var(--accent-g)}
.tpl-name{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);margin-bottom:4px;font-weight:500}
.tpl-meta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim)}
.tpl-del{position:absolute;top:8px;right:8px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);background:none;border:none;cursor:pointer;padding:2px 5px;border-radius:3px}
.tpl-del:hover{color:var(--red);background:rgba(201,110,110,.1)}
.tpl-tok{display:inline-block;margin-top:4px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);background:var(--surface3);padding:2px 6px;border-radius:3px}
.tpl-cached-badge{display:inline-block;margin-left:4px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--blue);background:rgba(110,168,201,.1);border:1px solid rgba(110,168,201,.2);padding:2px 6px;border-radius:3px}

hr.div{border:none;border-top:1px solid var(--border);margin:18px 0}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:3px}
@media(max-width:640px){.app{grid-template-columns:1fr} aside{display:none} .diff-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">Lettera<span>.</span>AI</div>
  <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);">Generatore Lettera di Dimissione</div>
  <div class="badge" id="statusBadge">â— Pronto</div>
</header>

<aside>
  <div class="ns">Flusso</div>
  <button class="ni active" onclick="goTo(0)" id="nav0"><span class="sn">1</span>Testo Clinico</button>
  <button class="ni" onclick="goTo(1)" id="nav1"><span class="sn">2</span>Anonimizzazione</button>
  <button class="ni" onclick="goTo(2)" id="nav2"><span class="sn">3</span>Generazione</button>
  <button class="ni" onclick="goTo(3)" id="nav3"><span class="sn">4</span>Lettera</button>
  <div class="ns" style="margin-top:14px;">Config</div>
  <button class="ni" onclick="goTo(4)" id="nav4"><span class="sn">âš™</span>Impostazioni</button>
  <button class="ni" onclick="goTo(5)" id="nav5"><span class="sn">ğŸ“š</span>Libreria Stili</button>
</aside>

<main>

<!-- â•â•â• STEP 1 â€” TESTO CLINICO â•â•â• -->
<div class="panel active" id="panel0">
  <div class="ptitle">Testo Clinico</div>
  <div class="psub">// step 01 â€” carica PDF o incolla il testo</div>

  <div class="ib acc">
    Incolla o carica il PDF. Le intestazioni ospedaliere (Regione, AZIENDA, Direttore, metadati paziente, numeri pagina, footer) vengono rimosse automaticamente prima di inviare al modello.
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div class="ctitle">Carica PDF â€” Estrazione Testo Offline</div>
    <div id="pdfDropzone" onclick="document.getElementById('pdfFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:24px 20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handlePdfDrop(event)">
      <input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="handlePdfFile(event)">
      <div style="font-size:24px;margin-bottom:6px;color:var(--dim);">â¬†</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina il PDF</strong> â€” estrazione offline, nessun dato trasmesso
      </div>
    </div>
    <div id="pdfStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="pdfSpin" style="display:none;"></span><span id="pdfStatusTxt"></span>
      </div>
      <div style="background:var(--surface3);border-radius:2px;height:3px;margin-top:6px;overflow:hidden;">
        <div id="pdfBar" style="height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .2s;"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div class="ctitle">Carica Referto Laboratorio XLS / XLSX â€” Opzionale</div>
    <div class="ib acc" style="margin-bottom:10px;">
      I valori vengono estratti e aggiunti al testo clinico. Il file viene letto <strong style="color:var(--text);">localmente</strong> â€” nessun dato trasmesso. Se un esame Ã¨ giÃ  presente nel testo PDF, il modello userÃ  entrambe le fonti e darÃ  prioritÃ  al valore piÃ¹ completo.
    </div>
    <div id="xlsDropzone" onclick="document.getElementById('xlsFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handleXlsDrop(event)">
      <input type="file" id="xlsFileInput" accept=".xls,.xlsx,.csv" style="display:none;" onchange="handleXlsFile(event)">
      <div style="font-size:22px;margin-bottom:5px;color:var(--dim);">ğŸ“Š</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina XLS / XLSX</strong> â€” referto laboratorio completo
      </div>
    </div>
    <div id="xlsStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="xlsSpin" style="display:none;"></span><span id="xlsStatusTxt"></span>
      </div>
    </div>
    <div id="xlsPreview" style="display:none;margin-top:10px;">
      <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px;">Anteprima valori estratti</div>
      <div id="xlsPreviewContent" style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mid);max-height:200px;overflow-y:auto;white-space:pre-wrap;"></div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="clearXls()">âœ• Rimuovi</button>
      </div>
    </div>
  </div>

  <label>Testo Completo del Paziente</label>
  <textarea id="inp_raw" style="flex:1;min-height:200px;" placeholder="Incolla qui il testo copiato dal PDF...&#10;&#10;PuÃ² contenere tutto, incluse intestazioni ospedaliere â€” verranno rimosse automaticamente prima dell'invio."></textarea>

  <label>Diagnosi Principale</label>
  <input type="text" id="inp_diagnosi" placeholder='Es: "Sospetto minor stroke silviano destro a genesi indeterminata"'>

  <div class="btn-row">
    <button class="btn btn-p" onclick="goToAnon()">Avanti â†’ Anonimizza</button>
    <button class="btn btn-g" onclick="clearAll()">âœ• Reset</button>
  </div>
</div>

<!-- â•â•â• STEP 2 â€” ANONIMIZZAZIONE â•â•â• -->
<div class="panel" id="panel1">
  <div class="ptitle">Anonimizzazione</div>
  <div class="psub">// step 02 â€” boilerplate strip â†’ regex offline â†’ revisiona</div>

  <div id="anonStatus" class="card" style="display:flex;align-items:center;gap:10px;padding:12px 14px;">
    <span class="spin" id="anonSpin" style="display:none;"></span>
    <span id="anonStatusTxt" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">Pronto.</span>
  </div>

  <div id="bpReview" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
      <div class="ib acc" style="margin:0;flex:1;">âœ‚ Blocchi boilerplate rimossi â€” <strong style="color:var(--text);">NON inviati al modello</strong>. <span id="bpCount" style="color:var(--accent);"></span></div>
      <button class="btn btn-g" style="font-size:10px;padding:4px 11px;margin-left:10px;flex-shrink:0;" onclick="toggleSection('bpList','bpToggleBtn')" id="bpToggleBtn">â–¼ Mostra</button>
    </div>
    <div id="bpList" style="display:none;"></div>
    <hr class="div">
  </div>

  <div id="repReview" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
      <div class="ib" style="margin:0;flex:1;border-left-color:var(--accent);">{ } Sostituzioni regex offline â€” <strong style="color:var(--text);">identificatori anonimizzati</strong>. <span id="repCount" style="color:var(--accent);"></span></div>
      <button class="btn btn-g" style="font-size:10px;padding:4px 11px;margin-left:10px;flex-shrink:0;" onclick="toggleSection('repList','repToggleBtn')" id="repToggleBtn">â–¼ Mostra</button>
    </div>
    <div id="repList" style="display:none;"></div>
    <hr class="div">
  </div>

  <div class="diff-grid">
    <div>
      <div class="dlabel">Testo originale â€” locale, non inviato</div>
      <div class="dtext" id="origText" style="flex:1;min-height:80vh;overflow-y:auto;">â€”</div>
    </div>
    <div>
      <div class="dlabel">Testo anonimizzato âœ modificabile</div>
      <textarea id="anonText" class="dtext" style="flex:1;min-height:80vh;resize:none;"></textarea>
    </div>
  </div>

  <div class="ib red">âš  Verifica il testo a destra. Correggi manualmente qualsiasi dato rimasto prima di procedere.</div>

  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(0)">â† Indietro</button>
    <button class="btn btn-p" onclick="proceedToGenerate()">Avanti â†’ Genera</button>
  </div>
</div>

<!-- â•â•â• STEP 3 â€” GENERAZIONE â•â•â• -->
<div class="panel" id="panel2">
  <div class="ptitle">Generazione</div>
  <div class="psub">// step 03 â€” stima costo â†’ genera</div>

  <div class="card">
    <div class="ctitle">API Key Anthropic</div>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-...  (solo in memoria di sessione, mai su disco)">
    <div class="an"><span>â„¹</span><span>Usata solo per questa sessione. Mai salvata. Ottenibile su console.anthropic.com.</span></div>
  </div>

  <div class="card">
    <div class="ctitle">Modello & Temperatura</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label>Modello</label>
        <select id="modelSelect" onchange="updateTokenPanel()">
          <option value="claude-haiku-4-5-20251001">claude-haiku-4-5 â€” economico, veloce</option>
          <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6 â€” migliore qualitÃ </option>
        </select>
      </div>
      <div>
        <label>Temperatura â€” <span id="tempLabel">0.1</span></label>
        <input type="range" id="tempSlider" min="0" max="5" value="1" step="1" style="width:100%;accent-color:var(--accent);margin-top:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);display:flex;justify-content:space-between;margin-top:2px;"><span>preciso</span><span>creativo</span></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ RAG MATCH PREVIEW (step 3) â”€â”€ -->
  <div id="ragPreviewGen" style="display:none;" class="card">
    <div class="ctitle">Casi Simili Trovati <span class="chip c-purple" style="margin-left:6px;">RAG auto</span></div>
    <div id="ragMatchesGen"></div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:8px;">Le lettere di questi casi vengono incluse nel prompt come esempi few-shot (con cache). Le cartelle restano locali.</div>
  </div>

  <!-- â”€â”€ LIVE TOKEN COST BREAKDOWN â”€â”€ -->
  <div class="tok-panel" id="tokPanel">
    <div class="ctitle" style="margin-bottom:14px;">
      Stima Token & Costo
      <span id="cacheActiveBadge" class="chip c-blue" style="margin-left:8px;display:none;">âš¡ Cache Attiva</span>
    </div>
    <div id="tokRows">
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);">Completa gli Step 1â€“2 per vedere la stima.</div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">Prompt di Sistema â€” modificabile</div>
    <textarea id="systemPrompt" rows="8" style="font-size:11px;"></textarea>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Prompt Completo</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="refreshPrompt()">â†º Aggiorna</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyFull()">â˜ Tutto</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyUser()">â˜ Solo User</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabFull"   onclick="showTab('full')">Completo</button>
      <button class="tab"        id="tabSystem" onclick="showTab('system')">System</button>
      <button class="tab"        id="tabUser"   onclick="showTab('user')">User</button>
    </div>
    <div style="position:relative;">
      <textarea id="promptView" readonly rows="12" style="font-size:11px;background:var(--surface2);color:var(--dim);cursor:default;"></textarea>
      <div class="cc" id="copyConfirm">âœ“ Copiato!</div>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(1)">â† Indietro</button>
    <button class="btn btn-p" id="genBtn" onclick="generateLetter()">
      <span class="spin" id="genSpin" style="display:none;"></span>
      âœ¦ Genera Lettera
    </button>
  </div>
  <div id="genErr" style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);display:none;"></div>
</div>

<!-- â•â•â• STEP 4 â€” LETTERA â•â•â• -->
<div class="panel" id="panel3">
  <div class="ptitle">Lettera Generata</div>
  <div class="psub">// step 04 â€” revisiona, stampa, copia</div>

  <div class="ib green">âœ“ Sostituisci i placeholder <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[PAZIENTE_NOME]</code>, <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[DATA_NASCITA]</code> ecc. con i dati reali prima di stampare.</div>

  <div id="usageInfo" style="display:none;" class="ib blue"></div>

  <div id="letterOut" class="paper">â€”</div>

  <div class="btn-row" style="margin-top:18px;">
    <button class="btn btn-p" onclick="copyLetter()">â˜ Copia testo</button>
    <button class="btn btn-g" onclick="printLetter()">â™ Stampa / PDF</button>
    <button class="btn btn-g" onclick="newLetter()">â†º Nuova lettera</button>
  </div>
</div>

<!-- â•â•â• STEP 5 â€” IMPOSTAZIONI â•â•â• -->
<div class="panel" id="panel4">
  <div class="ptitle">Impostazioni</div>
  <div class="psub">// config â€” intestazione, firma, regex</div>

  <div class="card">
    <div class="ctitle">Intestazione & Firme</div>
    <label>CittÃ </label><input type="text" id="cfg_citta" placeholder="Es: Padova">
    <label>U.O. / Reparto</label><input type="text" id="cfg_reparto" placeholder="Es: U.O. di Neurologia">
    <label>Firma â€” Medico in Formazione Specialistica</label><input type="text" id="cfg_dott" placeholder="Es: Dott. [COGNOME]">
    <label>Firma â€” Dirigente Medico</label><input type="text" id="cfg_prof" placeholder="Es: Prof. [COGNOME]">
  </div>

  <div class="card">
    <div class="ctitle">Pattern Regex Anonimizzazione Custom</div>
    <div class="ib" style="margin-bottom:10px;">Pattern aggiuntivi in JSON. I pattern base (CF, telefono, date di nascita, titoli+nomi, numeri ricovero) sono giÃ  inclusi. Le date cliniche e i nomi di strutture ospedaliere NON vengono anonimizzati.</div>
    <textarea id="cfg_regex" rows="5" placeholder='[
  {"pattern": "NHI:\\s*[A-Z]{3}\\d{4}", "replace": "[ID_PAZIENTE]"},
  {"pattern": "cartella\\s*n\\.?\\s*\\d+", "replace": "[CARTELLA]"}
]'></textarea>
  </div>

  <div class="btn-row">
    <button class="btn btn-p" onclick="saveBaseSettings()">âœ“ Salva</button>
  </div>
</div>

<!-- â•â•â• STEP 6 â€” LIBRERIA CASI â•â•â• -->
<div class="panel" id="panel5">
  <div class="ptitle">Libreria Casi</div>
  <div class="psub">// casi clinici precedenti â€” RAG + fingerprint + caching</div>

  <div class="ib blue">
    <strong style="color:var(--text);">Come funziona:</strong> ogni caso memorizza la cartella anonimizzata (usata localmente per trovare il caso piÃ¹ simile), la lettera generata (iniettata come esempio few-shot), e un fingerprint stilistico compresso (cacheable). Al momento della generazione, il sistema recupera automaticamente i <strong style="color:var(--text);">1â€“2 casi piÃ¹ simili</strong> al paziente corrente tramite TF-IDF, e li usa come contesto â€” solo le loro <em>lettere</em>, non le cartelle complete. Tutto in localStorage, tutto offline.
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Casi Salvati</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);" id="libStats"></div>
        <label style="display:flex;align-items:center;gap:6px;margin:0;text-transform:none;font-size:11px;cursor:pointer;">
          <input type="checkbox" id="ragToggle" checked style="width:auto;accent-color:var(--blue);">
          <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);">RAG auto</span>
        </label>
      </div>
    </div>
    <div id="tplGrid" class="tpl-grid"></div>
    <div id="noTplMsg" class="ib" style="margin:0;">Nessun caso ancora. Aggiungine uno qui sotto.</div>
  </div>

  <div id="ragPreview" style="display:none;" class="card">
    <div class="ctitle">Casi Recuperati per il Paziente Corrente <span class="chip c-blue" style="margin-left:6px;">RAG</span></div>
    <div id="ragMatches"></div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:8px;">Solo le <em>lettere</em> di questi casi vengono inviate al modello come esempi. Le cartelle restano locali.</div>
  </div>

  <div class="card">
    <div class="ctitle">Aggiungi Caso</div>
    <div class="ib purple" style="margin-bottom:12px;">
      Salva una coppia cartellaâ†’lettera giÃ  elaborata. La cartella serve solo per il matching locale (mai inviata). La lettera viene usata come esempio few-shot. Il fingerprint stilistico viene estratto automaticamente (richiede API key) o puoi saltarlo.
    </div>

    <label>Nome / Etichetta Caso</label>
    <input type="text" id="newTplName" placeholder='Es: "Neurologia â€” Stroke ischemico", "Psichiatria â€” Consulenza BDZ"'>

    <label>Cartella Clinica Anonimizzata <span style="color:var(--dim);font-size:9px;text-transform:none;letter-spacing:0;">(usata solo localmente per RAG â€” non inviata al modello)</span></label>
    <textarea id="newCaseFolder" rows="8" placeholder="Incolla la cartella clinica giÃ  anonimizzata..."></textarea>

    <label>Lettera di Dimissione Corrispondente <span style="color:var(--dim);font-size:9px;text-transform:none;letter-spacing:0;">(questa viene inviata come esempio few-shot)</span></label>
    <textarea id="newCaseLetter" rows="8" placeholder="Incolla la lettera di dimissione giÃ  generata e revisionata per questo caso..."></textarea>

    <div class="btn-row" style="margin-top:12px;">
      <button class="btn btn-g" onclick="autoExtractTemplate()">
        <span class="spin" id="tplExtSpin" style="display:none;"></span>
        âœ¦ Auto-estrai fingerprint (opzionale)
      </button>
      <button class="btn btn-p" onclick="saveNewTemplate()">âœ“ Salva Caso</button>
    </div>
    <div id="tplExtStatus" style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);display:none;"></div>
    <div id="newTplSections" style="margin-top:10px;"></div>
  </div>
</div>

</main>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICING TABLE (per 1M tokens, USD)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRICING = {
  'claude-sonnet-4-6':        { in: 3.00,  in_cache_write: 3.75, in_cache_read: 0.30,  out: 15.00 },
  'claude-haiku-4-5-20251001':{ in: 0.80,  in_cache_write: 1.00, in_cache_read: 0.08,  out: 4.00  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = { rawText:'', cleanText:'', anonText:'', letter:'', strippedBlocks:[], activeTemplateId: null };
let newTplSections = [];

const DEFAULT_SYS = `Sei un assistente esperto in documentazione medica ospedaliera italiana.
Genera una lettera di dimissione strutturata in italiano formale clinico.

REGOLE ASSOLUTE:
- NON inventare, inferire o aggiungere dati clinici non presenti nell'input.
- NON aggiungere diagnosi, valori di laboratorio, farmaci, dosi o date non esplicitamente forniti.
- Se una sezione manca, scrivi: "Non documentato."
- NON usare nomi di pazienti, medici, ospedali o qualsiasi identificativo personale.
- Usa il passato remoto per eventi durante il ricovero.
- Mantieni il registro formale della medicina clinica italiana.
- Segui esattamente la struttura del template fornito.
- Restituisci SOLO la lettera, senza preamboli o commenti.`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTo(i) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  document.getElementById('panel' + i).classList.add('active');
  document.getElementById('nav' + i).classList.add('active');
  if (i === 2) updateTokenPanel();
  if (i === 5) renderLibrary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOILERPLATE STRIPPER â€” FIX: only strip PII headers/footers,
// NOT clinical content, hospital department names, or dates.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOILERPLATE_PATTERNS = [
  // â”€â”€ Regional / company headers â”€â”€
  { re:/^REGIONE\s+DEL\s+\w+[^\n]*/gim,                                            tag:'Intestazione Regione' },
  { re:/^Regione\s+(?:del\s+)?\w[\w\s]*$/gim,                                      tag:'Intestazione Regione' },
  { re:/^AZIENDA\s+OSPEDALE[^\n]*/gim,                                              tag:'Intestazione Azienda' },
  { re:/^AZIENDA\s+OSPEDALIERA[^\n]*/gim,                                           tag:'Intestazione Azienda' },
  { re:/^Azienda\s+Ospedaliera[^\n]*/gim,                                           tag:'Intestazione Azienda' },
  { re:/^AULSS\s*\d*[^\n]*/gim,                                                     tag:'Intestazione AULSS' },
  { re:/^ULSS\s*\d*[^\n]*/gim,                                                      tag:'Intestazione ULSS' },
  // â”€â”€ Dip/DIDAS/Servizi lines â”€â”€
  { re:/^Dip\.?\s+Didattico[^\n]*/gim,                                              tag:'Intestazione Dip' },
  { re:/^Didas\s+[^\n]*/gim,                                                        tag:'Intestazione Didas' },
  { re:/^Servizi\s+di\s+Diagnostica[^\n]*/gim,                                      tag:'Intestazione Servizi' },
  { re:/^U\.O\.(?:C|S|D|SD)?\.?\s+[^\n]{3,60}$/gim,                               tag:'U.O. Reparto' },
  // â”€â”€ Director / responsible lines â”€â”€
  { re:/^Direttore(?:\s+ad\s+interim)?\s*:?[^\n]*/gim,                             tag:'Direttore' },
  { re:/^Responsabile\s*:?[^\n]*/gim,                                               tag:'Responsabile' },
  // â”€â”€ Admission metadata â”€â”€
  { re:/per il ricovero\s+[\d\/x]+\s+in\s+regime\s+\w+[^\n]*/gi,                  tag:'Metadato ricovero' },
  { re:/^Ricovero\s*(?:n\.|numero)?\s*[\d\/x]+[^\n]*/gim,                          tag:'Numero ricovero' },
  { re:/RICOVERO\s+[\dx\/]+[^\n]*/gi,                                               tag:'Numero ricovero' },
  { re:/^Episodio\s+RIC_AO_[^\n]*/gim,                                              tag:'Episodio RIC' },
  { re:/^RIC_AO_[^\r\n]*/gm,                                                        tag:'ID Ricovero' },
  // â”€â”€ Document type headers â”€â”€
  { re:/^LETTERA\s+DI\s+DIMISSIONE\s*$\n?/gim,                                     tag:'Tipo documento' },
  { re:/^Diario\s+clinico\s*$/gim,                                                  tag:'Titolo diario' },
  // â”€â”€ Patient metadata header blocks â”€â”€
  { re:/^Paziente\s*:?\s*[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][^\n]*\n?(?:Data\s+(?:di\s+)?[Nn]ascita\s*:?\s*[^\n]*)?\n?/gim, tag:'Metadato paziente' },
  { re:/^(?:Nominativo|Paziente)\s*:\s*[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,}[^\n]*/gim,              tag:'Metadato paziente' },
  { re:/^Data\s+(?:di\s+)?[Nn]ascita\s*:\s*[^\n]*Sesso[^\n]*/gim,                 tag:'Metadato paziente' },
  { re:/^Anni\s*:\s*\d+[^\n]*/gim,                                                  tag:'Metadato etÃ ' },
  // â”€â”€ Lab report header blocks â”€â”€
  { re:/^Al\s+Medico\s+Curante\s*:?\s*[^\n]*/gim,                                  tag:'Intestazione lab' },
  { re:/^Provenienza\s*:\s*[^\n]*/gim,                                              tag:'Provenienza lab' },
  { re:/^Prelievo\s+del\s*:\s*[^\n]*/gim,                                           tag:'Data prelievo' },
  { re:/^Ricevuto\s+il\s*:\s*[^\n]*/gim,                                            tag:'Data ricezione' },
  { re:/^Referto\s+del\s*:\s*[^\n]*/gim,                                            tag:'Data referto' },
  { re:/^Riferimento\s*:\s*[^\n]*/gim,                                              tag:'Riferimento lab' },
  { re:/^Note\s+dal\s+richiedente[^\n]*/gim,                                        tag:'Note richiedente' },
  { re:/^ASSIPCA\s*:\s*[^\n]*/gim,                                                  tag:'ASSIPCA' },
  { re:/Ric\/Ref\s*:\s*[\d\s\/\-]+[^\n]*/gi,                                       tag:'Ric/Ref' },
  { re:/^Num\.\s+(?:interno|esterno)\s*:\s*[^\n]*/gim,                              tag:'Num. lab' },
  { re:/^Ref\.\s+SSI\s*:\s*[^\n]*/gim,                                              tag:'Ref SSI' },
  // â”€â”€ Page numbers / footers â”€â”€
  { re:/Pagina\s*:\s*\d+[^\n]*/gi,                                                  tag:'Numero pagina' },
  { re:/Pagina\s+\d+\s*(?:di|\/)\s*\d+[^\n]*/gi,                                   tag:'Numero pagina' },
  { re:/Pag\.\s*\d+\s*(?:di|\/)\s*\d+[^\n]*/gi,                                    tag:'Numero pagina' },
  { re:/^(\d+)Page\s+(\d+)\s+of\s+\d+[^\n]*/gim,                                   tag:'Numero pagina' },
  { re:/^Page\s+\d+\s+of\s+\d+[^\n]*/gim,                                           tag:'Numero pagina' },
  // â”€â”€ Document number lines â”€â”€
  { re:/^Documento\s+Numero\s*:?\s*\d*[^\n]*/gim,                                  tag:'Numero documento' },
  { re:/^Versione\s+Referto\s*:\s*\d+[^\n]*/gim,                                   tag:'Versione referto' },
  { re:/^N\.\s+Richiesta\s*:[^\n]*/gim,                                             tag:'N. Richiesta' },
  // â”€â”€ Signing / digital signature lines â”€â”€
  { re:/Lettera\s+di\s+dimissione\s+firmata\s+digitalmente[^\n]*/gi,               tag:'Firma digitale' },
  { re:/(?:Copia\s+di\s+(?:referto|documento)\s+firmato[^\n]*)\n?/gi,              tag:'Nota copia digitale' },
  { re:/I\s+risultati\s+di\s+questo\s+referto[^\n]*/gi,                            tag:'Nota referto' },
  { re:/Rappresentazione\s+di\s+un\s+referto\s+firmato[^\n]*/gi,                   tag:'Nota firma' },
  { re:/Il\s+referto\s+Ã¨\s+conservato[^\n]*/gi,                                    tag:'Nota conservazione' },
  { re:/^Validato\s+da[^\n]*/gim,                                                   tag:'Validazione' },
  { re:/^\*{3}\s*Referto\s+Finale\s*\*{3}[^\n]*/gim,                               tag:'Referto finale' },
  { re:/^Firmato\s+il\s+\d{1,2}\/\d{2}\/\d{4}[^\n]*/gim,                          tag:'Data firma' },
  // â”€â”€ Staff / footer lines â”€â”€
  { re:/^Dirigenti\s+Medici\s*:[^\n]*/gim,                                          tag:'Lista staff' },
  { re:/^(?:Coord(?:inatore)?\s*:|Inf\s*:)[^\n]*/gim,                              tag:'Lista staff' },
  { re:/^Lab\.\s+Neurosonologia[^\n]*/gim,                                          tag:'Footer lab' },
  { re:/^Segreteria\s+interni[^\n]*/gim,                                            tag:'Segreteria' },
  { re:/^(?:Tel|Fax)\s*[\+\d\-\.\s]+$/gim,                                         tag:'Telefono footer' },
  // â”€â”€ Cost / DRG / GDPR notice blocks â”€â”€
  { re:/INFORMAZIONE\s+AI\s+SENSI\s+DELLA\s+DELIBERAZIONE[^\n]*/gi,               tag:'Nota GDPR' },
  { re:/Gentile\s+signore\/signora\s+desideriamo[^\n]*/gi,                          tag:'Nota costi' },
  { re:/impiego\s+di\s+risorse\s+economiche[^\n]*/gi,                              tag:'Nota costi' },
  { re:/(?:DRG|tariffa|rimborso)\s*:?\s*[\d.,â‚¬$]+[^\n]*/gi,                       tag:'Nota costi DRG' },
  { re:/pari\s+ad\s+euro\s+[\d.,]+[^\n]*/gi,                                       tag:'Importo costi' },
  // â”€â”€ Diary table header row â”€â”€
  { re:/^Data\s+nota\s+Nota\s+P\s+Operatore[^\n]*/gim,                             tag:'Header diario' },
  // â”€â”€ Diary timestamp lines (date + time alone on lines) â”€â”€
  { re:/^\d{1,2}\/\d{2}\/\d{4}\n\d{2}:\d{2}(?:\n\d{1,2}\/\d{2}\/\d{4}\n\d{2}:\d{2})?(?:\nMotivo\s+Cancellazione[^\n]*)?\n/gm, tag:'Timestamp diario' },
  // â”€â”€ Vital signs chart footer with names in parentheses â”€â”€
  { re:/(?:\([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\)\s*)+/g, tag:'Operatori grafica' },
  // â”€â”€ Address lines â€” full footer "35128 Padova - Ospedale Civile, Via Giustiniani..." â”€â”€
  { re:/^\d{5}\s+\w[\w\s]+-\s*Ospedale[^\n]*/gim,                               tag:'Footer indirizzo ospedale' },
  { re:/^\d{5}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zA-ZÃ€-Ãº\s]+[-â€“]\s*(?:Via|Viale|Piazza|C\.so)[^\n]*/gim, tag:'Indirizzo' },
  { re:/^(?:Via|Viale|Piazza|C\.so)\s+[^\n]{5,60}$/gim,                          tag:'Indirizzo' },
  { re:/^Azienda\s+Ospedale\s+-\s+UniversitÃ \s+Padova[^\n]*/gim,                 tag:'Footer azienda' },

  // â”€â”€ Standalone all-caps department name on its own line â”€â”€
  { re:/^(?:CLINICA\s+NEUROLOGICA|STROKE\s+UNIT)\s*$/gim,                        tag:'Intestazione reparto' },

  // â”€â”€ Repeated page header: "SCHIAVON GIANFRANCOPaziente: Nato il: ..." â”€â”€
  { re:/^[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20}Paziente:[^\n]*/gim,       tag:'Header paziente ripetuto' },

  // â”€â”€ Patient demographic header lines â”€â”€
  { re:/^Codice\s+fiscale\s*:[^\n]*/gim,                                          tag:'CF header' },
  { re:/^(?:Indirizzo\s+(?:domicilio|residenza)|Indirizzo\s+n\.)\s*:[^\n]*/gim,  tag:'Indirizzo paziente' },
  { re:/^Telefono\s*\d?\s*:[^\n]*/gim,                                            tag:'Telefono paziente' },
  { re:/^MMG\/PLS\s*:[^\n]*/gim,                                                  tag:'MMG header' },
  { re:/\bSSN\s*:\s*\d+/g,                                                        tag:'SSN' },

  // â”€â”€ Rete sociale table header + rows â”€â”€
  { re:/^Rete\s+sociale\s*$/gim,                                                  tag:'Rete sociale' },
  { re:/^Cognome\/Nome\s+Relazione\s+Tipo[^\n]*/gim,                              tag:'Header rete sociale' },

  // â”€â”€ "Stampato il DD/MM/YYYY HH:MM" â”€â”€
  { re:/Stampato\s+il\s+\d{1,2}\/\d{2}\/\d{4}[^\n]*/gi,                         tag:'Data stampa' },

  // â”€â”€ "QUELLO PRESCRITTO DAL MEDICO" â”€â”€
  { re:/^QUELLO\s+PRESCRITTO\s+DAL\s+MEDICO\s*$/gim,                             tag:'Avviso posologia' },

  // â”€â”€ Staff list block: multiple "Dr. / Dr.ssa / Prof." lines in sequence â”€â”€
  { re:/(?:^(?:Dr\.?(?:ssa)?|Prof\.?(?:ssa)?)\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][^\n]*\n){2,}/gm, tag:'Lista medici' },
  // â”€â”€ Legenda / footnote lines â”€â”€
  { re:/^\(P\)\s+Profilo[^\n]*/gim,                                                 tag:'Legenda profilo' },
  { re:/^Data\s+stampa\s*:[^\n]*/gim,                                               tag:'Data stampa' },
  { re:/^L'ORARIO\s+DELLE\s+SOMMINISTRAZIONI[^\n]*/gim,                            tag:'Nota orario' },
  { re:/^Legenda\s+vie\s*:[^\n]*/gim,                                               tag:'Legenda vie' },
  { re:/^SARANNO\s+DISPONIBILI\s+ULTERIORI[^\n]*/gim,                              tag:'Nota completamento' },
  // â”€â”€ Radiology/consult request metadata â”€â”€
  { re:/^Medico\s+[Rr]ichiedente\s*:[^\n]*/gim,                                    tag:'Medico richiedente' },
  { re:/^Quesito\s+[Dd]iagnostico\s*:[^\n]*/gim,                                   tag:'Quesito' },
  { re:/^(?:Equipe|Operatore)\s*:[^\n]*/gim,                                        tag:'Equipe' },
  { re:/^T\.S\.R\.M\.[^\n]*/gim,                                                    tag:'TSRM' },
  { re:/^Documento\s+firmato\s+digitalmente\s+il[^\n]*/gim,                        tag:'Firma digitale' },
  { re:/^Frequenza\s+campionamento[^\n]*/gim,                                       tag:'Parametri ECG' },
  // â”€â”€ Physiatric consult footer â”€â”€
  { re:/^(?:MFS|Dott\.?(?:ssa)?)\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][^\n]{3,60}$/gim,              tag:'Firma fisiatria' },
  { re:/^\d+\/\d+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]+\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]+\s+-\s+\d+\/\d+\/\d+/gm,    tag:'Footer consulenza' },
];

function stripBoilerplate(text) {
  const strippedBlocks = [];
  let result = text;
  for (const p of BOILERPLATE_PATTERNS) {
    result = result.replace(p.re, (match) => {
      const t = match.trim();
      if (t.length > 2 && !strippedBlocks.find(b => b.text === t))
        strippedBlocks.push({ text: t, tag: p.tag });
      return '';
    });
    if (p.re.global) p.re.lastIndex = 0;
  }
  return { clean: result.replace(/\n{3,}/g, '\n\n').trim(), strippedBlocks };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goToAnon() {
  const raw = document.getElementById('inp_raw').value.trim();
  if (!raw && !S_XLS.text) { alert('Incolla il testo clinico o carica un referto XLS nello Step 1.'); return; }
  S.rawText = raw + (S_XLS.text ? '\n\n' + S_XLS.text : '');
  goTo(1);
  runPipeline();
}

function runPipeline() {
  const spin = document.getElementById('anonSpin');
  const stxt = document.getElementById('anonStatusTxt');
  const scard = document.getElementById('anonStatus');
  spin.style.display = 'inline-block';
  stxt.textContent = 'Strip boilerplate + anonimizzazione regex...';
  scard.style.borderColor = 'var(--border)';
  setTimeout(() => {
    const { clean, strippedBlocks } = stripBoilerplate(S.rawText);
    S.cleanText = clean; S.strippedBlocks = strippedBlocks;
    const { text: anonText, reps } = applyRegex(clean);
    renderBoilerplateReview(strippedBlocks);
    renderAnonResult(anonText, reps);
    const saved = S.rawText.length - clean.length;
    stxt.textContent = `âœ“ ${strippedBlocks.length} blocchi boilerplate rimossi (âˆ’${saved} char) Â· ${reps.length} identificatori anonimizzati`;
    scard.style.borderColor = 'var(--green)';
    spin.style.display = 'none';
  }, 60);
}

function toggleSection(listId, btnId) {
  const list = document.getElementById(listId);
  const btn  = document.getElementById(btnId);
  const open = list.style.display === 'none';
  list.style.display = open ? 'block' : 'none';
  btn.textContent = open ? 'â–² Nascondi' : 'â–¼ Mostra';
}

function renderBoilerplateReview(blocks) {
  const wrap  = document.getElementById('bpReview');
  const list  = document.getElementById('bpList');
  const count = document.getElementById('bpCount');
  const btn   = document.getElementById('bpToggleBtn');
  list.style.display = 'none';
  btn.textContent = 'â–¼ Mostra';
  if (!blocks.length) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  count.textContent = blocks.length + ' blocco' + (blocks.length === 1 ? '' : 'chi');
  list.innerHTML = blocks.map(function(b) {
    return '<div class="bpblock"><span class="bptag">âœ‚ ' + esc(b.tag) + '</span>' + esc(b.text) + '</div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGEX ANONYMIZER
// FIX 1: Dates â€” only redact birth dates explicitly, keep all clinical dates.
// FIX 2: Names â€” redact ALL Firstname Lastname patterns including diary headers,
//         staff names in parentheses, etc.
// FIX 3: Lab ranges â€” don't treat "1.7-17" range notation as a date.
// FIX 4: Hospital names â€” keep "Clinica Neurologica", "Ospedale Civile" etc.
//         as non-PII structural terms (they describe ward/location, not patient ID).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyRegex(text) {
  const reps = []; let result = text;

  // â”€â”€ Words that are NEVER names â€” lab tests, drugs, ECG terms, anatomy, clinical terms â”€â”€
  const CLINICAL_WORDS = new Set([
    // Lab test names
    'LEUCOCITI','ERITROCITI','EMOGLOBINA','EMATOCRITO','PIASTRINE','NEUTROFILI','LINFOCITI',
    'MONOCITI','EOSINOFILI','BASOFILI','PROTROMBINA','GLUCOSIO','UREA','CREATININA','SODIO',
    'POTASSIO','CLORO','CALCIO','FOSFATO','FERRO','MAGNESIO','BILIRUBINA','CONIUGATA',
    'ALBUMINA','COLESTEROLO','TRIGLICERIDI','OMOCISTEINA','VITAMINA','FOLATI','TIROXINA',
    'TRIIODOTIRONINA','EMOGLOBINA','GLICATA','PROTEINE','TOTALI','PROTEICO','LIPIDICO',
    'EMATOLOGICO','URINARIO','COAGULAZIONE','EMATOLOGIA','BIOCHIMICI','COSTITUENTI',
    'MICROSCOPICA','CLINICA','ORMONI','METABOLITI','SPECIALI','SIEROIMMUNOLOGICA',
    'BATTERIOLOGICA','INDAGINE','PROFILO','FORMULA','ZONA','ALBUMINICA','DIFFERENZIALE',
    'INORGANICO','FOSFORO','LATTATO','DEIDROGENASI',
    // Lab units / markers
    'LEUCOCITI','ERITROCITI','PIASTRINE','NEUTROFILI','MONOCITI','EOSINOFILI','BASOFILI',
    'APTT','AIFA','RATIO','INR','PCR','MCH','MCV','RDW','LDL','HDL','TSH','FT3','FT4',
    'HBSAG','ACIDO','URICO','FERRITINA','ELETTROFORESI','IMMUNOGLOBULINE',
    // Drug forms / identifiers
    'CAPSULE','COMPRESSE','RIVESTITE','DIVISIBILI','ORODISPERSIBILI','SOLUZIONE','INFUSIONE',
    'INIETTABILE','POLV','PLAST','SACCHE','VIAFLO','BAXTER','RIGIDE','GASTROENTERICHE',
    'GASTRORESISTENTI','RETTALE','ORALE',
    // Drug partial names that are all-caps
    'ELIQUIS','BERBEROL','NEURABEN','DELTACORTENE','TAMSULOSIN','TAMSULOSINA','BISOPROLOLO',
    'RAMIPRIL','SIMVASTATINA','OMEPRAZOLO','PANTOPRAZOLO','LANSOPRAZOLO','LIXIANA','XANAX',
    'LYRICA','NORMIX','ZOLOFT','FUROSEMIDE','LASIX','QUARK','ASPIRIN',
    // ECG / cardiology terms
    'SINUSALE','NORMALE','FIBRILLAZIONE','ATRIALE','VENTRICOLARE','RITMO','FLUTTER',
    'BRADICARDIA','TACHICARDIA','EXTRASISTOLIA','ASHMAN',
    // Anatomy / clinical
    'STROKE','UNIT','NEUROLOGICA','NEUROLOGIA','CARDIOLOGIA','ORTOPEDICA','FISIATRICA',
    'MICROBIOLOGIA','VIROLOGIA','NEURORADIOLOGIA','RADIOLOGIA','PEDIATRICA','LABORATORIO',
    'MEDICINA','SISTEMI','DIAGNOSTICA','INTEGRATA','RIABILITAZIONE',
    // Institutional / org
    'PADOVA','VENETO','REGIONE','AZIENDA','OSPEDALE','UNIVERSITA','CLINICA','REPARTO',
    'STROKE','CERTIFICATO','CERTIQUALITY',
    // Surveillance test
    'ENTEROBACTERALES','ACINETOBACTER','CARBAPENEMI','ENTEROCOCCHI',
    // Misc
    'FINE','DOCUMENTO','PAGINA','FINALE','SARANNO','DISPONIBILI','ULTERIORI',
    'QUELLO','PRESCRITTO','MEDICO','STAMPATO',
    // SGQ / ISO
    'SGQ','UNI','ISO','DPC','SOLO','AIFA',
  ]);

  function isAllCapsName(w1, w2) {
    // Both words must be ALL-CAPS letters only (no digits, no special chars)
    if (!/^[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20}$/.test(w1) || !/^[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20}$/.test(w2)) return false;
    // Reject if either word is a known clinical term
    if (CLINICAL_WORDS.has(w1) || CLINICAL_WORDS.has(w2)) return false;
    // Reject if both are 2-3 chars (likely abbreviations: TV, FC, PA, etc.)
    if (w1.length <= 3 && w2.length <= 3) return false;
    // Reject common 2-letter combos
    if (['FC','PA','TC','RM','SR','CV','BM','BE','EU','OS','PT'].includes(w1)) return false;
    return true;
  }

  const patterns = [

    // â•â• 1. CODICE FISCALE â•â•
    { re:/\b[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]\b/g,
      label:'Codice Fiscale', tag:'[CODICE_FISCALE]' },

    // â•â• 2. SSN / nosografico identifiers â•â•
    { re:/\bSSN\s*:\s*\d+/g,
      label:'SSN', tag:'[ID_PAZIENTE]' },

    // â•â• 3. ADDRESS lines â€” VIA/VIALE/PIAZZA + street name + number â•â•
    { re:/\b(?:VIA|VIALE|PIAZZA|CORSO|C\.SO|LOC\.?)\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][A-ZÃ€-Ãša-zÃ -Ãº\s']{2,40}\s+\d+[\/A-Z]*/g,
      label:'Indirizzo', tag:'[INDIRIZZO]' },
    // City name (PONTE SAN NICOLO' etc.) after address
    { re:/\b(?:Indirizzo\s+(?:domicilio|residenza)\s*:\s*)[^\n]+/gi,
      label:'Indirizzo completo', tag:'' },

    // â•â• 4. INLINE BIRTH DATE BLOCKS â€” "(n. 22/06/1968)", "(d.n.26/05/1941)" â•â•
    { re:/\(\s*(?:[Dd]\.?[Nn]\.?|n\.)\s*\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\s*\)/g,
      label:'Blocco nascita inline', tag:'' },

    // â•â• 5. BIRTH DATES with context â•â•
    { re:/\b(?:nata?\s+(?:il\s+)?|[Dd]ata\s+di\s+[Nn]ascita\s*:?\s*|[Dd]\.?[Nn]\.?\s*:?\s*|nato\/a\s+il\s+|Nato\/a\s+il\s+|[Nn]ato\s+(?:il\s+)?|[Nn]ato\s+in\s+data\s+)\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b/g,
      label:'Data Nascita', tag:'[DATA_NASCITA]' },

    // â•â• 6. PHONE NUMBERS â•â•
    { re:/(?:\+39[\s\-]?|\+039[\s\-]?)?\b0\d{1,4}[\s\-.]?\d{3,4}[\s\-.]?\d{3,5}\b/g,
      label:'Telefono fisso', tag:'[TELEFONO]' },
    { re:/\b3\d{2}[\s\-]?\d{3}[\s\-]?\d{4}\b/g,
      label:'Telefono mobile', tag:'[TELEFONO]' },

    // â•â• 7. EMAIL â•â•
    { re:/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/g,
      label:'Email', tag:'[EMAIL]' },

    // â•â• 8. ADMISSION / RECORD NUMBERS (but NOT "nosografico" clinical usage) â•â•
    { re:/\b(?:cartella|pratica|SDO|scheda)\s*(?:n\.|numero|nr\.?)?\s*[\dx\/]+/gi,
      label:'Nr.Ricovero', tag:'[NR_RICOVERO]' },

    // â•â• 9. PATIENT/STAFF IDs â•â•
    { re:/\b(?:matricola|NPI|NHI|MRN|ASSIPCA)\s*[:\s]+[A-Z0-9\-]+/gi,
      label:'ID', tag:'[ID_PAZIENTE]' },

    // â•â• 10. DIARY HEADER: Firstname\nSurname on two lines + role letter â•â•
    { re:/^([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})\n([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})\n[MITNOF]\b/gm,
      label:'Intestazione diario split', tag:'[MEDICO]' },

    // â•â• 11. DIARY HEADER: FirstnameSurname+role concatenated (no space) â•â•
    // e.g. "Rossana RagoneM", "ValentinaFerreroM", "GiuliaIemmoloI"
    { re:/\b([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})[MITNOF](?=\s|$)/gm,
      label:'Intestazione diario concat', tag:'[MEDICO]' },

    // â•â• 12. NAMES IN PARENTHESES â€” vital signs chart â•â•
    { re:/\(([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})\)/g,
      label:'Operatore in parentesi', tag:'([MEDICO])' },

    // â•â• 13. ALL-CAPS PATIENT/STAFF NAME â€” with clinical-word guard â•â•
    // Only replaces pairs where NEITHER word is a known clinical/drug/lab term
    { re:/\b([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20})\s+([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20})\b/g,
      label:'Nome maiuscolo',
      tag:'[PAZIENTE_NOME]',
      guard: (m, w1, w2) => isAllCapsName(w1, w2) },

    // â•â• 14. PATIENT NAME AFTER COURTESY TITLE â•â•
    { re:/\b(?:sig\.?r?a?\.?|signora?)\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/gi,
      label:'Paziente sig.', tag:'[PAZIENTE_NOME]' },

    // â•â• 15. NAME + AGE ANCHOR â•â•
    { re:/[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}(?:\s*,)?\s+(?:di\s+)?anni\s+\d{1,3}/g,
      label:'Paziente + etÃ ', tag:'[PAZIENTE_NOME]' },

    // â•â• 16. TITLED NAMES â€” Dott./Prof./Dr. etc. â•â•
    { re:/\b(?:Dott(?:\.ssa?|ssa?)?\.?|Prof(?:\.ssa?|ssa?)?\.?|Dr\.?|T\.S\.R\.M\.?|MFS)\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zA-ZÃ€-Ãº.\s]{1,35}(?=[,\n\r;(]|$)/gm,
      label:'Medico con titolo', tag:'[MEDICO]' },

    // â•â• 17. ABBREVIATED TITLED NAMES â€” "Dr. F. Causin", "Prof. R. Manara" â•â•
    { re:/\b(?:Dott(?:\.ssa?)?\.?|Prof(?:\.ssa?)?\.?|Dr\.?)\s+[A-Z]\.\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zA-ZÃ€-Ãº]{1,20}/g,
      label:'Medico abbreviato', tag:'[MEDICO]' },

    // â•â• 18. ALL-CAPS NAMES AFTER LABEL KEYWORDS â•â•
    { re:/(?:Medico\s+[Rr]ichiedente|Firmatario|Operatore|Refertato\s+da)\s*:?\s*[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20}/g,
      label:'Nome dopo etichetta', tag:'[MEDICO]' },

    // â•â• 19. SIGNING PHRASES â•â•
    { re:/(?:lettera\s+(?:di\s+dimissione\s+)?firmata?\s+da|referto\s+firmato\s+(?:digitalmente\s+)?da\s*:?|documento\s+firmato\s+(?:digitalmente\s+)?da\s*:?|Firmatario\s*:)\s*[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/gi,
      label:'Firma documento', tag:'[DOCUMENTO_FIRMATO_DA_MEDICO]' },

    // â•â• 20. CONTEXTUAL NAMES AFTER ROLE PHRASES â•â•
    { re:/(?:refertato\s+da|visitata?\s+da|seguita?\s+da|eseguita?\s+da|firmata?\s+da|compilata?\s+da|dettata?\s+da|[Rr]edatto\s+da|[Cc]omunicato\s+a|con\s+(?:il\s+)?(?:dott|prof)\.?\s*|[Gg]iro\s+visite\s+con\s+(?:prof\.?(?:ssa\s)?|dott\.?(?:ssa\s)?)?)\s*([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}(?:\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})?)/gi,
      label:'Nome contestuale', tag:'[MEDICO]' },

    // â•â• 21. MMG/PLS NAME after label â•â•
    { re:/\b(?:MMG|PLS|MdG|MDG)\s*(?:\/[A-Z]+)?\s*:\s*[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/g,
      label:'MMG/PLS nome', tag:'[MEDICO_CURANTE]' },

    // â•â• 22. RELATIVE/SOCIAL NETWORK NAMES â€” lowercase pairs after relationship keywords â•â•
    // "barbiero laura" â€” mixed/lowercase name pair after social network context
    { re:/(?:^|\n)([a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{2,20}\s+[a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{2,20})(?:\s+(?:Coniuge|Figlio|Figlia|Madre|Padre|Fratello|Sorella|Parente|Sconosciuto))/gm,
      label:'Familiare rete sociale', tag:'[FAMILIARE]' },

    // â•â• 23. NAME SPLIT ACROSS TWO LINES in lab headers â•â•
    { re:/^(?:Sig\.?\s+)?([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš]{2,20})\n([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{2,20})$/gm,
      label:'Nome split riga', tag:'[PAZIENTE_NOME]' },

    // â•â• 24. STANDALONE SINGLE NAME on its own line â•â•
    // Catches "Valentina Ferrero" alone at end of section, "Cosetta Pinzerato" standalone
    { re:/^([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})\s+([A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20})\s*$/gm,
      label:'Nome standalone', tag:'[MEDICO]' },

    // â•â• 25. PATIENT CONTEXT PHRASES â•â•
    { re:/\b(?:il|la|del|della)\s+paziente\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/gi,
      label:'Paziente in contesto', tag:'[PAZIENTE_NOME]' },
    { re:/\bassistit[oa]\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/gi,
      label:'Paziente assistito', tag:'[PAZIENTE_NOME]' },
    { re:/\bricoverat[oa]\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/gi,
      label:'Paziente ricoverato', tag:'[PAZIENTE_NOME]' },
    { re:/\bdimess[oa]\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}\s+[A-ZÃ€ÃˆÃ‰ÃŒÃÃ’Ã“Ã™Ãš][a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº]{1,20}/gi,
      label:'Paziente dimesso', tag:'[PAZIENTE_NOME]' },
  ];

  // Apply custom patterns from settings
  try {
    const raw = document.getElementById('cfg_regex').value.trim();
    if (raw) JSON.parse(raw).forEach(cp =>
      patterns.push({ re: new RegExp(cp.pattern, 'gi'), label:'Custom', tag: cp.replace }));
  } catch(e) {}

  for (const p of patterns) {
    if (p.re.global) p.re.lastIndex = 0;
    result = result.replace(p.re, (match, g1, g2) => {
      // Pattern 13 (ALL-CAPS guard) uses a guard function
      if (p.guard && !p.guard(match, g1, g2)) return match;
      const m = match.trim();
      if (!p.tag) return '';
      if (m.length > 1 && !reps.find(r => r.orig === m))
        reps.push({ orig: m, repl: p.tag, type: p.label });
      return p.tag;
    });
  }

  return { text: result, reps };
}

function renderAnonResult(anonText, reps) {
  document.getElementById('anonText').value = anonText;

  const repReview = document.getElementById('repReview');
  const listEl    = document.getElementById('repList');
  const repCount  = document.getElementById('repCount');
  const btn       = document.getElementById('repToggleBtn');

  // reset toggle state
  listEl.style.display = 'none';
  btn.textContent = 'â–¼ Mostra';

  if (!reps.length) {
    repReview.style.display = 'block';
    repCount.textContent = '0 sostituzioni';
    listEl.innerHTML = '<div class="ib green" style="margin-bottom:4px;">âœ“ Nessun identificatore rilevato dai pattern base. Verifica manualmente.</div>';
  } else {
    repReview.style.display = 'block';
    repCount.textContent = reps.length + ' sostituzion' + (reps.length === 1 ? 'e' : 'i');
    let h = '<div class="rl"><div class="rtitle">' + reps.length + ' sostituzion' + (reps.length === 1 ? 'e' : 'i') + ' <span class="chip c-w" style="margin-left:6px;">{ } Regex Offline</span></div>';
    for (const r of reps)
      h += '<div class="rrow"><span class="rorig">' + esc(r.orig) + '</span><span class="rarr">â†’</span><span class="rnew">' + esc(r.repl) + '</span><span class="rtype">' + r.type + '</span></div>';
    h += '</div>';
    listEl.innerHTML = h;
  }

  let hi = esc(S.cleanText);
  for (const r of reps)
    hi = hi.replace(new RegExp(escR(esc(r.orig)), 'g'), '<span class="redacted">' + esc(r.orig) + '</span>');
  document.getElementById('origText').innerHTML = hi;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMPLATE LIBRARY (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadLibrary() {
  try { return JSON.parse(localStorage.getItem('letteraai_lib') || '[]'); } catch(e) { return []; }
}
function saveLibrary(lib) {
  localStorage.setItem('letteraai_lib', JSON.stringify(lib));
}

function renderLibrary() {
  const lib = loadLibrary();
  const grid = document.getElementById('tplGrid');
  const noMsg = document.getElementById('noTplMsg');
  const stats = document.getElementById('libStats');
  const totalFpTok = lib.reduce((a,t) => a + tok(t.fingerprint||''), 0);
  const totalLetTok = lib.reduce((a,t) => a + tok(t.letter||''), 0);
  stats.textContent = `${lib.length} casi Â· fingerprint ~${totalFpTok} tok Â· lettere ~${totalLetTok} tok`;
  if (!lib.length) { grid.innerHTML=''; noMsg.style.display='block'; return; }
  noMsg.style.display = 'none';
  grid.innerHTML = lib.map(t => {
    const fpTok  = tok(t.fingerprint||'');
    const letTok = tok(t.letter||'');
    const folTok = tok(t.folder||'');
    const isActive = S.activeTemplateId === t.id;
    return `<div class="tpl-card${isActive?' active-tpl':''}" onclick="selectTemplate('${t.id}')">
      <button class="tpl-del" onclick="event.stopPropagation();deleteTemplate('${t.id}')">âœ•</button>
      <div class="tpl-name">${esc(t.name)}</div>
      <div class="tpl-meta" style="margin-bottom:6px;">${new Date(t.createdAt).toLocaleDateString('it-IT')}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        ${t.folder?`<span class="chip c-w">ğŸ“ cartella ~${folTok}t</span>`:''}
        ${t.letter?`<span class="chip c-ok">ğŸ“„ lettera ~${letTok}t</span>`:''}
        ${t.fingerprint?`<span class="tpl-cached-badge">âš¡ fp ~${fpTok}t</span>`:''}
      </div>
    </div>`;
  }).join('');
  updateRagPreview();
}

function selectTemplate(id) {
  S.activeTemplateId = (S.activeTemplateId === id) ? null : id;
  renderLibrary();
  updateTokenPanel();
  const lib = loadLibrary();
  const t = lib.find(x => x.id === id);
  document.getElementById('statusBadge').textContent =
    (t && S.activeTemplateId === id) ? `ğŸ“š ${t.name}` : 'â— Pronto';
}

function deleteTemplate(id) {
  if (!confirm('Eliminare questo caso?')) return;
  if (S.activeTemplateId === id) S.activeTemplateId = null;
  saveLibrary(loadLibrary().filter(t => t.id !== id));
  renderLibrary();
  updateTokenPanel();
}

function getActiveFingerprint() {
  if (!S.activeTemplateId) return '';
  const t = loadLibrary().find(x => x.id === S.activeTemplateId);
  return t ? (t.fingerprint || '') : '';
}

// â”€â”€â”€ TF-IDF RAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STOPWORDS_IT = new Set(['il','la','lo','i','gli','le','un','una','uno','dei','delle','degli',
  'di','da','in','con','su','per','tra','fra','a','al','alla','allo','ai','alle','agli',
  'del','della','dello','e','ed','o','ma','se','non','si','che','Ã¨','era','sono','stato',
  'stata','stati','state','ha','hanno','ho','nei','nelle','negli','nel','nella','nello',
  'questo','questa','questi','queste','come','piÃ¹','anche','dopo','prima','durante','presso',
  'viene','veniva','venivano','al','dal','dai','dalle','dagli']);

function tokenizeForTfidf(text) {
  return text.toLowerCase()
    .replace(/\[[\w_]+\]/g, '')
    .replace(/[^a-zÃ Ã¨Ã©Ã¬Ã­Ã²Ã³Ã¹Ãº\s]/g, ' ')
    .split(/\s+/)
    .filter(w => w.length > 3 && !STOPWORDS_IT.has(w));
}

function buildTfIdf(docs) {
  const N = docs.length;
  const df = {};
  for (const d of docs)
    for (const w of new Set(d)) df[w] = (df[w]||0) + 1;
  return docs.map(tokens => {
    const tf = {};
    for (const w of tokens) tf[w] = (tf[w]||0) + 1;
    const vec = {};
    for (const [w, c] of Object.entries(tf))
      vec[w] = (c / tokens.length) * Math.log((N + 1) / ((df[w]||0) + 1));
    return vec;
  });
}

function cosineSim(a, b) {
  let dot = 0, na = 0, nb = 0;
  for (const [w, v] of Object.entries(a)) { dot += v * (b[w]||0); na += v*v; }
  for (const v of Object.values(b)) nb += v*v;
  return (na && nb) ? dot / (Math.sqrt(na) * Math.sqrt(nb)) : 0;
}

function findSimilarCases(queryText, topK = 2) {
  const lib = loadLibrary().filter(t => t.folder && t.letter);
  if (!lib.length) return [];
  const queryToks = tokenizeForTfidf(queryText);
  const allDocs = [queryToks, ...lib.map(t => tokenizeForTfidf(t.folder))];
  const vecs = buildTfIdf(allDocs);
  const queryVec = vecs[0];
  const scored = lib.map((t, i) => ({ t, score: cosineSim(queryVec, vecs[i+1]) }));
  scored.sort((a,b) => b.score - a.score);
  return scored.slice(0, topK).filter(x => x.score > 0.05);
}

function updateRagPreview() {
  const ragOn = document.getElementById('ragToggle')?.checked;
  const matches = (ragOn && S.anonText) ? findSimilarCases(S.anonText) : [];

  const preview = document.getElementById('ragPreview');
  const matchesEl = document.getElementById('ragMatches');
  if (preview) {
    if (!matches.length || !S.anonText) { preview.style.display='none'; }
    else {
      preview.style.display='block';
      matchesEl.innerHTML = matches.map(({t,score}) => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
          <div style="flex:1;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);">${esc(t.name)}</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:2px;">lettera: ~${tok(t.letter||'')} tok</div>
          </div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--blue);">${(score*100).toFixed(0)}%</div>
        </div>`).join('');
    }
  }

  const previewGen = document.getElementById('ragPreviewGen');
  const matchesGen = document.getElementById('ragMatchesGen');
  if (previewGen) {
    if (!matches.length || !S.anonText) { previewGen.style.display='none'; }
    else {
      previewGen.style.display='block';
      matchesGen.innerHTML = matches.map(({t,score}) => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
          <div style="flex:1;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);">${esc(t.name)}</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:2px;">lettera ~${tok(t.letter||'')} tok Â· cartella locale ~${tok(t.folder||'')} tok (non inviata)</div>
          </div>
          <div style="text-align:right;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--blue);">${(score*100).toFixed(0)}%</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);">similaritÃ </div>
          </div>
        </div>`).join('');
    }
  }
}

// â”€â”€â”€ New case builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteNewTplSection(id) {
  newTplSections = newTplSections.filter(s => s.id !== id);
  renderNewTplSections();
}
function renderNewTplSections() {
  const el = document.getElementById('newTplSections');
  if (!newTplSections.length) { el.innerHTML=''; return; }
  el.innerHTML = `<div style="margin-top:10px;"><div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Fingerprint stilistico estratto</div>`
    + newTplSections.map(s => `
    <div style="margin-bottom:8px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;">
        <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.08em;">${esc(s.label)}</span>
        <button style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--red);cursor:pointer;background:none;border:none;" onclick="deleteNewTplSection('${s.id}')">âœ•</button>
      </div>
      <textarea rows="2" style="font-size:11px;margin-top:0;" oninput="updateNewTplSection('${s.id}',this.value)">${esc(s.text||'')}</textarea>
    </div>`).join('')
    + `</div>`;
}
function updateNewTplSection(id, val) {
  const s = newTplSections.find(x => x.id === id);
  if (s) s.text = val;
}
function buildFingerprintFromSections(sections) {
  const active = sections.filter(s => s.text && s.text.trim());
  if (!active.length) return '';
  return active.map(s => `[${s.label}]\n${s.text.trim()}`).join('\n\n');
}

async function autoExtractTemplate() {
  const key = document.getElementById('apiKeyInput').value.trim();
  const letter = document.getElementById('newCaseLetter').value.trim();
  if (!letter) { alert('Incolla prima la lettera nel campo sopra.'); return; }
  if (!key)    { alert('Inserisci la API key nella sezione Generazione.'); return; }

  const spin = document.getElementById('tplExtSpin');
  const status = document.getElementById('tplExtStatus');
  spin.style.display = 'inline-block';
  status.style.display = 'block';
  status.style.color = 'var(--mid)';
  status.textContent = 'Estrazione fingerprint con Haiku...';

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{ 'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true' },
      body: JSON.stringify({
        model:'claude-haiku-4-5-20251001', max_tokens:500,
        system:`Estrai lo stile di scrittura da una lettera di dimissione medica italiana.
Restituisci SOLO JSON con queste chiavi (solo quelle presenti):
{"apertura":"frase tipo apertura (max 2 righe)","decorso":"1-2 frasi tipo del decorso","terapia":"1 riga tipo presentazione terapia","chiusura":"frase tipo chiusura (max 2 righe)"}
REGOLE: solo stile/registro, NON dati clinici reali. Sostituisci dati specifici con [...]. Solo JSON nudo, nessun testo extra.`,
        messages:[{ role:'user', content:`Lettera:\n\n${letter}` }],
      }),
    });
    if (!resp.ok) { const e = await resp.json(); throw new Error(e.error?.message||`HTTP ${resp.status}`); }
    const raw = (await resp.json()).content[0].text;
    const parsed = JSON.parse(raw.replace(/```json|```/g,'').trim());
    const map = { apertura:'Apertura', decorso:'Decorso tipo', terapia:'Terapia tipo', chiusura:'Chiusura' };
    newTplSections = [];
    for (const [k,label] of Object.entries(map))
      if (parsed[k]) newTplSections.push({ id:'ntpl_'+Date.now()+'_'+k, label, text:parsed[k] });
    renderNewTplSections();
    const origTok = tok(letter);
    const newTok  = tok(buildFingerprintFromSections(newTplSections));
    status.style.color='var(--green)';
    status.textContent=`âœ“ Fingerprint estratto Â· da ~${origTok} a ~${newTok} token (âˆ’${Math.round((1-newTok/origTok)*100)}%)`;
  } catch(err) {
    status.style.color='var(--red)'; status.textContent='âœ— '+err.message;
  } finally { spin.style.display='none'; }
}

function saveNewTemplate() {
  const name   = document.getElementById('newTplName').value.trim();
  const folder = document.getElementById('newCaseFolder').value.trim();
  const letter = document.getElementById('newCaseLetter').value.trim();
  if (!name)   { alert('Inserisci un nome per il caso.'); return; }
  if (!letter) { alert('La lettera di dimissione Ã¨ obbligatoria.'); return; }
  const fp = buildFingerprintFromSections(newTplSections);
  const lib = loadLibrary();
  lib.push({ id:'tpl_'+Date.now(), name, folder, letter, fingerprint: fp, createdAt: new Date().toISOString() });
  saveLibrary(lib);
  newTplSections = [];
  renderNewTplSections();
  document.getElementById('newTplName').value = '';
  document.getElementById('newCaseFolder').value = '';
  document.getElementById('newCaseLetter').value = '';
  document.getElementById('tplExtStatus').style.display = 'none';
  renderLibrary();
  alert(`Caso "${name}" salvato.${!folder?' Nota: senza cartella questo caso non parteciperÃ  al RAG automatico.':''}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN BREAKDOWN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tok(str) { return Math.round((str||'').length / 4); }

function updateTokenPanel() {
  if (!S.anonText) return;
  const model = document.getElementById('modelSelect').value;
  const price = PRICING[model] || PRICING['claude-sonnet-4-6'];
  const sysTxt   = document.getElementById('systemPrompt').value || DEFAULT_SYS;
  const fp       = getActiveFingerprint();
  const ragOn    = document.getElementById('ragToggle')?.checked;
  const ragMatches = (ragOn && S.anonText) ? findSimilarCases(S.anonText) : [];
  const templateTxt = buildLetterTemplate();
  const clinical = S.anonText;

  const tSys      = tok(sysTxt);
  const tFp       = tok(fp);
  const tRag      = ragMatches.reduce((a,{t}) => a + tok(t.letter||''), 0);
  const tTemplate = tok(templateTxt);
  const tClinical = tok(clinical);
  const tOut      = 900;
  const tCacheableBlock = tFp + tRag;
  const tTotal    = tSys + tFp + tRag + tTemplate + tClinical;

  const cacheActive = tCacheableBlock > 0;

  const costNoCacheIn        = (tTotal / 1e6) * price.in;
  const costCacheWrite       = cacheActive ? (tCacheableBlock / 1e6) * price.in_cache_write : 0;
  const costCacheRead        = cacheActive ? (tCacheableBlock / 1e6) * price.in_cache_read  : 0;
  const costNonCached        = ((tSys + tTemplate + tClinical) / 1e6) * price.in;
  const costWithCacheFirst   = costCacheWrite + costNonCached;
  const costWithCacheSubseq  = costCacheRead  + costNonCached;
  const costOut              = (tOut / 1e6) * price.out;

  const sections = [
    { label:'System Prompt',                tokens: tSys,      color:'#7a6340', cached:false },
    { label:'Fingerprint Stile',            tokens: tFp,       color:'#6ea8c9', cached:cacheActive && tFp>0 },
    { label:`Esempi RAG (${ragMatches.length} casi)`, tokens: tRag, color:'#a96ec9', cached:cacheActive && tRag>0 },
    { label:'Template lettera',             tokens: tTemplate, color:'#7a7570', cached:false },
    { label:'Testo clinico',                tokens: tClinical, color:'#c9a96e', cached:false },
    { label:'Output stimato',               tokens: tOut,      color:'#6ec98a', cached:false },
  ].filter(s => s.tokens > 0);

  const maxTok = Math.max(...sections.map(s=>s.tokens), 1);

  let html = `<div style="margin-bottom:12px;">`;
  for (const s of sections) {
    const pct = Math.round((s.tokens/maxTok)*100);
    const unitPrice = s.label==='Output stimato' ? price.out : price.in;
    const costStr = `$${((s.tokens/1e6)*unitPrice).toFixed(4)}`;
    html += `<div class="tok-row">
      <span class="tok-label">${s.label}${s.cached?`<span class="tok-cached">âš¡ cached</span>`:''}</span>
      <div class="tok-bar-wrap"><div class="tok-bar" style="width:${pct}%;background:${s.color};"></div></div>
      <span class="tok-val">${s.tokens.toLocaleString()} tok</span>
      <span class="tok-cost" style="color:${s.cached?'var(--blue)':'var(--dim)'};">${costStr}</span>
    </div>`;
  }
  html += `</div>`;

  html += `<div class="tok-total-row">
    <div class="tok-total-box">
      <div class="tlabel">Senza caching</div>
      <div class="tval">$${(costNoCacheIn+costOut).toFixed(4)}</div>
      <div class="tsub">${(tTotal+tOut).toLocaleString()} token totali</div>
    </div>
    <div class="tok-total-box" style="${cacheActive?'border-color:var(--blue);':''}">
      <div class="tlabel">${cacheActive?'Con caching (1Âª chiamata)':'Con caching (nessun caso/template)'}</div>
      <div class="tval" style="color:${cacheActive?'var(--blue)':'var(--accent)'};">$${(costWithCacheFirst+costOut).toFixed(4)}</div>
      <div class="tsub">${cacheActive?`Successive: $${(costWithCacheSubseq+costOut).toFixed(4)}`:'Seleziona un caso o aggiungi cartelle'}</div>
    </div>
  </div>`;

  if (cacheActive) {
    const saving = costNoCacheIn > 0 ? ((costNoCacheIn - costWithCacheSubseq) / costNoCacheIn * 100).toFixed(0) : 0;
    const ragNote = ragMatches.length ? ` + ${ragMatches.length} lettera${ragMatches.length>1?'e':''} RAG (${tRag} tok)` : '';
    html += `<div class="tok-cache-note">âš¡ Cache attiva â€” fingerprint${ragNote} = ${tCacheableBlock} token cacheable. Dalla 2Âª chiamata risparmio stimato: <strong>${saving}%</strong> sul costo input.</div>`;
  }

  document.getElementById('tokRows').innerHTML = html;
  document.getElementById('cacheActiveBadge').style.display = cacheActive ? 'inline-flex' : 'none';
  updateRagPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMPT BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLetterTemplate() {
  const citta    = (document.getElementById('cfg_citta').value    || 'Padova').trim();
  const dott     = (document.getElementById('cfg_dott').value     || 'Dott. [NOME]').trim();
  const prof     = (document.getElementById('cfg_prof').value     || 'Prof. [NOME]').trim();
  const diagnosi = document.getElementById('inp_diagnosi').value.trim() || '[DIAGNOSI_PRINCIPALE]';
  const today    = new Date().toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
  return `## TEMPLATE LETTERA DI DIMISSIONE

Genera la lettera seguendo ESATTAMENTE questa struttura. Per dati assenti: "Non documentato." â€” MAI inventare.

---
${citta}, ${today}

All'attenzione del Medico Curante

Egregio Collega,
        dimettiamo in data odierna la Sua Assistita, [PAZIENTE_NOME], nata in data [DATA_NASCITA], ricoverata presso la nostra Clinica dal [DATA_RICOVERO] u.s., con diagnosi di:

"${diagnosi}"

**Motivo del ricovero**
[Prosa continua, passato remoto â€” dati di presentazione dall'input]

**Non farmacoallergie note.** [oppure allergie se documentate]

**Terapia domiciliare**: [farmaci pre-ricovero dall'input]

**Anamnesi Patologica Remota**
[Trattini per voce â€” dati APR dall'input]

**Anamnesi Fisiologica/Sociale/Familiare**
[Prosa concisa â€” dati dall'input]

**Esame neurologico all'ingresso**: [se presente â€” ometti altrimenti]

**Esame obiettivo generale all'ingresso**: [se presente â€” ometti altrimenti]

Durante la degenza sono stati eseguiti i seguenti **esami di laboratorio:**
[Lista â€” mantieni valori numerici esatti dall'input]

ed i seguenti **accertamenti strumentali** e **valutazioni specialistiche**:
[Lista â€” mantieni date e referti esatti dall'input]

**Decorso clinico**
[Prosa clinica 150-300 parole, passato remoto, sintesi cronologica dell'input]

Alla dimissione [condizioni cliniche alla dimissione].

**Terapia alla dimissione:**
[Trascrivi ultima terapia dall'input â€” farmaco, dose, frequenza]

[Follow-up e accertamenti pendenti dall'input]

Si prega di presentarsi muniti degli appositi foglietti azzurri allegati.

SarÃ  nostra cura fornire gli esiti mediante Lettera di Completamento.

[Raccomandazioni specifiche se presenti nell'input]

Ringraziando per la collaborazione, rimaniamo a disposizione. Cordiali saluti.

${dott.padEnd(46)}${prof}
(Medico in formazione specialistica)${' '.repeat(14)}(Dirigente Medico)
---`;
}

function buildMessages() {
  const fp = getActiveFingerprint();
  const ragOn = document.getElementById('ragToggle')?.checked;
  const ragMatches = (ragOn && S.anonText) ? findSimilarCases(S.anonText) : [];
  const blocks = [];

  if (fp) {
    blocks.push({ type:'text', text:
      `## RIFERIMENTO STILISTICO â€” frasi-chiave del tuo stile (NON dati clinici reali)\n\n${fp}\n\n---\n\n`,
      cache_control:{ type:'ephemeral' }
    });
  }

  if (ragMatches.length) {
    let ragBlock = `## ESEMPI DI RIFERIMENTO â€” casi clinici simili giÃ  elaborati\n\nUsa questi esempi come riferimento per stile, struttura e ragionamento clinico. NON copiare dati clinici specifici.\n\n`;
    ragMatches.forEach(({t, score}, i) => {
      ragBlock += `### Esempio ${i+1} â€” ${t.name} (similaritÃ  ${(score*100).toFixed(0)}%)\n\n${t.letter}\n\n---\n\n`;
    });
    blocks.push({ type:'text', text: ragBlock, cache_control:{ type:'ephemeral' } });
  }

  blocks.push({ type:'text', text:
    `## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n` +
    buildLetterTemplate()
  });

  const useCache = fp || ragMatches.length;
  return [{ role:'user', content: useCache ? blocks : blocks.map(b => b.text).join('') }];
}

function buildUserPromptStr() {
  const fp = getActiveFingerprint();
  const ragOn = document.getElementById('ragToggle')?.checked;
  const ragMatches = (ragOn && S.anonText) ? findSimilarCases(S.anonText) : [];
  let p = '';
  if (fp) p += `## RIFERIMENTO STILISTICO\n\n${fp}\n\n---\n\n`;
  if (ragMatches.length) {
    p += `## ESEMPI DI RIFERIMENTO â€” casi simili\n\n`;
    ragMatches.forEach(({t,score},i) => {
      p += `### Esempio ${i+1} â€” ${t.name} (${(score*100).toFixed(0)}%)\n\n${t.letter}\n\n---\n\n`;
    });
  }
  p += `## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n`;
  p += buildLetterTemplate();
  return p;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCEED TO GENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function proceedToGenerate() {
  S.anonText = document.getElementById('anonText').value;
  if (!S.anonText.trim()) { alert('Nessun testo. Torna allo Step 1.'); return; }
  if (!document.getElementById('systemPrompt').value.trim())
    document.getElementById('systemPrompt').value = DEFAULT_SYS;
  goTo(2);
  updateRagPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateLetter() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key)        { showErr('Inserisci la API key Anthropic.'); return; }
  if (!S.anonText) { showErr('Nessun testo anonimizzato.'); return; }

  const btn = document.getElementById('genBtn');
  const spin = document.getElementById('genSpin');
  btn.disabled = true; spin.style.display = 'inline-block';
  document.getElementById('genErr').style.display = 'none';
  document.getElementById('statusBadge').textContent = 'âŸ³ Generando...';

  const fp = getActiveFingerprint();
  const ragOn = document.getElementById('ragToggle')?.checked;
  const ragMatches = (ragOn && S.anonText) ? findSimilarCases(S.anonText) : [];
  const useCache = fp || ragMatches.length > 0;
  const headers = {
    'Content-Type':'application/json','x-api-key':key,
    'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true',
  };
  if (useCache) headers['anthropic-beta'] = 'prompt-caching-2024-07-31';

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers,
      body: JSON.stringify({
        model:       document.getElementById('modelSelect').value,
        max_tokens:  8192,
        temperature: parseInt(document.getElementById('tempSlider').value) / 10,
        system: [{ type:'text', text: document.getElementById('systemPrompt').value || DEFAULT_SYS,
                   ...(useCache ? { cache_control:{ type:'ephemeral' } } : {}) }],
        messages: buildMessages(),
      }),
    });

    if (!resp.ok) { const e = await resp.json(); throw new Error(e.error?.message || `HTTP ${resp.status}`); }
    const data = await resp.json();
    S.letter = data.content[0].text;

    const u = data.usage || {};
    const model = document.getElementById('modelSelect').value;
    const price = PRICING[model] || PRICING['claude-sonnet-4-6'];
    const inCost   = ((u.input_tokens||0)/1e6)*price.in;
    const cacheCr  = ((u.cache_creation_input_tokens||0)/1e6)*price.in_cache_write;
    const cacheRd  = ((u.cache_read_input_tokens||0)/1e6)*price.in_cache_read;
    const outCost  = ((u.output_tokens||0)/1e6)*price.out;
    const total    = inCost + cacheCr + cacheRd + outCost;

    const usageEl = document.getElementById('usageInfo');
    usageEl.style.display = 'block';
    usageEl.innerHTML = `âœ“ Costo reale â€” input: ${u.input_tokens||0} tok ($${inCost.toFixed(4)})` +
      (u.cache_creation_input_tokens ? ` Â· cache write: ${u.cache_creation_input_tokens} tok ($${cacheCr.toFixed(4)})` : '') +
      (u.cache_read_input_tokens ? ` Â· cache read: ${u.cache_read_input_tokens} tok ($${cacheRd.toFixed(4)})` : '') +
      ` Â· output: ${u.output_tokens||0} tok ($${outCost.toFixed(4)}) â€” <strong style="color:var(--text);">totale: $${total.toFixed(4)}</strong>`;

    document.getElementById('letterOut').textContent = S.letter;
    document.getElementById('statusBadge').textContent = 'âœ“ Lettera generata';
    document.getElementById('nav3').classList.add('done');
    goTo(3);

  } catch(err) {
    showErr('âœ— ' + err.message);
    document.getElementById('statusBadge').textContent = 'âœ— Errore';
  } finally { btn.disabled=false; spin.style.display='none'; }
}

function showErr(msg) {
  const el = document.getElementById('genErr');
  el.textContent = msg; el.style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMPT VIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pTab = 'full', pSys = '', pUsr = '';

function showTab(t) {
  pTab = t;
  ['full','system','user'].forEach(id =>
    document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)).classList.toggle('active', id===t));
  renderPromptView();
}

function renderPromptView() {
  const el = document.getElementById('promptView');
  if (!pSys && !pUsr) return;
  if (pTab==='full')
    el.value = 'â•â• SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n'+pSys+'\n\nâ•â• USER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n'+pUsr;
  else if (pTab==='system') el.value = pSys;
  else el.value = pUsr;
}

function refreshPrompt() {
  if (!S.anonText) { document.getElementById('promptView').value = 'Completa gli Step 1â€“2.'; return; }
  pSys = document.getElementById('systemPrompt').value || DEFAULT_SYS;
  pUsr = buildUserPromptStr();
  renderPromptView();
  updateTokenPanel();
}

async function copyFull() {
  refreshPrompt();
  const txt = pTab==='full'
    ? 'â•â• SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n'+pSys+'\n\nâ•â• USER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n'+pUsr
    : document.getElementById('promptView').value;
  await navigator.clipboard.writeText(txt); flash();
}
async function copyUser() { refreshPrompt(); await navigator.clipboard.writeText(pUsr); flash(); }
function flash() {
  const el = document.getElementById('copyConfirm');
  el.style.display='block'; setTimeout(()=>el.style.display='none', 1600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OUTPUT ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyLetter() { navigator.clipboard.writeText(S.letter).then(()=>alert('Copiato.')); }
function printLetter() {
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Lettera di Dimissione</title>
    <style>body{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.8;margin:2.5cm;color:#000}pre{white-space:pre-wrap;font-family:inherit}</style>
  </head><body><pre>${esc(S.letter)}</pre></body></html>`);
  w.document.close(); w.print();
}
function newLetter() {
  if (!confirm('Nuova lettera? I dati correnti andranno persi.')) return;
  S.rawText=S.cleanText=S.anonText=S.letter=''; S.strippedBlocks=[];
  document.getElementById('inp_raw').value='';
  document.getElementById('inp_diagnosi').value='';
  document.getElementById('letterOut').textContent='â€”';
  document.getElementById('usageInfo').style.display='none';
  document.getElementById('statusBadge').textContent = S.activeTemplateId ? 'ğŸ“š Template attivo' : 'â— Pronto';
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('done'));
  goTo(0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveBaseSettings() {
  localStorage.setItem('letteraai_cfg', JSON.stringify({
    citta:   document.getElementById('cfg_citta').value,
    reparto: document.getElementById('cfg_reparto').value,
    dott:    document.getElementById('cfg_dott').value,
    prof:    document.getElementById('cfg_prof').value,
    regex:   document.getElementById('cfg_regex').value,
  }));
  alert('Impostazioni salvate.');
}
function loadBaseSettings() {
  try {
    const c = JSON.parse(localStorage.getItem('letteraai_cfg')||'{}');
    if(c.citta)   document.getElementById('cfg_citta').value    = c.citta;
    if(c.reparto) document.getElementById('cfg_reparto').value  = c.reparto;
    if(c.dott)    document.getElementById('cfg_dott').value     = c.dott;
    if(c.prof)    document.getElementById('cfg_prof').value     = c.prof;
    if(c.regex)   document.getElementById('cfg_regex').value    = c.regex;
  } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escR(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function clearAll() {
  if(!confirm('Cancellare tutto?')) return;
  document.getElementById('inp_raw').value='';
  document.getElementById('inp_diagnosi').value='';
  S.rawText=S.cleanText=S.anonText=S.letter=''; S.strippedBlocks=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// XLS / XLSX LAB RESULTS PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S_XLS = { text: '', filename: '' };

function handleXlsDrop(e) {
  e.preventDefault();
  document.getElementById('xlsDropzone').style.borderColor = 'var(--border)';
  const file = e.dataTransfer.files[0];
  if (file) processXls(file);
  else alert('Carica un file XLS, XLSX o CSV.');
}
function handleXlsFile(e) {
  const file = e.target.files[0];
  if (file) processXls(file);
}

async function ensureSheetJs() {
  if (window.XLSX) return window.XLSX;
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload = () => res(window.XLSX);
    s.onerror = () => rej(new Error('Impossibile caricare SheetJS'));
    document.head.appendChild(s);
  });
}

async function processXls(file) {
  const spin   = document.getElementById('xlsSpin');
  const stxt   = document.getElementById('xlsStatusTxt');
  const status = document.getElementById('xlsStatus');
  const preview = document.getElementById('xlsPreview');
  status.style.display = 'block';
  spin.style.display   = 'inline-block';
  stxt.style.color     = 'var(--mid)';
  stxt.textContent     = 'Caricamento SheetJS...';

  try {
    const XLS = await ensureSheetJs();
    stxt.textContent = 'Parsing ' + file.name + '...';

    const buf = await file.arrayBuffer();
    const wb  = XLS.read(buf, { type: 'array', cellText: true, cellDates: true });

    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLS.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });

    const formatted = formatLabRows(rows);
    S_XLS.text = formatted.text;
    S_XLS.filename = file.name;

    spin.style.display = 'none';
    stxt.style.color   = 'var(--green)';
    stxt.textContent   = `âœ“ ${formatted.examCount} esami estratti da "${file.name}"`;
    document.getElementById('xlsPreviewContent').textContent = formatted.preview;
    preview.style.display = 'block';
    document.getElementById('xlsFileInput').value = '';

  } catch(err) {
    spin.style.display = 'none';
    stxt.style.color   = 'var(--red)';
    stxt.textContent   = 'âœ— ' + err.message;
  }
}

function formatLabRows(rows) {
  let dataStart = 0;
  for (let i = 0; i < Math.min(rows.length, 15); i++) {
    const r = rows[i].map(c => String(c).trim().toLowerCase());
    if (r.some(c => c.includes('metodo') || c.includes('unit') || c.includes('intervallo') || c.includes('riferimento'))) {
      dataStart = i + 1;
      break;
    }
  }

  const lines = [];
  let examCount = 0;

  for (let i = dataStart; i < rows.length; i++) {
    const row = rows[i].map(c => String(c).trim());
    const [name, value, method, unit, refRange] = row;

    if (!name) continue;

    const isSection = name && !value && !unit;
    const isComment = name && !value && name.length > 40;
    const isExam    = name && value && value !== '';

    if (isComment) {
      lines.push(`  â€» ${name}`);
      continue;
    }
    if (isSection) {
      lines.push(`\n[${name.toUpperCase()}]`);
      continue;
    }
    if (isExam) {
      examCount++;
      let line = `  ${name}: ${value}`;
      if (unit && unit !== method) line += ` ${unit}`;
      if (refRange) line += ` (rif: ${refRange})`;
      if (isAbnormal(value, refRange)) line += ' âš ';
      lines.push(line);
    }
  }

  const text = `## ESAMI DI LABORATORIO (da file: ${S_XLS.filename || 'referto.xls'})\n` + lines.join('\n');
  const preview = lines.slice(0, 40).join('\n') + (lines.length > 40 ? `\n  ... e altri ${lines.length - 40} righe` : '');
  return { text, preview, examCount };
}

// FIX 3: Lab ranges â€” parse "1.7-17" as a numeric range, NOT as a date.
// Only flag as abnormal if both ends look like plain decimals (no slashes).
function isAbnormal(value, refRange) {
  if (!refRange || !value) return false;
  // Reject if refRange looks like a date (contains / or -)
  if (/\d{1,2}[\/]\d{1,2}/.test(refRange)) return false;
  const numVal = parseFloat(value.replace(',', '.'));
  if (isNaN(numVal)) return false;
  const rangeMatch = refRange.match(/([\d.,]+)\s*[-â€“]\s*([\d.,]+)/);
  if (!rangeMatch) return false;
  const lo = parseFloat(rangeMatch[1].replace(',', '.'));
  const hi = parseFloat(rangeMatch[2].replace(',', '.'));
  if (isNaN(lo) || isNaN(hi)) return false;
  return numVal < lo || numVal > hi;
}

function clearXls() {
  S_XLS.text = '';
  S_XLS.filename = '';
  document.getElementById('xlsPreview').style.display = 'none';
  document.getElementById('xlsStatus').style.display = 'none';
  document.getElementById('xlsFileInput').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF.js
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pdfjsLib=null;
async function ensurePdfJs() {
  if(pdfjsLib) return pdfjsLib;
  return new Promise((res,rej)=>{
    if(window.pdfjsLib){pdfjsLib=window.pdfjsLib;res(pdfjsLib);return;}
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
    s.onload=()=>{pdfjsLib=window.pdfjsLib;pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';res(pdfjsLib);};
    s.onerror=()=>rej(new Error('Impossibile caricare PDF.js.'));
    document.head.appendChild(s);
  });
}
function handlePdfDrop(e){e.preventDefault();document.getElementById('pdfDropzone').style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')processPdf(f);else alert('Carica un PDF.');}
function handlePdfFile(e){const f=e.target.files[0];if(f)processPdf(f);}
async function processPdf(file){
  const spin=document.getElementById('pdfSpin'),stxt=document.getElementById('pdfStatusTxt'),bar=document.getElementById('pdfBar'),status=document.getElementById('pdfStatus');
  status.style.display='block';spin.style.display='inline-block';bar.style.width='0%';stxt.style.color='var(--mid)';stxt.textContent='Caricamento PDF.js...';
  try {
    const lib=await ensurePdfJs();stxt.textContent=`Lettura: ${file.name}`;
    const ab=await file.arrayBuffer();const pdf=await lib.getDocument({data:ab}).promise;const tot=pdf.numPages;
    let full='';
    for(let i=1;i<=tot;i++){
      const pg=await pdf.getPage(i);const ct=await pg.getTextContent();
      let pt='',ly=null;
      for(const it of ct.items){if('str'in it){if(ly!==null&&Math.abs(it.transform[5]-ly)>5)pt+='\n';pt+=it.str;if(it.hasEOL)pt+='\n';ly=it.transform[5];}}
      full+=pt.trim()+'\n\n';bar.style.width=Math.round(i/tot*100)+'%';stxt.textContent=`Pag ${i}/${tot}...`;
    }
    full=full.replace(/\n{3,}/g,'\n\n').trim();
    const ex=document.getElementById('inp_raw').value.trim();
    document.getElementById('inp_raw').value=ex?ex+'\n\n--- '+file.name+' ---\n\n'+full:full;
    bar.style.width='100%';spin.style.display='none';stxt.style.color='var(--green)';
    stxt.textContent=`âœ“ ${tot} pagina${tot===1?'':'e'} Â· ${full.length.toLocaleString()} caratteri`;
    document.getElementById('pdfFileInput').value='';
  } catch(err){spin.style.display='none';stxt.style.color='var(--red)';stxt.textContent='âœ— '+err.message;}
}

// â”€â”€ INIT â”€â”€
document.getElementById('tempSlider').addEventListener('input', function(){
  document.getElementById('tempLabel').textContent=(this.value/10).toFixed(1);
});
document.getElementById('systemPrompt').addEventListener('input', ()=>{ updateTokenPanel(); refreshPrompt(); });
loadBaseSettings();
document.getElementById('systemPrompt').value = DEFAULT_SYS;
renderLibrary();
</script>
</body>
</html>
