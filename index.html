<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lettera.AI — Dimissione</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f0f; --surface:#171717; --surface2:#1e1e1e; --surface3:#242424;
  --border:#2a2a2a; --border-hi:#3d3d3d;
  --text:#e8e4dc; --dim:#7a7570; --mid:#b0aa9f;
  --accent:#c9a96e; --accent-d:#7a6340; --accent-g:rgba(201,169,110,0.12);
  --red:#c96e6e; --green:#6ec98a; --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:17px;line-height:1.6;min-height:100vh}

/* layout */
.app{display:grid;grid-template-columns:196px 1fr;grid-template-rows:52px 1fr;min-height:100vh}
header{grid-column:1/-1;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px}
.logo{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.14em;color:var(--accent);text-transform:uppercase}
.logo span{color:var(--dim)}
.badge{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);background:var(--surface2);border:1px solid var(--border);padding:3px 10px;border-radius:20px}

aside{background:var(--surface);border-right:1px solid var(--border);padding:14px 0;display:flex;flex-direction:column;gap:1px;overflow-y:auto}
.ns{padding:12px 14px 5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase}
.ni{display:flex;align-items:center;gap:9px;padding:8px 13px;margin:0 5px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);cursor:pointer;border:1px solid transparent;background:transparent;width:calc(100% - 10px);text-align:left;transition:all .12s}
.ni:hover{background:var(--surface2);color:var(--text)}
.ni.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}
.ni.done .sn{background:rgba(110,201,138,.15);border-color:var(--green);color:var(--green)}
.sn{width:17px;height:17px;border-radius:50%;background:var(--surface3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;transition:all .12s}
.ni.active .sn{background:var(--accent-d);border-color:var(--accent);color:var(--accent)}

main{overflow-y:auto;background:var(--bg)}
.panel{display:none;padding:28px 32px;max-width:920px}
.panel.active{display:block}
.ptitle{font-size:24px;font-weight:300;margin-bottom:3px;letter-spacing:-.01em}
.psub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:22px;letter-spacing:.06em}

/* form */
label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;margin-top:16px}
label:first-child{margin-top:0}
textarea,input[type=text],input[type=password]{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;padding:11px 13px;outline:none;transition:border-color .12s}
textarea{resize:vertical}
textarea:focus,input:focus{border-color:var(--accent-d)}
textarea::placeholder,input::placeholder{color:var(--dim)}
select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:10px 12px;outline:none;cursor:pointer}

/* buttons */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.05em;cursor:pointer;border:1px solid;transition:all .12s;text-transform:uppercase}
.btn-p{background:var(--accent);color:#0f0f0f;border-color:var(--accent)}
.btn-p:hover{background:#dfbb80}
.btn-p:disabled{opacity:.4;cursor:not-allowed}
.btn-g{background:transparent;color:var(--mid);border-color:var(--border)}
.btn-g:hover{background:var(--surface2);color:var(--text);border-color:var(--border-hi)}
.btn-row{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}

/* cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.ctitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:11px}

/* infobox */
.ib{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);line-height:1.65;margin-bottom:13px}
.ib.red{border-left-color:var(--red)}
.ib.green{border-left-color:var(--green)}
.ib.acc{border-left-color:var(--accent)}

/* chips */
.chip{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.06em;padding:3px 8px;border-radius:20px;text-transform:uppercase}
.c-ok{background:rgba(110,201,138,.12);color:var(--green);border:1px solid rgba(110,201,138,.25)}
.c-w{background:rgba(201,169,110,.12);color:var(--accent);border:1px solid rgba(201,169,110,.25)}
.c-err{background:rgba(201,110,110,.12);color:var(--red);border:1px solid rgba(201,110,110,.25)}

/* spinner */
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* checklist */
.ci{display:flex;align-items:flex-start;gap:11px;padding:10px 13px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all .12s;user-select:none;margin-bottom:7px}
.ci:hover{border-color:var(--border-hi);background:var(--surface2)}
.ci.chk{border-color:var(--green);background:rgba(110,201,138,.05)}
.cb{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--dim);flex-shrink:0;line-height:1.4}
.ci.chk .cb{color:var(--green)}
.ct{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);line-height:1.6}
.ci.chk .ct{color:var(--text)}

/* diff */
.diff-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:13px}
.dlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;padding:2px 6px;background:var(--surface2);border-radius:3px;display:inline-block}
.dtext{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.8;white-space:pre-wrap;overflow-y:auto}
.redacted{background:rgba(201,110,110,.18);color:var(--red);border-radius:2px;padding:0 2px}

/* replacements */
.rl{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:11px;margin-bottom:11px}
.rtitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.rrow{display:flex;align-items:center;gap:7px;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 0;border-bottom:1px solid var(--border)}
.rrow:last-child{border-bottom:none}
.rorig{color:var(--red);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rarr{color:var(--dim);flex-shrink:0}
.rnew{color:var(--green);flex:1}
.rtype{color:var(--dim);font-size:9px;background:var(--surface3);padding:2px 5px;border-radius:3px;white-space:nowrap}

/* letter */
.paper{background:#faf8f3;color:#1a1a1a;border-radius:var(--r);padding:42px 50px;font-family:'Crimson Pro',Georgia,serif;font-size:15.5px;line-height:1.82;white-space:pre-wrap;border:1px solid #d4d0c8;box-shadow:0 4px 40px rgba(0,0,0,.5);max-height:680px;overflow-y:auto}

/* prompt tabs */
.tabs{display:flex;gap:4px;margin-bottom:8px}
.tab{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 12px;border-radius:var(--r);border:1px solid var(--border);background:transparent;color:var(--mid);cursor:pointer;transition:all .12s;text-transform:uppercase;letter-spacing:.05em}
.tab.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}

/* copy confirm */
.cc{display:none;position:absolute;top:10px;right:10px;background:var(--green);color:#0f0f0f;font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 10px;border-radius:4px;font-weight:600}

/* api notice */
.an{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);display:flex;gap:7px;margin-top:8px;line-height:1.5}

hr.div{border:none;border-top:1px solid var(--border);margin:18px 0}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:3px}
@media(max-width:640px){.app{grid-template-columns:1fr} aside{display:none} .diff-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">Lettera<span>.</span>AI</div>
  <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);">Generatore Lettera di Dimissione</div>
  <div class="badge" id="statusBadge">● Pronto</div>
</header>

<aside>
  <div class="ns">Flusso</div>
  <button class="ni active" onclick="goTo(0)" id="nav0"><span class="sn">1</span>Testo Clinico</button>
  <button class="ni" onclick="goTo(1)" id="nav1"><span class="sn">2</span>Anonimizzazione</button>
  <button class="ni" onclick="goTo(2)" id="nav2"><span class="sn">3</span>Generazione</button>
  <button class="ni" onclick="goTo(3)" id="nav3"><span class="sn">4</span>Lettera</button>
  <div class="ns" style="margin-top:14px;">Config</div>
  <button class="ni" onclick="goTo(4)" id="nav4"><span class="sn">⚙</span>Impostazioni</button>
</aside>

<main>

<!-- ═══ STEP 1 — TESTO CLINICO ═══ -->
<div class="panel active" id="panel0" style="display:flex;flex-direction:column;height:calc(100vh - 52px);">
  <div class="ptitle">Testo Clinico</div>
  <div class="psub">// step 01 — incolla il testo copiato dal PDF</div>

  <div class="ib acc">
    Incolla qui il testo completo copiato dal PDF ospedaliero: anamnesi, esami di laboratorio, accertamenti strumentali, decorso, terapia domiciliare, terapia in reparto, follow-up. Tutto in un unico blocco — non è necessario strutturarlo.
  </div>

  <!-- PDF UPLOAD -->
  <div class="card" style="margin-bottom:16px;">
    <div class="ctitle">Carica PDF — Estrazione Testo Offline</div>
    <div class="ib acc" style="margin-bottom:12px;">
      Carica il PDF scaricato dal server ospedaliero. Il testo viene estratto localmente con PDF.js — <strong style="color:var(--text);">nessun OCR, nessuna rete, nessun dato trasmesso.</strong> Funziona solo su PDF con testo selezionabile (i tuoi lo sono).
    </div>

    <div id="pdfDropzone" onclick="document.getElementById('pdfFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:28px 20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handlePdfDrop(event)">
      <input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="handlePdfFile(event)">
      <div style="font-size:28px;margin-bottom:8px;color:var(--dim);">⬆</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina il PDF</strong><br>
        <span style="color:var(--dim);">Estrazione offline — PDF.js — nessun OCR</span>
      </div>
    </div>

    <div id="pdfStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="pdfSpin" style="display:none;"></span>
        <span id="pdfStatusTxt"></span>
      </div>
      <div style="background:var(--surface3);border-radius:2px;height:3px;margin-top:6px;overflow:hidden;">
        <div id="pdfBar" style="height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .2s;"></div>
      </div>
    </div>
  </div>

  <label>Testo Completo del Paziente</label>
  <textarea id="inp_raw" style="height:calc(100vh - 420px);min-height:300px;" placeholder="Incolla qui il testo copiato dal PDF...

Il blocco può contenere tutto:
- Motivo del ricovero e anamnesi
- Esami ematochimici e strumentali
- Terapia domiciliare e in reparto
- Decorso clinico
- Follow-up e raccomandazioni

Non è necessario strutturarlo preventivamente."></textarea>

  <label>Diagnosi Principale</label>
  <input type="text" id="inp_diagnosi" placeholder='Es: "Sospetto minor stroke silviano destro a genesi indeterminata"'>

  <div class="btn-row">
    <button class="btn btn-p" onclick="goToAnon()">Avanti → Anonimizza</button>
    <button class="btn btn-g" onclick="clearAll()">✕ Reset</button>
  </div>
</div>

<!-- ═══ STEP 2 — ANONIMIZZAZIONE ═══ -->
<div class="panel" id="panel1">
  <div class="ptitle">Anonimizzazione</div>
  <div class="psub">// step 02 — regex offline → revisiona → procedi</div>

  <div class="ib acc">
    Anonimizzazione con pattern regex — gira nel browser, <strong style="color:var(--text);">zero rete, zero trasmissione dati.</strong> Pattern configurabili nelle Impostazioni.
  </div>

  <div id="anonStatus" class="card" style="display:flex;align-items:center;gap:10px;padding:12px 14px;">
    <span class="spin" id="anonSpin" style="display:none;"></span>
    <span id="anonStatusTxt" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">Pronto.</span>
  </div>

  <div id="repList"></div>

  <div class="diff-grid">
    <div>
      <div class="dlabel">Testo originale — locale, non inviato</div>
      <div class="dtext" id="origText" style="max-height:420px;overflow-y:auto;">—</div>
    </div>
    <div>
      <div class="dlabel">Testo anonimizzato ✏ modificabile</div>
      <textarea id="anonText" class="dtext" style="height:420px;font-size:11px;resize:vertical;"></textarea>
    </div>
  </div>

  <div class="ib red">⚠ Verifica il testo a destra. Correggi manualmente qualsiasi nome o dato rimasto prima di procedere.</div>

  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(0)">← Indietro</button>
    <button class="btn btn-p" onclick="proceedToGenerate()">Avanti → Genera</button>
  </div>
</div>

<!-- ═══ STEP 3 — GENERAZIONE ═══ -->
<div class="panel" id="panel2">
  <div class="ptitle">Generazione</div>
  <div class="psub">// step 03 — configura e genera la lettera</div>

  <div class="card">
    <div class="ctitle">API Key Anthropic</div>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-...  (solo in memoria di sessione, mai su disco)">
    <div class="an"><span>ℹ</span><span>Usata solo per questa sessione. Mai salvata. Ottenibile su console.anthropic.com — deposito minimo $5, ~200–300 lettere per lettera completa.</span></div>
  </div>

  <div class="card">
    <div class="ctitle">Modello & Temperatura</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label>Modello</label>
        <select id="modelSelect">
          <option value="claude-haiku-4-5-20251001">claude-haiku-4-5 — economico, veloce</option>
          <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6 — migliore qualità</option>
        </select>
      </div>
      <div>
        <label>Temperatura — <span id="tempLabel">0.1</span></label>
        <input type="range" id="tempSlider" min="0" max="5" value="1" step="1" style="width:100%;accent-color:var(--accent);margin-top:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);display:flex;justify-content:space-between;margin-top:2px;"><span>preciso</span><span>creativo</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">Prompt di Sistema — modificabile</div>
    <textarea id="systemPrompt" rows="10" style="font-size:11px;"></textarea>
  </div>

  <!-- FULL PROMPT VIEWER -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Prompt Completo — Copia per qualsiasi AI</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="refreshPrompt()">↺ Aggiorna</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyFull()">⎘ Tutto</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyUser()">⎘ Solo User</button>
      </div>
    </div>
    <div class="ib" style="margin-bottom:10px;">
      Copia il prompt e incollalo su <strong style="color:var(--text);">ChatGPT, Gemini, Copilot</strong> o qualsiasi altro AI. Il <strong style="color:var(--accent);">System</strong> va nelle istruzioni di sistema, lo <strong style="color:var(--accent);">User</strong> nel campo messaggio.
    </div>
    <div class="tabs">
      <button class="tab active" id="tabFull"   onclick="showTab('full')">Completo</button>
      <button class="tab"        id="tabSystem" onclick="showTab('system')">System</button>
      <button class="tab"        id="tabUser"   onclick="showTab('user')">User</button>
    </div>
    <div style="position:relative;">
      <textarea id="promptView" readonly rows="14" style="font-size:11px;background:var(--surface2);color:var(--dim);cursor:default;">Clicca "Aggiorna" per assemblare il prompt completo.</textarea>
      <div class="cc" id="copyConfirm">✓ Copiato!</div>
    </div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:6px;" id="tokEst"></div>
  </div>

  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(1)">← Indietro</button>
    <button class="btn btn-p" id="genBtn" onclick="generateLetter()">
      <span class="spin" id="genSpin" style="display:none;"></span>
      ✦ Genera Lettera
    </button>
  </div>
  <div id="genErr" style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);display:none;"></div>
</div>

<!-- ═══ STEP 4 — LETTERA ═══ -->
<div class="panel" id="panel3">
  <div class="ptitle">Lettera Generata</div>
  <div class="psub">// step 04 — revisiona, stampa, copia</div>

  <div class="ib green">✓ Lettera generata. Sostituisci i placeholder <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[PAZIENTE_NOME]</code>, <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[DATA_NASCITA]</code> ecc. con i dati reali prima di stampare.</div>

  <div id="letterOut" class="paper">—</div>

  <div class="btn-row" style="margin-top:18px;">
    <button class="btn btn-p" onclick="copyLetter()">⎘ Copia testo</button>
    <button class="btn btn-g" onclick="printLetter()">⎙ Stampa / PDF</button>
    <button class="btn btn-g" onclick="newLetter()">↺ Nuova lettera</button>
  </div>
</div>

<!-- ═══ STEP 5 — IMPOSTAZIONI ═══ -->
<div class="panel" id="panel4">
  <div class="ptitle">Impostazioni</div>
  <div class="psub">// config — intestazione, regex, stile</div>

  <div class="card">
    <div class="ctitle">Intestazione Lettera</div>
    <label>Città</label><input type="text" id="cfg_citta" placeholder="Es: Padova">
    <label>U.O. / Reparto</label><input type="text" id="cfg_reparto" placeholder="Es: U.O. di Neurologia">
    <label>Firma — Medico in Formazione Specialistica</label><input type="text" id="cfg_dott" placeholder="Es: Dott. [COGNOME]">
    <label>Firma — Dirigente Medico</label><input type="text" id="cfg_prof" placeholder="Es: Prof. [COGNOME]">
  </div>

  <div class="card">
    <div class="ctitle">Pattern Regex Anonimizzazione</div>
    <div class="ib" style="margin-bottom:10px;">
      Pattern aggiuntivi in formato JSON per ID locali e formati specifici del tuo ospedale. Questi si aggiungono ai pattern base già inclusi (CF, telefono, DOB, titoli+nomi, strutture).
    </div>
    <textarea id="cfg_regex" rows="6" placeholder='Formato JSON array, es:
[
  {"pattern": "NHI:\\s*[A-Z]{3}\\d{4}", "replace": "[ID_PAZIENTE]"},
  {"pattern": "cartella\\s*n\\.?\\s*\\d+", "replace": "[CARTELLA]"}
]'></textarea>
  </div>

  <div class="card">
    <div class="ctitle">Lettere Esempio — Few-Shot Stile</div>
    <div class="ib" style="margin-bottom:10px;">
      Incolla 1–2 tue lettere precedenti <strong style="color:var(--text);">già anonimizzate</strong>. Il modello replicherà il tuo stile. Non vengono mai inviate insieme ai dati del paziente corrente — sono incluse solo come riferimento stilistico nel prompt.
    </div>
    <textarea id="cfg_examples" rows="14" placeholder="Incolla qui lettere di dimissione precedenti già anonimizzate..."></textarea>
  </div>

  <div class="btn-row">
    <button class="btn btn-p" onclick="saveSettings()">✓ Salva per questa sessione</button>
  </div>
</div>

</main>
</div>

<script>
'use strict';

// ═══════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════
const S = { rawText:'', anonText:'', letter:'' };

const DEFAULT_SYS = `Sei un assistente esperto in documentazione medica ospedaliera italiana.
Genera una lettera di dimissione strutturata in italiano formale clinico.

REGOLE ASSOLUTE:
- NON inventare, inferire o aggiungere dati clinici non presenti nell'input.
- NON aggiungere diagnosi, valori di laboratorio, farmaci, dosi o date non esplicitamente forniti.
- Se una sezione manca, scrivi: "Non documentato."
- NON usare nomi di pazienti, medici, ospedali o qualsiasi identificativo personale.
- Usa il passato remoto per eventi durante il ricovero.
- Mantieni il registro formale della medicina clinica italiana.
- Segui esattamente la struttura del template fornito.
- Restituisci SOLO la lettera, senza preamboli o commenti.`;

// ═══════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════
function goTo(i) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel'+i).classList.add('active');
  document.getElementById('nav'+i).classList.add('active');
}

function goToAnon() {
  const raw = document.getElementById('inp_raw').value.trim();
  if (!raw) { alert('Incolla prima il testo clinico nello Step 1.'); return; }
  S.rawText = raw;
  goTo(1);
  runRegex();
}

// (checklist removed)

// ═══════════════════════════════════════════════════
// REGEX ANONYMIZER (fully offline)
// ═══════════════════════════════════════════════════
function runRegex() {
  const spin = document.getElementById('anonSpin');
  const stxt = document.getElementById('anonStatusTxt');
  const scard = document.getElementById('anonStatus');
  spin.style.display = 'inline-block';
  stxt.textContent = 'Regex: elaborazione in corso...';
  scard.style.borderColor = 'var(--border)';

  // slight delay to let UI update
  setTimeout(() => {
    const { text, reps } = applyRegex(S.rawText);
    renderAnonResult(text, reps);
    stxt.textContent = `✓ Regex completato — ${reps.length} sostituzion${reps.length===1?'e':'i'} effettuate. Verifica il testo a destra.`;
    scard.style.borderColor = 'var(--green)';
    spin.style.display = 'none';
  }, 60);
}

function applyRegex(text) {
  const reps = [];
  let result = text;

  const patterns = [
    // Codice fiscale
    { re:/\b[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]\b/gi, label:'Codice Fiscale', tag:'[CODICE_FISCALE]' },
    // Data di nascita con "nata/nato il"
    { re:/\bnata?\s+(?:il\s+)?\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b/gi, label:'Data Nascita', tag:'[DATA_NASCITA]' },
    { re:/\b(?:nato|nata)\s+(?:il\s+)?\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b/gi, label:'Data Nascita', tag:'[DATA_NASCITA]' },
    // Telefono
    { re:/(?:\+39\s?)?(?:0\d{1,4}[\s\-]?\d{5,8}|\d{3}[\s\-]\d{3}[\s\-]\d{4}|\b\d{10}\b)/g, label:'Telefono', tag:'[TELEFONO]' },
    // Email
    { re:/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/g, label:'Email', tag:'[EMAIL]' },
    // ID strutturati
    { re:/\b(?:matricola|NPI|NHI|MRN|cartella\s*n\.?)\s*[:\s]+[A-Z0-9\-]+/gi, label:'ID', tag:'[ID_PAZIENTE]' },
    // Titoli + nome: Dott., Prof., Dr., Dottoressa
    { re:/\b(?:Dott(?:\.?ssa?)?\.?|Prof(?:\.?ssa?)?\.?|Dr\.?)\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+(?:\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+)?\b/g, label:'Medico', tag:'[MEDICO]' },
    // Sig. / Sig.ra + nome
    { re:/\bSig(?:\.?ra?\.?)\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+(?:\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+){0,2}\b/g, label:'Paziente', tag:'[PAZIENTE_NOME]' },
    // Strutture ospedaliere
    { re:/\b(?:Ospedale|Clinica|Policlinico|ULSS|AULSS|Azienda\s+Ospedaliera|A\.O\.)\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zA-ZÀ-ú\s\.]{2,30}(?=[\s,\.\n\r])/g, label:'Struttura', tag:'[STRUTTURA]' },
  ];

  // Custom patterns from settings
  try {
    const raw = document.getElementById('cfg_regex').value.trim();
    if (raw) JSON.parse(raw).forEach(cp =>
      patterns.push({ re: new RegExp(cp.pattern, 'gi'), label:'Custom', tag: cp.replace }));
  } catch(e) {}

  for (const p of patterns) {
    const matches = [...result.matchAll(p.re)];
    for (const m of matches)
      if (m[0].trim().length > 1 && !reps.find(r => r.orig === m[0]))
        reps.push({ orig: m[0], repl: p.tag, type: p.label });
    result = result.replace(p.re, p.tag);
  }

  // Contextual bare names after clinical keywords
  const ctxRe = /\b((?:con|dalla?|dal|refertato\s+da|visitata?\s+da|seguita?\s+da|eseguita?\s+da|infermier[ae])\s+)([A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]{2,})\b/g;
  for (const m of [...result.matchAll(ctxRe)])
    if (!reps.find(r => r.orig === m[2]))
      reps.push({ orig: m[2], repl: '[NOME]', type: 'Nome contestuale' });
  result = result.replace(ctxRe, '$1[NOME]');

  return { text: result, reps };
}

function renderAnonResult(anonText, reps) {
  document.getElementById('anonText').value = anonText;

  // Replacements list
  const listEl = document.getElementById('repList');
  if (!reps.length) {
    listEl.innerHTML = '<div class="ib green" style="margin-bottom:11px;">✓ Nessun identificatore strutturato rilevato dai pattern regex. Verifica manualmente il testo.</div>';
  } else {
    let h = `<div class="rl"><div class="rtitle">${reps.length} sostituzion${reps.length===1?'e':'i'} <span class="chip c-w" style="margin-left:6px;">{ } Regex Offline</span></div>`;
    for (const r of reps)
      h += `<div class="rrow"><span class="rorig">${esc(r.orig)}</span><span class="rarr">→</span><span class="rnew">${esc(r.repl)}</span><span class="rtype">${r.type}</span></div>`;
    h += '</div>';
    listEl.innerHTML = h;
  }

  // Highlight originals in left panel
  let hi = esc(S.rawText);
  for (const r of reps)
    hi = hi.replace(new RegExp(escR(esc(r.orig)),'g'), `<span class="redacted">${esc(r.orig)}</span>`);
  document.getElementById('origText').innerHTML = hi;
}

// ═══════════════════════════════════════════════════
// PROCEED TO GENERATE
// ═══════════════════════════════════════════════════
function proceedToGenerate() {
  S.anonText = document.getElementById('anonText').value;
  if (!S.anonText.trim()) { alert('Nessun testo anonimizzato. Torna allo Step 1.'); return; }
  if (!document.getElementById('systemPrompt').value.trim())
    document.getElementById('systemPrompt').value = DEFAULT_SYS;
  goTo(2);
  setTimeout(refreshPrompt, 100);
}

// ═══════════════════════════════════════════════════
// PROMPT BUILDER
// ═══════════════════════════════════════════════════
function buildUserPrompt() {
  const citta    = (document.getElementById('cfg_citta').value    || 'Padova').trim();
  const dott     = (document.getElementById('cfg_dott').value     || 'Dott. [NOME]').trim();
  const prof     = (document.getElementById('cfg_prof').value     || 'Prof. [NOME]').trim();
  const examples = document.getElementById('cfg_examples').value.trim();
  const diagnosi = document.getElementById('inp_diagnosi').value.trim() || '[DIAGNOSI_PRINCIPALE]';
  const today    = new Date().toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});

  let p = '';

  if (examples)
    p += `## ESEMPI DI STILE (riferimento stilistico SOLO — non copiare contenuto clinico)\n\n${examples}\n\n---\n\n`;

  p += `## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n`;

  p += `## TEMPLATE LETTERA DI DIMISSIONE

Genera la lettera completa seguendo ESATTAMENTE questa struttura.

ISTRUZIONI SPECIALI:
— Il DECORSO CLINICO deve essere generato sintetizzando cronologicamente tutti i dati dell'input: accertamenti eseguiti, terapie avviate, evoluzione, ragionamento diagnostico-terapeutico. Prosa continua, 150-300 parole, passato remoto.
— La TERAPIA ALLA DIMISSIONE deve corrispondere all'ultima terapia somministrata identificabile dall'input. Modificala solo se ci sono ragioni cliniche esplicite nei dati (es. DAPT → singola antiaggregante, sospensione antibiotico, titolazione).
— Per dati assenti scrivi "Non documentato." — MAI inventare.

---
${citta}, ${today}

All'attenzione del Medico Curante

Egregio Collega,
        dimettiamo in data odierna la Sua Assistita, [PAZIENTE_NOME], nata in data [DATA_NASCITA], ricoverata presso la nostra Clinica dal [DATA_RICOVERO] u.s., con diagnosi di:

"${diagnosi}"

**Motivo del ricovero**
[Prosa continua, passato remoto — usa i dati di presentazione dall'input]

**Non farmacoallergie note.** [oppure allergie se documentate nell'input]

**Terapia domiciliare**: [farmaci pre-ricovero dall'input, se presenti]

**Anamnesi Patologica Remota**
[Trattini per ogni voce — usa i dati APR dall'input]

**Anamnesi Fisiologica/Sociale/Familiare**
[Prosa concisa — usa i dati dall'input]

**Esame neurologico all'ingresso**: [se presente nell'input — ometti altrimenti]

**Esame obiettivo generale all'ingresso**: [se presente nell'input — ometti altrimenti]

Durante la degenza sono stati eseguiti i seguenti **esami di laboratorio:**
[Lista strutturata — mantieni i valori numerici esatti dall'input]

ed i seguenti **accertamenti strumentali** e le seguenti **valutazioni specialistiche**:
[Lista strutturata — mantieni date e referti esatti dall'input]

**Decorso clinico**
[GENERA prosa clinica continua sintetizzando i dati dell'input in ordine cronologico]

Alla dimissione [condizioni cliniche alla dimissione dall'input].

**Terapia alla dimissione:**
[Trascrivi l'ultima terapia dall'input — farmaco, dose, frequenza. Applica modifiche solo se clinicamente motivate.]

[Follow-up e accertamenti pendenti dall'input]

Si prega di presentarsi muniti degli appositi foglietti azzurri allegati alla lettera di dimissione.

Sarà nostra cura fornire gli esiti degli accertamenti mediante Lettera di Completamento.

[Raccomandazioni specifiche se presenti nell'input]

Ringraziando per la collaborazione, rimaniamo a disposizione per qualsiasi chiarimento. Cordiali saluti.

${dott.padEnd(46)}${prof}
(Medico in formazione specialistica)${' '.repeat(14)}(Dirigente Medico)
---`;

  return p;
}

// ═══════════════════════════════════════════════════
// GENERATION
// ═══════════════════════════════════════════════════
async function generateLetter() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key)       { showErr('Inserisci la API key Anthropic.'); return; }
  if (!S.anonText){ showErr('Nessun testo anonimizzato. Completa prima gli Step 1–2.'); return; }

  const btn  = document.getElementById('genBtn');
  const spin = document.getElementById('genSpin');
  btn.disabled = true;
  spin.style.display = 'inline-block';
  document.getElementById('genErr').style.display = 'none';
  document.getElementById('statusBadge').textContent = '⟳ Generando...';

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': key,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true',
      },
      body: JSON.stringify({
        model:       document.getElementById('modelSelect').value,
        max_tokens:  3500,
        temperature: parseInt(document.getElementById('tempSlider').value) / 10,
        system:      document.getElementById('systemPrompt').value || DEFAULT_SYS,
        messages:   [{ role:'user', content: buildUserPrompt() }],
      }),
    });

    if (!resp.ok) { const e=await resp.json(); throw new Error(e.error?.message||`HTTP ${resp.status}`); }

    S.letter = (await resp.json()).content[0].text;
    document.getElementById('letterOut').textContent = S.letter;
    document.getElementById('statusBadge').textContent = '✓ Lettera generata';
    document.getElementById('nav3').classList.add('done');
    goTo(3);

  } catch(err) {
    showErr('✗ ' + err.message);
    document.getElementById('statusBadge').textContent = '✗ Errore';
  } finally {
    btn.disabled = false;
    spin.style.display = 'none';
  }
}

function showErr(msg) {
  const el = document.getElementById('genErr');
  el.textContent = msg; el.style.display = 'block';
}

// ═══════════════════════════════════════════════════
// FULL PROMPT VIEWER
// ═══════════════════════════════════════════════════
let pTab = 'full', pSys = '', pUsr = '';

function showTab(t) {
  pTab = t;
  ['full','system','user'].forEach(id => {
    document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)).classList.toggle('active', id===t);
  });
  renderPromptView();
}

function renderPromptView() {
  const el = document.getElementById('promptView');
  if (!pSys && !pUsr) return;
  if (pTab==='full')
    el.value = '══ SYSTEM PROMPT ══════════════════════════════\n\n'+pSys+'\n\n══ USER PROMPT ════════════════════════════════\n\n'+pUsr;
  else if (pTab==='system')
    el.value = pSys;
  else
    el.value = pUsr;

  const tok = Math.round((pSys.length+pUsr.length)/4);
  document.getElementById('tokEst').textContent =
    `~${tok.toLocaleString()} token stimati — Haiku: ~$${(tok/1000*0.00025).toFixed(4)} | Sonnet: ~$${(tok/1000*0.003).toFixed(4)}`;
}

function refreshPrompt() {
  if (!S.anonText) {
    document.getElementById('promptView').value = 'Completa gli Step 1–2 per vedere il prompt assemblato.';
    return;
  }
  pSys = document.getElementById('systemPrompt').value || DEFAULT_SYS;
  pUsr = buildUserPrompt();
  renderPromptView();
}

async function copyFull() {
  refreshPrompt();
  const txt = pTab==='full'
    ? '══ SYSTEM PROMPT ══════════════════════════════\n\n'+pSys+'\n\n══ USER PROMPT ════════════════════════════════\n\n'+pUsr
    : document.getElementById('promptView').value;
  await navigator.clipboard.writeText(txt);
  flash();
}

async function copyUser() {
  refreshPrompt();
  await navigator.clipboard.writeText(pUsr);
  flash();
}

function flash() {
  const el = document.getElementById('copyConfirm');
  el.style.display='block';
  setTimeout(()=>el.style.display='none', 1600);
}

// ═══════════════════════════════════════════════════
// OUTPUT ACTIONS
// ═══════════════════════════════════════════════════
function copyLetter() {
  navigator.clipboard.writeText(S.letter).then(()=>alert('Lettera copiata negli appunti.'));
}

function printLetter() {
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Lettera di Dimissione</title>
    <style>body{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.8;margin:2.5cm;color:#000}pre{white-space:pre-wrap;font-family:inherit}</style>
  </head><body><pre>${esc(S.letter)}</pre></body></html>`);
  w.document.close(); w.print();
}

function newLetter() {
  if (!confirm('Iniziare una nuova lettera? I dati correnti andranno persi.')) return;
  S.rawText=S.anonText=S.letter='';
  document.getElementById('inp_raw').value='';
  document.getElementById('inp_diagnosi').value='';
  document.getElementById('letterOut').textContent='—';
  document.getElementById('statusBadge').textContent='● Pronto';
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('done'));
  goTo(0);
}

// ═══════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════
function saveSettings() {
  try {
    sessionStorage.setItem('cfg', JSON.stringify({
      citta:   document.getElementById('cfg_citta').value,
      reparto: document.getElementById('cfg_reparto').value,
      dott:    document.getElementById('cfg_dott').value,
      prof:    document.getElementById('cfg_prof').value,
      regex:   document.getElementById('cfg_regex').value,
      ex:      document.getElementById('cfg_examples').value,
    }));
    alert('Impostazioni salvate per questa sessione.');
  } catch(e) { alert('Errore: '+e.message); }
}

function loadSettings() {
  try {
    const c = JSON.parse(sessionStorage.getItem('cfg')||'{}');
    if(c.citta)   document.getElementById('cfg_citta').value   = c.citta;
    if(c.reparto) document.getElementById('cfg_reparto').value = c.reparto;
    if(c.dott)    document.getElementById('cfg_dott').value    = c.dott;
    if(c.prof)    document.getElementById('cfg_prof').value    = c.prof;
    if(c.regex)   document.getElementById('cfg_regex').value   = c.regex;
    if(c.ex)      document.getElementById('cfg_examples').value= c.ex;
  } catch(e){}
}

// ═══════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escR(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function clearAll() {
  if(!confirm('Cancellare tutto?')) return;
  document.getElementById('inp_raw').value='';
  document.getElementById('inp_diagnosi').value='';
  S.rawText=S.anonText=S.letter='';
}

// ═══════════════════════════════════════════════════
// PDF.js TEXT EXTRACTION — fully offline
// ═══════════════════════════════════════════════════
// Loads PDF.js from CDN once, then all processing is local.
// Reads the actual text layer — no OCR, no image processing.

let pdfjsLib = null;

async function ensurePdfJs() {
  if (pdfjsLib) return pdfjsLib;
  // Use PDF.js 3.11.174 — compatible with Chrome 80+, no Promise.withResolvers needed
  return new Promise((resolve, reject) => {
    if (window.pdfjsLib) { pdfjsLib = window.pdfjsLib; resolve(pdfjsLib); return; }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
    script.onload = () => {
      pdfjsLib = window.pdfjsLib;
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
      resolve(pdfjsLib);
    };
    script.onerror = () => reject(new Error('Impossibile caricare PDF.js. Verifica la connessione internet.'));
    document.head.appendChild(script);
  });
}

function handlePdfDrop(e) {
  e.preventDefault();
  document.getElementById('pdfDropzone').style.borderColor = 'var(--border)';
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') processPdf(file);
  else alert('Carica un file PDF.');
}

function handlePdfFile(e) {
  const file = e.target.files[0];
  if (file) processPdf(file);
}

async function processPdf(file) {
  const spin   = document.getElementById('pdfSpin');
  const stxt   = document.getElementById('pdfStatusTxt');
  const bar    = document.getElementById('pdfBar');
  const status = document.getElementById('pdfStatus');

  status.style.display = 'block';
  spin.style.display   = 'inline-block';
  bar.style.width      = '0%';
  stxt.style.color     = 'var(--mid)';
  stxt.textContent     = 'Caricamento PDF.js...';

  try {
    const lib = await ensurePdfJs();
    stxt.textContent = `Lettura PDF: ${file.name}`;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await lib.getDocument({ data: arrayBuffer }).promise;
    const total = pdf.numPages;

    let fullText = '';
    for (let i = 1; i <= total; i++) {
      const page    = await pdf.getPage(i);
      const content = await page.getTextContent();

      // Reconstruct page text preserving line breaks
      let pageText = '';
      let lastY = null;
      for (const item of content.items) {
        if ('str' in item) {
          // New line if Y position changed significantly
          if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
            pageText += '\n';
          }
          pageText += item.str;
          if (item.hasEOL) pageText += '\n';
          lastY = item.transform[5];
        }
      }

      fullText += pageText.trim() + '\n\n';
      bar.style.width = Math.round((i / total) * 100) + '%';
      stxt.textContent = `Pagina ${i} / ${total}...`;
    }

    // Clean up excessive blank lines
    fullText = fullText.replace(/\n{3,}/g, '\n\n').trim();

    // Append to existing text or replace
    const existing = document.getElementById('inp_raw').value.trim();
    document.getElementById('inp_raw').value = existing
      ? existing + '\n\n--- ' + file.name + ' ---\n\n' + fullText
      : fullText;

    bar.style.width  = '100%';
    spin.style.display = 'none';
    stxt.style.color = 'var(--green)';
    stxt.textContent = `✓ ${total} pagina${total===1?'':'e'} estratta${total===1?'':'e'} da "${file.name}" — ${fullText.length.toLocaleString()} caratteri`;

    // Reset file input so same file can be re-uploaded
    document.getElementById('pdfFileInput').value = '';

  } catch(err) {
    spin.style.display = 'none';
    stxt.style.color   = 'var(--red)';
    stxt.textContent   = '✗ Errore: ' + err.message;
  }
}

// ── INIT ──
document.getElementById('tempSlider').addEventListener('input', function(){
  document.getElementById('tempLabel').textContent = (this.value/10).toFixed(1);
});
document.getElementById('systemPrompt').addEventListener('input', refreshPrompt);

loadSettings();
document.getElementById('systemPrompt').value = DEFAULT_SYS;
</script>
</body>
</html>
