<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lettera.AI ‚Äî Dimissione</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0f0f0f; --surface:#171717; --surface2:#1e1e1e; --surface3:#242424;
  --border:#2a2a2a; --border-hi:#3d3d3d;
  --text:#e8e4dc; --dim:#7a7570; --mid:#b0aa9f;
  --accent:#c9a96e; --accent-d:#7a6340; --accent-g:rgba(201,169,110,0.12);
  --red:#c96e6e; --green:#6ec98a; --blue:#6ea8c9; --purple:#a96ec9; --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:17px;line-height:1.6;min-height:100vh}
.app{display:grid;grid-template-columns:210px 1fr;grid-template-rows:52px 1fr;min-height:100vh}
header{grid-column:1/-1;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px}
.logo{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.14em;color:var(--accent);text-transform:uppercase}
.logo span{color:var(--dim)}
.badge{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);background:var(--surface2);border:1px solid var(--border);padding:3px 10px;border-radius:20px}
aside{background:var(--surface);border-right:1px solid var(--border);padding:14px 0;display:flex;flex-direction:column;gap:1px;overflow-y:auto}
.ns{padding:12px 14px 5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase}
.ni{display:flex;align-items:center;gap:9px;padding:8px 13px;margin:0 5px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);cursor:pointer;border:1px solid transparent;background:transparent;width:calc(100% - 10px);text-align:left;transition:all .12s}
.ni:hover{background:var(--surface2);color:var(--text)}
.ni.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}
.ni.done .sn{background:rgba(110,201,138,.15);border-color:var(--green);color:var(--green)}
.sn{width:17px;height:17px;border-radius:50%;background:var(--surface3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;transition:all .12s}
.ni.active .sn{background:var(--accent-d);border-color:var(--accent);color:var(--accent)}
main{overflow-y:auto;background:var(--bg);display:flex;flex-direction:column}
.panel{display:none;padding:28px 32px;width:100%;flex:1}
.panel.active{display:block}
#panel0.active{display:flex;flex-direction:column;height:calc(100vh - 52px)}
.ptitle{font-size:24px;font-weight:300;margin-bottom:3px;letter-spacing:-.01em}
.psub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:22px;letter-spacing:.06em}
label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;margin-top:16px}
label:first-child{margin-top:0}
textarea,input[type=text],input[type=password]{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;padding:11px 13px;outline:none;transition:border-color .12s}
textarea{resize:vertical}
textarea:focus,input:focus{border-color:var(--accent-d)}
textarea::placeholder,input::placeholder{color:var(--dim)}
select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:10px 12px;outline:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;letter-spacing:.05em;cursor:pointer;border:1px solid;transition:all .12s;text-transform:uppercase}
.btn-p{background:var(--accent);color:#0f0f0f;border-color:var(--accent)}
.btn-p:hover{background:#dfbb80}
.btn-p:disabled{opacity:.4;cursor:not-allowed}
.btn-g{background:transparent;color:var(--mid);border-color:var(--border)}
.btn-g:hover{background:var(--surface2);color:var(--text);border-color:var(--border-hi)}
.btn-row{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;align-items:center}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.ctitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:11px}
.ib{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);line-height:1.65;margin-bottom:13px}
.ib.red{border-left-color:var(--red)} .ib.green{border-left-color:var(--green)}
.ib.acc{border-left-color:var(--accent)} .ib.blue{border-left-color:var(--blue)}
.ib.purple{border-left-color:var(--purple)}
.chip{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.06em;padding:3px 8px;border-radius:20px;text-transform:uppercase}
.c-ok{background:rgba(110,201,138,.12);color:var(--green);border:1px solid rgba(110,201,138,.25)}
.c-w{background:rgba(201,169,110,.12);color:var(--accent);border:1px solid rgba(201,169,110,.25)}
.c-err{background:rgba(201,110,110,.12);color:var(--red);border:1px solid rgba(201,110,110,.25)}
.c-blue{background:rgba(110,168,201,.12);color:var(--blue);border:1px solid rgba(110,168,201,.25)}
.c-purple{background:rgba(169,110,201,.12);color:var(--purple);border:1px solid rgba(169,110,201,.25)}
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.diff-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:13px}
.diff-grid>div{display:flex;flex-direction:column}
.dlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;padding:2px 6px;background:var(--surface2);border-radius:3px;display:inline-block}
.dtext{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 13px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.8;white-space:pre-wrap;overflow-y:auto;min-height:600px}
.redacted{background:rgba(201,110,110,.18);color:var(--red);border-radius:2px;padding:0 2px}
.bpblock{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-d);border-radius:0 var(--r) var(--r) 0;padding:10px 12px;margin-bottom:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);white-space:pre-wrap;line-height:1.6}
.bpblock .bptag{color:var(--accent);font-size:9px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;display:block}
.rl{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:11px;margin-bottom:11px}
.rtitle{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.rrow{display:flex;align-items:center;gap:7px;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 0;border-bottom:1px solid var(--border)}
.rrow:last-child{border-bottom:none}
.rorig{color:var(--red);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rarr{color:var(--dim);flex-shrink:0}
.rnew{color:var(--green);flex:1}
.rtype{color:var(--dim);font-size:9px;background:var(--surface3);padding:2px 5px;border-radius:3px;white-space:nowrap}
.paper{background:#faf8f3;color:#1a1a1a;border-radius:var(--r);padding:42px 50px;font-family:'Crimson Pro',Georgia,serif;font-size:15.5px;line-height:1.82;white-space:pre-wrap;border:1px solid #d4d0c8;box-shadow:0 4px 40px rgba(0,0,0,.5);max-height:680px;overflow-y:auto}
.tabs{display:flex;gap:4px;margin-bottom:8px}
.tab{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 12px;border-radius:var(--r);border:1px solid var(--border);background:transparent;color:var(--mid);cursor:pointer;transition:all .12s;text-transform:uppercase;letter-spacing:.05em}
.tab.active{background:var(--accent-g);color:var(--accent);border-color:var(--accent-d)}
.cc{display:none;position:absolute;top:10px;right:10px;background:var(--green);color:#0f0f0f;font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 10px;border-radius:4px;font-weight:600}
.an{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);display:flex;gap:7px;margin-top:8px;line-height:1.5}

/* ‚îÄ‚îÄ MODE SELECTOR ‚îÄ‚îÄ */
.mode-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.mode-card{background:var(--surface2);border:2px solid var(--border);border-radius:var(--r);padding:14px 10px;cursor:pointer;transition:all .14s;text-align:center;position:relative}
.mode-card:hover{border-color:var(--border-hi);background:var(--surface3)}
.mode-card.sel-regex{border-color:var(--accent-d);background:var(--accent-g)}
.mode-card.sel-llm{border-color:var(--purple);background:rgba(169,110,201,.1)}
.mode-card.sel-combined{border-color:var(--blue);background:rgba(110,168,201,.08)}
.mode-card.sel-llm-only{border-color:var(--purple);background:rgba(169,110,201,.1)}
.mode-icon{font-size:22px;margin-bottom:5px}
.mode-name{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:var(--text);margin-bottom:3px}
.mode-desc{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);line-height:1.5}
.mode-badge{position:absolute;top:-8px;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;letter-spacing:.08em;padding:2px 7px;border-radius:10px;text-transform:uppercase;white-space:nowrap}
.mb-rec{background:var(--green);color:#0f0f0f}
.mb-exp{background:var(--blue);color:#0f0f0f}



/* ‚îÄ‚îÄ TOKEN COST ‚îÄ‚îÄ */
.tok-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
.tok-row{display:flex;align-items:center;gap:0;font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 0;border-bottom:1px solid var(--border)}
.tok-row:last-child{border-bottom:none;font-weight:600;color:var(--text)}
.tok-label{flex:1;color:var(--mid)}
.tok-bar-wrap{width:180px;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin:0 12px}
.tok-bar{height:100%;border-radius:3px;transition:width .3s}
.tok-val{width:70px;text-align:right;color:var(--dim)}
.tok-cost{width:90px;text-align:right}
.tok-cached{color:var(--blue);font-size:9px;margin-left:5px}
.tok-total-row{margin-top:12px;padding-top:10px;border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tok-total-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 14px;text-align:center}
.tok-total-box .tlabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px}
.tok-total-box .tval{font-family:'JetBrains Mono',monospace;font-size:18px;color:var(--accent);font-weight:500}
.tok-total-box .tsub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:2px}
.tok-cache-note{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);margin-top:10px;line-height:1.6}

/* ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ */
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-bottom:14px}
.tpl-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px;cursor:pointer;transition:all .12s;position:relative}
.tpl-card:hover{border-color:var(--border-hi);background:var(--surface3)}
.tpl-card.active-tpl{border-color:var(--accent-d);background:var(--accent-g)}
.tpl-name{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);margin-bottom:4px;font-weight:500}
.tpl-meta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim)}
.tpl-del{position:absolute;top:8px;right:8px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);background:none;border:none;cursor:pointer;padding:2px 5px;border-radius:3px}
.tpl-del:hover{color:var(--red);background:rgba(201,110,110,.1)}
.tpl-cached-badge{display:inline-block;margin-left:4px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--blue);background:rgba(110,168,201,.1);border:1px solid rgba(110,168,201,.2);padding:2px 6px;border-radius:3px}

hr.div{border:none;border-top:1px solid var(--border);margin:18px 0}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:3px}
@media(max-width:640px){.app{grid-template-columns:1fr}aside{display:none}.diff-grid{grid-template-columns:1fr}.mode-selector{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">Lettera<span>.</span>AI</div>
  <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);">Generatore Lettera di Dimissione</div>
  <div class="badge" id="statusBadge">‚óè Pronto</div>
</header>

<aside>
  <div class="ns">Flusso</div>
  <button class="ni active" onclick="goTo(0)" id="nav0"><span class="sn">1</span>Testo Clinico</button>
  <button class="ni" onclick="goTo(1)" id="nav1"><span class="sn">2</span>Anonimizzazione</button>
  <button class="ni" onclick="goTo(2)" id="nav2"><span class="sn">3</span>Generazione</button>
  <button class="ni" onclick="goTo(3)" id="nav3"><span class="sn">4</span>Lettera</button>
  <div class="ns" style="margin-top:14px;">Config</div>
  <button class="ni" onclick="goTo(4)" id="nav4"><span class="sn">‚öô</span>Impostazioni</button>
  <button class="ni" onclick="goTo(5)" id="nav5"><span class="sn">üìö</span>Libreria Casi</button>
</aside>

<main>

<!-- ‚ïê‚ïê‚ïê STEP 1 ‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel0">
  <div class="ptitle">Testo Clinico</div>
  <div class="psub">// step 01 ‚Äî carica PDF o incolla il testo</div>

  <div class="ib acc">
    Incolla il testo della cartella o carica il PDF. Le intestazioni (Regione, Azienda, Direttore, metadati paziente, numeri pagina) vengono rimosse automaticamente prima dell'invio al modello.
  </div>

  <div class="card">
    <div class="ctitle">Carica PDF ‚Äî Estrazione Testo Offline</div>
    <div id="pdfDropzone" onclick="document.getElementById('pdfFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:24px 20px;text-align:center;cursor:pointer;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handlePdfDrop(event)">
      <input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="handlePdfFile(event)">
      <div style="font-size:24px;margin-bottom:6px;color:var(--dim);">‚¨Ü</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina il PDF</strong> ‚Äî testo estratto offline, nessun dato trasmesso
      </div>
    </div>
    <div id="pdfStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="pdfSpin" style="display:none;"></span><span id="pdfStatusTxt"></span>
      </div>
      <div style="background:var(--surface3);border-radius:2px;height:3px;margin-top:6px;overflow:hidden;">
        <div id="pdfBar" style="height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .2s;"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">Carica Referto Laboratorio XLS / XLSX ‚Äî Opzionale</div>
    <div id="xlsDropzone" onclick="document.getElementById('xlsFileInput').click()"
      style="border:2px dashed var(--border);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;background:var(--surface2);"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="handleXlsDrop(event)">
      <input type="file" id="xlsFileInput" accept=".xls,.xlsx,.csv" style="display:none;" onchange="handleXlsFile(event)">
      <div style="font-size:22px;margin-bottom:5px;color:var(--dim);">üìä</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <strong style="color:var(--text);">Clicca o trascina XLS / XLSX</strong> ‚Äî referto laboratorio
      </div>
    </div>
    <div id="xlsStatus" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">
        <span class="spin" id="xlsSpin" style="display:none;"></span><span id="xlsStatusTxt"></span>
      </div>
    </div>
    <div id="xlsPreview" style="display:none;margin-top:10px;">
      <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px;">Anteprima valori estratti</div>
      <div id="xlsPreviewContent" style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mid);max-height:200px;overflow-y:auto;white-space:pre-wrap;"></div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="clearXls()">‚úï Rimuovi</button>
      </div>
    </div>
  </div>

  <label>Testo Completo del Paziente</label>
  <textarea id="inp_raw" style="flex:1;min-height:200px;" placeholder="Incolla qui il testo copiato dal PDF...&#10;&#10;Pu√≤ contenere tutto, incluse intestazioni ospedaliere ‚Äî verranno rimosse automaticamente."></textarea>

  <label>Diagnosi Principale</label>
  <input type="text" id="inp_diagnosi" placeholder='Es: "Sospetto minor stroke silviano destro a genesi indeterminata"'>

  <div class="btn-row">
    <button class="btn btn-p" onclick="goToAnon()">Avanti ‚Üí Anonimizza</button>
    <button class="btn btn-g" onclick="clearAll()">‚úï Reset</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 2 ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel1">
  <div class="ptitle">Anonimizzazione</div>
  <div class="psub">// step 02 ‚Äî scegli modalit√† ‚Üí boilerplate strip ‚Üí anonimizza ‚Üí revisiona</div>

  <!-- MODE SELECTOR -->
  <div class="card">
    <div class="ctitle">Modalit√† Anonimizzazione</div>
    <div class="mode-selector">

      <div class="mode-card sel-regex" id="modeCard_regex" onclick="selectAnonMode('regex')">
        <div class="mode-badge mb-rec">Offline ¬∑ gratis</div>
        <div class="mode-icon">{ }</div>
        <div class="mode-name">Solo Regex</div>
        <div class="mode-desc">CF, telefono, data nascita, nomi con titolo. Istantaneo, deterministico. Pu√≤ perdere nomi senza titolo.</div>
      </div>

      <div class="mode-card" id="modeCard_dict" onclick="selectAnonMode('dict')">
        <div class="mode-badge mb-rec" style="background:var(--green);color:#0f0f0f;">Offline ¬∑ gratis</div>
        <div class="mode-icon">üìñ</div>
        <div class="mode-name">Dizionario Nomi</div>
        <div class="mode-desc">~8.000 nomi e cognomi italiani. Cattura "Mario Rossi" senza titolo. 100% locale, istantaneo, zero API.</div>
      </div>

      <div class="mode-card" id="modeCard_combined" onclick="selectAnonMode('combined')">
        <div class="mode-badge mb-exp">Consigliato</div>
        <div class="mode-icon">üõ°</div>
        <div class="mode-name">Regex + Dizionario</div>
        <div class="mode-desc">Prima regex (CF, tel, date nascita), poi dizionario nomi. Doppio livello, massima copertura, tutto offline.</div>
      </div>

    </div>
  </div>

  <!-- PIPELINE STATUS -->
  <div id="anonStatus" class="card" style="display:flex;align-items:center;gap:10px;padding:12px 14px;">
    <span class="spin" id="anonSpin" style="display:none;"></span>
    <span id="anonStatusTxt" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--mid);">Pronto.</span>
  </div>

  <!-- BOILERPLATE REVIEW -->
  <div id="bpReview" style="display:none;">
    <div class="ib acc">‚úÇ Blocchi rimossi automaticamente ‚Äî <strong style="color:var(--text);">NON inviati al modello</strong>. Verifica cosa √® stato eliminato.</div>
    <div id="bpList"></div>
    <hr class="div">
  </div>

  <!-- REPLACEMENTS LIST -->
  <div id="repList"></div>

  <!-- DIFF VIEW -->
  <div class="diff-grid">
    <div>
      <div class="dlabel">Testo originale ‚Äî locale, non inviato</div>
      <div class="dtext" id="origText" style="min-height:600px;overflow-y:auto;">‚Äî</div>
    </div>
    <div>
      <div class="dlabel">Testo anonimizzato ‚úè modificabile</div>
      <textarea id="anonText" class="dtext" style="font-size:11px;resize:vertical;min-height:600px;"></textarea>
    </div>
  </div>

  <div class="ib red">‚ö† Verifica il testo a destra. Correggi manualmente qualsiasi dato rimasto prima di procedere.</div>

  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(0)">‚Üê Indietro</button>
    <button class="btn btn-p" onclick="proceedToGenerate()">Avanti ‚Üí Genera</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 3 ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel2">
  <div class="ptitle">Generazione</div>
  <div class="psub">// step 03 ‚Äî stima costo ‚Üí genera</div>

  <div class="card">
    <div class="ctitle">API Key Anthropic</div>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-... (solo in memoria di sessione, mai su disco)">
    <div class="an"><span>‚Ñπ</span><span>Usata solo per questa sessione. Mai salvata. Ottenibile su console.anthropic.com.</span></div>
  </div>

  <div class="card">
    <div class="ctitle">Modello & Temperatura</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label>Modello</label>
        <select id="modelSelect" onchange="updateTokenPanel()">
          <option value="claude-haiku-4-5-20251001">claude-haiku-4-5 ‚Äî economico, veloce</option>
          <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6 ‚Äî migliore qualit√†</option>
        </select>
      </div>
      <div>
        <label>Temperatura ‚Äî <span id="tempLabel">0.1</span></label>
        <input type="range" id="tempSlider" min="0" max="5" value="1" step="1" style="width:100%;accent-color:var(--accent);margin-top:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);display:flex;justify-content:space-between;margin-top:2px;"><span>preciso</span><span>creativo</span></div>
      </div>
    </div>
  </div>

  <div id="ragPreviewGen" style="display:none;" class="card">
    <div class="ctitle">Casi Simili Trovati <span class="chip c-purple" style="margin-left:6px;">RAG auto</span></div>
    <div id="ragMatchesGen"></div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);margin-top:8px;">Le lettere di questi casi vengono incluse nel prompt come esempi few-shot. Le cartelle restano locali.</div>
  </div>

  <div class="tok-panel" id="tokPanel">
    <div class="ctitle" style="margin-bottom:14px;">
      Stima Token & Costo
      <span id="cacheActiveBadge" class="chip c-blue" style="margin-left:8px;display:none;">‚ö° Cache Attiva</span>
    </div>
    <div id="tokRows"><div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);">Completa gli Step 1‚Äì2 per vedere la stima.</div></div>
  </div>

  <div class="card">
    <div class="ctitle">Prompt di Sistema ‚Äî modificabile</div>
    <textarea id="systemPrompt" rows="8" style="font-size:11px;"></textarea>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Prompt Completo</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;">
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="refreshPrompt()">‚Ü∫ Aggiorna</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyFull()">‚éò Tutto</button>
        <button class="btn btn-g" style="font-size:10px;padding:5px 11px;" onclick="copyUser()">‚éò Solo User</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabFull"   onclick="showTab('full')">Completo</button>
      <button class="tab"        id="tabSystem" onclick="showTab('system')">System</button>
      <button class="tab"        id="tabUser"   onclick="showTab('user')">User</button>
    </div>
    <div style="position:relative;">
      <textarea id="promptView" readonly rows="12" style="font-size:11px;background:var(--surface2);color:var(--dim);cursor:default;"></textarea>
      <div class="cc" id="copyConfirm">‚úì Copiato!</div>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-g" onclick="goTo(1)">‚Üê Indietro</button>
    <button class="btn btn-p" id="genBtn" onclick="generateLetter()">
      <span class="spin" id="genSpin" style="display:none;"></span>
      ‚ú¶ Genera Lettera
    </button>
  </div>
  <div id="genErr" style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);display:none;"></div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 4 ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel3">
  <div class="ptitle">Lettera Generata</div>
  <div class="psub">// step 04 ‚Äî revisiona, stampa, copia</div>
  <div class="ib green">‚úì Sostituisci i placeholder <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[PAZIENTE_NOME]</code>, <code style="background:var(--surface3);padding:1px 5px;border-radius:3px;">[DATA_NASCITA]</code> ecc. con i dati reali prima di stampare.</div>
  <div id="usageInfo" style="display:none;" class="ib blue"></div>
  <div id="letterOut" class="paper">‚Äî</div>
  <div class="btn-row" style="margin-top:18px;">
    <button class="btn btn-p" onclick="copyLetter()">‚éò Copia testo</button>
    <button class="btn btn-g" onclick="printLetter()">‚éô Stampa / PDF</button>
    <button class="btn btn-g" onclick="newLetter()">‚Ü∫ Nuova lettera</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 5 ‚Äî IMPOSTAZIONI ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel4">
  <div class="ptitle">Impostazioni</div>
  <div class="psub">// config ‚Äî intestazione, firma, regex custom</div>
  <div class="card">
    <div class="ctitle">Intestazione & Firme</div>
    <label>Citt√†</label><input type="text" id="cfg_citta" placeholder="Es: Padova">
    <label>U.O. / Reparto</label><input type="text" id="cfg_reparto" placeholder="Es: U.O. di Neurologia">
    <label>Firma ‚Äî Medico in Formazione Specialistica</label><input type="text" id="cfg_dott" placeholder="Es: Dott. [COGNOME]">
    <label>Firma ‚Äî Dirigente Medico</label><input type="text" id="cfg_prof" placeholder="Es: Prof. [COGNOME]">
  </div>
  <div class="card">
    <div class="ctitle">Pattern Regex Custom</div>
    <div class="ib" style="margin-bottom:10px;">Pattern aggiuntivi in JSON. I pattern base sono gi√† inclusi.</div>
    <textarea id="cfg_regex" rows="5" placeholder='[
  {"pattern": "NHI:\\s*[A-Z]{3}\\d{4}", "replace": "[ID_PAZIENTE]"},
  {"pattern": "cartella\\s*n\\.?\\s*\\d+", "replace": "[CARTELLA]"}
]'></textarea>
  </div>
  <div class="btn-row">
    <button class="btn btn-p" onclick="saveBaseSettings()">‚úì Salva</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 6 ‚Äî LIBRERIA ‚ïê‚ïê‚ïê -->
<div class="panel" id="panel5">
  <div class="ptitle">Libreria Casi</div>
  <div class="psub">// casi clinici precedenti ‚Äî RAG + fingerprint + caching</div>
  <div class="ib blue">
    <strong style="color:var(--text);">Come funziona:</strong> ogni caso memorizza la cartella anonimizzata (usata localmente per TF-IDF), la lettera generata (iniettata come few-shot), e un fingerprint stilistico compresso (cacheable). I 1‚Äì2 casi pi√π simili vengono recuperati automaticamente. Solo le <em>lettere</em>, non le cartelle, vengono inviate al modello.
  </div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div class="ctitle" style="margin:0;">Casi Salvati</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);" id="libStats"></div>
        <label style="display:flex;align-items:center;gap:6px;margin:0;text-transform:none;font-size:11px;cursor:pointer;">
          <input type="checkbox" id="ragToggle" checked style="width:auto;accent-color:var(--blue);">
          <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);">RAG auto</span>
        </label>
      </div>
    </div>
    <div id="tplGrid" class="tpl-grid"></div>
    <div id="noTplMsg" class="ib" style="margin:0;">Nessun caso ancora. Aggiungine uno qui sotto.</div>
  </div>
  <div id="ragPreview" style="display:none;" class="card">
    <div class="ctitle">Casi Recuperati <span class="chip c-blue" style="margin-left:6px;">RAG</span></div>
    <div id="ragMatches"></div>
  </div>
  <div class="card">
    <div class="ctitle">Aggiungi Caso</div>
    <label>Nome / Etichetta Caso</label>
    <input type="text" id="newTplName" placeholder='Es: "Neurologia ‚Äî Stroke ischemico"'>
    <label>Cartella Clinica Anonimizzata <span style="color:var(--dim);font-size:9px;text-transform:none;letter-spacing:0;">(solo locale per RAG)</span></label>
    <textarea id="newCaseFolder" rows="8" placeholder="Incolla la cartella anonimizzata..."></textarea>
    <label>Lettera di Dimissione Corrispondente <span style="color:var(--dim);font-size:9px;text-transform:none;letter-spacing:0;">(inviata come few-shot)</span></label>
    <textarea id="newCaseLetter" rows="8" placeholder="Incolla la lettera gi√† generata e revisionata..."></textarea>
    <div class="btn-row" style="margin-top:12px;">
      <button class="btn btn-g" onclick="autoExtractTemplate()">
        <span class="spin" id="tplExtSpin" style="display:none;"></span>
        ‚ú¶ Auto-estrai fingerprint
      </button>
      <button class="btn btn-p" onclick="saveNewTemplate()">‚úì Salva Caso</button>
    </div>
    <div id="tplExtStatus" style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);display:none;"></div>
    <div id="newTplSections" style="margin-top:10px;"></div>
  </div>
</div>

</main>
</div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRICING = {
  'claude-sonnet-4-6':        { in:3.00,  in_cache_write:3.75, in_cache_read:0.30, out:15.00 },
  'claude-haiku-4-5-20251001':{ in:0.80,  in_cache_write:1.00, in_cache_read:0.08, out:4.00  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S    = { rawText:'', cleanText:'', anonText:'', letter:'', strippedBlocks:[], activeTemplateId:null };
const S_XLS = { text:'', filename:'' };
let newTplSections = [];
let anonMode = 'regex'; // 'regex' | 'dict' | 'combined'

const DEFAULT_SYS = `Sei un assistente esperto in documentazione medica ospedaliera italiana.
Genera una lettera di dimissione strutturata in italiano formale clinico.

REGOLE ASSOLUTE:
- NON inventare, inferire o aggiungere dati clinici non presenti nell'input.
- NON aggiungere diagnosi, valori di laboratorio, farmaci, dosi o date non esplicitamente forniti.
- Se una sezione manca, scrivi: "Non documentato."
- NON usare nomi di pazienti, medici, ospedali o qualsiasi identificativo personale.
- Usa il passato remoto per eventi durante il ricovero.
- Mantieni il registro formale della medicina clinica italiana.
- Segui esattamente la struttura del template fornito.
- Restituisci SOLO la lettera, senza preamboli o commenti.`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(i) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  document.getElementById('panel'+i).classList.add('active');
  document.getElementById('nav'+i).classList.add('active');
  if (i===2) updateTokenPanel();
  if (i===5) renderLibrary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODE SELECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectAnonMode(mode) {
  anonMode = mode;
  ['regex','dict','combined'].forEach(m => {
    const el = document.getElementById('modeCard_'+m);
    if (!el) return;
    el.className = 'mode-card' + (m===mode ? ' sel-'+m : '');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOILERPLATE STRIPPER
// Key principle: be SURGICAL ‚Äî only remove lines that are 100% administrative.
// Never remove clinical content. When in doubt, leave it in.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BOILERPLATE_PATTERNS = [
  // ‚îÄ‚îÄ Institutional headers (very safe) ‚îÄ‚îÄ
  { re:/^REGIONE\s+(?:DEL\s+|AUTONOMA\s+)?[\w\s]{2,30}$/gim,              tag:'Intestazione Regione' },
  { re:/^Regione\s+(?:del\s+|Autonoma\s+)?[\w\s]{2,25}$/gim,              tag:'Intestazione Regione' },
  { re:/^AZIENDA\s+OSPEDALE[\s\S]*?(?=\n\n|\n[A-Z])/gim,                  tag:'Intestazione Azienda' },
  { re:/^Azienda\s+Ospedaliera[^\n]*/gim,                                  tag:'Intestazione Azienda' },
  { re:/^Azienda\s+Ospedale\s+-\s+Universit√†[^\n]*/gim,                    tag:'Footer Azienda' },
  { re:/^AULSS\s*\d*\b[^\n]*/gim,                                          tag:'Intestazione AULSS' },
  { re:/^ULSS\s*\d*\b[^\n]*/gim,                                           tag:'Intestazione ULSS' },
  { re:/^Dip(?:artimento)?\.?\s+Didattico[^\n]*/gim,                       tag:'Intestazione Dip.' },
  // U.O. header lines only ‚Äî pattern anchored to start of line + short line
  { re:/^U\.O\.(?:C|S|D|SD)?\.?\s+.{3,60}$/gim,                          tag:'Intestazione U.O.' },
  // ‚îÄ‚îÄ Staff / director lines ‚îÄ‚îÄ
  { re:/^Direttore(?:\s+ad\s+interim)?\s*:?[^\n]*/gim,                    tag:'Direttore' },
  { re:/^Responsabile\s*(?:U\.O\.?)?\s*:?[^\n]*/gim,                      tag:'Responsabile' },
  { re:/^(?:Dirigenti\s+Medici|Staff\s+medico)\s*:[^\n]*/gim,             tag:'Lista staff' },
  { re:/^(?:Coord(?:inatore)?|Inf\.?)\s*:[^\n]*/gim,                      tag:'Lista staff' },
  { re:/^T\.S\.R\.M\.[^\n]*/gim,                                           tag:'TSRM' },
  { re:/^(?:Equipe|Operatore)\s*:[^\n]*/gim,                               tag:'Equipe' },
  // ‚îÄ‚îÄ Record / episode ID lines ‚îÄ‚îÄ
  { re:/^(?:Episodio\s+)?RIC_AO_[^\r\n]*/gm,                              tag:'ID Ricovero' },
  { re:/^Ricovero\s*(?:n\.|numero|nr\.?)?\s*[\dX\/]+[^\n]*/gim,           tag:'Nr. Ricovero' },
  { re:/\bper\s+il\s+ricovero\s+[\dX\/]+\s+in\s+regime\s+\w+[^\n]*/gi,   tag:'Metadato ricovero' },
  // ‚îÄ‚îÄ Document type headers ‚îÄ‚îÄ
  { re:/^LETTERA\s+DI\s+DIMISSIONE\s*$/gim,                               tag:'Tipo documento' },
  { re:/^CONSULENZA\s+SPECIALISTICA\s*$/gim,                               tag:'Tipo documento' },
  { re:/^REFERTO\s*$/gim,                                                   tag:'Tipo documento' },
  { re:/^Diario\s+clinico\s*$/gim,                                         tag:'Titolo sezione' },
  // ‚îÄ‚îÄ Patient identity header block (name, DOB, gender on consecutive lines) ‚îÄ‚îÄ
  // Only match when it's clearly a metadata block (name in ALL CAPS or immediately followed by DOB)
  { re:/^(?:Nominativo|Paziente|Assistito)\s*:\s*[A-Z√Ä√à√â√å√ç√í√ì√ô√ö]{2,}[^\n]*/gim, tag:'Metadato paziente' },
  { re:/^(?:Cognome\s+e\s+)?[Nn]ome\s*:\s*[A-Z√Ä√à√â√å√ç√í√ì√ô√ö]{2,}[^\n]*/gim, tag:'Metadato paziente' },
  { re:/^Data\s+(?:di\s+)?[Nn]ascita\s*:\s*[\d\/\-.]+[^\n]*/gim,         tag:'Data nascita header' },
  { re:/^(?:Sesso|Genere)\s*:\s*[MF][^\n]*/gim,                           tag:'Sesso header' },
  { re:/^Anni\s*:\s*\d+[^\n]*/gim,                                        tag:'Et√† header' },
  { re:/^Codice\s+[Ff]iscale\s*:[^\n]*/gim,                               tag:'CF header' },
  { re:/^(?:Indirizzo|Residenza|Domicilio)\s*(?:n\.)?\s*:[^\n]*/gim,      tag:'Indirizzo paziente' },
  { re:/^Telefono\s*\d?\s*:[^\n]*/gim,                                    tag:'Telefono paziente' },
  { re:/^MMG\/PLS\s*:[^\n]*/gim,                                           tag:'MMG header' },
  { re:/^Rete\s+sociale\s*$/gim,                                           tag:'Rete sociale' },
  { re:/^Cognome\/Nome\s+Relazione\s+Tipo[^\n]*/gim,                       tag:'Header rete sociale' },
  { re:/\bSSN\s*:\s*\d+/g,                                                 tag:'SSN' },
  // ‚îÄ‚îÄ Lab report meta headers ‚îÄ‚îÄ
  { re:/^Al\s+Medico\s+[Cc]urante\s*:?[^\n]*/gim,                         tag:'Intestazione lab' },
  { re:/^Provenienza\s*:\s*[^\n]*/gim,                                     tag:'Provenienza lab' },
  { re:/^Prelievo\s+del\s*:\s*[^\n]*/gim,                                  tag:'Data prelievo' },
  { re:/^Ricevuto\s+il\s*:\s*[^\n]*/gim,                                   tag:'Data ricezione' },
  { re:/^Referto\s+del\s*:\s*[^\n]*/gim,                                   tag:'Data referto' },
  { re:/^Risposta\s*-?\s*del\s+\d{1,2}\/\d{2}\/\d{4}[^\n]*/gim,          tag:'Intestazione risposta' },
  { re:/^N\.\s+Richiesta\s*:[^\n]*/gim,                                    tag:'N. Richiesta' },
  { re:/^Versione\s+Referto\s*:[^\n]*/gim,                                  tag:'Versione referto' },
  { re:/^Medico\s+[Rr]ichiedente\s*:[^\n]*/gim,                           tag:'Medico richiedente' },
  { re:/^Quesito\s+[Dd]iagnostico\s*:[^\n]*/gim,                          tag:'Quesito' },
  // ‚îÄ‚îÄ Page numbers / footers ‚îÄ‚îÄ
  { re:/^Pag(?:ina|\.?)\s*:?\s*\d+\s*(?:di|\/)\s*\d+[^\n]*/gim,         tag:'Numero pagina' },
  { re:/^Page\s+\d+\s+of\s+\d+[^\n]*/gim,                                 tag:'Numero pagina' },
  { re:/^(?:Tel|Fax)\s*\.?\s*:?\s*[\+\d\s\-\.]+$/gim,                    tag:'Telefono footer' },
  { re:/^\d{5}\s+[A-Z√Ä-√öa-z√†-√∫\s]+[-‚Äì]\s*(?:Via|Viale|Piazza|C\.so)[^\n]*/gim, tag:'Indirizzo footer' },
  { re:/^(?:Via|Viale|Piazza|C\.so|Largo)\s+[^\n]{5,60}$/gim,            tag:'Indirizzo' },
  // ‚îÄ‚îÄ Digital signatures / legal notices ‚îÄ‚îÄ
  { re:/^Documento\s+firmato\s+digitalmente[^\n]*/gim,                    tag:'Firma digitale' },
  { re:/^Firmato\s+il\s+\d{1,2}\/\d{2}\/\d{4}[^\n]*/gim,                tag:'Data firma' },
  { re:/^Validato\s+da[^\n]*/gim,                                          tag:'Validazione' },
  { re:/Lettera\s+di\s+dimissione\s+firmata\s+digitalmente[^\n]*/gi,      tag:'Firma digitale' },
  { re:/Copia\s+di\s+(?:referto|documento)\s+firmato[^\n]*/gi,            tag:'Nota copia' },
  { re:/Rappresentazione\s+di\s+un\s+referto\s+firmato[^\n]*/gi,          tag:'Nota firma' },
  { re:/INFORMAZIONE\s+AI\s+SENSI\s+DELLA\s+DELIBERAZIONE[^\n]*/gi,       tag:'Nota GDPR' },
  // ‚îÄ‚îÄ Cost / DRG lines ‚îÄ‚îÄ
  { re:/(?:DRG|tariffa|rimborso)\s*:?\s*[\d.,‚Ç¨$]+[^\n]*/gi,              tag:'DRG/costi' },
  { re:/pari\s+ad\s+euro\s+[\d.,]+[^\n]*/gi,                              tag:'Importo' },
  // ‚îÄ‚îÄ Medication instruction banner (not clinical content) ‚îÄ‚îÄ
  { re:/^QUELLO\s+PRESCRITTO\s+DAL\s+MEDICO\s*$/gim,                      tag:'Avviso posologia' },
  { re:/^L'ORARIO\s+DELLE\s+SOMMINISTRAZIONI[^\n]*/gim,                   tag:'Avviso orario' },
  { re:/^Legenda\s+vie\s*:[^\n]*/gim,                                      tag:'Legenda vie' },
  { re:/^SARANNO\s+DISPONIBILI\s+ULTERIORI[^\n]*/gim,                     tag:'Nota completamento' },
  // ‚îÄ‚îÄ Misc printout metadata ‚îÄ‚îÄ
  { re:/^Stampato\s+il\s+\d{1,2}\/\d{2}\/\d{4}[^\n]*/gim,               tag:'Data stampa' },
  { re:/^\*{3}\s*Referto\s+Finale\s*\*{3}[^\n]*/gim,                      tag:'Referto finale' },
  { re:/^Data\s+nota\s+Nota\s+P\s+Operatore[^\n]*/gim,                    tag:'Header diario' },
  { re:/^Frequenza\s+campionamento[^\n]*/gim,                              tag:'Param. ECG' },
  { re:/^\(P\)\s+Profilo[^\n]*/gim,                                        tag:'Legenda profilo' },
];

function stripBoilerplate(text) {
  const stripped = [];
  let result = text;
  for (const p of BOILERPLATE_PATTERNS) {
    result = result.replace(p.re, (match) => {
      const t = match.trim();
      if (t.length>2 && !stripped.find(b=>b.text===t))
        stripped.push({ text:t, tag:p.tag });
      return '';
    });
    if (p.re.global) p.re.lastIndex = 0;
  }
  // Collapse 3+ blank lines to 2
  return { clean: result.replace(/\n{3,}/g,'\n\n').trim(), strippedBlocks: stripped };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ITALIAN NAME DICTIONARY ‚Äî fully offline, zero API
// Strategy:
//   NAMES  = Italian first names (male + female), ~600 entries
//   SURNAMES = Italian surnames, ~700 entries
//   Match patterns:
//     1. "Dott./Prof./Sig. FirstName [LastName]"  ‚Üí [MEDICO] / [PAZIENTE_NOME]
//     2. "A. Surname" (initial + known surname)    ‚Üí [NOME]
//     3. "FirstName Surname" or "Surname FirstName" (both in dict) ‚Üí [NOME]
//   Safety: skip tokens in MEDICAL_SAFELIST (drugs, anatomy, cities, acronyms)
//   All matching is case-sensitive on first letter (capitalised only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const IT_FIRST_NAMES = new Set([
  // ‚îÄ‚îÄ Male ‚îÄ‚îÄ
  'Abramo','Achille','Adalberto','Adelmo','Adolfo','Adriano','Agostino','Alberto',
  'Aldo','Alessandro','Alessio','Alfonso','Alfredo','Amedeo','Ambrogio','Amerigo',
  'Andrea','Angelo','Anselmo','Antonio','Arcangelo','Arduino','Arnaldo','Arturo',
  'Attilio','Augusto','Aurelio','Baldo','Bartolomeo','Basilio','Benedetto',
  'Beniamino','Bernardo','Biagio','Bruno','Calogero','Camillo','Carlo','Carmelo',
  'Cesare','Christian','Ciro','Claudio','Clemente','Corrado','Cosimo','Costantino',
  'Damiano','Daniele','Danilo','Dario','Davide','Diego','Domenico','Donato',
  'Edoardo','Egidio','Eligio','Elio','Emanuele','Emilio','Enrico','Enzo','Ernesto',
  'Ettore','Eugenio','Ezio','Fabio','Fabrizio','Fausto','Federico','Felice',
  'Ferdinando','Fernando','Filippo','Fiorenzo','Flavio','Franco','Francesco',
  'Fulvio','Gabriele','Gaspare','Gavino','Gerardo','Gerolamo','Giacomo','Gianluca',
  'Gianluigi','Gianmarco','Gianni','Gianpiero','Giorgio','Giovanni','Giuliano',
  'Giulio','Giuseppe','Gregorio','Guido','Ignazio','Ivan','Ivano','Lazzaro',
  'Leonardo','Leone','Leopoldo','Lorenzo','Luca','Luciano','Luigi','Manlio',
  'Marco','Marino','Mario','Massimiliano','Massimo','Matteo','Mattia','Mauro',
  'Michele','Mirco','Mirko','Moreno','Natale','Nicola','Nicol√≤','Nunzio',
  'Onofrio','Orazio','Orlando','Oscar','Ottavio','Paolo','Pasquale','Patrizio',
  'Pellegrino','Pietro','Primo','Raffaele','Raffaello','Renato','Renzo','Riccardo',
  'Roberto','Rocco','Rodolfo','Romano','Romeo','Romualdo','Rosario','Ruggero',
  'Ruggiero','Salvatore','Sandro','Samuele','Sebastiano','Secondo','Serafino',
  'Sergio','Silvano','Silvestro','Silvio','Simone','Stefano','Teodoro','Timoteo',
  'Tiziano','Tobia','Tommaso','Tullio','Ubaldo','Umberto','Ugo','Valentino',
  'Valerio','Vincenzo','Virgilio','Vitale','Vittorio','Walter','Zaccaria',
  'Gioacchino','Pier','Pierluigi','Piero','Giordano','Erminio','Lucio','Mariano',
  'Claudi','Loreto','Lino','Livio','Marcello','Nino','Nello','Samuel','Christian',
  'Cristian','Cristiano','Ivan','Mirco','Mirko','Moreno','Gerardo','Gerolamo',
  // ‚îÄ‚îÄ Female ‚îÄ‚îÄ
  'Ada','Adele','Adriana','Agata','Agnese','Alberta','Albina','Alessandra',
  'Alessia','Alice','Alicia','Alina','Alma','Amalia','Amanda','Ambra','Amelia',
  'Angela','Anna','Annalisa','Annunziata','Antonia','Antonietta','Arianna',
  'Assunta','Aurora','Barbara','Beatrice','Benedetta','Bianca','Camilla',
  'Carmela','Carolina','Carla','Caterina','Cecilia','Chiara','Cinzia','Claudia',
  'Concetta','Consolata','Costanza','Cristina','Daniela','Debora','Diana',
  'Diletta','Dina','Dolores','Donata','Donatella','Dora','Edvige','Elena',
  'Eleonora','Elisa','Elisabetta','Elvira','Emma','Enrichetta','Erica','Eugenia',
  'Eva','Fabiola','Federica','Fernanda','Filomena','Fiorella','Flavia',
  'Floriana','Franca','Francesca','Fulvia','Gabriella','Gemma','Giorgia',
  'Giovanna','Giulia','Giuseppina','Graziella','Grazia','Ilaria','Immacolata',
  'Ines','Irene','Iris','Jessica','Katia','Lara','Laura','Lavinia','Letizia',
  'Liliana','Lina','Linda','Lisa','Livia','Loredana','Lorella','Lorena',
  'Luana','Lucia','Luisa','Luigia','Maddalena','Manuela','Marcella',
  'Margherita','Maria','Mariangela','Marianna','Mariella','Marilena','Marina',
  'Marisa','Marta','Martina','Marzia','Maura','Michela','Milena','Mirella',
  'Miriam','Monica','Nadia','Noemi','Nunzia','Ornella','Paola','Patrizia',
  'Rachele','Raffaella','Renata','Rita','Roberta','Romina','Rosa','Rossana',
  'Rossella','Sabrina','Sandra','Sara','Serena','Silvia','Silvana','Simonetta',
  'Sofia','Sonia','Stefania','Stella','Susanna','Teresa','Tiziana','Valentina',
  'Valeria','Vera','Veronica','Viola','Virginia','Vittoria','Wanda','Ylenia',
]);

const IT_SURNAMES = new Set([
  'Agus','Altea','Amato','Angeli','Angius','Angioni','Atzeni',
  'Auriemma','Barbato','Barbieri','Barone','Basile','Bassi','Basso','Bellini',
  'Benedetti','Bernardi','Bernardo','Bianco','Bianchi','Biggio','Biondi','Boi',
  'Bonetti','Bottino','Bruno','Caddeo','Cadeddu','Cadoni','Camba','Cannas',
  'Cao','Careddu','Carbone','Caruso','Castelli','Cattaneo','Cattani','Cavallaro',
  'Cavallo','Ceccarelli','Cerri','Ciampi','Cipriani','Cocco','Colombi','Colombo',
  'Conte','Conti','Corrado','Corrias','Cossu','Crispo','Coppola',
  'Damiani','Damico','Deidda','Demontis','Deplano','De Luca','De Rosa',
  'De Santis','Desogus','Dess√¨','Donati','Esposito','Fabbri','Fabbro',
  'Fadda','Farina','Fava','Ferrari','Ferrara','Ferrante','Ferraris','Ferraro',
  'Ferreri','Ferretti','Ferretti','Figus','Fiore','Fiorini','Floris','Fois',
  'Fontana','Frau','Frongia','Gallo','Garau','Gargiulo','Gatti','Gentile',
  'Ghiani','Giorgi','Giordano','Giuliani','Giuliano','Grassi','Graziani',
  'Greco','Guerriero','Ibba','Izzo','Iovino','Lagana','Lai','Lampis','Leone',
  'Lilliu','Locatelli','Loddo','Lombardi','Longo','Lo Presti','Loriga',
  'Lucchese','Manca','Mancini','Mannai','Marchetti','Mariani','Marini',
  'Marras','Martini','Martinelli','Martis','Masi','Maxia','Mazza','Mazzi',
  'Medda','Melis','Meloni','Messina','Migheli','Milani','Molinari','Monti',
  'Montanari','Morandi','Morelli','Moretti','Mori','Mos√®','Mula','Murroni',
  'Muratori','Murru','Musu','Nannini','Napoli','Neri','Negri','Olla','Onnis',
  'Orlando','Orr√π','Pagano','Palma','Palumbo','Palmieri','Pane','Parisi',
  'Peddis','Pellegrini','Pellegrino','Perna','Piazza','Pieri','Pillai','Pinna',
  'Pio','Piredda','Piras','Pisano','Pistis','Pitu','Piga','Piu','Poddighe',
  'Podda','Poli','Porcu','Porceddu','Puddu','Pusceddu','Pucci','Quaglieri',
  'Raffaele','Raimondi','Ricci','Rinaldi','Riva','Rizzi','Rizzo','Romagnoli',
  'Romano','Rosa','Rossi','Rossetti','Rota','Ruggero','Ruggieri','Russo',
  'Sacco','Sala','Salaris','Sanna','Santoro','Sardu','Sartori','Satta',
  'Scalas','Scanu','Schirru','Scotto','Sechi','Serra','Sergi','Serri',
  'Siddi','Silvestri','Sorrentino','Spada','Spano','Spiga','Stochino',
  'Taranto','Tedesco','Testa','Tosi','Tocco','Trentini','Tronci','Trudu',
  'Uras','Usai','Vacca','Valentini','Valli','Vargiu','Villa','Vinci','Vitale',
  'Volpe','Ximenes','Zanetti','Zedda','Zito','Palumbo','Caputo','Basile',
  'Giunta','Capasso','Manzo','Pagano','Graziani','Battista','Cataldo','Valenti',
  'Corrado','Cimino','Giorgi','Angeli','Coletta','Pace','Viola','Calvino',
  'Maiorana','Ciampi','Raimondi','Prete','Mauro','Agnello',
]);

// Tokens that look like names but must NEVER be redacted
// (drugs, anatomy, clinical scales, bacteria, cities used as surnames)
const MEDICAL_SAFELIST = new Set([
  // Drugs
  'Aspirina','Warfarin','Eparina','Morfina','Insulina','Cortisone','Adrenalina',
  'Dopamina','Serotonina','Atropina','Digossina','Amiodarone','Metoprololo',
  'Carvedilolo','Furosemide','Metformina','Ramipril','Enalapril','Lisinopril',
  'Amlodipina','Nifedipina','Simvastatina','Atorvastatina','Rosuvastatina',
  'Omeprazolo','Pantoprazolo','Lansoprazolo','Paracetamolo','Ibuprofene',
  'Naprossene','Diclofenac','Pregabalina','Gabapentina','Levodopa','Carbamazepina',
  'Valproato','Lamotrigina','Clopidogrel','Ticagrelor','Rivaroxaban','Apixaban',
  'Dabigatran','Prednisone','Desametasone','Betametasone','Idrocortisone',
  'Amoxicillina','Cefalexina','Ciprofloxacina','Levofloxacina','Azitromicina',
  'Claritromicina','Metronidazolo','Fluconazolo','Aciclovir','Vancomicina',
  'Meropenem','Piperacillina','Tazobactam','Gentamicina','Augmentin',
  // Anatomical / clinical terms that happen to be capitalised names
  'Rosa','Bruno','Viola','Bianca','Bruna','Marino','Leone','Serra','Greco',
  'Costa','Costa','Farina','Vitale','Fiore','Ferrari','Palma',
  // Organisms
  'Staphylococcus','Streptococcus','Pseudomonas','Klebsiella','Candida',
  'Aspergillus','Escherichia','Enterococcus','Proteus','Serratia',
  // Clinical scales
  'Glasgow','Barthel','Rankin','Wells','Apache','Sofa','Nihss','Curb',
  // Devices / procedures capitalised
  'Holter','Baxter','Swan','Ganz','Foley','Hickman','Broviac',
]);

/**
 * applyNameDict(text) ‚Üí { text, reps }
 *
 * Three passes, in order:
 *  1. Titled names   ‚Äî "Dott. Mario Rossi" ‚Üí [MEDICO]
 *  2. Initial+Surname ‚Äî "M. Rossi" where Rossi ‚àà IT_SURNAMES ‚Üí [NOME]
 *  3. Pair matching  ‚Äî "Mario Rossi" / "Rossi Mario" where both tokens are in
 *                       their respective sets ‚Üí [NOME]
 *     Pair check skips whitespace between tokens (tokenises words only).
 */
function applyNameDict(text) {
  const reps = [];

  function track(orig, repl, type) {
    if (!reps.find(r => r.orig === orig)) reps.push({ orig, repl, type });
    return repl;
  }

  // ‚îÄ‚îÄ Pass 1: titled names ‚îÄ‚îÄ
  const titledRe = /\b(dott(?:\.ssa?)?\.?|prof(?:\.ssa?)?\.?|dr\.?|sig(?:\.ra?)?\.?|signor[ae]?|dottoressa|professoressa?)\s+([A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-z√†√®√©√¨√≠√≤√≥√π√∫\-']+)(?:\s+([A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-z√†√®√©√¨√≠√≤√≥√π√∫\-']+))?/gi;
  text = text.replace(titledRe, (match, title, first, last) => {
    if (MEDICAL_SAFELIST.has(first)) return match;
    const pl = /sig/i.test(title) ? '[PAZIENTE_NOME]' : '[MEDICO]';
    return track(match, pl, 'Nome con titolo');
  });

  // ‚îÄ‚îÄ Pass 2: Initial(s) + known surname ‚Äî "M. Rossi" or "M.G. Rossi" ‚îÄ‚îÄ
  const initialRe = /\b([A-Z√Ä√à√â√å√ç√í√ì√ô√ö]\.(?:[A-Z√Ä√à√â√å√ç√í√ì√ô√ö]\.)?)\s+([A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-z√†√®√©√¨√≠√≤√≥√π√∫\-']{2,})\b/g;
  text = text.replace(initialRe, (match, init, surname) => {
    if (!IT_SURNAMES.has(surname) || MEDICAL_SAFELIST.has(surname)) return match;
    return track(match, '[NOME]', 'Iniziale + Cognome');
  });

  // ‚îÄ‚îÄ Pass 3: FirstName + Surname or Surname + FirstName ‚îÄ‚îÄ
  // Tokenise into WORDS only (skip punctuation/spaces), preserving original positions
  // so we can reconstruct the string.
  const wordRe = /[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-z√†√®√©√¨√≠√≤√≥√π√∫\-']{1,}/g;
  let match;
  // Collect all word positions
  const words = [];
  while ((match = wordRe.exec(text)) !== null) {
    words.push({ word: match[0], start: match.index, end: match.index + match[0].length });
  }

  // Find adjacent pairs (in the token array) that match first+surname or surname+first
  // "Adjacent" = consecutive in words[] regardless of whitespace between them,
  // BUT we only pair them if they are on the same line (no \n between them).
  const toRedact = []; // list of [start,end] char ranges to replace
  for (let i = 0; i < words.length - 1; i++) {
    const w1 = words[i], w2 = words[i+1];
    // Don't cross line boundaries
    if (text.slice(w1.end, w2.start).includes('\n')) continue;
    // Skip already-replaced placeholders
    if (w1.word.startsWith('[') || w2.word.startsWith('[')) continue;
    if (MEDICAL_SAFELIST.has(w1.word) || MEDICAL_SAFELIST.has(w2.word)) continue;

    const fwPair = IT_FIRST_NAMES.has(w1.word) && IT_SURNAMES.has(w2.word);
    const rwPair = IT_SURNAMES.has(w1.word) && IT_FIRST_NAMES.has(w2.word);
    if (!fwPair && !rwPair) continue;

    const origStr = text.slice(w1.start, w2.end);
    track(origStr, '[NOME]', 'Nome+Cognome (dizionario)');
    toRedact.push([w1.start, w2.end]);
    i++; // consume w2 so we don't double-match
  }

  // Apply replacements in reverse order to preserve indices
  toRedact.sort((a,b) => b[0]-a[0]);
  for (const [s,e] of toRedact) {
    text = text.slice(0,s) + '[NOME]' + text.slice(e);
  }

  return { text, reps };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REGEX ANONYMIZER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// KEY FIXES vs. previous version:
//  1. Date redaction: ONLY when preceded by DOB context keywords (nato/nata/D.N.)
//     All other dates (exam dates, admission dates) are KEPT.
//  2. Lab ranges like "1.7-17" no longer match ‚Äî date pattern requires
//     exactly 2-digit month AND 2-4 digit year, with / or - separator.
//  3. Hospital names (Clinica Neurologica, Ospedale Civile) are NOT redacted ‚Äî
//     they are not privacy-sensitive.
//  4. Free-standing "Nome Cognome" without title: use Dizionario mode.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyRegex(text) {
  const reps=[];
  let result = text;

  const patterns = [
    // ‚îÄ‚îÄ Codice Fiscale (always safe, unique format) ‚îÄ‚îÄ
    {
      re: /\b[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]\b/g,
      label:'Codice Fiscale', tag:'[CODICE_FISCALE]'
    },

    // ‚îÄ‚îÄ Date of birth ONLY ‚Äî must be preceded by DOB keyword ‚îÄ‚îÄ
    // Matches: "nata il 12/03/1985", "nato 12-03-85", "D.N. 12.03.1985",
    //          "Data di Nascita: 12/03/1985", "nato/a il 12/03/1985"
    // Does NOT match standalone dates like "12/03/2024" (exam dates, etc.)
    {
      re: /(?:nata?\s+(?:il\s+|a\s+[A-Za-z√Ä-√∫]+\s+il\s+)?|nato\/a\s+il\s+|D\.?\s*N\.?\s*:?\s*|[Dd]ata\s+(?:di\s+)?[Nn]ascita\s*:?\s*)\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b/g,
      label:'Data Nascita', tag:'[DATA_NASCITA]'
    },
    // Parenthetical DOB: "(n. 12/03/1985)" or "(D.N. 12/03/1985)"
    {
      re: /\(\s*(?:[Dd]\.?[Nn]\.?|n\.)\s*\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\s*\)/g,
      label:'Data Nascita inline', tag:'[DATA_NASCITA]'
    },
    // Age alone (standalone demographic) ‚Äî "anni 67" or "67 anni" at start of clinical sentence
    // Only when immediately following a name or at start of line
    // (deliberately conservative ‚Äî don't catch "dopo 3 anni di terapia")
    {
      re: /\b(?:di\s+)?anni\s+\d{1,3}(?:\s+(?:di\s+et√†|aa))?(?=[,\.\s]|$)/gim,
      label:'Et√†', tag:'[ETA]'
    },

    // ‚îÄ‚îÄ Phone numbers ‚îÄ‚îÄ
    {
      re: /(?:\+39[\s\-]?|\+039[\s\-]?)?\b0\d{1,4}[\s\-.]?\d{3,4}[\s\-.]?\d{3,5}\b/g,
      label:'Telefono fisso', tag:'[TELEFONO]'
    },
    {
      re: /\b3\d{2}[\s\-]?\d{3}[\s\-]?\d{4}\b/g,
      label:'Telefono mobile', tag:'[TELEFONO]'
    },

    // ‚îÄ‚îÄ Email ‚îÄ‚îÄ
    {
      re: /[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/g,
      label:'Email', tag:'[EMAIL]'
    },

    // ‚îÄ‚îÄ Street address of patient (not hospital addresses) ‚îÄ‚îÄ
    // Only match "Via/Viale/Piazza ... NN" residential patterns
    {
      re: /\b(?:residente|domiciliato[a]?|abita\s+(?:in|a))\s+(?:in\s+)?(?:Via|Viale|Piazza|Corso|C\.so|Largo)\s+[A-Za-z√Ä-√∫'\s]{3,40}\s+\d+[\/A-Z]*/gi,
      label:'Indirizzo residenza', tag:'[INDIRIZZO]'
    },

    // ‚îÄ‚îÄ Record numbers ‚îÄ‚îÄ
    {
      re: /\b(?:cartella|pratica|SDO|scheda)\s*(?:n\.|numero|nr\.?)?\s*[\dx\/]+/gi,
      label:'Nr. Cartella', tag:'[NR_CARTELLA]'
    },
    {
      re: /\b(?:matricola|NPI|NHI|MRN|ASSIPCA)\s*[:\s]+[A-Z0-9\-]+/gi,
      label:'ID Paziente', tag:'[ID_PAZIENTE]'
    },

    // ‚îÄ‚îÄ Titled names ‚Äî MEDICI (reliable: preceded by formal title) ‚îÄ‚îÄ
    // Captures: "Dott. Mario Rossi", "Prof.ssa Bianchi", "Dr. M. Verdi"
    {
      re: /\b(?:Dott(?:\.ssa?|ssa?)?\.?|Prof(?:\.ssa?|ssa?)?\.?|Dr\.?)\s+(?:[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\s+)?[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\b/g,
      label:'Medico con titolo', tag:'[MEDICO]'
    },
    // Abbreviated: "Dott. M. Rossi"
    {
      re: /\b(?:Dott(?:\.ssa?)?\.?|Prof(?:\.ssa?)?\.?|Dr\.?)\s+[A-Z]\.\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\b/g,
      label:'Medico abbreviato', tag:'[MEDICO]'
    },

    // ‚îÄ‚îÄ Titled patient names ‚îÄ‚îÄ
    {
      re: /\bSig(?:\.ra?\.?|nora?\.?|nor?\.?)\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+(?:\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+)?\b/g,
      label:'Paziente Sig/Sig.ra', tag:'[PAZIENTE_NOME]'
    },

    // ‚îÄ‚îÄ MMG/PLS named in text ‚îÄ‚îÄ
    {
      re: /\b(?:MMG|PLS|MdG|medico\s+(?:di\s+base|curante))\s*:?\s*(?:Dott(?:\.ssa?)?\.?\s+)?[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+/gi,
      label:'MMG/PLS nome', tag:'[MEDICO_CURANTE]'
    },

    // ‚îÄ‚îÄ Contextual names after role-assignment verbs ‚îÄ‚îÄ
    // "refertato da Mario Rossi", "visitata dal dott. Bianchi", "firmato da Verdi"
    {
      re: /\b(?:refertata?\s+da|visitata?\s+da|seguita?\s+da|eseguita?\s+da|firmata?\s+da|compilata?\s+da|dettata?\s+da|redatto\s+da|supervisionato\s+da)\s+(?:(?:Dott(?:\.ssa?)?\.?|Prof(?:\.ssa?)?\.?|Dr\.?)\s+)?([A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+(?:\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+)?)/gi,
      label:'Nome contestuale', tag:'[MEDICO]'
    },

    // ‚îÄ‚îÄ Patient name in specific clinical contexts ‚îÄ‚îÄ
    // "la paziente Mario Rossi" / "il paziente Rossi Mario"
    {
      re: /\b(?:il|la)\s+(?:paziente|assistito|assistita)\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\b/gi,
      label:'Paziente in contesto', tag:'[PAZIENTE_NOME]'
    },
    // "ricoverata/dimessa + Name Surname"
    {
      re: /\b(?:ricoverat|dimess|assistit)[oa]\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\s+[A-Z√Ä√à√â√å√ç√í√ì√ô√ö][a-zA-Z√Ä-√∫\-]+\b/gi,
      label:'Paziente ricoverato/dimesso', tag:'[PAZIENTE_NOME]'
    },
  ];

  // Custom patterns from settings
  try {
    const raw = document.getElementById('cfg_regex').value.trim();
    if (raw) JSON.parse(raw).forEach(cp =>
      patterns.push({ re:new RegExp(cp.pattern,'gi'), label:'Custom', tag:cp.replace }));
  } catch(e) {}

  for (const p of patterns) {
    if (p.re.global) p.re.lastIndex = 0;
    result = result.replace(p.re, (match) => {
      const m = match.trim();
      if (m.length>1 && !reps.find(r=>r.orig===m))
        reps.push({ orig:m, repl:p.tag, type:p.label });
      return p.tag;
    });
  }

  return { text:result, reps };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIPELINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToAnon() {
  const raw = document.getElementById('inp_raw').value.trim();
  if (!raw && !S_XLS.text) { alert('Incolla il testo clinico o carica un referto XLS nello Step 1.'); return; }
  S.rawText = raw + (S_XLS.text ? '\n\n'+S_XLS.text : '');
  goTo(1);
  runPipeline();
}

function runPipeline() {
  const spin  = document.getElementById('anonSpin');
  const stxt  = document.getElementById('anonStatusTxt');
  const scard = document.getElementById('anonStatus');
  spin.style.display = 'inline-block';
  stxt.textContent = 'Strip boilerplate...';
  scard.style.borderColor = 'var(--border)';

  setTimeout(async () => {
    try {
      // Stage 1 ‚Äî boilerplate (always)
      const { clean, strippedBlocks } = stripBoilerplate(S.rawText);
      S.cleanText = clean;
      S.strippedBlocks = strippedBlocks;
      renderBoilerplateReview(strippedBlocks);

      let finalText = clean;
      let reps = [];

      if (anonMode === 'regex') {
        stxt.textContent = 'Anonimizzazione regex...';
        const res = applyRegex(clean);
        finalText = res.text; reps = res.reps;

      } else if (anonMode === 'dict') {
        stxt.textContent = 'Ricerca dizionario nomi...';
        const res = applyRegex(clean);          // structural PII first
        const res2 = applyNameDict(res.text);   // then name dictionary
        finalText = res2.text;
        reps = [...res.reps, ...res2.reps];

      } else if (anonMode === 'combined') {
        stxt.textContent = 'Stage 1 ‚Äî Regex strutturale...';
        const res = applyRegex(clean);
        stxt.textContent = 'Stage 2 ‚Äî Dizionario nomi...';
        const res2 = applyNameDict(res.text);
        finalText = res2.text;
        reps = [...res.reps, ...res2.reps];
      }

      renderAnonResult(finalText, reps, anonMode);

      const saved = S.rawText.length - clean.length;
      const modeLabel = anonMode==='regex' ? '{ } Regex' : anonMode==='dict' ? 'üìñ Dizionario' : 'üõ° Regex+Dizionario';
      stxt.textContent = `‚úì ${strippedBlocks.length} blocchi rimossi (‚àí${saved} char) ¬∑ ${modeLabel} ¬∑ verifica manualmente`;
      scard.style.borderColor = 'var(--green)';

    } catch(err) {
      stxt.textContent = '‚úó '+err.message;
      scard.style.borderColor = 'var(--red)';
      console.error(err);
    } finally {
      spin.style.display = 'none';
    }
  }, 60);
}

function renderBoilerplateReview(blocks) {
  const wrap = document.getElementById('bpReview');
  const list = document.getElementById('bpList');
  if (!blocks.length) { wrap.style.display='none'; return; }
  wrap.style.display='block';
  list.innerHTML = blocks.map(b=>
    `<div class="bpblock"><span class="bptag">‚úÇ ${esc(b.tag)}</span>${esc(b.text)}</div>`
  ).join('');
}

function renderAnonResult(anonText, reps, mode) {
  document.getElementById('anonText').value = anonText;
  const listEl = document.getElementById('repList');

  if (!reps.length) {
    listEl.innerHTML = '<div class="ib green" style="margin-bottom:11px;">‚úì Nessun identificatore regex rilevato. Verifica manualmente.</div>';
  } else {
    const modeChip = mode==='combined'
      ? `<span class="chip c-w" style="margin-left:6px;">{ } Regex</span><span class="chip c-ok" style="margin-left:4px;">üìñ Dizionario</span>`
      : mode==='dict'
      ? `<span class="chip c-ok" style="margin-left:6px;">üìñ Dizionario</span>`
      : `<span class="chip c-w" style="margin-left:6px;">{ } Regex Offline</span>`;
    let h = `<div class="rl"><div class="rtitle">${reps.length} sostituzion${reps.length===1?'e':'i'} ${modeChip}</div>`;
    for (const r of reps)
      h+=`<div class="rrow"><span class="rorig">${esc(r.orig)}</span><span class="rarr">‚Üí</span><span class="rnew">${esc(r.repl)}</span><span class="rtype">${r.type}</span></div>`;
    h+='</div>';
    listEl.innerHTML = h;
  }

  // Highlight redacted in original
  let hi = esc(S.cleanText);
  for (const r of reps)
    hi = hi.replace(new RegExp(escR(esc(r.orig)),'g'), `<span class="redacted">${esc(r.orig)}</span>`);
  document.getElementById('origText').innerHTML = hi;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XLS / XLSX LAB RESULTS PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleXlsDrop(e) {
  e.preventDefault();
  document.getElementById('xlsDropzone').style.borderColor='var(--border)';
  const f=e.dataTransfer.files[0]; if(f) processXls(f);
}
function handleXlsFile(e) { const f=e.target.files[0]; if(f) processXls(f); }

async function ensureSheetJs() {
  if (window.XLSX) return window.XLSX;
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload=()=>res(window.XLSX); s.onerror=()=>rej(new Error('Impossibile caricare SheetJS'));
    document.head.appendChild(s);
  });
}

async function processXls(file) {
  const spin=document.getElementById('xlsSpin'), stxt=document.getElementById('xlsStatusTxt');
  const status=document.getElementById('xlsStatus'), preview=document.getElementById('xlsPreview');
  status.style.display='block'; spin.style.display='inline-block';
  stxt.style.color='var(--mid)'; stxt.textContent='Caricamento SheetJS...';
  try {
    const XLS=await ensureSheetJs();
    stxt.textContent='Parsing '+file.name+'...';
    const buf=await file.arrayBuffer();
    const wb=XLS.read(buf,{type:'array',cellText:true,cellDates:true});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLS.utils.sheet_to_json(ws,{header:1,defval:'',raw:false});
    const fmt=formatLabRows(rows);
    S_XLS.text=fmt.text; S_XLS.filename=file.name;
    spin.style.display='none'; stxt.style.color='var(--green)';
    stxt.textContent=`‚úì ${fmt.examCount} esami estratti da "${file.name}"`;
    document.getElementById('xlsPreviewContent').textContent=fmt.preview;
    preview.style.display='block';
    document.getElementById('xlsFileInput').value='';
  } catch(err) {
    spin.style.display='none'; stxt.style.color='var(--red)'; stxt.textContent='‚úó '+err.message;
  }
}

function formatLabRows(rows) {
  let dataStart=0;
  for (let i=0; i<Math.min(rows.length,15); i++) {
    const r=rows[i].map(c=>String(c).trim().toLowerCase());
    if (r.some(c=>c.includes('metodo')||c.includes('unit')||c.includes('intervallo')||c.includes('riferimento'))) {
      dataStart=i+1; break;
    }
  }
  const lines=[];
  let examCount=0;
  for (let i=dataStart; i<rows.length; i++) {
    const row=rows[i].map(c=>String(c).trim());
    const [name,value,,unit,refRange]=row;
    if (!name) continue;
    const isComment=name&&!value&&name.length>40;
    const isSection=name&&!value&&!unit&&!isComment;
    const isExam=name&&value&&value!=='';
    if (isComment) { lines.push(`  ‚Äª ${name}`); continue; }
    if (isSection) { lines.push(`\n[${name.toUpperCase()}]`); continue; }
    if (isExam) {
      examCount++;
      let line=`  ${name}: ${value}`;
      if (unit) line+=` ${unit}`;
      if (refRange) line+=` (rif: ${refRange})`;
      if (isAbnormal(value,refRange)) line+=' ‚ö†';
      lines.push(line);
    }
  }
  const text=`## ESAMI DI LABORATORIO (da file: ${S_XLS.filename||'referto.xls'})\n`+lines.join('\n');
  const preview=lines.slice(0,40).join('\n')+(lines.length>40?`\n  ... e altri ${lines.length-40} righe`:'');
  return {text,preview,examCount};
}

function isAbnormal(value,refRange) {
  if (!refRange||!value) return false;
  // If refRange looks like a date (contains / with day-month pattern), skip
  if (/\d{1,2}\/\d{1,2}/.test(refRange)) return false;
  const numVal=parseFloat(value.replace(',','.'));
  if (isNaN(numVal)) return false;
  const m=refRange.match(/([\d.,]+)\s*[-‚Äì]\s*([\d.,]+)/);
  if (!m) return false;
  const lo=parseFloat(m[1].replace(',','.')), hi=parseFloat(m[2].replace(',','.'));
  if (isNaN(lo)||isNaN(hi)) return false;
  return numVal<lo||numVal>hi;
}

function clearXls() {
  S_XLS.text=''; S_XLS.filename='';
  document.getElementById('xlsPreview').style.display='none';
  document.getElementById('xlsStatus').style.display='none';
  document.getElementById('xlsFileInput').value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF.js
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pdfjsLib=null;
async function ensurePdfJs() {
  if (pdfjsLib) return pdfjsLib;
  return new Promise((res,rej)=>{
    if (window.pdfjsLib) {pdfjsLib=window.pdfjsLib;res(pdfjsLib);return;}
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
    s.onload=()=>{
      pdfjsLib=window.pdfjsLib;
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
      res(pdfjsLib);
    };
    s.onerror=()=>rej(new Error('Impossibile caricare PDF.js.'));
    document.head.appendChild(s);
  });
}
function handlePdfDrop(e){e.preventDefault();document.getElementById('pdfDropzone').style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')processPdf(f);else alert('Carica un PDF.');}
function handlePdfFile(e){const f=e.target.files[0];if(f)processPdf(f);}
async function processPdf(file){
  const spin=document.getElementById('pdfSpin'),stxt=document.getElementById('pdfStatusTxt'),
    bar=document.getElementById('pdfBar'),status=document.getElementById('pdfStatus');
  status.style.display='block';spin.style.display='inline-block';
  bar.style.width='0%';stxt.style.color='var(--mid)';stxt.textContent='Caricamento PDF.js...';
  try{
    const lib=await ensurePdfJs();stxt.textContent=`Lettura: ${file.name}`;
    const ab=await file.arrayBuffer();const pdf=await lib.getDocument({data:ab}).promise;
    const tot=pdf.numPages;let full='';
    for(let i=1;i<=tot;i++){
      const pg=await pdf.getPage(i);const ct=await pg.getTextContent();
      let pt='',ly=null;
      for(const it of ct.items){
        if('str'in it){
          if(ly!==null&&Math.abs(it.transform[5]-ly)>5)pt+='\n';
          pt+=it.str;if(it.hasEOL)pt+='\n';ly=it.transform[5];
        }
      }
      full+=pt.trim()+'\n\n';bar.style.width=Math.round(i/tot*100)+'%';stxt.textContent=`Pag ${i}/${tot}...`;
    }
    full=full.replace(/\n{3,}/g,'\n\n').trim();
    const ex=document.getElementById('inp_raw').value.trim();
    document.getElementById('inp_raw').value=ex?ex+'\n\n--- '+file.name+' ---\n\n'+full:full;
    bar.style.width='100%';spin.style.display='none';stxt.style.color='var(--green)';
    stxt.textContent=`‚úì ${tot} pagina${tot===1?'':'e'} ¬∑ ${full.length.toLocaleString()} caratteri`;
    document.getElementById('pdfFileInput').value='';
  }catch(err){spin.style.display='none';stxt.style.color='var(--red)';stxt.textContent='‚úó '+err.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEMPLATE LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadLibrary(){try{return JSON.parse(localStorage.getItem('letteraai_lib')||'[]');}catch(e){return[];}}
function saveLibrary(lib){localStorage.setItem('letteraai_lib',JSON.stringify(lib));}

function renderLibrary(){
  const lib=loadLibrary();
  const grid=document.getElementById('tplGrid'),noMsg=document.getElementById('noTplMsg'),stats=document.getElementById('libStats');
  stats.textContent=`${lib.length} casi ¬∑ lettere ~${lib.reduce((a,t)=>a+tok(t.letter||''),0)} tok`;
  if(!lib.length){grid.innerHTML='';noMsg.style.display='block';updateRagPreview();return;}
  noMsg.style.display='none';
  grid.innerHTML=lib.map(t=>{
    const isActive=S.activeTemplateId===t.id;
    return `<div class="tpl-card${isActive?' active-tpl':''}" onclick="selectTemplate('${t.id}')">
      <button class="tpl-del" onclick="event.stopPropagation();deleteTemplate('${t.id}')">‚úï</button>
      <div class="tpl-name">${esc(t.name)}</div>
      <div class="tpl-meta" style="margin-bottom:6px;">${new Date(t.createdAt).toLocaleDateString('it-IT')}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        ${t.folder?`<span class="chip c-w">üìÅ ~${tok(t.folder)}t</span>`:''}
        ${t.letter?`<span class="chip c-ok">üìÑ ~${tok(t.letter)}t</span>`:''}
        ${t.fingerprint?`<span class="tpl-cached-badge">‚ö° fp ~${tok(t.fingerprint)}t</span>`:''}
      </div>
    </div>`;
  }).join('');
  updateRagPreview();
}

function selectTemplate(id){
  S.activeTemplateId=(S.activeTemplateId===id)?null:id;
  renderLibrary();updateTokenPanel();
  const t=loadLibrary().find(x=>x.id===id);
  document.getElementById('statusBadge').textContent=(t&&S.activeTemplateId===id)?`üìö ${t.name}`:'‚óè Pronto';
}
function deleteTemplate(id){
  if(!confirm('Eliminare questo caso?'))return;
  if(S.activeTemplateId===id)S.activeTemplateId=null;
  saveLibrary(loadLibrary().filter(t=>t.id!==id));renderLibrary();updateTokenPanel();
}
function getActiveFingerprint(){
  if(!S.activeTemplateId)return'';
  const t=loadLibrary().find(x=>x.id===S.activeTemplateId);
  return t?(t.fingerprint||''):'';
}

// TF-IDF RAG
const STOPWORDS_IT=new Set(['il','la','lo','i','gli','le','un','una','uno','dei','delle','degli','di','da','in','con','su','per','tra','fra','a','al','alla','allo','ai','alle','agli','del','della','dello','e','ed','o','ma','se','non','si','che','√®','era','sono','stato','stata','stati','state','ha','hanno','ho','nei','nelle','negli','nel','nella','nello','questo','questa','questi','queste','come','pi√π','anche','dopo','prima','durante','presso','viene','veniva','venivano','dal','dai','dalle','dagli']);

function tokenizeForTfidf(text){
  return text.toLowerCase().replace(/\[[\w_]+\]/g,'').replace(/[^a-z√†√®√©√¨√≠√≤√≥√π√∫\s]/g,' ').split(/\s+/).filter(w=>w.length>3&&!STOPWORDS_IT.has(w));
}
function buildTfIdf(docs){
  const N=docs.length,df={};
  for(const d of docs)for(const w of new Set(d))df[w]=(df[w]||0)+1;
  return docs.map(tokens=>{
    const tf={},vec={};
    for(const w of tokens)tf[w]=(tf[w]||0)+1;
    for(const[w,c]of Object.entries(tf))vec[w]=(c/tokens.length)*Math.log((N+1)/((df[w]||0)+1));
    return vec;
  });
}
function cosineSim(a,b){
  let dot=0,na=0,nb=0;
  for(const[w,v]of Object.entries(a)){dot+=v*(b[w]||0);na+=v*v;}
  for(const v of Object.values(b))nb+=v*v;
  return(na&&nb)?dot/(Math.sqrt(na)*Math.sqrt(nb)):0;
}
function findSimilarCases(queryText,topK=2){
  const lib=loadLibrary().filter(t=>t.folder&&t.letter);
  if(!lib.length)return[];
  const qt=tokenizeForTfidf(queryText);
  const allDocs=[qt,...lib.map(t=>tokenizeForTfidf(t.folder))];
  const vecs=buildTfIdf(allDocs);
  const scored=lib.map((t,i)=>({t,score:cosineSim(vecs[0],vecs[i+1])}));
  scored.sort((a,b)=>b.score-a.score);
  return scored.slice(0,topK).filter(x=>x.score>0.05);
}

function updateRagPreview(){
  const ragOn=document.getElementById('ragToggle')?.checked;
  const matches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const show=(wrapId,listId,showFolder)=>{
    const wrap=document.getElementById(wrapId),list=document.getElementById(listId);
    if(!wrap)return;
    if(!matches.length||!S.anonText){wrap.style.display='none';return;}
    wrap.style.display='block';
    list.innerHTML=matches.map(({t,score})=>`
      <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="flex:1;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);">${esc(t.name)}</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:2px;">lettera ~${tok(t.letter||'')} tok${showFolder?` ¬∑ cartella locale ~${tok(t.folder||'')} tok (non inviata)`:''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--blue);">${(score*100).toFixed(0)}%</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);">similarit√†</div>
        </div>
      </div>`).join('');
  };
  show('ragPreview','ragMatches',false);
  show('ragPreviewGen','ragMatchesGen',true);
}

// New case builder
function deleteNewTplSection(id){newTplSections=newTplSections.filter(s=>s.id!==id);renderNewTplSections();}
function renderNewTplSections(){
  const el=document.getElementById('newTplSections');
  if(!newTplSections.length){el.innerHTML='';return;}
  el.innerHTML=`<div style="margin-top:10px;"><div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;">Fingerprint Estratto</div>`
    +newTplSections.map(s=>`
    <div style="margin-bottom:8px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;">
        <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.08em;">${esc(s.label)}</span>
        <button style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--red);cursor:pointer;background:none;border:none;" onclick="deleteNewTplSection('${s.id}')">‚úï</button>
      </div>
      <textarea rows="2" style="font-size:11px;margin-top:0;" oninput="updateNewTplSection('${s.id}',this.value)">${esc(s.text||'')}</textarea>
    </div>`).join('')
    +`</div>`;
}
function updateNewTplSection(id,val){const s=newTplSections.find(x=>x.id===id);if(s)s.text=val;}
function buildFingerprintFromSections(sections){
  const active=sections.filter(s=>s.text&&s.text.trim());
  if(!active.length)return'';
  return active.map(s=>`[${s.label}]\n${s.text.trim()}`).join('\n\n');
}
async function autoExtractTemplate(){
  const key=document.getElementById('apiKeyInput').value.trim();
  const letter=document.getElementById('newCaseLetter').value.trim();
  if(!letter){alert('Incolla prima la lettera.');return;}
  if(!key){alert('Inserisci la API key nella sezione Generazione.');return;}
  const spin=document.getElementById('tplExtSpin'),status=document.getElementById('tplExtStatus');
  spin.style.display='inline-block';status.style.display='block';
  status.style.color='var(--mid)';status.textContent='Estrazione fingerprint con Haiku...';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:500,
        system:`Estrai lo stile da una lettera di dimissione medica italiana. Restituisci SOLO JSON:
{"apertura":"...","decorso":"...","terapia":"...","chiusura":"..."} Solo stile/registro, NO dati clinici. Solo JSON nudo.`,
        messages:[{role:'user',content:`Lettera:\n\n${letter}`}]}),
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const raw=(await resp.json()).content[0].text;
    const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const map={apertura:'Apertura',decorso:'Decorso tipo',terapia:'Terapia tipo',chiusura:'Chiusura'};
    newTplSections=[];
    for(const[k,label]of Object.entries(map))
      if(parsed[k])newTplSections.push({id:'ntpl_'+Date.now()+'_'+k,label,text:parsed[k]});
    renderNewTplSections();
    const origTok=tok(letter),newTok=tok(buildFingerprintFromSections(newTplSections));
    status.style.color='var(--green)';
    status.textContent=`‚úì Fingerprint estratto ¬∑ da ~${origTok} a ~${newTok} token (‚àí${Math.round((1-newTok/origTok)*100)}%)`;
  }catch(err){status.style.color='var(--red)';status.textContent='‚úó '+err.message;}
  finally{spin.style.display='none';}
}
function saveNewTemplate(){
  const name=document.getElementById('newTplName').value.trim();
  const folder=document.getElementById('newCaseFolder').value.trim();
  const letter=document.getElementById('newCaseLetter').value.trim();
  if(!name){alert('Inserisci un nome.');return;}
  if(!letter){alert('La lettera √® obbligatoria.');return;}
  const fp=buildFingerprintFromSections(newTplSections);
  const lib=loadLibrary();
  lib.push({id:'tpl_'+Date.now(),name,folder,letter,fingerprint:fp,createdAt:new Date().toISOString()});
  saveLibrary(lib);newTplSections=[];renderNewTplSections();
  ['newTplName','newCaseFolder','newCaseLetter'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('tplExtStatus').style.display='none';
  renderLibrary();alert(`Caso "${name}" salvato.`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOKEN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tok(str){return Math.round((str||'').length/4);}

function updateTokenPanel(){
  if(!S.anonText)return;
  const model=document.getElementById('modelSelect').value;
  const price=PRICING[model]||PRICING['claude-sonnet-4-6'];
  const sysTxt=document.getElementById('systemPrompt').value||DEFAULT_SYS;
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const templateTxt=buildLetterTemplate();
  const tSys=tok(sysTxt),tFp=tok(fp);
  const tRag=ragMatches.reduce((a,{t})=>a+tok(t.letter||''),0);
  const tTemplate=tok(templateTxt),tClinical=tok(S.anonText),tOut=900;
  const tCacheable=tFp+tRag,tTotal=tSys+tFp+tRag+tTemplate+tClinical;
  const cacheActive=tCacheable>0;
  const costNoCache=(tTotal/1e6)*price.in;
  const costCacheW=cacheActive?(tCacheable/1e6)*price.in_cache_write:0;
  const costCacheR=cacheActive?(tCacheable/1e6)*price.in_cache_read:0;
  const costNonCached=((tSys+tTemplate+tClinical)/1e6)*price.in;
  const costFirst=costCacheW+costNonCached,costSubseq=costCacheR+costNonCached;
  const costOut=(tOut/1e6)*price.out;
  const sections=[
    {label:'System Prompt',tokens:tSys,color:'#7a6340',cached:false},
    {label:'Fingerprint Stile',tokens:tFp,color:'#6ea8c9',cached:cacheActive&&tFp>0},
    {label:`RAG (${ragMatches.length} casi)`,tokens:tRag,color:'#a96ec9',cached:cacheActive&&tRag>0},
    {label:'Template lettera',tokens:tTemplate,color:'#7a7570',cached:false},
    {label:'Testo clinico',tokens:tClinical,color:'#c9a96e',cached:false},
    {label:'Output stimato',tokens:tOut,color:'#6ec98a',cached:false},
  ].filter(s=>s.tokens>0);
  const maxTok=Math.max(...sections.map(s=>s.tokens),1);
  let html='<div style="margin-bottom:12px;">';
  for(const s of sections){
    const pct=Math.round((s.tokens/maxTok)*100);
    const up=s.label==='Output stimato'?price.out:price.in;
    html+=`<div class="tok-row"><span class="tok-label">${s.label}${s.cached?'<span class="tok-cached">‚ö° cached</span>':''}</span><div class="tok-bar-wrap"><div class="tok-bar" style="width:${pct}%;background:${s.color};"></div></div><span class="tok-val">${s.tokens.toLocaleString()} tok</span><span class="tok-cost" style="color:${s.cached?'var(--blue)':'var(--dim)'};">$${((s.tokens/1e6)*up).toFixed(4)}</span></div>`;
  }
  html+='</div>';
  html+=`<div class="tok-total-row"><div class="tok-total-box"><div class="tlabel">Senza caching</div><div class="tval">$${(costNoCache+costOut).toFixed(4)}</div><div class="tsub">${(tTotal+tOut).toLocaleString()} token</div></div><div class="tok-total-box" style="${cacheActive?'border-color:var(--blue);':''}"><div class="tlabel">${cacheActive?'Con caching (1¬™)':'Nessun caso/template'}</div><div class="tval" style="color:${cacheActive?'var(--blue)':'var(--accent)'};">$${(costFirst+costOut).toFixed(4)}</div><div class="tsub">${cacheActive?`Successive: $${(costSubseq+costOut).toFixed(4)}`:'Seleziona un caso'}</div></div></div>`;
  if(cacheActive){
    const saving=costNoCache>0?((costNoCache-costSubseq)/costNoCache*100).toFixed(0):0;
    html+=`<div class="tok-cache-note">‚ö° ${tCacheable} token cacheable. Risparmio dalla 2¬™ chiamata: <strong>${saving}%</strong> sull'input.</div>`;
  }
  document.getElementById('tokRows').innerHTML=html;
  document.getElementById('cacheActiveBadge').style.display=cacheActive?'inline-flex':'none';
  updateRagPreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPT BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildLetterTemplate(){
  const citta=(document.getElementById('cfg_citta').value||'Padova').trim();
  const dott=(document.getElementById('cfg_dott').value||'Dott. [NOME]').trim();
  const prof=(document.getElementById('cfg_prof').value||'Prof. [NOME]').trim();
  const diagnosi=document.getElementById('inp_diagnosi').value.trim()||'[DIAGNOSI_PRINCIPALE]';
  const today=new Date().toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
  return `## TEMPLATE LETTERA DI DIMISSIONE

Genera la lettera seguendo ESATTAMENTE questa struttura. Per dati assenti: "Non documentato." ‚Äî MAI inventare.

---
${citta}, ${today}

All'attenzione del Medico Curante

Egregio Collega,
        dimettiamo in data odierna la Sua Assistita, [PAZIENTE_NOME], nata in data [DATA_NASCITA], ricoverata presso la nostra Clinica dal [DATA_RICOVERO] u.s., con diagnosi di:

"${diagnosi}"

**Motivo del ricovero**
[Prosa continua, passato remoto ‚Äî dati di presentazione dall'input]

**Non farmacoallergie note.** [oppure allergie se documentate]

**Terapia domiciliare**: [farmaci pre-ricovero dall'input]

**Anamnesi Patologica Remota**
[Trattini per voce ‚Äî dati APR dall'input]

**Anamnesi Fisiologica/Sociale/Familiare**
[Prosa concisa ‚Äî dati dall'input]

**Esame neurologico all'ingresso**: [se presente ‚Äî ometti altrimenti]

**Esame obiettivo generale all'ingresso**: [se presente ‚Äî ometti altrimenti]

Durante la degenza sono stati eseguiti i seguenti **esami di laboratorio:**
[Lista ‚Äî mantieni valori numerici esatti dall'input]

ed i seguenti **accertamenti strumentali** e **valutazioni specialistiche**:
[Lista ‚Äî mantieni date e referti esatti dall'input]

**Decorso clinico**
[Prosa clinica 150-300 parole, passato remoto, sintesi cronologica dell'input]

Alla dimissione [condizioni cliniche alla dimissione].

**Terapia alla dimissione:**
[Trascrivi ultima terapia dall'input ‚Äî farmaco, dose, frequenza]

[Follow-up e accertamenti pendenti dall'input]

Si prega di presentarsi muniti degli appositi foglietti azzurri allegati.

Sar√† nostra cura fornire gli esiti mediante Lettera di Completamento.

[Raccomandazioni specifiche se presenti nell'input]

Ringraziando per la collaborazione, rimaniamo a disposizione. Cordiali saluti.

${dott.padEnd(46)}${prof}
(Medico in formazione specialistica)${' '.repeat(14)}(Dirigente Medico)
---`;
}

function buildMessages(){
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const blocks=[];
  if(fp)blocks.push({type:'text',text:`## RIFERIMENTO STILISTICO\n\n${fp}\n\n---\n\n`,cache_control:{type:'ephemeral'}});
  if(ragMatches.length){
    let rb=`## ESEMPI DI RIFERIMENTO ‚Äî casi simili\n\nUsa per stile e struttura. NON copiare dati clinici.\n\n`;
    ragMatches.forEach(({t,score},i)=>{rb+=`### Esempio ${i+1} ‚Äî ${t.name} (${(score*100).toFixed(0)}%)\n\n${t.letter}\n\n---\n\n`;});
    blocks.push({type:'text',text:rb,cache_control:{type:'ephemeral'}});
  }
  blocks.push({type:'text',text:`## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n`+buildLetterTemplate()});
  const useCache=fp||ragMatches.length;
  return[{role:'user',content:useCache?blocks:blocks.map(b=>b.text).join('')}];
}

function buildUserPromptStr(){
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  let p='';
  if(fp)p+=`## RIFERIMENTO STILISTICO\n\n${fp}\n\n---\n\n`;
  if(ragMatches.length){
    p+=`## ESEMPI DI RIFERIMENTO\n\n`;
    ragMatches.forEach(({t,score},i)=>{p+=`### Esempio ${i+1} ‚Äî ${t.name} (${(score*100).toFixed(0)}%)\n\n${t.letter}\n\n---\n\n`;});
  }
  p+=`## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${S.anonText}\n</clinical_input>\n\n---\n\n`;
  p+=buildLetterTemplate();
  return p;
}

function proceedToGenerate(){
  S.anonText=document.getElementById('anonText').value;
  if(!S.anonText.trim()){alert('Nessun testo. Torna allo Step 1.');return;}
  if(!document.getElementById('systemPrompt').value.trim())
    document.getElementById('systemPrompt').value=DEFAULT_SYS;
  goTo(2);updateRagPreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateLetter(){
  const key=document.getElementById('apiKeyInput').value.trim();
  if(!key){showErr('Inserisci la API key Anthropic.');return;}
  if(!S.anonText){showErr('Nessun testo anonimizzato.');return;}
  const btn=document.getElementById('genBtn'),spin=document.getElementById('genSpin');
  btn.disabled=true;spin.style.display='inline-block';
  document.getElementById('genErr').style.display='none';
  document.getElementById('statusBadge').textContent='‚ü≥ Generando...';
  const fp=getActiveFingerprint();
  const ragOn=document.getElementById('ragToggle')?.checked;
  const ragMatches=(ragOn&&S.anonText)?findSimilarCases(S.anonText):[];
  const useCache=fp||ragMatches.length>0;
  const headers={'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'};
  if(useCache)headers['anthropic-beta']='prompt-caching-2024-07-31';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers,
      body:JSON.stringify({
        model:document.getElementById('modelSelect').value,
        max_tokens:3500,
        temperature:parseInt(document.getElementById('tempSlider').value)/10,
        system:[{type:'text',text:document.getElementById('systemPrompt').value||DEFAULT_SYS,...(useCache?{cache_control:{type:'ephemeral'}}:{})}],
        messages:buildMessages(),
      }),
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const data=await resp.json();
    S.letter=data.content[0].text;
    const u=data.usage||{};
    const price=PRICING[document.getElementById('modelSelect').value]||PRICING['claude-sonnet-4-6'];
    const inCost=((u.input_tokens||0)/1e6)*price.in;
    const cacheCr=((u.cache_creation_input_tokens||0)/1e6)*price.in_cache_write;
    const cacheRd=((u.cache_read_input_tokens||0)/1e6)*price.in_cache_read;
    const outCost=((u.output_tokens||0)/1e6)*price.out;
    const total=inCost+cacheCr+cacheRd+outCost;
    const usageEl=document.getElementById('usageInfo');
    usageEl.style.display='block';
    usageEl.innerHTML=`‚úì Costo reale ‚Äî input: ${u.input_tokens||0} tok ($${inCost.toFixed(4)})`
      +(u.cache_creation_input_tokens?` ¬∑ cache write: ${u.cache_creation_input_tokens} tok ($${cacheCr.toFixed(4)})`:'')+
      (u.cache_read_input_tokens?` ¬∑ cache read: ${u.cache_read_input_tokens} tok ($${cacheRd.toFixed(4)})`:'')
      +` ¬∑ output: ${u.output_tokens||0} tok ($${outCost.toFixed(4)}) ‚Äî <strong style="color:var(--text);">totale: $${total.toFixed(4)}</strong>`;
    document.getElementById('letterOut').textContent=S.letter;
    document.getElementById('statusBadge').textContent='‚úì Lettera generata';
    document.getElementById('nav3').classList.add('done');
    goTo(3);
  }catch(err){
    showErr('‚úó '+err.message);
    document.getElementById('statusBadge').textContent='‚úó Errore';
  }finally{btn.disabled=false;spin.style.display='none';}
}

function showErr(msg){const el=document.getElementById('genErr');el.textContent=msg;el.style.display='block';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPT VIEWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pTab='full',pSys='',pUsr='';
function showTab(t){
  pTab=t;
  ['full','system','user'].forEach(id=>
    document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)).classList.toggle('active',id===t));
  renderPromptView();
}
function renderPromptView(){
  const el=document.getElementById('promptView');
  if(!pSys&&!pUsr)return;
  if(pTab==='full')el.value='‚ïê‚ïê SYSTEM ‚ïê‚ïê\n\n'+pSys+'\n\n‚ïê‚ïê USER ‚ïê‚ïê\n\n'+pUsr;
  else if(pTab==='system')el.value=pSys;
  else el.value=pUsr;
}
function refreshPrompt(){
  if(!S.anonText){document.getElementById('promptView').value='Completa gli Step 1‚Äì2.';return;}
  pSys=document.getElementById('systemPrompt').value||DEFAULT_SYS;
  pUsr=buildUserPromptStr();
  renderPromptView();updateTokenPanel();
}
async function copyFull(){refreshPrompt();await navigator.clipboard.writeText(document.getElementById('promptView').value);flash();}
async function copyUser(){refreshPrompt();await navigator.clipboard.writeText(pUsr);flash();}
function flash(){const el=document.getElementById('copyConfirm');el.style.display='block';setTimeout(()=>el.style.display='none',1600);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OUTPUT ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyLetter(){navigator.clipboard.writeText(S.letter).then(()=>alert('Copiato.'));}
function printLetter(){
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Lettera di Dimissione</title><style>body{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.8;margin:2.5cm;color:#000}pre{white-space:pre-wrap;font-family:inherit}</style></head><body><pre>${esc(S.letter)}</pre></body></html>`);
  w.document.close();w.print();
}
function newLetter(){
  if(!confirm('Nuova lettera? I dati correnti andranno persi.'))return;
  S.rawText=S.cleanText=S.anonText=S.letter='';S.strippedBlocks=[];
  document.getElementById('inp_raw').value='';document.getElementById('inp_diagnosi').value='';
  document.getElementById('letterOut').textContent='‚Äî';document.getElementById('usageInfo').style.display='none';
  document.getElementById('statusBadge').textContent=S.activeTemplateId?'üìö Template attivo':'‚óè Pronto';
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('done'));
  goTo(0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveBaseSettings(){
  localStorage.setItem('letteraai_cfg',JSON.stringify({
    citta:document.getElementById('cfg_citta').value,
    reparto:document.getElementById('cfg_reparto').value,
    dott:document.getElementById('cfg_dott').value,
    prof:document.getElementById('cfg_prof').value,
    regex:document.getElementById('cfg_regex').value,
  }));alert('Impostazioni salvate.');
}
function loadBaseSettings(){
  try{
    const c=JSON.parse(localStorage.getItem('letteraai_cfg')||'{}');
    if(c.citta)document.getElementById('cfg_citta').value=c.citta;
    if(c.reparto)document.getElementById('cfg_reparto').value=c.reparto;
    if(c.dott)document.getElementById('cfg_dott').value=c.dott;
    if(c.prof)document.getElementById('cfg_prof').value=c.prof;
    if(c.regex)document.getElementById('cfg_regex').value=c.regex;
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escR(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function clearAll(){
  if(!confirm('Cancellare tutto?'))return;
  document.getElementById('inp_raw').value='';document.getElementById('inp_diagnosi').value='';
  S.rawText=S.cleanText=S.anonText=S.letter='';S.strippedBlocks=[];
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.getElementById('tempSlider').addEventListener('input',function(){
  document.getElementById('tempLabel').textContent=(this.value/10).toFixed(1);
});
document.getElementById('systemPrompt').addEventListener('input',()=>{updateTokenPanel();refreshPrompt();});
loadBaseSettings();
document.getElementById('systemPrompt').value=DEFAULT_SYS;
renderLibrary();
</script>
</body>
</html>
