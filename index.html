<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generatore Lettera di Dimissione</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  :root {
    --bg: #0f0f0f;
    --surface: #171717;
    --surface2: #1e1e1e;
    --surface3: #242424;
    --border: #2a2a2a;
    --border-active: #3d3d3d;
    --text: #e8e4dc;
    --text-dim: #7a7570;
    --text-mid: #b0aa9f;
    --accent: #c9a96e;
    --accent-dim: #7a6340;
    --accent-glow: rgba(201,169,110,0.12);
    --red: #c96e6e;
    --green: #6ec98a;
    --blue: #6e9ec9;
    --radius: 6px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Crimson Pro', Georgia, serif;
    font-size: 17px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ── LAYOUT ── */
  .app { display: grid; grid-template-columns: 220px 1fr; grid-template-rows: 56px 1fr; min-height: 100vh; }

  header {
    grid-column: 1 / -1;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 24px;
    gap: 16px;
  }
  .logo {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 500; letter-spacing: 0.12em;
    color: var(--accent); text-transform: uppercase;
  }
  .logo span { color: var(--text-dim); }
  .header-badge {
    margin-left: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--text-dim);
    background: var(--surface2); border: 1px solid var(--border);
    padding: 3px 10px; border-radius: 20px; letter-spacing: 0.08em;
  }

  aside {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 20px 0;
    display: flex; flex-direction: column; gap: 2px;
  }

  .nav-section {
    padding: 0 12px 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; color: var(--text-dim); letter-spacing: 0.14em;
    text-transform: uppercase;
  }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 16px; margin: 0 8px;
    border-radius: var(--radius);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; color: var(--text-mid);
    cursor: pointer; border: none; background: transparent;
    width: calc(100% - 16px); text-align: left;
    transition: all 0.15s;
    position: relative;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active {
    background: var(--accent-glow);
    color: var(--accent);
    border: 1px solid var(--accent-dim);
  }
  .nav-item .step-num {
    width: 18px; height: 18px; border-radius: 50%;
    background: var(--surface3); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 9px; flex-shrink: 0;
  }
  .nav-item.active .step-num { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
  .nav-item.done .step-num { background: rgba(110,201,138,0.15); border-color: var(--green); color: var(--green); }
  .nav-item.done { color: var(--text-mid); }

  main {
    overflow-y: auto;
    background: var(--bg);
  }

  /* ── PANELS ── */
  .panel { display: none; padding: 32px; max-width: 860px; }
  .panel.active { display: block; }

  .panel-title {
    font-size: 26px; font-weight: 300; color: var(--text);
    margin-bottom: 6px; letter-spacing: -0.01em;
  }
  .panel-subtitle {
    font-size: 14px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 28px;
  }

  /* ── FORM ELEMENTS ── */
  label {
    display: block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--text-dim);
    letter-spacing: 0.1em; text-transform: uppercase;
    margin-bottom: 6px; margin-top: 20px;
  }
  label:first-child { margin-top: 0; }

  textarea {
    width: 100%; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius);
    color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 12px; line-height: 1.7; padding: 14px;
    resize: vertical; transition: border-color 0.15s;
    outline: none;
  }
  textarea:focus { border-color: var(--accent-dim); }
  textarea::placeholder { color: var(--text-dim); }

  input[type=text] {
    width: 100%; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius);
    color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 12px; padding: 10px 14px;
    transition: border-color 0.15s; outline: none;
  }
  input[type=text]:focus { border-color: var(--accent-dim); }

  /* ── BUTTONS ── */
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 20px; border-radius: var(--radius);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 500; letter-spacing: 0.06em;
    cursor: pointer; border: 1px solid; transition: all 0.15s;
    text-transform: uppercase;
  }
  .btn-primary {
    background: var(--accent); color: #0f0f0f;
    border-color: var(--accent);
  }
  .btn-primary:hover { background: #e0c07a; border-color: #e0c07a; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-ghost {
    background: transparent; color: var(--text-mid);
    border-color: var(--border);
  }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); border-color: var(--border-active); }

  .btn-danger {
    background: transparent; color: var(--red);
    border-color: rgba(201,110,110,0.3);
  }
  .btn-danger:hover { background: rgba(201,110,110,0.08); }

  .btn-row { display: flex; gap: 10px; margin-top: 24px; flex-wrap: wrap; }

  /* ── UPLOAD DROP ZONE ── */
  .dropzone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
    position: relative;
  }
  .dropzone:hover, .dropzone.drag-over {
    border-color: var(--accent-dim);
    background: var(--accent-glow);
  }
  .dropzone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .dropzone-icon { font-size: 32px; margin-bottom: 10px; }
  .dropzone-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; color: var(--text-dim);
  }
  .dropzone-text strong { color: var(--accent); display: block; margin-bottom: 4px; font-size: 13px; }

  /* ── OCR PROGRESS ── */
  .progress-bar {
    width: 100%; height: 3px;
    background: var(--surface3);
    border-radius: 2px; margin: 12px 0;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%; background: var(--accent);
    border-radius: 2px; transition: width 0.3s;
    width: 0%;
  }

  /* ── ANON REVIEW ── */
  .diff-container {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
    margin-bottom: 16px;
  }
  .diff-box { }
  .diff-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; color: var(--text-dim);
    letter-spacing: 0.14em; text-transform: uppercase;
    margin-bottom: 8px; padding: 4px 8px;
    background: var(--surface2); border-radius: 3px; display: inline-block;
  }
  .diff-text {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px; font-family: 'JetBrains Mono', monospace;
    font-size: 11px; line-height: 1.8; white-space: pre-wrap;
    max-height: 400px; overflow-y: auto;
  }
  .diff-text .redacted {
    background: rgba(201,110,110,0.15);
    color: var(--red);
    border-radius: 2px; padding: 0 3px;
    font-weight: 500;
  }
  .diff-text .replaced {
    background: rgba(110,201,138,0.15);
    color: var(--green);
    border-radius: 2px; padding: 0 3px;
  }

  .replacements-list {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px; margin-bottom: 16px;
  }
  .rep-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--text-dim);
    letter-spacing: 0.1em; text-transform: uppercase;
    margin-bottom: 10px;
  }
  .rep-item {
    display: flex; align-items: center; gap: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; padding: 4px 0;
    border-bottom: 1px solid var(--border);
  }
  .rep-item:last-child { border-bottom: none; }
  .rep-original { color: var(--red); flex: 1; }
  .rep-arrow { color: var(--text-dim); }
  .rep-new { color: var(--green); flex: 1; }
  .rep-type {
    color: var(--text-dim); font-size: 9px;
    background: var(--surface3); padding: 2px 6px; border-radius: 3px;
  }

  /* ── API KEY ── */
  .api-key-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px; margin-bottom: 20px;
  }
  .api-notice {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--accent);
    display: flex; align-items: flex-start; gap: 8px;
    margin-top: 8px; line-height: 1.5;
  }

  /* ── OUTPUT ── */
  .letter-output {
    background: #faf8f3;
    color: #1a1a1a;
    border-radius: var(--radius);
    padding: 48px 52px;
    font-family: 'Crimson Pro', Georgia, serif;
    font-size: 16px; line-height: 1.75;
    white-space: pre-wrap;
    border: 1px solid #d4d0c8;
    box-shadow: 0 4px 32px rgba(0,0,0,0.4);
    max-height: 700px; overflow-y: auto;
  }
  .letter-output .letter-header { text-align: right; color: #555; font-size: 14px; margin-bottom: 24px; }
  .letter-output .letter-to { margin-bottom: 20px; }
  .letter-output .letter-section-title { font-weight: 600; margin-top: 20px; margin-bottom: 4px; }
  .letter-output .letter-diagnosis { text-align: center; font-weight: 600; font-style: italic; margin: 16px 0; }

  /* ── STATUS CHIPS ── */
  .chip {
    display: inline-flex; align-items: center; gap: 5px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; letter-spacing: 0.08em;
    padding: 4px 10px; border-radius: 20px;
    text-transform: uppercase;
  }
  .chip-ok { background: rgba(110,201,138,0.12); color: var(--green); border: 1px solid rgba(110,201,138,0.25); }
  .chip-warn { background: rgba(201,169,110,0.12); color: var(--accent); border: 1px solid rgba(201,169,110,0.25); }
  .chip-err { background: rgba(201,110,110,0.12); color: var(--red); border: 1px solid rgba(201,110,110,0.25); }

  /* ── LOADING ── */
  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  /* ── CARD ── */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    margin-bottom: 16px;
  }

  /* ── INFO BOX ── */
  .infobox {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent-dim);
    border-radius: 0 var(--radius) var(--radius) 0;
    padding: 12px 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; color: var(--text-dim);
    line-height: 1.6; margin-bottom: 16px;
  }
  .infobox.green { border-left-color: var(--green); }
  .infobox.red { border-left-color: var(--red); }

  /* ── FREE TIER INFO ── */
  .free-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
    margin-bottom: 24px;
  }
  .free-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
  }
  .free-card-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--accent);
    letter-spacing: 0.08em; margin-bottom: 6px; text-transform: uppercase;
  }
  .free-card-val {
    font-size: 18px; font-weight: 600; color: var(--text);
    margin-bottom: 4px;
  }
  .free-card-desc {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; color: var(--text-dim);
  }

  hr.divider {
    border: none; border-top: 1px solid var(--border);
    margin: 24px 0;
  }

  .confirm-bar {
    position: sticky; bottom: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 14px 24px;
    display: flex; align-items: center; gap: 14px;
  }
  .confirm-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; color: var(--text-mid);
  }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-active); border-radius: 3px; }

  @media (max-width: 700px) {
    .app { grid-template-columns: 1fr; }
    aside { display: none; }
    .diff-container { grid-template-columns: 1fr; }
    .free-grid { grid-template-columns: 1fr; }
  }

  /* ── CHECKLIST ── */
  .check-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 10px 14px; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius);
    cursor: pointer; transition: all 0.15s; user-select: none;
  }
  .check-item:hover { border-color: var(--border-active); background: var(--surface2); }
  .check-item.checked { border-color: var(--green); background: rgba(110,201,138,0.06); }
  .check-box { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-dim); flex-shrink:0; line-height:1.4; }
  .check-item.checked .check-box { color: var(--green); }
  .check-text { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-mid); line-height: 1.6; }
  .check-item.checked .check-text { color: var(--text); }

</style>
</head>
<body>

<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">Lettera<span>.</span>AI</div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);">Generatore Lettera di Dimissione — Uso Privato</div>
    <div class="header-badge" id="statusBadge">● Pronto</div>
  </header>

  <!-- SIDEBAR -->
  <aside>
    <div class="nav-section">Flusso</div>
    <button class="nav-item active" onclick="goTo(0)" id="nav0">
      <span class="step-num">1</span> Dati Clinici
    </button>
    <button class="nav-item" onclick="goTo(1)" id="nav1">
      <span class="step-num">2</span> Farmaci / OCR
    </button>
    <button class="nav-item" onclick="goTo(2)" id="nav2">
      <span class="step-num">3</span> Anonimizzazione
    </button>
    <button class="nav-item" onclick="goTo(3)" id="nav3">
      <span class="step-num">4</span> Generazione
    </button>
    <button class="nav-item" onclick="goTo(4)" id="nav4">
      <span class="step-num">5</span> Lettera
    </button>

    <div class="nav-section" style="margin-top:24px;">Config</div>
    <button class="nav-item" onclick="goTo(5)" id="nav5">
      <span class="step-num">⚙</span> Impostazioni
    </button>
    <button class="nav-item" onclick="goTo(6)" id="nav6">
      <span class="step-num">?</span> Free Tier Info
    </button>
  </aside>

  <!-- MAIN -->
  <main id="mainContent">

    <!-- ═══ STEP 1: CLINICAL DATA ═══ -->
    <div class="panel active" id="panel0">
      <div class="panel-title">Dati Clinici</div>
      <div class="panel-subtitle">// step 01 — incolla il testo clinico</div>

      <div class="infobox">
        Incolla qui il testo grezzo: esami ematochimici, referti di imaging, consulenze specialistiche, anamnesi. Il sistema estrarrà e strutturerà automaticamente le informazioni.
      </div>

      <label>Motivo del Ricovero / Presentazione in PS</label>
      <textarea id="inp_motivo" rows="5" placeholder="Es: In data 22/04 alle ore 10 circa, esordio di astenia e debolezza all'arto superiore sinistro..."></textarea>

      <label>Anamnesi Patologica Remota</label>
      <textarea id="inp_apr" rows="5" placeholder="Patologie, interventi chirurgici, terapia domiciliare..."></textarea>

      <label>Anamnesi Fisiologica / Sociale / Familiare</label>
      <textarea id="inp_afs" rows="3" placeholder="Condizioni di vita, abitudini, familiarità..."></textarea>

      <label>Esami di Laboratorio</label>
      <textarea id="inp_lab" rows="6" placeholder="Profilo ematologico, metabolico, funzionalità epatica/renale, tiroidea..."></textarea>

      <label>Accertamenti Strumentali e Valutazioni Specialistiche</label>
      <textarea id="inp_strum" rows="8" placeholder="ECG, Eco cardiaco, TC encefalo, RMN, ECD TSA, consulenze..."></textarea>

      <label>Decorso Clinico</label>
      <div class="infobox" style="margin-bottom:8px;">
        Il decorso clinico verrà <strong style="color:var(--accent);">generato automaticamente</strong> nella fase Farmaci, sintetizzando tutti i dati inseriti. Puoi comunque inserire note aggiuntive qui sotto che verranno integrate.
      </div>
      <textarea id="inp_decorso" rows="4" placeholder="Note aggiuntive per il decorso (opzionale) — es: sintomi riferiti durante la degenza, eventi intercorrenti non documentati altrove..."></textarea>

      <label>Diagnosi Principale (per intestazione)</label>
      <input type="text" id="inp_diagnosi" placeholder='Es: "Sospetto minor stroke silviano destro a genesi indeterminata"'>

      <label>Condizioni alla Dimissione</label>
      <textarea id="inp_condizioni" rows="2" placeholder="Es: La paziente permane negativa per sintomi neurologici acuti."></textarea>

      <div class="btn-row">
        <button class="btn btn-primary" onclick="goTo(1)">Avanti → Farmaci</button>
        <button class="btn btn-ghost" onclick="clearAll()">✕ Reset</button>
      </div>
    </div>

    <!-- ═══ STEP 2: MEDICATIONS / OCR ═══ -->
    <div class="panel" id="panel1">
      <div class="panel-title">Farmaci & Decorso</div>
      <div class="panel-subtitle">// step 02 — OCR, analisi terapia, generazione decorso</div>

      <div class="infobox">
        Le funzioni AI (✦) richiedono la API key. Inseriscila qui o nello Step 4 — è la stessa.
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:20px;">
        <input type="password" id="apiKeyInput2" placeholder="API key Anthropic (sk-ant-...)" style="flex:1;font-family:'JetBrains Mono',monospace;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:12px;padding:10px 14px;outline:none;" oninput="syncApiKey(this.value)">
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);">sincronizzata con Step 4</span>
      </div>

      <label>Carica Screenshot Foglio Terapia</label>
      <div class="dropzone" id="dropzone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <input type="file" accept="image/*" onchange="handleImageUpload(event)">
        <div class="dropzone-icon">⬆</div>
        <div class="dropzone-text">
          <strong>Clicca o trascina immagine</strong>
          PNG, JPG, WEBP — processato offline con Tesseract.js
        </div>
      </div>

      <div id="ocrProgress" style="display:none;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:12px;" id="ocrStatus">Inizializzazione OCR...</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div id="ocrPreview" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Testo OCR estratto</div>
          <span class="chip chip-warn">⚠ Verifica prima di procedere</span>
        </div>
        <textarea id="ocrText" rows="6" placeholder="Testo estratto dall'OCR..."></textarea>
      </div>

      <hr class="divider">

      <label>Terapia Domiciliare (pre-ricovero)</label>
      <textarea id="inp_terapia_dom" rows="3" placeholder="Es: eutirox 100mg, ramipril 5mg, amlodipina 5mg, bisoprololo 2.5mg"></textarea>

      <label>Ultima Terapia Somministrata in Reparto (base per dimissione)</label>
      <div class="infobox" style="margin-bottom:8px;">
        Incolla qui la terapia dell'<strong style="color:var(--accent);">ultimo giorno di degenza</strong> (dall'OCR o manualmente). Verrà usata come punto di partenza per la terapia di dimissione — l'AI analizzerà le lettere esempio per rilevare pattern di modifica.
      </div>
      <textarea id="inp_ultima_terapia" rows="6" placeholder="Es:&#10;Acido acetilsalicilico 100 mg — 1 cp ore 12&#10;Clopidogrel 75 mg — 1 cp ore 8&#10;Ramipril 5 mg — 1 cp ore 8&#10;Amlodipina 5 mg — 1 cp ore 20&#10;Bisoprololo 2.5 mg — 1 cp ore 8&#10;Eutirox 100 mcg — 1 cp ore 8"></textarea>

      <!-- DRUG INTELLIGENCE PANEL -->
      <div id="drugIntelPanel" style="display:none;margin-top:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Analisi Intelligente Terapia</div>
          <span class="chip" id="drugIntelChip">⟳ Analisi in corso...</span>
        </div>
        <div id="drugIntelContent" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.8;color:var(--text-mid);"></div>
        <div style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);">Modifica la terapia di dimissione proposta se necessario:</div>
      </div>

      <label style="margin-top:16px;">Terapia alla Dimissione <span style="color:var(--accent);font-size:10px;">✦ Auto-proposta dall'AI</span></label>
      <textarea id="inp_terapia_dim" rows="8" placeholder="Verrà auto-compilata dopo l'analisi AI, oppure inserisci manualmente...&#10;&#10;Farmaco — dose — frequenza — note"></textarea>

      <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;">
        <button class="btn btn-ghost" style="font-size:10px;" onclick="copyFromUltimaTerapia()">← Copia da ultima terapia senza modifiche</button>
        <button class="btn btn-ghost" style="font-size:10px;color:var(--accent);border-color:var(--accent-dim);" id="drugAnalyzeBtn" onclick="analyzeDrugsWithAI()">✦ Analizza con AI</button>
      </div>

      <hr class="divider">

      <!-- DECORSO AUTO-GENERATE -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <label style="margin:0;">Decorso Clinico <span style="color:var(--accent);font-size:10px;">✦ Auto-generato dall'AI</span></label>
        <button class="btn btn-ghost" style="font-size:10px;color:var(--accent);border-color:var(--accent-dim);" id="decorsoBtn" onclick="generateDecorso()">
          <span class="spinner" id="decorsoSpinner" style="display:none;"></span>
          ✦ Genera Decorso
        </button>
      </div>
      <div class="infobox" id="decorsoInfobox" style="margin-bottom:8px;">
        Clicca "Genera Decorso" per sintetizzare automaticamente il decorso clinico da tutti i dati inseriti. Richiede API key (vedi Step 4). Puoi anche compilare manualmente.
      </div>
      <textarea id="inp_decorso_generated" rows="10" placeholder="Il decorso verrà generato qui, oppure compilalo manualmente..."></textarea>
      <div id="decorsoError" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);margin-top:6px;display:none;"></div>

      <hr class="divider">

      <label>Esami Pendenti / Follow-up</label>
      <textarea id="inp_followup" rows="4" placeholder="Es:&#10;- RM e Angio-RM encefalo presso Neuroradiologia (data da comunicare)&#10;- Visita neurologica di controllo ambulatoriale (data da comunicare)&#10;- ECG Holter in refertazione"></textarea>

      <label>Raccomandazioni Specifiche</label>
      <textarea id="inp_raccomandazioni" rows="3" placeholder="Es: Frequente controllo parametri pressori domicilio. Ecocardiografia di controllo a 3 mesi. Visita ortodonzista per bruxismo."></textarea>

      <div class="btn-row">
        <button class="btn btn-ghost" onclick="goTo(0)">← Indietro</button>
        <button class="btn btn-primary" onclick="buildAndAnonymize()">Avanti → Anonimizza</button>
      </div>
    </div>

    <!-- ═══ STEP 3: ANONYMIZATION ═══ -->
    <div class="panel" id="panel2">
      <div class="panel-title">Revisione Anonimizzazione</div>
      <div class="panel-subtitle">// step 03 — tre livelli: checklist → regex → Claude Haiku</div>

      <!-- LAYER EXPLANATION -->
      <div class="card" style="margin-bottom:16px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;">Architettura Privacy — 3 Livelli</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);margin-bottom:6px;">LIVELLO 1</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);margin-bottom:4px;">Checklist manuale</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);">Tu rimuovi i dati più evidenti prima di qualsiasi elaborazione. Zero rete.</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);margin-bottom:6px;">LIVELLO 2</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);margin-bottom:4px;">Regex locale</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);">CF, telefoni, DOB, titoli+nomi strutturati. Gira nel browser, istantaneo.</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);margin-bottom:6px;">LIVELLO 3</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);margin-bottom:4px;">Claude Haiku</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);">Rileva nomi liberi nel testo residuo. DPA + SCCs EU. ~€0.001/paziente.</div>
          </div>
        </div>
      </div>

      <!-- LAYER 1: MANUAL CHECKLIST — shown before anonymization runs -->
      <div id="checklistPanel">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;">① Checklist Pre-Invio — completa prima di procedere</div>
        <div class="infobox" style="margin-bottom:14px;">
          Rimuovi manualmente i dati più sensibili <strong style="color:var(--text);">direttamente nei campi dello Step 1</strong> prima di cliccare "Avanti". Questa checklist conferma che tu abbia fatto questa verifica.
        </div>

        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
          <label class="check-item" onclick="toggleCheck(this)">
            <span class="check-box" id="chk0">☐</span>
            <span class="check-text">Ho rimosso o sostituito il <strong>cognome del paziente</strong> nei campi di testo</span>
          </label>
          <label class="check-item" onclick="toggleCheck(this)">
            <span class="check-box" id="chk1">☐</span>
            <span class="check-text">Ho rimosso o sostituito i <strong>nomi dei medici curanti</strong> (es. "dott.ssa Giovanna", "con Sara")</span>
          </label>
          <label class="check-item" onclick="toggleCheck(this)">
            <span class="check-box" id="chk2">☐</span>
            <span class="check-text">Ho rimosso o sostituito i <strong>nomi specifici di reparti/strutture</strong> identificabili</span>
          </label>
          <label class="check-item" onclick="toggleCheck(this)">
            <span class="check-box" id="chk3">☐</span>
            <span class="check-text">Ho rimosso <strong>codice fiscale, data di nascita, numero di telefono</strong> se presenti</span>
          </label>
          <label class="check-item" onclick="toggleCheck(this)">
            <span class="check-box" id="chk4">☐</span>
            <span class="check-text">Ho rimosso <strong>indirizzi, numeri cartella clinica, ID ospedalieri</strong></span>
          </label>
        </div>

        <div id="checklistError" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);margin-bottom:12px;display:none;">
          ✗ Completa tutte le voci della checklist prima di procedere.
        </div>

        <button class="btn btn-primary" onclick="proceedToAnonymize()">
          ✓ Checklist completata — Avvia Anonimizzazione
        </button>
      </div>

      <!-- LAYER 2+3: ANONYMIZATION RESULT — shown after anonymization runs -->
      <div id="anonResultPanel" style="display:none;">
        <!-- Status bar -->
        <div id="anonStatus" style="font-family:'JetBrains Mono',monospace;font-size:11px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;display:flex;align-items:center;gap:10px;">
          <span class="spinner" id="anonSpinner"></span>
          <span id="anonStatusText">Elaborazione...</span>
        </div>

        <!-- Replacements list -->
        <div id="replacementsList" style="margin-bottom:14px;"></div>

        <!-- Diff view -->
        <div class="diff-container">
          <div class="diff-box">
            <div class="diff-label">Testo originale (solo locale — non inviato)</div>
            <div class="diff-text" id="origText" style="max-height:380px;overflow-y:auto;">—</div>
          </div>
          <div class="diff-box">
            <div class="diff-label">Testo anonimizzato ✏ modificabile</div>
            <textarea id="anonText" class="diff-text" style="height:380px;font-size:11px;resize:vertical;"></textarea>
          </div>
        </div>

        <!-- Final confirmation -->
        <div class="infobox red" style="margin-top:14px;">
          ⚠ Revisiona attentamente ogni riga. Correggi manualmente qualsiasi nome o dato rimasto nel testo a destra prima di confermare.
        </div>

        <div style="display:flex;align-items:center;gap:12px;margin-top:12px;">
          <input type="checkbox" id="confirmAnon" style="accent-color:var(--accent);width:16px;height:16px;flex-shrink:0;">
          <label style="margin:0;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-mid);text-transform:none;letter-spacing:0;cursor:pointer;" for="confirmAnon">
            Confermo di aver revisionato manualmente il testo e che nessun dato identificativo è rimasto
          </label>
        </div>

        <div class="btn-row">
          <button class="btn btn-ghost" onclick="resetToChecklist()">← Torna alla checklist</button>
          <button class="btn btn-primary" onclick="proceedToGenerate()">Avanti → Genera Lettera</button>
        </div>
      </div>
    </div>

    <!-- ═══ STEP 4: GENERATE ═══ -->
    <div class="panel" id="panel3">
      <div class="panel-title">Generazione Lettera</div>
      <div class="panel-subtitle">// step 04 — invio all'AI</div>

      <div id="apiKeySection" class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.1em;">API Key Anthropic</div>
        <input type="password" id="apiKeyInput" placeholder="sk-ant-...  (salvata solo in memoria, non persistita)" style="font-family:'JetBrains Mono',monospace;">
        <div class="api-notice">
          <span>ℹ</span>
          <span>La chiave non viene mai salvata su disco o inviata ad altri server. Viene usata solo per la singola chiamata API a api.anthropic.com. Per uso gratuito vedi la sezione Free Tier Info.</span>
        </div>
      </div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.1em;">Modello & Parametri</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label>Modello</label>
            <select id="modelSelect" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:10px;outline:none;">
              <option value="claude-haiku-4-5-20251001">claude-haiku-4-5 (più economico)</option>
              <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6 (migliore qualità)</option>
            </select>
          </div>
          <div>
            <label>Temperatura (0 = preciso)</label>
            <input type="range" id="tempSlider" min="0" max="5" value="1" step="1" style="width:100%;accent-color:var(--accent);margin-top:12px;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);text-align:center;" id="tempLabel">0.1</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.1em;">Prompt di Sistema (modificabile)</div>
        <textarea id="systemPrompt" rows="12" style="font-size:11px;" ></textarea>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;">Prompt Completo — Copia per qualsiasi AI</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-ghost" style="font-size:10px;" onclick="refreshFullPrompt()">↺ Aggiorna</button>
            <button class="btn btn-ghost" style="font-size:10px;" onclick="copyFullPrompt()" id="copyPromptBtn">⎘ Copia tutto</button>
            <button class="btn btn-ghost" style="font-size:10px;" onclick="copyUserPromptOnly()" >⎘ Solo user prompt</button>
          </div>
        </div>
        <div class="infobox" style="margin-bottom:10px;">
          Questo è l'esatto prompt inviato all'API. Puoi copiarlo e incollarlo su ChatGPT, Gemini, o qualsiasi altro AI. Il <strong style="color:var(--accent);">System Prompt</strong> va nel campo "Istruzioni di sistema", lo <strong style="color:var(--accent);">User Prompt</strong> nel campo messaggio.
        </div>

        <!-- Tab switcher -->
        <div style="display:flex;gap:4px;margin-bottom:8px;">
          <button class="btn" id="tabFull" onclick="showPromptTab('full')"
            style="font-size:10px;background:var(--accent-glow);color:var(--accent);border-color:var(--accent-dim);padding:6px 14px;">
            Prompt Completo
          </button>
          <button class="btn btn-ghost" id="tabSystem" onclick="showPromptTab('system')"
            style="font-size:10px;padding:6px 14px;">
            System
          </button>
          <button class="btn btn-ghost" id="tabUser" onclick="showPromptTab('user')"
            style="font-size:10px;padding:6px 14px;">
            User
          </button>
        </div>

        <div style="position:relative;">
          <textarea id="fullPromptView" readonly
            style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);
                   color:var(--text-dim);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;
                   padding:14px;resize:vertical;height:320px;outline:none;white-space:pre-wrap;">
Clicca "Aggiorna" per assemblare il prompt completo.</textarea>
          <div id="copyConfirm" style="display:none;position:absolute;top:10px;right:10px;
               background:var(--green);color:#0f0f0f;font-family:'JetBrains Mono',monospace;
               font-size:10px;padding:4px 10px;border-radius:4px;font-weight:600;">
            ✓ Copiato!
          </div>
        </div>

        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:6px;" id="promptTokenEstimate"></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-ghost" onclick="goTo(2)">← Indietro</button>
        <button class="btn btn-primary" id="generateBtn" onclick="generateLetter()">
          <span class="spinner" id="generateSpinner" style="display:none;"></span>
          ✦ Genera Lettera
        </button>
      </div>
      <div id="generateError" style="margin-top:12px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);display:none;"></div>
    </div>

    <!-- ═══ STEP 5: LETTER OUTPUT ═══ -->
    <div class="panel" id="panel4">
      <div class="panel-title">Lettera Generata</div>
      <div class="panel-subtitle">// step 05 — revisiona, copia, stampa</div>

      <div class="infobox green">
        ✓ Lettera generata. Revisiona ogni sezione — sostituisci i placeholder [PAZIENTE_NOME], [DATA_NASCITA], ecc. con i dati reali prima di stampare.
      </div>

      <div id="letterOutput" class="letter-output">—</div>

      <div class="btn-row" style="margin-top:20px;">
        <button class="btn btn-primary" onclick="copyLetter()">⎘ Copia testo</button>
        <button class="btn btn-ghost" onclick="printLetter()">⎙ Stampa / PDF</button>
        <button class="btn btn-ghost" onclick="goTo(0)">↺ Nuova lettera</button>
      </div>
    </div>

    <!-- ═══ STEP 6: SETTINGS ═══ -->
    <div class="panel" id="panel5">
      <div class="panel-title">Impostazioni</div>
      <div class="panel-subtitle">// config — personalizza intestazione e template</div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Intestazione Ospedale (anonimizzata)</div>
        <label>Città / Data</label>
        <input type="text" id="cfg_citta" placeholder="Es: Padova" value="Padova">
        <label>U.O. / Reparto</label>
        <input type="text" id="cfg_reparto" placeholder="Es: U.O. di Neurologia">
        <label>Titolo Medico in Formazione</label>
        <input type="text" id="cfg_dott" placeholder="Es: Dott. [COGNOME]">
        <label>Titolo Dirigente Medico</label>
        <input type="text" id="cfg_prof" placeholder="Es: Prof. [COGNOME]">
      </div>

      <div class="card">
      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Hugging Face Token — NER Anonimizzazione</div>
      </div>

        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Regex Aggiuntive Anonimizzazione</div>
        <textarea id="cfg_regex" rows="5" placeholder='Aggiungi pattern JSON, es:&#10;[{"pattern": "NHI:\\s*[A-Z]{3}\\d{4}", "replace": "[ID_PAZIENTE]"},&#10; {"pattern": "\\b\\d{7}\\b", "replace": "[MATRICOLA]"}]'></textarea>
      </div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Lettere Esempio (few-shot)</div>
        <textarea id="cfg_examples" rows="10" placeholder="Incolla qui 1-2 lettere di dimissione precedenti (già anonimizzate) per preservare lo stile..."></textarea>
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:6px;">Queste lettere vengono incluse nel prompt come riferimento stilistico. Non verranno mai inviate all'API insieme ai dati del paziente corrente.</div>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveSettings()">✓ Salva impostazioni</button>
      </div>
    </div>

    <!-- ═══ STEP 7: FREE TIER INFO ═══ -->
    <div class="panel" id="panel6">
      <div class="panel-title">Free Tier & Costi</div>
      <div class="panel-subtitle">// info — usare questo tool gratuitamente o quasi</div>

      <div class="free-grid">
        <div class="free-card">
          <div class="free-card-name">OCR</div>
          <div class="free-card-val">100% Gratis</div>
          <div class="free-card-desc">Tesseract.js — gira nel browser, offline, nessun limite</div>
        </div>
        <div class="free-card">
          <div class="free-card-name">Anonimizzazione</div>
          <div class="free-card-val">Gratis</div>
          <div class="free-card-desc">Regex + NLP locale (browser) — nessun server</div>
        </div>
        <div class="free-card">
          <div class="free-card-name">AI Generation</div>
          <div class="free-card-val">~€0.01–0.04</div>
          <div class="free-card-desc">Per lettera con claude-haiku-4-5 (~2000 token)</div>
        </div>
      </div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Opzione 1 — Anthropic API (pagamento a consumo)</div>
        <div style="font-size:15px;line-height:1.7;color:var(--text-mid);">
          Crea un account su <strong style="color:var(--text);">console.anthropic.com</strong>. Nessun abbonamento, paghi solo quello che usi. Con <strong style="color:var(--text);">claude-haiku-4-5</strong> (modello più veloce ed economico), una lettera di dimissione completa costa circa <strong style="color:var(--accent);">€0.01–0.02</strong>. Per 20 lettere al mese → ~€0.30. Deposito minimo: $5.
        </div>
      </div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Opzione 2 — LLM Locale (Ollama + Llama 3) — GRATUITO al 100%</div>
        <div style="font-size:15px;line-height:1.7;color:var(--text-mid);">
          Installa <strong style="color:var(--text);">Ollama</strong> (ollama.com) → scarica <strong style="color:var(--text);">llama3.1:8b</strong> o <strong style="color:var(--text);">mistral:7b</strong>.<br>
          Avvia con: <code style="background:var(--surface3);padding:2px 6px;border-radius:3px;font-size:12px;">ollama serve</code><br>
          Cambia l'endpoint in questo tool da <code style="background:var(--surface3);padding:2px 6px;border-radius:3px;font-size:12px;">api.anthropic.com</code> a <code style="background:var(--surface3);padding:2px 6px;border-radius:3px;font-size:12px;">http://localhost:11434/v1</code>.<br><br>
          <strong style="color:var(--text);">Pro:</strong> 100% gratuito, dati non escono mai dal PC, anonimizzazione opzionale.<br>
          <strong style="color:var(--red);">Contro:</strong> Qualità ~70% rispetto a Claude Sonnet. Llama 3.1 8B è sufficiente per struttura, meno affidabile per prosa clinica complessa. Richiede GPU ≥8GB VRAM o CPU lenta.
        </div>
      </div>

      <div class="card">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em;">Opzione 3 — OpenRouter (accesso multi-modello)</div>
        <div style="font-size:15px;line-height:1.7;color:var(--text-mid);">
          <strong style="color:var(--text);">openrouter.ai</strong> offre $1 di credito gratuito all'iscrizione e accesso a modelli gratuiti come <strong style="color:var(--text);">google/gemini-flash-1.5</strong> o <strong style="color:var(--text);">meta-llama/llama-3.1-8b-instruct:free</strong>. La qualità è inferiore a Claude ma sufficiente per bozze.
        </div>
      </div>

      <div class="infobox">
        Consiglio pratico: usa Haiku per le bozze (veloce, economico), passa a Sonnet per le lettere finali che richiedono massima accuratezza terminologica.
      </div>
    </div>

  </main>
</div>

<script>
// ═══════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════
let state = {
  clinicalText: '',
  anonText: '',
  generatedLetter: '',
  confirmed: false
};

let currentPanel = 0;

// Default system prompt
const DEFAULT_SYSTEM_PROMPT = `Sei un assistente esperto in documentazione medica ospedaliera italiana. Il tuo compito è generare una lettera di dimissione strutturata in italiano formale clinico.

REGOLE ASSOLUTE:
- NON inventare, inferire o aggiungere dati clinici non presenti nell'input.
- NON aggiungere diagnosi, valori di laboratorio, farmaci, dosi o date non esplicitamente forniti.
- Se una sezione non può essere completata con i dati disponibili, scrivi: "Non documentato."
- NON usare nomi di pazienti, medici, ospedali o qualsiasi identificativo.
- Usa il passato per eventi durante il ricovero.
- Mantieni il registro formale della medicina clinica italiana.
- Segui esattamente la struttura del template fornito.
- NON aggiungere preambolo, commenti o spiegazioni al di fuori della lettera.`;

// ═══════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════
function goTo(index) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel' + index).classList.add('active');
  document.getElementById('nav' + index).classList.add('active');
  currentPanel = index;
}

// ═══════════════════════════════════════════════════
// OCR
// ═══════════════════════════════════════════════════
function handleDragOver(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.add('drag-over');
}
function handleDragLeave(e) {
  document.getElementById('dropzone').classList.remove('drag-over');
}
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) runOCR(file);
}
function handleImageUpload(e) {
  const file = e.target.files[0];
  if (file) runOCR(file);
}

async function runOCR(file) {
  document.getElementById('ocrProgress').style.display = 'block';
  document.getElementById('ocrPreview').style.display = 'none';

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const result = await Tesseract.recognize(e.target.result, 'ita+eng', {
        logger: m => {
          if (m.status === 'recognizing text') {
            const pct = Math.round(m.progress * 100);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('ocrStatus').textContent = `OCR: ${pct}%`;
          } else {
            document.getElementById('ocrStatus').textContent = m.status;
          }
        }
      });
      document.getElementById('ocrStatus').textContent = '✓ OCR completato';
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('ocrText').value = result.data.text;
      document.getElementById('ocrPreview').style.display = 'block';

      // Auto-merge into terapia_dim if empty
      if (!document.getElementById('inp_terapia_dim').value.trim()) {
        document.getElementById('inp_terapia_dim').value = result.data.text;
      }
    } catch(err) {
      document.getElementById('ocrStatus').textContent = '✗ Errore OCR: ' + err.message;
    }
  };
  reader.readAsDataURL(file);
}

// ═══════════════════════════════════════════════════
// ANONYMIZATION
// ═══════════════════════════════════════════════════
function buildMergedText() {
  const parts = [];
  const fields = [
    ['MOTIVO DEL RICOVERO', 'inp_motivo'],
    ['ANAMNESI PATOLOGICA REMOTA', 'inp_apr'],
    ['ANAMNESI FISIOLOGICA/SOCIALE/FAMILIARE', 'inp_afs'],
    ['ESAMI DI LABORATORIO', 'inp_lab'],
    ['ACCERTAMENTI STRUMENTALI E VALUTAZIONI SPECIALISTICHE', 'inp_strum'],
    ['NOTE DECORSO AGGIUNTIVE', 'inp_decorso'],
    ['DECORSO CLINICO', 'inp_decorso_generated'],
    ['DIAGNOSI', 'inp_diagnosi'],
    ['TERAPIA DOMICILIARE PRE-RICOVERO', 'inp_terapia_dom'],
    ['ULTIMA TERAPIA IN REPARTO', 'inp_ultima_terapia'],
    ['TERAPIA ALLA DIMISSIONE', 'inp_terapia_dim'],
    ['FOLLOW-UP E ESAMI PENDENTI', 'inp_followup'],
    ['RACCOMANDAZIONI', 'inp_raccomandazioni'],
    ['CONDIZIONI ALLA DIMISSIONE', 'inp_condizioni'],
  ];
  for (const [section, id] of fields) {
    const el = document.getElementById(id);
    if (!el) continue;
    const val = el.value.trim();
    if (val) parts.push(`### ${section}\n${val}`);
  }
  const ocrTxt = document.getElementById('ocrText').value.trim();
  if (ocrTxt) parts.push(`### TERAPIA OCR (verifica)\n${ocrTxt}`);
  return parts.join('\n\n');
}

// ═══════════════════════════════════════════════════
// DECORSO CLINICO AUTO-GENERATION
// ═══════════════════════════════════════════════════
async function generateDecorso() {
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!apiKey) {
    document.getElementById('decorsoError').style.display = 'block';
    document.getElementById('decorsoError').textContent = '✗ Inserisci la API key nello Step 4 prima di usare questa funzione.';
    return;
  }

  const btn = document.getElementById('decorsoBtn');
  const spinner = document.getElementById('decorsoSpinner');
  const errEl = document.getElementById('decorsoError');
  const infobox = document.getElementById('decorsoInfobox');

  btn.disabled = true;
  spinner.style.display = 'inline-block';
  errEl.style.display = 'none';
  infobox.innerHTML = '⟳ Generazione decorso in corso...';
  infobox.style.borderLeftColor = 'var(--accent-dim)';

  // Gather all clinical data available so far
  const clinicalSummary = [
    ['MOTIVO DEL RICOVERO', 'inp_motivo'],
    ['ANAMNESI PATOLOGICA REMOTA', 'inp_apr'],
    ['ANAMNESI FISIOLOGICA', 'inp_afs'],
    ['ESAMI DI LABORATORIO', 'inp_lab'],
    ['ACCERTAMENTI STRUMENTALI', 'inp_strum'],
    ['DIAGNOSI', 'inp_diagnosi'],
    ['TERAPIA DOMICILIARE', 'inp_terapia_dom'],
    ['ULTIMA TERAPIA IN REPARTO', 'inp_ultima_terapia'],
    ['CONDIZIONI ALLA DIMISSIONE', 'inp_condizioni'],
    ['NOTE AGGIUNTIVE DECORSO', 'inp_decorso'],
  ].map(([sec, id]) => {
    const el = document.getElementById(id);
    const val = el ? el.value.trim() : '';
    return val ? `### ${sec}\n${val}` : '';
  }).filter(Boolean).join('\n\n');

  if (!clinicalSummary.trim()) {
    errEl.style.display = 'block';
    errEl.textContent = '✗ Nessun dato clinico disponibile. Compila prima i campi nello Step 1.';
    btn.disabled = false;
    spinner.style.display = 'none';
    return;
  }

  const model = document.getElementById('modelSelect').value;
  const examples = document.getElementById('cfg_examples').value.trim();

  const systemMsg = `Sei un medico specializzando esperto in documentazione clinica ospedaliera italiana. 
Devi scrivere SOLO la sezione "Decorso clinico" di una lettera di dimissione.

REGOLE:
- Scrivi in prosa continua, in italiano formale clinico, usando il passato remoto/prossimo.
- Sintetizza cronologicamente: accertamenti eseguiti, terapie iniziate, evoluzione clinica, ragionamento diagnostico-terapeutico.
- NON inventare dati non presenti nell'input.
- Se un dato non è disponibile, ometti quella parte (non scrivere "Non documentato" nel decorso — il decorso deve fluire naturalmente).
- NON includere i titoli delle sezioni, intestazioni, o commenti. Scrivi solo il testo del decorso.
- Lunghezza: 150-300 parole, proporzionale alla complessità del caso.
- Stile: segui lo stile delle lettere esempio se fornite.`;

  let userMsg = '';
  if (examples) {
    userMsg += `## ESEMPI DI STILE DECORSO (da lettere precedenti)\n${examples}\n\n---\n\n`;
  }
  userMsg += `## DATI CLINICI\n\n${clinicalSummary}\n\n---\n\nGenera ora il testo del decorso clinico:`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 800,
        temperature: 0.2,
        system: systemMsg,
        messages: [{ role: 'user', content: userMsg }]
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);

    const decorsoText = data.content[0].text.trim();
    document.getElementById('inp_decorso_generated').value = decorsoText;
    infobox.innerHTML = '✓ Decorso generato. Revisionalo e modifica se necessario prima di procedere.';
    infobox.style.borderLeftColor = 'var(--green)';

  } catch(err) {
    errEl.style.display = 'block';
    errEl.textContent = '✗ Errore generazione decorso: ' + err.message;
    infobox.innerHTML = '⚠ Generazione fallita. Puoi compilare manualmente il decorso.';
    infobox.style.borderLeftColor = 'var(--red)';
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
  }
}

// ═══════════════════════════════════════════════════
// DRUG INTELLIGENCE — analyze therapy patterns from examples
// ═══════════════════════════════════════════════════
function copyFromUltimaTerapia() {
  const ultima = document.getElementById('inp_ultima_terapia').value.trim();
  if (!ultima) { alert('Inserisci prima l\'ultima terapia in reparto.'); return; }
  document.getElementById('inp_terapia_dim').value = ultima;
}

async function analyzeDrugsWithAI() {
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!apiKey) {
    alert('Inserisci la API key nello Step 4 prima di usare l\'analisi AI.');
    return;
  }

  const ultimaTerapia = document.getElementById('inp_ultima_terapia').value.trim();
  if (!ultimaTerapia) {
    alert('Inserisci prima l\'ultima terapia somministrata in reparto.');
    return;
  }

  const panel = document.getElementById('drugIntelPanel');
  const chip = document.getElementById('drugIntelChip');
  const content = document.getElementById('drugIntelContent');
  const btn = document.getElementById('drugAnalyzeBtn');

  panel.style.display = 'block';
  chip.className = 'chip chip-warn';
  chip.textContent = '⟳ Analisi in corso...';
  content.textContent = '';
  btn.disabled = true;

  const model = document.getElementById('modelSelect').value;
  const examples = document.getElementById('cfg_examples').value.trim();
  const diagnosi = document.getElementById('inp_diagnosi').value.trim();
  const terapiaDom = document.getElementById('inp_terapia_dom').value.trim();
  const decorso = document.getElementById('inp_decorso_generated').value.trim() || document.getElementById('inp_decorso').value.trim();
  const strum = document.getElementById('inp_strum').value.trim();

  const systemMsg = `Sei un medico specializzando esperto in farmacologia clinica e dimissioni ospedaliere italiane.
Il tuo compito è analizzare la terapia dell'ultimo giorno di degenza e proporre la terapia di dimissione ottimale.

REGOLE ASSOLUTE:
- La terapia di dimissione DEVE essere basata sull'ultima terapia somministrata come punto di partenza.
- Puoi SOLO modificare/aggiungere/rimuovere farmaci se hai una ragione clinica ESPLICITA nei dati forniti.
- NON inventare modifiche terapeutiche non supportate dai dati.
- Se rilevi pattern dalle lettere esempio (es: DAPT→singola antipiastrinica dopo X giorni post-stroke, scalaggio beta-bloccante, titolazione tiroxina), applicali SOLO se coerenti con questo caso.
- Riporta SEMPRE la motivazione clinica per ogni modifica suggerita.
- Se non hai motivo di modificare, proponi l'ultima terapia invariata.
- Rispondi in JSON con struttura: { "terapia_proposta": "...", "modifiche": [{"farmaco": "...", "tipo": "AGGIUNTO|RIMOSSO|MODIFICATO|INVARIATO", "motivazione": "..."}], "note_cliniche": "..." }`;

  let userMsg = `## DIAGNOSI DI DIMISSIONE\n${diagnosi || 'Non specificata'}\n\n`;
  userMsg += `## TERAPIA DOMICILIARE PRE-RICOVERO\n${terapiaDom || 'Non specificata'}\n\n`;
  userMsg += `## ULTIMA TERAPIA IN REPARTO\n${ultimaTerapia}\n\n`;
  if (decorso) userMsg += `## DECORSO CLINICO\n${decorso}\n\n`;
  if (strum) userMsg += `## ACCERTAMENTI STRUMENTALI\n${strum}\n\n`;
  if (examples) userMsg += `## LETTERE ESEMPIO (analizza i pattern terapeutici di dimissione)\n${examples}\n\n`;
  userMsg += `Analizza e proponi la terapia di dimissione. Rispondi SOLO in JSON valido, senza markdown.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 1200,
        temperature: 0.1,
        system: systemMsg,
        messages: [{ role: 'user', content: userMsg }]
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);

    let raw = data.content[0].text.trim();
    // Strip markdown fences if present
    raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
    const parsed = JSON.parse(raw);

    // Populate discharge therapy field
    if (parsed.terapia_proposta) {
      document.getElementById('inp_terapia_dim').value = parsed.terapia_proposta;
    }

    // Build intelligence display
    let html = '';
    if (parsed.note_cliniche) {
      html += `<div style="color:var(--accent);margin-bottom:10px;font-size:12px;">${escHtml(parsed.note_cliniche)}</div>`;
    }

    const modifiche = parsed.modifiche || [];
    const hasChanges = modifiche.some(m => m.tipo !== 'INVARIATO');

    if (modifiche.length > 0) {
      html += `<div style="display:flex;flex-direction:column;gap:6px;">`;
      for (const m of modifiche) {
        const color = m.tipo === 'INVARIATO' ? 'var(--text-dim)' 
          : m.tipo === 'AGGIUNTO' ? 'var(--green)'
          : m.tipo === 'RIMOSSO' ? 'var(--red)'
          : 'var(--accent)';
        const icon = m.tipo === 'INVARIATO' ? '=' : m.tipo === 'AGGIUNTO' ? '+' : m.tipo === 'RIMOSSO' ? '−' : '~';
        html += `<div style="display:flex;gap:8px;align-items:flex-start;">
          <span style="color:${color};font-weight:600;min-width:14px;">${icon}</span>
          <div>
            <span style="color:${color};">${escHtml(m.farmaco)}</span>
            ${m.motivazione && m.tipo !== 'INVARIATO' ? `<span style="color:var(--text-dim);"> — ${escHtml(m.motivazione)}</span>` : ''}
          </div>
        </div>`;
      }
      html += '</div>';
    }

    content.innerHTML = html || 'Analisi completata. Terapia proposta nella casella sottostante.';
    chip.className = hasChanges ? 'chip chip-warn' : 'chip chip-ok';
    chip.textContent = hasChanges ? `⚠ ${modifiche.filter(m=>m.tipo!=='INVARIATO').length} modifica/he suggerite` : '✓ Nessuna modifica';

  } catch(err) {
    content.textContent = '✗ Errore analisi: ' + err.message + '. Usa "Copia da ultima terapia" come fallback.';
    chip.className = 'chip chip-err';
    chip.textContent = '✗ Errore';
  } finally {
    btn.disabled = false;
  }
}

// ═══════════════════════════════════════════════════
// ANONYMIZATION — 3-Layer Pipeline
// ═══════════════════════════════════════════════════
// Layer 1: Manual checklist (user removes obvious identifiers)
// Layer 2: Regex (local, instant) — structured identifiers
// Layer 3: Claude Haiku (anonymize only call) — free-text names
//
// GDPR rationale: Anthropic has formal DPA + EU SCCs.
// Claude Haiku receives text already cleaned by L1+L2.
// Claude NEVER receives both identity + clinical content
// in the same generation call.
// ═══════════════════════════════════════════════════

let checksCompleted = [false, false, false, false, false];

function toggleCheck(label) {
  const idx = parseInt(label.querySelector('.check-box').id.replace('chk',''));
  checksCompleted[idx] = !checksCompleted[idx];
  label.classList.toggle('checked', checksCompleted[idx]);
  label.querySelector('.check-box').textContent = checksCompleted[idx] ? '☑' : '☐';
}

function proceedToAnonymize() {
  // Validate all 5 checklist items
  if (!checksCompleted.every(Boolean)) {
    document.getElementById('checklistError').style.display = 'block';
    return;
  }
  document.getElementById('checklistError').style.display = 'none';
  document.getElementById('checklistPanel').style.display = 'none';
  document.getElementById('anonResultPanel').style.display = 'block';
  runAnonymizationPipeline();
}

function resetToChecklist() {
  document.getElementById('anonResultPanel').style.display = 'none';
  document.getElementById('checklistPanel').style.display = 'block';
  document.getElementById('confirmAnon').checked = false;
}

// ── LAYER 2: Regex — fully local, zero network ──
function regexAnonymize(text) {
  const replacements = [];
  let result = text;

  const patterns = [
    // Codice fiscale
    { regex: /\b[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]\b/gi,
      label: 'Codice Fiscale', tag: '[CODICE_FISCALE]' },
    // Date di nascita
    { regex: /\bnata?\s+(?:il\s+)?\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b/gi,
      label: 'Data Nascita', tag: '[DATA_NASCITA]' },
    { regex: /\b(?:nato|nata)\s+(?:il\s+)?\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b/gi,
      label: 'Data Nascita', tag: '[DATA_NASCITA]' },
    // Telefono
    { regex: /(?:\+39\s?)?(?:0\d{1,4}[\s\-]?\d{5,8}|\d{3}[\s\-]\d{3}[\s\-]\d{4}|\d{10})/g,
      label: 'Telefono', tag: '[TELEFONO]' },
    // Email
    { regex: /[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/g,
      label: 'Email', tag: '[EMAIL]' },
    // ID strutturati
    { regex: /\b(?:matricola|NPI|NHI|MRN|cartella\s*n\.?)[:\s]+[A-Z0-9\-]+/gi,
      label: 'ID', tag: '[ID_PAZIENTE]' },
    // Titoli seguiti da nome: Dott., Prof., Dr.
    { regex: /\b(?:Dott(?:\.?ssa?)?\.?|Prof(?:\.?ssa?)?\.?|Dr\.?)\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+(?:\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+)?\b/g,
      label: 'Medico', tag: '[MEDICO]' },
    // Sig. / Sig.ra
    { regex: /\bSig(?:\.?ra?\.?)\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+(?:\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]+){0,2}\b/g,
      label: 'Paziente', tag: '[PAZIENTE_NOME]' },
    // Strutture ospedaliere
    { regex: /\b(?:Ospedale|Clinica|Policlinico|ULSS|AULSS|Azienda\s+Ospedaliera|A\.O\.)\s+[A-ZÀÈÉÌÍÒÓÙÚ][a-zA-ZÀ-ú\s\.]{2,30}(?=[\s,\.\n\r])/g,
      label: 'Struttura', tag: '[STRUTTURA]' },
    // Nomi contestuali: "con Sara", "dalla Giovanna", "refertato da Mario"
    { regex: /\b((?:con|dalla?|dal|refertato\s+da|visitata?\s+da|seguita?\s+da|dottoressa|infermiera?)\s+)([A-ZÀÈÉÌÍÒÓÙÚ][a-zàèéìíòóùú]{2,})\b/g,
      label: 'Nome contestuale', tag: '$1[NOME]' },
  ];

  // Custom patterns from settings
  try {
    const customStr = document.getElementById('cfg_regex').value.trim();
    if (customStr) {
      for (const cp of JSON.parse(customStr))
        patterns.push({ regex: new RegExp(cp.pattern, 'gi'), label: 'Custom', tag: cp.replace });
    }
  } catch(e) {}

  for (const p of patterns) {
    const isTemplate = p.tag.includes('$');
    if (!isTemplate) {
      const matches = [...result.matchAll(p.regex)];
      for (const m of matches)
        if (m[0].trim().length > 1 && !replacements.find(r => r.original === m[0]))
          replacements.push({ original: m[0], replacement: p.tag, type: p.label });
      result = result.replace(p.regex, p.tag);
    } else {
      // Template replacement (e.g. $1[NOME])
      const matches = [...result.matchAll(p.regex)];
      for (const m of matches) {
        const captured = m[2] || m[1];
        if (captured && !replacements.find(r => r.original === captured))
          replacements.push({ original: captured, replacement: '[NOME]', type: p.label });
      }
      result = result.replace(p.regex, p.tag);
    }
  }

  return { text: result, replacements };
}

// ── LAYER 3: Claude Haiku anonymization call ──
// Receives post-regex text. Only task: find remaining names.
// Anthropic has DPA + EU SCCs. No training on API inputs.
// Cost: ~€0.001 per call.
async function claudeAnonymize(text, apiKey) {
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 4000,
      temperature: 0,
      system: `Sei un sistema di anonimizzazione per testi clinici italiani.
Il testo che ricevi è già stato pre-processato con regex e potrebbe contenere tag come [MEDICO], [CODICE_FISCALE], ecc.

Il tuo UNICO compito: identificare e sostituire qualsiasi dato identificativo RESIDUO non già sostituito.

Sostituisci:
- Nomi propri di persone (pazienti, medici, infermieri, familiari) → [NOME]
- Strutture sanitarie specifiche identificabili → [STRUTTURA]
- Qualsiasi altro dato identificativo non già sostituito

NON toccare:
- Tag già presenti ([MEDICO], [NOME], [STRUTTURA], [CODICE_FISCALE], ecc.)
- Date di esami/ricovero/accertamenti
- Valori di laboratorio, farmaci, dosi
- Diagnosi, sintomi, procedure cliniche
- Nomi di farmaci, patologie, anatomia

Restituisci SOLO il testo modificato. Nessun commento, nessuna spiegazione, nessun markdown.`,
      messages: [{ role: 'user', content: text }]
    })
  });

  if (!response.ok) {
    const err = await response.json();
    throw new Error(err.error?.message || `HTTP ${response.status}`);
  }

  const data = await response.json();
  return data.content[0].text.trim();
}

// ── MAIN PIPELINE ORCHESTRATOR ──
async function runAnonymizationPipeline() {
  const merged = buildMergedText();
  const apiKey = document.getElementById('apiKeyInput').value.trim()
               || document.getElementById('apiKeyInput2').value.trim();

  const statusText = document.getElementById('anonStatusText');
  const spinner = document.getElementById('anonSpinner');
  const statusBar = document.getElementById('anonStatus');

  spinner.style.display = 'inline-block';
  statusBar.style.borderColor = 'var(--border)';

  // Show original
  document.getElementById('origText').textContent = merged;
  document.getElementById('replacementsList').innerHTML = '';

  // ── Layer 2: Regex (instant) ──
  statusText.textContent = '① Regex: rimozione identificativi strutturati...';
  await new Promise(r => setTimeout(r, 50)); // let UI update
  const { text: regexText, replacements: regexReps } = regexAnonymize(merged);

  if (!apiKey) {
    // No API key — regex only, warn user
    renderAnonResult(merged, regexText, regexReps, 'regex');
    statusText.textContent = '⚠ Solo regex applicato (API key assente). Inserisci la chiave nello Step 4 per anonimizzazione AI completa.';
    statusBar.style.borderColor = 'var(--accent-dim)';
    spinner.style.display = 'none';
    return;
  }

  // ── Layer 3: Claude Haiku ──
  statusText.textContent = '② Claude Haiku: ricerca nomi residui nel testo...';
  try {
    const claudeText = await claudeAnonymize(regexText, apiKey);

    // Diff: find what Claude additionally replaced
    const claudeReps = findAdditionalReplacements(regexText, claudeText);

    renderAnonResult(merged, claudeText, [...regexReps, ...claudeReps], 'full');
    const total = regexReps.length + claudeReps.length;
    statusText.textContent = `✓ Completato — ${regexReps.length} regex + ${claudeReps.length} AI = ${total} sostituzioni totali`;
    statusBar.style.borderColor = 'var(--green)';
  } catch(err) {
    // Claude failed — use regex result + warn
    renderAnonResult(merged, regexText, regexReps, 'regex');
    statusText.textContent = `⚠ Claude non disponibile (${err.message}) — solo regex. Verifica attentamente nomi nel testo.`;
    statusBar.style.borderColor = 'var(--red)';
  } finally {
    spinner.style.display = 'none';
  }
}

// Find what Claude replaced that regex hadn't (for display)
function findAdditionalReplacements(before, after) {
  const reps = [];
  const placeholders = ['[NOME]','[STRUTTURA]','[MEDICO]','[PAZIENTE_NOME]','[REDACTED]'];
  // Simple heuristic: find new placeholder occurrences in after vs before
  for (const tag of placeholders) {
    const countBefore = (before.match(new RegExp(escRegex(tag), 'g')) || []).length;
    const countAfter  = (after.match(new RegExp(escRegex(tag), 'g')) || []).length;
    const newOnes = countAfter - countBefore;
    if (newOnes > 0)
      reps.push({ original: `[${newOnes} identificativo/i rilevato/i da AI]`, replacement: tag, type: 'Claude AI' });
  }
  return reps;
}

function renderAnonResult(original, anonText, replacements, mode) {
  document.getElementById('anonText').value = anonText;

  const listEl = document.getElementById('replacementsList');
  const badge = mode === 'full'
    ? '<span class="chip chip-ok" style="margin-left:8px;vertical-align:middle;font-size:9px;">✦ Regex + Claude AI</span>'
    : '<span class="chip chip-warn" style="margin-left:8px;vertical-align:middle;font-size:9px;">{ } Solo Regex</span>';

  if (replacements.length === 0) {
    listEl.innerHTML = '<div class="infobox green" style="margin-bottom:12px;">✓ Nessun identificatore strutturato rilevato automaticamente. Verifica manualmente.</div>';
  } else {
    let html = `<div class="replacements-list" style="margin-bottom:14px;">
      <div class="rep-title">${replacements.length} sostituzion${replacements.length===1?'e':'i'} effettuate ${badge}</div>`;
    for (const r of replacements)
      html += `<div class="rep-item">
        <span class="rep-original">${escHtml(r.original)}</span>
        <span class="rep-arrow">→</span>
        <span class="rep-new">${escHtml(r.replacement)}</span>
        <span class="rep-type">${r.type}</span>
      </div>`;
    html += '</div>';
    listEl.innerHTML = html;
  }

  // Highlight original
  let highlighted = escHtml(original);
  for (const r of replacements) {
    if (!r.original.startsWith('[')) // skip meta-entries like "[2 identificativi...]"
      highlighted = highlighted.replace(
        new RegExp(escRegex(escHtml(r.original)), 'g'),
        `<span class="redacted">${escHtml(r.original)}</span>`
      );
  }
  document.getElementById('origText').innerHTML = highlighted;
}

// Entry point called from Step 2 "Avanti" button
function buildAndAnonymize() {
  const merged = buildMergedText();
  if (!merged.trim()) {
    alert('Inserisci almeno alcuni dati clinici prima di procedere.');
    return;
  }
  // Reset checklist state
  checksCompleted.fill(false);
  document.querySelectorAll('.check-item').forEach(el => {
    el.classList.remove('checked');
    el.querySelector('.check-box').textContent = '☐';
  });
  document.getElementById('checklistPanel').style.display = 'block';
  document.getElementById('anonResultPanel').style.display = 'none';
  document.getElementById('confirmAnon').checked = false;
  document.getElementById('checklistError').style.display = 'none';
  goTo(2);
}

function proceedToGenerate() {
  if (!document.getElementById('confirmAnon').checked) {
    alert('Devi confermare di aver verificato l\'anonimizzazione prima di procedere.');
    return;
  }
  state.anonText = document.getElementById('anonText').value;
  // Set default system prompt
  if (!document.getElementById('systemPrompt').value.trim()) {
    document.getElementById('systemPrompt').value = DEFAULT_SYSTEM_PROMPT;
  }
  goTo(3);
  // Build full prompt view after navigation
  setTimeout(refreshFullPrompt, 100);
}

// ═══════════════════════════════════════════════════
// GENERATION
// ═══════════════════════════════════════════════════
document.getElementById('systemPrompt').addEventListener('input', function() {
  refreshFullPrompt();
});

document.getElementById('tempSlider').addEventListener('input', function() {
  document.getElementById('tempLabel').textContent = (this.value / 10).toFixed(1);
});

function buildUserPrompt() {
  const examples = document.getElementById('cfg_examples').value.trim();
  const citta = document.getElementById('cfg_citta').value || 'Padova';
  const today = new Date().toLocaleDateString('it-IT', { day:'2-digit', month:'2-digit', year:'numeric' });

  let prompt = '';

  if (examples) {
    prompt += `## ESEMPI DI STILE (usa SOLO come riferimento stilistico — non copiare contenuto clinico)\n\n${examples}\n\n---\n\n`;
  }

  prompt += `## DATI CLINICI ANONIMIZZATI\n\n<clinical_input>\n${state.anonText}\n</clinical_input>\n\n---\n\n`;

  prompt += `## ISTRUZIONI DI GENERAZIONE

Genera la lettera di dimissione completa seguendo ESATTAMENTE questa struttura.

NOTA SPECIALE SUL DECORSO CLINICO: I dati contengono già la sezione "### DECORSO CLINICO" pre-generata. Usala DIRETTAMENTE, adattando solo la prosa se necessario per fluidità, senza aggiungere o rimuovere contenuto clinico.

NOTA SPECIALE SULLA TERAPIA: La sezione "### TERAPIA ALLA DIMISSIONE" contiene già la terapia definitiva approvata. Trascrivila ESATTAMENTE come fornita, senza modifiche.

---
${citta}, ${today}

All'attenzione del Medico Curante

Egregio Collega,
        dimettiamo in data odierna la Sua Assistita, [PAZIENTE_NOME], nata in data [DATA_NASCITA], ricoverata presso la nostra Clinica dal [DATA_RICOVERO] u.s., con diagnosi di:

"[DIAGNOSI_PRINCIPALE]"

**Motivo del ricovero**
[Testo dalla sezione MOTIVO DEL RICOVERO — prosa continua, passato remoto, NO elenchi puntati]

**Non farmacoallergie note.** [oppure indica allergie se documentate nei dati]

**Terapia domiciliare**: [farmaci dalla sezione TERAPIA DOMICILIARE PRE-RICOVERO]

**Anamnesi Patologica Remota**
[Dati dalla sezione APR — trattini per ogni voce, tono clinico sintetico]

**Anamnesi Fisiologica/Sociale/Familiare**
[Dati dalla sezione AFS — prosa concisa]

**Esame neurologico all'ingresso**:
[Se presente nei dati — altrimenti ometti questa voce]

**Esame obiettivo generale all'ingresso**:
[Se presente nei dati — altrimenti ometti questa voce]

Durante la degenza sono stati eseguiti i seguenti **esami di laboratorio:**
[Lista strutturata dai dati di laboratorio — mantieni i valori numerici esatti]

ed i seguenti **accertamenti strumentali** e le seguenti **valutazioni specialistiche**:
[Lista strutturata dagli accertamenti — mantieni date e refertazioni esatte]

**Decorso clinico**
[USA DIRETTAMENTE il testo dalla sezione DECORSO CLINICO — non modificare i contenuti clinici]

Alla dimissione [condizioni dalla sezione CONDIZIONI ALLA DIMISSIONE].

**Terapia alla dimissione:**
[TRASCRIVI ESATTAMENTE la sezione TERAPIA ALLA DIMISSIONE — farmaco, dose, frequenza, note temporali]

[Testo dalla sezione FOLLOW-UP E ESAMI PENDENTI — mantieni formulazione esatta]

Si prega di presentarsi muniti degli appositi foglietti azzurri allegati alla lettera di dimissione.

Sarà nostra cura fornire gli esiti degli accertamenti mediante Lettera di Completamento.

[Raccomandazioni dalla sezione RACCOMANDAZIONI se presenti]

Ringraziando per la collaborazione, rimaniamo a disposizione per qualsiasi chiarimento. Cordiali saluti.

${document.getElementById('cfg_dott').value || 'Dott. [NOME]'}                                    ${document.getElementById('cfg_prof').value || 'Prof. [NOME]'}
(Medico in formazione specialistica)              (Dirigente Medico)
---

REGOLA FINALE: Sostituisci SOLO i placeholder con i dati presenti nell'input. Per dati assenti usa "Non documentato." — MAI inventare.`;

  return prompt;
}

async function generateLetter() {
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!apiKey) {
    document.getElementById('generateError').style.display = 'block';
    document.getElementById('generateError').textContent = '✗ Inserisci la API key prima di generare.';
    return;
  }

  const btn = document.getElementById('generateBtn');
  const spinner = document.getElementById('generateSpinner');
  const errEl = document.getElementById('generateError');

  btn.disabled = true;
  spinner.style.display = 'inline-block';
  errEl.style.display = 'none';
  document.getElementById('statusBadge').textContent = '⟳ Generando...';

  const model = document.getElementById('modelSelect').value;
  const temperature = parseInt(document.getElementById('tempSlider').value) / 10;
  const systemPrompt = document.getElementById('systemPrompt').value || DEFAULT_SYSTEM_PROMPT;
  const userPrompt = buildUserPrompt();

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 3000,
        temperature: temperature,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error?.message || `HTTP ${response.status}`);
    }

    const letterText = data.content[0].text;
    state.generatedLetter = letterText;
    document.getElementById('letterOutput').textContent = letterText;
    document.getElementById('statusBadge').textContent = '✓ Lettera generata';
    document.getElementById('nav4').classList.add('done');
    goTo(4);

  } catch(err) {
    errEl.style.display = 'block';
    errEl.textContent = '✗ Errore: ' + err.message;
    document.getElementById('statusBadge').textContent = '✗ Errore';
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
  }
}

// ═══════════════════════════════════════════════════
// OUTPUT ACTIONS
// ═══════════════════════════════════════════════════
function copyLetter() {
  navigator.clipboard.writeText(state.generatedLetter).then(() => {
    alert('Lettera copiata negli appunti.');
  });
}

function printLetter() {
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head>
    <meta charset="UTF-8">
    <title>Lettera di Dimissione</title>
    <style>
      body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.7; margin: 2.5cm; color: #000; }
      pre { white-space: pre-wrap; font-family: inherit; }
    </style>
  </head><body><pre>${escHtml(state.generatedLetter)}</pre></body></html>`);
  win.document.close();
  win.print();
}

// ═══════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════
function saveSettings() {
  // Save to sessionStorage only (not localStorage per security)
  try {
    sessionStorage.setItem('cfg', JSON.stringify({
      citta: document.getElementById('cfg_citta').value,
      reparto: document.getElementById('cfg_reparto').value,
      dott: document.getElementById('cfg_dott').value,
      prof: document.getElementById('cfg_prof').value,
      regex: document.getElementById('cfg_regex').value,
    }));
    alert('Impostazioni salvate per questa sessione.');
  } catch(e) {}
}

function loadSettings() {
  try {
    const cfg = JSON.parse(sessionStorage.getItem('cfg') || '{}');
    if (cfg.citta) document.getElementById('cfg_citta').value = cfg.citta;
    if (cfg.reparto) document.getElementById('cfg_reparto').value = cfg.reparto;
    if (cfg.dott) document.getElementById('cfg_dott').value = cfg.dott;
    if (cfg.prof) document.getElementById('cfg_prof').value = cfg.prof;
    if (cfg.regex) document.getElementById('cfg_regex').value = cfg.regex;
  } catch(e) {}
}

function clearAll() {
  if (!confirm('Cancellare tutti i dati inseriti?')) return;
  document.querySelectorAll('textarea, input[type=text]').forEach(el => {
    if (!['cfg_citta','cfg_reparto','cfg_dott','cfg_prof','cfg_regex','cfg_examples','systemPrompt','apiKeyInput'].includes(el.id)) {
      el.value = '';
    }
  });
  state = { clinicalText: '', anonText: '', generatedLetter: '', confirmed: false };
  goTo(0);
}

// ═══════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════
function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ═══════════════════════════════════════════════════
// API KEY SYNC between step 2 and step 4
// ═══════════════════════════════════════════════════
function syncApiKey(val) {
  document.getElementById('apiKeyInput').value = val;
  document.getElementById('apiKeyInput2').value = val;
}

document.getElementById('apiKeyInput').addEventListener('input', function() {
  syncApiKey(this.value);
});


// ═══════════════════════════════════════════════════
// FULL PROMPT VIEWER
// ═══════════════════════════════════════════════════
let currentPromptTab = 'full';
let cachedSystemPrompt = '';
let cachedUserPrompt = '';

function showPromptTab(tab) {
  currentPromptTab = tab;
  const tabs = { full: 'tabFull', system: 'tabSystem', user: 'tabUser' };
  for (const [t, id] of Object.entries(tabs)) {
    const btn = document.getElementById(id);
    const active = t === tab;
    btn.style.background = active ? 'var(--accent-glow)' : 'transparent';
    btn.style.color = active ? 'var(--accent)' : 'var(--text-mid)';
    btn.style.borderColor = active ? 'var(--accent-dim)' : 'var(--border)';
  }
  updatePromptDisplay();
}

function updatePromptDisplay() {
  const view = document.getElementById('fullPromptView');
  if (!cachedSystemPrompt && !cachedUserPrompt) {
    view.value = 'Clicca "Aggiorna" per assemblare il prompt completo.';
    return;
  }
  if (currentPromptTab === 'full') {
    view.value =
      '══ SYSTEM PROMPT ══════════════════════════════════\n\n' +
      cachedSystemPrompt +
      '\n\n══ USER PROMPT ════════════════════════════════════\n\n' +
      cachedUserPrompt;
  } else if (currentPromptTab === 'system') {
    view.value = cachedSystemPrompt;
  } else {
    view.value = cachedUserPrompt;
  }
  // Token estimate (~4 chars per token)
  const total = (cachedSystemPrompt.length + cachedUserPrompt.length);
  const est = Math.round(total / 4);
  const cost_haiku = ((est / 1000) * 0.00025).toFixed(4);
  const cost_sonnet = ((est / 1000) * 0.003).toFixed(4);
  document.getElementById('promptTokenEstimate').textContent =
    `~${est.toLocaleString()} token stimati — Haiku: ~$${cost_haiku} | Sonnet: ~$${cost_sonnet} per questa generazione`;
}

function refreshFullPrompt() {
  // Make sure anonText is current
  if (state.anonText) {
    cachedSystemPrompt = document.getElementById('systemPrompt').value || DEFAULT_SYSTEM_PROMPT;
    cachedUserPrompt = buildUserPrompt();
    updatePromptDisplay();
  } else {
    document.getElementById('fullPromptView').value =
      'Nessun testo anonimizzato disponibile. Completa prima i passi 1-3.';
  }
}

async function copyFullPrompt() {
  refreshFullPrompt();
  const view = document.getElementById('fullPromptView');
  const text = currentPromptTab === 'full'
    ? '══ SYSTEM PROMPT ══════════════════════════════════\n\n' + cachedSystemPrompt +
      '\n\n══ USER PROMPT ════════════════════════════════════\n\n' + cachedUserPrompt
    : view.value;
  await navigator.clipboard.writeText(text);
  showCopyConfirm();
}

async function copyUserPromptOnly() {
  refreshFullPrompt();
  await navigator.clipboard.writeText(cachedUserPrompt);
  showCopyConfirm();
}

function showCopyConfirm() {
  const el = document.getElementById('copyConfirm');
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 1800);
}

// INIT
loadSettings();
document.getElementById('systemPrompt').value = DEFAULT_SYSTEM_PROMPT;
</script>
</body>
</html>
